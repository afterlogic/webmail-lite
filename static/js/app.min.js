/*!
 * Copyright 2004-2015, AfterLogic Corp.
 * Licensed under AGPLv3 license or AfterLogic license
 * if commerical version of the product was purchased.
 * See the LICENSE file for a full license statement.
 */
!function(e,t,i,s,o){"use strict";function n(){this.ie11=!!navigator.userAgent.match(/Trident.*rv[ :]*11\./),this.ie=/msie/.test(navigator.userAgent.toLowerCase())&&!t.opera||this.ie11,this.ieVersion=this.getIeVersion(),this.ie8AndBelow=this.ie&&this.ieVersion<=8,this.ie9AndBelow=this.ie&&this.ieVersion<=9,this.ie10AndAbove=this.ie&&this.ieVersion>=10,this.opera=!!t.opera||/opr/.test(navigator.userAgent.toLowerCase()),this.firefox=/firefox/.test(navigator.userAgent.toLowerCase()),this.chrome=/chrome/.test(navigator.userAgent.toLowerCase())&&!/opr/.test(navigator.userAgent.toLowerCase()),this.chromeIos=/crios/.test(navigator.userAgent.toLowerCase()),this.safari=/safari/.test(navigator.userAgent.toLowerCase())&&!this.chromeIos}function r(){this.sUrl="?/Ajax/",this.requests=i.observableArray([]),this.openedRequestsCount=i.observable(0),this.requests.subscribe(function(){this.openedRequestsCount(this.requests().length)},this),this.aActionsWithoutAuthForSend=["SystemLogin","SystemUpdateLanguageOnLogin","SystemLogout","AccountCreate","SystemSetMobile","AccountRegister","AccountGetForgotQuestion","AccountValidateForgotQuestion","AccountChangeForgotPassword"],this.aActionsWithoutAuthForSendExt=["SocialRegister","HelpdeskRegister","HelpdeskForgot","HelpdeskLogin","HelpdeskForgotChangePassword","SystemLogout","CalendarList","CalendarEventList","FilesPub"]}function a(){this.defaultScreen=Ci.Screens.Mailbox,this.currentScreen=Ci.Screens.Mailbox,this.lastMailboxHash=i.observable(Ci.Screens.Mailbox),this.lastHelpdeskHash=i.observable(Ci.Screens.Helpdesk),this.lastSettingsHash=i.observable(Ci.Screens.Settings),this.currentHash=i.observable(""),this.previousHash=i.observable("")}function l(){}function h(){this.replyText=i.observable(""),this.replyDraftUid=i.observable(""),this.postponedMailData=null}function c(){this.prefetchStarted=i.observable(!1),this.serverInitializationsDone=i.observable(!1),this.helpdeskInitialized=i.observable(!1),this.fetchersIdentitiesPrefetched=i.observable(!1),this.init()}function u(t,s,o,n,r,a,l,h,c,u){this.fBeforeSelectCallback=null,this.fSelectCallback=s||function(){},this.fDeleteCallback=o||function(){},this.fDblClickCallback=!Pi&&n?n:function(){},this.fEnterCallback=r||function(){},this.bResetCheckedOnClick=Ei.isUnd(l)?!1:!!l,this.bCheckOnSelect=Ei.isUnd(h)?!1:!!h,this.bUnselectOnCtrl=Ei.isUnd(c)?!1:!!c,this.bDisableMultiplySelection=Ei.isUnd(u)?!1:!!u,this.useKeyboardKeys=i.observable(!1),this.list=i.observableArray([]),t&&t.subscribe&&t.subscribe(function(e){this.list(e)},this),this.multiplyLineFactor=a,this.oLast=null,this.oListScope=null,this.oScrollScope=null,this.iTimer=0,this.iFactor=1,this.KeyUp=Ci.Key.Up,this.KeyDown=Ci.Key.Down,this.KeyLeft=Ci.Key.Up,this.KeyRight=Ci.Key.Down,this.multiplyLineFactor&&(this.multiplyLineFactor.subscribe?this.multiplyLineFactor.subscribe(function(e){this.iFactor=e>0?e:1},this):this.iFactor=Ei.pInt(this.multiplyLineFactor),this.KeyUp=Ci.Key.Up,this.KeyDown=Ci.Key.Down,this.KeyLeft=Ci.Key.Left,this.KeyRight=Ci.Key.Right,e("html").hasClass("rtl")&&(this.KeyLeft=Ci.Key.Right,this.KeyRight=Ci.Key.Left)),this.sActionSelector="",this.sSelectabelSelector="",this.sCheckboxSelector="";var d=this;this.listChecked=i.computed({read:function(){var e=_.filter(this.list(),function(e){var t=e.checked(),i=e.selected();return t||d.bCheckOnSelect&&i});return e},write:function(e){e=!!e,_.each(this.list(),function(t){t.checked(e)}),this.list.valueHasMutated()},owner:this}),this.checkAll=i.computed({read:function(){return 0<this.listChecked().length},write:function(e){this.listChecked(!!e)},owner:this}),this.selectorHook=i.observable(null),this.selectorHook.subscribe(function(){var e=this.selectorHook();e&&e.selected(!1)},this,"beforeChange"),this.selectorHook.subscribe(function(e){e&&e.selected(!0)},this),this.itemSelected=i.computed({read:this.selectorHook,write:function(e){this.selectorHook(e),e&&(this.oLast=e)},owner:this}),this.list.subscribe(function(e){if(_.isArray(e)){var t=this.itemSelected();t&&(_.find(e,function(e){return t===e})||this.itemSelected(null))}else this.itemSelected(null)},this),this.listCheckedOrSelected=i.computed({read:function(){var e=this.itemSelected(),t=this.listChecked();return 0<t.length?t:e?[e]:[]},write:function(e){e?this.listChecked(!0):(this.itemSelected(null),this.listChecked(!1))},owner:this}),this.listCheckedAndSelected=i.computed({read:function(){var e=[],t=this.itemSelected(),i=this.listChecked();return i&&(e=i.slice(0)),t&&-1===_.indexOf(i,t)&&e.push(t),e},write:function(e){e?this.listChecked(!0):(this.itemSelected(null),this.listChecked(!1))},owner:this}),this.isIncompleteChecked=i.computed(function(){var e=this.list().length,t=this.listChecked().length;return e>0&&t>0&&e>t},this),this.onKeydownBinded=_.bind(this.onKeydown,this)}function d(){this.openPgp=null,this.openPgpCallbacks=[]}function p(){Data.init()}function m(){this.provider=null,this.report=i.observable(""),this.missedCalls=i.observable(!1),this.phoneToCall=i.observable(""),this.action=i.observable(Ci.PhoneAction.Offline),this.action.subscribe(function(e){switch(e){case Ci.PhoneAction.Offline:this.provider.reconnect(6e4);break;case Ci.PhoneAction.OfflineError:this.provider.reconnect(6e4);break;case Ci.PhoneAction.OfflineInit:this.provider.init();break;case Ci.PhoneAction.OfflineActive:break;case Ci.PhoneAction.Online:Fi.Screens.hidePopup(V),Fi.desktopNotify("hide"),this.provider.reconnect(),this.provider.hangup();break;case Ci.PhoneAction.OnlineActive:break;case Ci.PhoneAction.Outgoing:this.provider.call(this.getFormattedPhone(this.phoneToCall()));break;case Ci.PhoneAction.OutgoingConnect:break;case Ci.PhoneAction.Incoming:break;case Ci.PhoneAction.IncomingConnect:Fi.Screens.hidePopup(V),Fi.desktopNotify("hide"),this.provider.answer()}},this)}function g(){this.phone=Fi.Phone,this.action=Fi.Phone.action,this.stack=i.observable(null),this.registerSession=i.observable(null),this.callSession=i.observable(null),this.stackConf=i.observable(null),this.registerConf=i.observable(null),this.hangupConf=i.observable(null),this.isStarted=i.observable(!1),this.eventSessionBinded=this.eventSession.bind(this),this.createStackErrorBinded=this.createStackError.bind(this),this.createStackBinded=this.createStack.bind(this),this.audioRemote=document.getElementById("audio_remote"),this.interval=0}function f(){this.flash=null,this.jqFlash=null,this.phone=Fi.Phone,this.voiceApp=Fi.Phone.voiceApp,this.report=Fi.Phone.report,this.action=Fi.Phone.action,this.voiceImpi=Mi.User.VoiceImpi,this.voicePassword=Mi.User.VoicePassword,this.sessionid=i.observable(""),this.callState=i.observable(""),this.initStatus=i.observable(!1),this.connectStatus=i.observable(!1),this.init()}function b(){this.phone=Fi.Phone,this.action=Fi.Phone.action,this.device=null,this.connection=null,this.token=null,this.webSocket=null}function y(e,t){this.pgp=e,this.pgpKeyring=new this.pgp.Keyring(new this.pgp.Keyring.localstore(t)),this.keys=i.observableArray([]),this.reloadKeysFromStorage()}function S(e){this.pgpKey=e;var t=this.pgpKey.getPrimaryUser();this.user=t&&t.user?t.user.userId.userid:this.pgpKey.users&&this.pgpKey.users[0]?this.pgpKey.users[0].userId.userid:"",this.emailParts=Ei.getEmailParts(this.user)}function v(){this.result=!0,this.errors=null,this.notices=null,this.exceptions=null}function A(){this.fConfirmCallback=null,this.shown=!1}function C(){this.alertDesc=i.observable(""),this.closeCallback=null,this.title=i.observable(""),this.okButtonText=i.observable(Ei.i18n("MAIN/BUTTON_OK"))}function E(){this.fConfirmCallback=null,this.confirmDesc=i.observable(""),this.title=i.observable(""),this.okButtonText=i.observable(Ei.i18n("MAIN/BUTTON_OK")),this.cancelButtonText=i.observable(Ei.i18n("MAIN/BUTTON_CANCEL")),this.shown=!1}function T(){this.editedAccountId=Mi.Accounts.editedId,this.loading=i.observable(!1),this.friendlyName=i.observable(""),this.email=i.observable(""),this.incomingMailLogin=i.observable(""),this.incomingLoginFocused=i.observable(!1),this.incomingMailPassword=i.observable(""),this.incomingMailPort=i.observable(143),this.incomingMailServer=i.observable(""),this.outgoingMailLogin=i.observable(""),this.outgoingMailPassword=i.observable(""),this.outgoingMailPort=i.observable(25),this.outgoingMailServer=i.observable(""),this.incomingServerFocused=i.observable(!1),this.outServerFocused=i.observable(!1),this.useSmtpAuthentication=i.observable(!0),this.friendlyNameFocus=i.observable(!1),this.emailFocus=i.observable(!1),this.incomingPasswordFocus=i.observable(!1),this.incomingMailFocus=i.observable(!1),this.isFirstStep=i.observable(!0),this.isFirstStep.subscribe(function(e){e||this.clearServers()},this),this.incomingLoginFocused.subscribe(function(){this.incomingLoginFocused()&&""===this.incomingMailLogin()&&this.incomingMailLogin(this.email())},this),this.outServerFocused.subscribe(function(){this.outServerFocused()&&""===this.outgoingMailServer()&&this.outgoingMailServer(this.incomingMailServer())},this)}function F(){this.oIdentityPropertiesViewModel=new ui(this,!0)}function I(){this.defaultAccountId=Mi.Accounts.defaultId,this.loading=i.observable(!1),this.newFolderCreating=i.observable(!1),this.incomingMailServer=i.observable(""),this.incomingMailPort=i.observable(110),this.incomingMailLogin=i.observable(""),this.incomingMailPassword=i.observable(""),this.folderList=Fi.MailCache.folderList,this.folder=i.observable(""),this.options=i.observable(this.folderList().getOptions("",!0,!1,!1)),this.folderList.subscribe(function(){this.options(this.folderList().getOptions("",!0,!1,!1))},this),this.addNewFolderCommand=Ei.createCommand(this,this.onAddNewFolderClick),this.outgoingMailServer=i.observable(""),this.outgoingMailPort=i.observable(25),this.leaveMessagesOnServer=i.observable(!1),this.useSmtpAuthentication=i.observable(!1),this.serverIsSelected=i.observable(!1),this.loginIsSelected=i.observable(!1),this.passwordIsSelected=i.observable(!1),this.defaultOptionsAfterRender=Ei.defaultOptionsAfterRender}function M(){this.folders=Fi.MailCache.editedFolderList,this.sentFolderFullName=i.observable(this.folders().sentFolderFullName()),this.draftsFolderFullName=i.observable(this.folders().draftsFolderFullName()),this.spamFolderFullName=i.observable(this.folders().spamFolderFullName()),this.trashFolderFullName=i.observable(this.folders().trashFolderFullName()),this.options=i.observableArray(this.folders().getOptions(Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_NO_USAGE_ASSIGNED"),!1,!1,!1)),this.defaultOptionsAfterRender=Ei.defaultOptionsAfterRender,this.allowSpamFolderEditing=i.computed(function(){var e=Mi.Accounts.getEdited(),t=e.extensionExists("AllowSpamFolderExtension");return t&&!Mi.IsMailsuite},this)}function w(){this.folders=Fi.MailCache.editedFolderList,this.loading=i.observable(!1),Fi.MailCache.folderListLoading.subscribe(function(){!Fi.MailCache.folderListLoading()&&this.loading()&&(this.fCallback&&this.fCallback(this.folderName(),this.parentFolder()),this.loading(!1),this.closeCommand())},this),this.options=i.computed(function(){return this.folders().getOptions(Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_NO_PARENT"),!0,!1,!0)},this),this.namespace=i.computed(function(){return this.folders().sNamespaceFolder},this),this.parentFolder=i.observable(""),this.folderName=i.observable(""),this.folderNameFocus=i.observable(!1),this.fCallback=null,this.defaultOptionsAfterRender=Ei.defaultOptionsAfterRender}function P(){this.currentPassword=i.observable(""),this.newPassword=i.observable(""),this.confirmPassword=i.observable(""),this.isHelpdesk=i.observable(!1)}function R(){this.fCallback=null,this.folderName=i.observable(""),this.folderName.focus=i.observable(!1),this.folderName.error=i.observable(""),this.folderName.subscribe(function(){this.folderName.error("")},this)}function D(){this.fCallback=null,this.link=i.observable(""),this.linkPrev=i.observable(""),this.linkFocus=i.observable(!1),this.checkTimeout=null,this.urlChecked=i.observable(!1),this.saveCommand=Ei.createCommand(this,this.executeSave,function(){return this.urlChecked()}),this.fileItem=i.observable(new st)}function N(){this.fCallback=null,this.item=null,this.name=i.observable(""),this.name.focus=i.observable(!1),this.name.error=i.observable(""),this.name.subscribe(function(){this.name.error("")},this)}function k(){this.item=null,this.pub=i.observable(""),this.pubFocus=i.observable(!1)}function L(){this.fileStorageViewModel=new pi,this.fileStorageViewModel.isPopup=!0,this.fCallback=null}function O(){this.fCallback=null,this.calendarId=i.observable(null),this.calendarName=i.observable(""),this.calendarDescription=i.observable(""),this.calendarNameFocus=i.observable(!1),this.calendarDescriptionFocus=i.observable(!1),this.colors=i.observableArray([]),this.selectedColor=i.observable(this.colors()[0]),this.popupTitle=i.observable("")}function x(){this.fCallback=null,this.oJua=null,this.allowDragNDrop=i.observable(!1),this.visibility=i.observable(!1),this.importing=i.observable(!1),this.color=i.observable(""),this.calendarId=i.observable("")}function U(){this.guestsDom=i.observable(),this.guestsDom.subscribe(function(){this.initInputosaurus(this.guestsDom,this.guests,this.guestsLock)},this),this.ownersDom=i.observable(),this.ownersDom.subscribe(function(){this.initInputosaurus(this.ownersDom,this.owners,this.ownersLock)},this),this.guestsLock=i.observable(!1),this.guests=i.observable("").extend({reversible:!0}),this.guests.subscribe(function(){this.guestsLock()||(e(this.guestsDom()).val(this.guests()),e(this.guestsDom()).inputosaurus("refresh"))},this),this.ownersLock=i.observable(!1),this.owners=i.observable("").extend({reversible:!0}),this.owners.subscribe(function(){this.ownersLock()||(e(this.ownersDom()).val(this.owners()),e(this.ownersDom()).inputosaurus("refresh"))},this),this.defaultAccount=Mi.Accounts.getDefault(),this.fCallback=null,this.calendarId=i.observable(null),this.selectedColor=i.observable(""),this.calendarUrl=i.observable(""),this.exportUrl=i.observable(""),this.icsLink=i.observable(""),this.isPublic=i.observable(!1),this.shares=i.observableArray([]),this.owner=i.observable(""),this.recivedAnim=i.observable(!1).extend({autoResetToFalse:500}),this.whomAnimate=i.observable(""),this.newShare=i.observable(""),this.newShareFocus=i.observable(!1),this.newShareAccess=i.observable(Ci.CalendarAccess.Read),this.sharedToAll=i.observable(!1),this.sharedToAllAccess=i.observable(Ci.CalendarAccess.Read),this.canAdd=i.observable(!1),this.aAccess=[{value:Ci.CalendarAccess.Read,display:Ei.i18n("CALENDAR/CALENDAR_ACCESS_READ")},{value:Ci.CalendarAccess.Write,display:Ei.i18n("CALENDAR/CALENDAR_ACCESS_WRITE")}],this.showGlobalContacts=!!Mi.User.ShowGlobalContacts}function H(){this.fCallback=null,this.calendarId=i.observable(null),this.selectedColor=i.observable(""),this.calendarUrl=i.observable(""),this.exportUrl=i.observable(""),this.icsLink=i.observable(""),this.isPublic=i.observable(!1),this.pubUrl=i.observable("")}function G(){this.defaultAccount=Mi.Accounts?Mi.Accounts.getDefault():null,this.modified=!1,this.isPublic=wi,this.isEditable=i.observable(!1),this.isEditableReminders=i.observable(!1),this.selectedCalendarIsShared=i.observable(!1),this.selectedCalendarIsEditable=i.observable(!1),this.callbackSave=null,this.callbackDelete=null,this.timeFormatMoment="HH:mm",this.dateFormatMoment="MM/DD/YYYY",this.dateFormatDatePicker="mm/dd/yy",this.ampmTimeFormat=i.observable(!1),this.calendarId=i.observable(null),this.id=i.observable(null),this.uid=i.observable(null),this.recurrenceId=i.observable(null),this.allEvents=i.observable(Ci.CalendarEditRecurrenceEvent.AllEvents),this.FCMoment=null,this.isMyEvent=i.observable(!1),this.startDom=i.observable(null),this.endDom=i.observable(null),this.repeatEndDom=i.observable(null),this.yearlyDayText=i.observable(""),this.monthlyDayText=i.observable(""),this.subject=i.observable(""),this.description=i.observable(""),this.lockSelectStartEndDate=i.observable(!1),this.startDate=i.observable(""),this.startTime=i.observable(""),this.startTime.subscribe(function(){this.selectStartDate()},this),this.allDay=i.observable(!1),this.allDay.subscribe(function(e){e||this.setActualTime()},this),this.endDate=i.observable(""),this.endTime=i.observable(""),this.endTime.subscribe(function(){this.selectEndDate()},this),this.repeatEndDate=i.observable(""),this.isEvOneDay=i.observable(!0),this.isEvOneTime=i.observable(!0),this.isRepeat=i.observable(!1),this.location=i.observable(""),this.repeatPeriodOptions=i.observableArray(this.getDisplayedPeriods()),this.repeatWeekIntervalOptions=i.observableArray([1,2,3,4]),this.repeatMonthIntervalOptions=i.observableArray(this.getDisplayedIntervals()),this.defaultAlarms=i.observableArray([5,10,15,30,60,120,180,240,300,360,420,480,540,600,660,720,1080,1440,2880,4320,5760,10080,20160]),this.alarmOptions=i.observableArray([]),this.timeOptions=i.observableArray(this.getDisplayedTimes(Mi.User.defaultTimeFormat()!==Ci.TimeFormat.F24?"hh:mm A":"HH:mm")),Mi.User.defaultTimeFormat.subscribe(function(){this.timeOptions(this.getDisplayedTimes(Mi.User.defaultTimeFormat()!==Ci.TimeFormat.F24?"hh:mm A":"HH:mm"))},this),this.displayedAlarms=i.observableArray([]),this.displayedAlarms.subscribe(function(){this.disableAlarms()},this),this.excluded=i.observable(!1),this.repeatPeriod=i.observable(Ci.CalendarRepeatPeriod.None),this.repeatPeriod.subscribe(function(e){this.setDayOfWeek(),this.isRepeat(!!e)},this),this.repeatInterval=i.observable(1),this.repeatCount=i.observable(null),this.repeatWeekNum=i.observable(null),this.weekMO=i.observable(!1),this.weekTU=i.observable(!1),this.weekWE=i.observable(!1),this.weekTH=i.observable(!1),this.weekFR=i.observable(!1),this.weekSA=i.observable(!1),this.weekSU=i.observable(!1),this.appointment=i.observable(!1),this.attendees=i.observableArray([]),this.attenderStatus=i.observable(0),this.owner=i.observable(""),this.ownerName=i.observable(""),this.recivedAnim=i.observable(!1).extend({autoResetToFalse:500}),this.whomAnimate=i.observable(""),this.guestAutocompleteItem=i.observable(null),this.guestAutocomplete=i.observable(""),this.guestEmailFocus=i.observable(!1),this.guestAutocomplete.subscribe(function(e){""===e&&this.guestAutocompleteItem(null)},this),this.condition=i.observable(""),this.autosizeTrigger=i.observable(!0),this.calendars=null,this.calendarsList=i.observableArray([]),this.calendarColor=i.observable(""),this.selectedCalendarId=i.observable(""),this.selectedCalendarName=i.observable(""),this.selectedCalendarId.subscribe(function(e){if(e){var t=this.calendars.getCalendarById(e);this.selectedCalendarName(t.name()),this.selectedCalendarIsShared(t.isShared()),this.selectedCalendarIsEditable(t.isEditable()),this.changeCalendarColor(e)}},this),this.subjectFocus=i.observable(!1),this.descriptionFocus=i.observable(!1),this.locationFocus=i.observable(!1),this.dateEdit=i.observable(!1),this.repeatEdit=i.observable(!1),this.guestsEdit=i.observable(!1),this.defaultOptionsAfterRender=Ei.defaultOptionsAfterRender,this.isEditForm=i.computed(function(){return!!this.id()},this),this.callbackAttendeeActionDecline=null,this.calendarAppointments=Mi.User.AllowCalendar&&Mi.User.CalendarAppointments,this.allChanges=i.computed(function(){this.subject(),this.description(),this.location(),this.isRepeat(),this.allDay(),this.repeatPeriod(),this.repeatInterval(),this.repeatCount(),this.repeatWeekNum(),this.startDate(),this.startTime(),this.endDate(),this.endTime(),this.repeatEndDate(),this.displayedAlarms(),this.weekMO(),this.weekTU(),this.weekWE(),this.weekTH(),this.weekFR(),this.weekSA(),this.weekSU(),this.attendees(),this.selectedCalendarId(),this.modified=!0},this),this.phaseArray=[""],_.each(Ei.i18n("CALENDAR/REMINDER_PHRASE").split(/\s/),function(e){var t=this.phaseArray.length-1;"%"===e.substr(0,1)||"%"===this.phaseArray[t].substr(-1,1)?this.phaseArray.push(e):this.phaseArray[t]+=" "+e},this),this.isAppointmentButtonsVisible=i.observable(!1)}function B(){this.fCallback=null,this.confirmDesc=Ei.i18n("CALENDAR/EDIT_RECURRENCE_CONFIRM_DESCRIPTION"),this.onlyThisInstanceButtonText=i.observable(Ei.i18n("CALENDAR/ONLY_THIS_INSTANCE")),this.allEventsButtonText=i.observable(Ei.i18n("CALENDAR/ALL_EVENTS_IN_THE_SERIES")),this.cancelButtonText=i.observable(Ei.i18n("MAIN/BUTTON_CANCEL"))}function j(){this.fCallback=null,this.fProceedUploading=null,this.calendars=null,this.calendarsList=i.observableArray([]),this.calendarColor=i.observable(""),this.selectedCalendarName=i.observable(""),this.selectedCalendarId=i.observable(""),this.selectedCalendarId.subscribe(function(e){if(e){var t=this.calendars.getCalendarById(e);this.selectedCalendarName(t.name()),this.selectedCalendarIsEditable(t.isEditable()),this.changeCalendarColor(e)}},this),this.selectedCalendarIsEditable=i.observable(!1)}function V(){this.phone=Fi.Phone,this.action=this.phone.action,this.report=this.phone.report,this.text=i.observable(""),this.callback=null}function K(){this.pgp=null,this.emails=i.observableArray([]),this.selectedEmail=i.observable(""),this.password=i.observable(""),this.keyLengthOptions=[1024,2048],this.selectedKeyLength=i.observable(1024),this.process=i.observable(!1)}function W(){this.armor=i.observable(""),this.htmlArmor=i.computed(function(){return Ei.encodeHtml(this.armor().replace(/\r/g,""))},this),this.user=i.observable(""),this.private=i.observable(!1),this.titleText=i.computed(function(){return this.private()?Ei.i18n("OPENPGP/POPUP_TITLE_VIEW_PRIVATE_KEY",{USER:this.user()}):Ei.i18n("OPENPGP/POPUP_TITLE_VIEW_PUBLIC_KEY",{USER:this.user()})},this),this.downloadLinkHref=i.computed(function(){var e="#",i=null;return t.URL=t.webkitURL||t.URL,Blob&&t.URL&&Ei.isFunc(t.URL.createObjectURL)&&(i=new Blob([this.armor()],{type:"text/plain"}),e=t.URL.createObjectURL(i)),e},this),this.downloadLinkFilename=i.computed(function(){var e=this.user().replace(/</g,"").replace(/>/g,""),t=this.private()?"OPENPGP/PRIVATE_KEY_FILENAME":"OPENPGP/PUBLIC_KEY_FILENAME";return Ei.i18n(t,{USER:e})+".asc"},this),this.domKey=i.observable(null)}function q(){this.pgp=null,this.keyArmor=i.observable(""),this.keyArmorFocused=i.observable(!1),this.keys=i.observableArray([]),this.hasExistingKeys=i.observable(!1),this.headlineText=i.computed(function(){return Ei.i18n("OPENPGP/INFO_TEXT_INCLUDES_KEYS_PLURAL",{},null,this.keys().length)},this)}function Y(){this.data=i.observable(""),this.fromEmail=i.observable(""),this.emails=i.observableArray([]),this.okCallback=null,this.cancelCallback=null,this.sign=i.observable(!0),this.password=i.observable(""),this.passwordFocused=i.observable(!1),this.encrypt=i.observable(!0),this.signEncryptButtonText=i.computed(function(){var e=Ei.i18n("OPENPGP/BUTTON_SIGN_ENCRYPT");return this.sign()&&!this.encrypt()&&(e=Ei.i18n("OPENPGP/BUTTON_SIGN")),!this.sign()&&this.encrypt()&&(e=Ei.i18n("OPENPGP/BUTTON_ENCRYPT")),e},this),this.isEnableSignEncrypt=i.computed(function(){return this.sign()||this.encrypt()},this),this.signEncryptCommand=Ei.createCommand(this,this.executeSignEncrypt,this.isEnableSignEncrypt),this.signAndSend=i.observable(!1)}function z(){this.allowGoogle=Mi.SocialGoogle,this.googleKey=Mi.SocialGoogleApiKey,this.googleClientId=Mi.SocialGoogleId,this.picker=null,this.pickerCreated=!1,this.googleApiLoaded=!1,this.pickerApiLoaded=!1,this.fCallback=null,this.timeOut=null}function Q(e){this.AllowWebMail=!0,this.AllowUsersChangeInterfaceSettings=!0,this.AllowUsersChangeEmailSettings=!0,this.AllowUsersAddNewAccounts=!0,this.SiteName="",this.Languages=[{name:"English",value:"en"}],this.Themes=["Default"],this.DateFormats=[],this.DefaultLanguage="English",this.AttachmentSizeLimit=1024e4,this.ImageUploadSizeLimit=1024e4,this.FileSizeLimit=1024e4,this.AutoSave=!0,this.AutoSaveIntervalSeconds=60,this.IdleSessionTimeout=0,this.AllowInsertImage=!0,this.AllowBodySize=!1,this.MaxBodySize=600,this.MaxSubjectSize=255,this.AllowPrefetch=!0,this.MaxPrefetchBodiesSize=5e4,this.LoginFormType=Ci.LoginFormType.Email,this.LoginAtDomainValue="",this.AllowRegistration=!1,this.AllowPasswordReset=!1,this.RegistrationDomains=[],this.RegistrationQuestions=[],this.DemoWebMail=!0,this.DemoWebMailLogin="",this.DemoWebMailPassword="",this.LoginDescription="",this.GoogleAnalyticsAccount="",this.ShowQuotaBar=!1,this.ServerUseUrlRewrite=!1,this.AllowLanguageOnLogin=!1,this.FlagsLangSelect=!1,this.CustomLoginUrl="",this.CustomLogoutUrl="",this.IosDetectOnLogin=!1,this.AllowContactsSharing=!1,this.DefaultLanguageShort="en",this.AllowOpenPgp=e,this.DefaultTab="",this.AllowIosProfile=!0,this.PasswordMinLength=0,this.PasswordMustBeComplex=!1}function $(){this.IdUser=1,this.MailsPerPage=20,this.ContactsPerPage=20,this.iInterval=-1,this.AutoCheckMailInterval=0,this.DefaultTheme="Default",this.DefaultLanguage="English",this.DefaultLanguageShort="en",this.DefaultDateFormat="MM/DD/YYYY",this.defaultTimeFormat=i.observable(Ci.TimeFormat.F24),this.ThreadsEnabled=!0,this.useThreads=i.observable(!0),this.SaveRepliedToCurrFolder=!0,this.AllowChangeInputDirection=!1,this.DesktopNotifications=!1,this.AllowCompose=!0,this.AllowReply=!0,this.AllowForward=!0,this.SaveMail=Ci.SaveMail.Checked,this.AllowFetcher=!1,this.OutlookSyncEnable=!0,this.MobileSyncEnable=!0,this.ShowPersonalContacts=!0,this.ShowGlobalContacts=!1,this.IsFilesSupported=!1,this.IsHelpdeskSupported=!1,this.IsHelpdeskAgent=!1,this.HelpdeskIframeUrl="",this.ShowContacts=this.ShowPersonalContacts||this.ShowGlobalContacts,this.LastLogin=0,this.IsDemo=!1,this.AllowVoice=!1,this.SipRealm="",this.SipWebsocketProxyUrl="",this.SipOutboundProxyUrl="",this.SipCallerID="",this.SipImpi="",this.SipImpu="",this.SipPassword="",this.VoiceProvider="",this.AllowCalendar=!0,this.CalendarSharing=!1,this.CalendarAppointments=!1,this.CalendarShowWeekEnds=!1,this.CalendarShowWorkDay=!1,this.CalendarWorkDayStarts=0,this.CalendarWorkDayEnds=0,this.CalendarWeekStartsOn=0,this.CalendarDefaultTab=Ci.CalendarDefaultTab.Month,this.mobileSync=i.observable(null),this.MobileSyncDemoPass="demo",this.outlookSync=i.observable(null),this.OutlookSyncDemoPass="demo",this.AllowHelpdeskNotifications=!1,this.IsCollaborationSupported=!1,this.AllowFilesSharing=!1,this.DefaultFontName="Tahoma",this.fillDefaultFontName(),this.DefaultFontSize=3,this.fillDefaultFontSize(),this.enableOpenPgp=i.observable(!1),this.AllowAutosaveInDrafts=!0,this.AutosignOutgoingEmails=!1,this.filesEnable=i.observable(!0),this.SocialAccounts=i.observableArray([])}function J(){this.id=i.observable(0),this.email=i.observable(""),this.extensions=i.observableArray([]),this.fetchers=i.observable(null),this.identities=i.observable(null),this.friendlyName=i.observable(""),this.incomingMailLogin=i.observable(""),this.incomingMailPort=i.observable(143),this.incomingMailServer=i.observable(""),this.isInternal=i.observable(!1),this.isLinked=i.observable(!1),this.isDefault=i.observable(!1),this.outgoingMailAuth=i.observable(0),this.outgoingMailLogin=i.observable(""),this.outgoingMailPort=i.observable(25),this.outgoingMailServer=i.observable(""),this.isExtended=i.observable(!1),this.signature=i.observable(null),this.autoresponder=i.observable(null),this.forward=i.observable(null),this.filters=i.observable(null),this.quota=i.observable(0),this.usedSpace=i.observable(0),this.quotaRecieved=i.observable(!1),this.fullEmail=i.computed(function(){return""===this.friendlyName()?this.email():this.friendlyName()+" <"+this.email()+">"},this),this.isCurrent=i.observable(!1),this.isEdited=i.observable(!1),this.extensionsRequested=i.observable(!1),this.removeHint=i.computed(function(){var e="",t="";return this.isDefault()?(Mi.User.AllowCalendar&&Mi.User.ShowContacts?e=Ei.i18n("SETTINGS/ACCOUNTS_REMOVE_CONTACTS_CALENDARS_HINT"):Mi.User.AllowCalendar?e=Ei.i18n("SETTINGS/ACCOUNTS_REMOVE_CALENDARS_HINT"):Mi.User.ShowContacts&&(e=Ei.i18n("SETTINGS/ACCOUNTS_REMOVE_CONTACTS_HINT")),t=Ei.i18n("SETTINGS/ACCOUNTS_REMOVE_DEFAULT_HINT",{AND_OTHER:e}),Mi.Accounts.collection().length>1&&(t+=Ei.i18n("SETTINGS/ACCOUNTS_REMOVE_DEFAULT_NOTSINGLE_HINT"))):t=Ei.i18n("SETTINGS/ACCOUNTS_REMOVE_HINT"),t},this),this.removeConfirmation=i.computed(function(){return this.isDefault()?this.removeHint()+Ei.i18n("SETTINGS/ACCOUNTS_REMOVE_DEFAULT_CONFIRMATION"):Ei.i18n("SETTINGS/ACCOUNTS_REMOVE_CONFIRMATION")},this)}function X(){this.defaultId=i.observable(0),this.currentId=i.observable(0),this.editedId=i.observable(0),this.currentId.subscribe(function(e){var t=this.getCurrent();t.requestExtensions(),_.delay(_.bind(function(){this.editedId(e)},this),1e3)},this),this.collection=i.observableArray([])}function Z(){this.sName="",this.sEmail="",this.sDisplay="",this.sFull="",this.loaded=i.observable(!1),this.founded=i.observable(!1)}function et(){this.aCollection=[]}function tt(){this.iTimeStampInUTC=0,this.oMoment=null}function it(){this.loyal=i.observable(!1),this.isDefault=i.observable(!1),this.enabled=i.observable(!0),this.email=i.observable(""),this.friendlyName=i.observable(""),this.fullEmail=i.computed(function(){var e="";return e=""!==this.friendlyName()?this.friendlyName()+" <"+this.email()+">":this.email()},this),this.accountId=i.observable(-1),this.id=i.observable(-1),this.signature=i.observable(""),this.useSignature=i.observable(!1)}function st(){this.isIosDevice=Di,this.isFolder=i.observable(!1),this.isLink=i.observable(!1),this.linkType=i.observable(Ci.FileStorageLinkType.Unknown),this.linkUrl=i.observable(""),this.isPopupItem=i.observable(!1),this.id=i.observable(""),this.fileName=i.observable(""),this.tempName=i.observable(""),this.displayName=i.observable(""),this.extension=i.observable(""),this.fileName.subscribe(function(){var e=this.fileName();this.id(e),this.isFolder()?(this.displayName(e),this.extension("")):(this.displayName(Ei.getFileNameWithoutExtension(e)),this.extension(Ei.getFileExtension(e)))},this),this.size=i.observable(0),this.friendlySize=i.computed(function(){return Ei.friendlySize(this.size())},this),this.content=i.observable(""),this.accountId=i.observable(Mi.Accounts?Mi.Accounts.defaultId():null),this.hash=i.observable(""),this.thumb=i.observable(!1),this.iframedView=i.observable(!1),this.downloadLink=i.computed(function(){return Ei.getDownloadLinkByHash(this.accountId(),this.hash())},this),this.viewLink=i.computed(function(){var e=Ei.getViewLinkByHash(this.accountId(),this.hash());return this.iframedView()?Ei.getIframeWrappwer(this.accountId(),e):e},this),this.thumbnailSrc=i.observable(""),this.thumbnailLoaded=i.observable(!1),this.thumbnailSessionUid=i.observable(""),this.thumbnailLink=i.computed(function(){return this.thumb()?Ei.getViewThumbnailLinkByHash(this.accountId(),this.hash()):""},this),this.type=i.observable(""),this.uploadUid=i.observable(""),this.uploaded=i.observable(!1),this.uploadError=i.observable(!1),this.visibleImportLink=i.computed(function(){return Mi.User.enableOpenPgp()&&"asc"===this.extension().toLowerCase()&&""!==this.content()&&!this.isPopupItem()},this),this.isViewMimeType=i.computed(function(){return-1!==e.inArray(this.type(),ki)||this.iframedView()},this),this.isMessageType=i.observable(!1),this.visibleViewLink=i.computed(function(){return this.isVisibleViewLink()&&!this.isPopupItem()},this),this.visibleDownloadLink=i.computed(function(){return!this.isPopupItem()},this),this.subFiles=i.observableArray([]),this.allowExpandSubFiles=i.observable(!1),this.subFilesLoaded=i.observable(!1),this.subFilesCollapsed=i.observable(!1),this.subFilesStartedLoading=i.observable(!1),this.visibleExpandLink=i.computed(function(){return this.allowExpandSubFiles()&&!this.subFilesCollapsed()&&!this.subFilesStartedLoading()},this),this.visibleExpandingText=i.computed(function(){return this.allowExpandSubFiles()&&!this.subFilesCollapsed()&&this.subFilesStartedLoading()},this),this.visibleSpinner=i.observable(!1),this.statusText=i.observable(""),this.statusTooltip=i.computed(function(){return this.uploadError()?this.statusText():""},this),this.progressPercent=i.observable(0),this.visibleProgress=i.observable(!1),this.uploadStarted=i.observable(!1),this.uploadStarted.subscribe(function(){this.uploadStarted()?(this.uploaded(!1),this.visibleProgress(!0),this.progressPercent(20)):(this.progressPercent(100),this.visibleProgress(!1),this.uploaded(!0))
},this),this.allowDrag=i.observable(!1),this.allowSelect=i.observable(!1),this.allowCheck=i.observable(!1),this.allowDelete=i.observable(!1),this.allowUpload=i.observable(!1),this.allowSharing=i.observable(!1),this.allowHeader=i.observable(!1),this.allowDownload=i.observable(!0),this.downloadTitle=i.computed(function(){return!this.allowSelect()&&this.allowDownload()?Ei.i18n("MESSAGE/ATTACHMENT_CLICK_TO_DOWNLOAD",{FILENAME:this.fileName(),SIZE:this.friendlySize()}):""},this)}function ot(){this.folderName=i.observable(""),this.messageUid=i.observable(""),this.cid=i.observable(""),this.contentLocation=i.observable(""),this.inline=i.observable(!1),this.linked=i.observable(!1),this.mimePartIndex=i.observable(""),this.messagePart=i.observable(null),st.call(this),this.isMessageType=i.computed(function(){return this.type(),this.mimePartIndex(),"message/rfc822"===this.type()&&""!==this.mimePartIndex()},this)}function nt(){this.iAccountId=0,this.account=i.computed(function(){return Mi.Accounts.getAccount(this.iAccountId)},this),this.parentFullName=i.observable(""),this.level=i.observable(0),this.name=i.observable(""),this.nameForEdit=i.observable(""),this.fullName=i.observable(""),this.fullNameHash=i.observable(""),this.uidNext=i.observable(""),this.hash=i.observable(""),this.routingHash=i.observable(""),this.delimiter=i.observable(""),this.type=i.observable(Ci.FolderTypes.User),this.showUnseenMessages=i.computed(function(){return this.type()!==Ci.FolderTypes.Drafts},this),this.withoutThreads=i.computed(function(){return this.type()===Ci.FolderTypes.Drafts||this.type()===Ci.FolderTypes.Spam||this.type()===Ci.FolderTypes.Trash},this),this.messageCount=i.observable(0),this.unseenMessageCount=i.observable(0),this.unseenMessageCount.subscribe(function(){_.delay(_.bind(function(){Fi.MailCache.countMessages(this)},this),1e3)},this),this.realUnseenMessageCount=i.observable(0),this.enableEmptyFolder=i.computed(function(){return this.messageCount()>0&&(this.type()===Ci.FolderTypes.Spam||this.type()===Ci.FolderTypes.Trash)},this),this.virtual=i.observable(!1),this.virtualEmpty=i.computed(function(){return this.virtual()&&0===this.messageCount()},this),this.hasExtendedInfo=i.observable(!1),this.selectable=i.observable(!0),this.subscribed=i.observable(!0),this.subscribed.subscribe(function(){if(this.parentFullName()){var e=Fi.MailCache.folderList().getFolderByFullName(this.parentFullName());e&&Fi.MailCache.countMessages(e)}},this),this.existen=i.observable(!0),this.isNamespace=i.observable(!1),this.subfoldersMessagesCount=i.observable(0),this.subfolders=i.observableArray([]),this.subfolders.subscribe(function(e){var t=_.any(_.map(e,function(e){return e.subscribed()}));this.canExpand(t)},this),this.canExpand=i.observable(!0),this.expanded=i.observable(!1),this.isCollapseHandler=i.computed(function(){return 0!==this.subfolders().length&&!this.isNamespace()&&this.canExpand()},this),this.messageCountToShow=i.computed(function(){return this.canExpand()?this.showUnseenMessages()?this.unseenMessageCount()+this.subfoldersMessagesCount():this.messageCount():this.showUnseenMessages()?this.unseenMessageCount():this.messageCount()},this),this.isSubFolder=i.computed(function(){return this.level()>0},this),this.selected=i.observable(!1),this.recivedAnim=i.observable(!1).extend({autoResetToFalse:500}),this.hasSubscribedSubfolders=i.computed(function(){return!!i.utils.arrayFirst(this.subfolders(),function(e){return e.subscribed()})},this),this.isSystem=i.computed(function(){return this.type()!==Ci.FolderTypes.User?!0:!1},this),this.visible=i.computed(function(){var e=this.subscribed(),t=this.existen(),i=this.selectable(),s=this.hasSubscribedSubfolders(),o=this.isSystem();return e||o||s&&(!t||!i)},this),this.edited=i.observable(!1),this.edited.subscribe(function(e){e===!1&&this.nameForEdit(this.name())},this),this.canBeSelected=i.computed(function(){var e=this.existen(),t=this.selectable();return e&&t},this),this.canSubscribe=i.computed(function(){var e=this.account(),t=!1;return e&&(t=e.extensionExists("DisableManageSubscribe")),!this.isSystem()&&this.canBeSelected()&&!t},this),this.canDelete=i.computed(function(){return!this.isSystem()&&this.hasExtendedInfo()&&0===this.messageCount()&&0===this.subfolders().length},this),this.canRename=i.computed(function(){return!this.isSystem()&&this.canBeSelected()},this),this.subscribeButtonHint=i.computed(function(){return this.canSubscribe()?Ei.i18n(this.subscribed()?"SETTINGS/ACCOUNT_FOLDERS_HIDE_FOLDER_HINT":"SETTINGS/ACCOUNT_FOLDERS_SHOW_FOLDER_HINT"):""},this),this.deleteButtonHint=i.computed(function(){return this.canDelete()?Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_DELETE_FOLDER_HINT"):""},this),this.usedAs=i.computed(function(){var e="";switch(this.type()){case Ci.FolderTypes.Inbox:e=Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_INBOX");break;case Ci.FolderTypes.Sent:e=Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_SENT");break;case Ci.FolderTypes.Drafts:e=Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_DRAFTS");break;case Ci.FolderTypes.Trash:e=Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_TRASH");break;case Ci.FolderTypes.Spam:e=Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_SPAM");break;default:e=""}return e},this),this.oMessages={},this.oUids={},this.aResponseHandlers=[],this.displayName=i.computed(function(){var e=this.name();switch(this.type()){case Ci.FolderTypes.Inbox:e=Ei.i18n("MAIN/FOLDER_INBOX");break;case Ci.FolderTypes.Sent:e=Ei.i18n("MAIN/FOLDER_SENT");break;case Ci.FolderTypes.Drafts:e=Ei.i18n("MAIN/FOLDER_DRAFTS");break;case Ci.FolderTypes.Trash:e=Ei.i18n("MAIN/FOLDER_TRASH");break;case Ci.FolderTypes.Spam:e=Ei.i18n("MAIN/FOLDER_SPAM")}return e},this),this.aRequestedUids=[],this.aRequestedThreadUids=[],this.requestedLists=[],this.hasChanges=i.observable(!1),this.hasChanges.subscribe(function(){this.requestedLists=[]},this),this.unseenFilterCommand=Ei.createCommand(this,this.executeUnseenFilter,this.showUnseenMessages),this.unseenMessagesTitle=i.computed(function(){return this.showUnseenMessages()?Ei.i18n("MAILBOX/TITLE_UNSEEN_MESSAGES_ONLY"):""},this),this.relevantInformationLastMoment=null}function rt(){this.iAccountId=0,this.bInitialized=i.observable(!1),this.expandFolders=i.observable(!1),this.expandNames=i.observableArray([]),this.collection=i.observableArray([]),this.options=i.observableArray([]),this.sNamespace="",this.sNamespaceFolder="",this.oStarredFolder=null,this.oNamedCollection={};var e=this,t=function(e){return function(t){t&&t.type(e)}},s=function(t){return{read:function(){return this.collection(),t()?t().fullName():""},write:function(e){t(this.getFolderByFullName(e))},owner:e}};this.currentFolder=i.observable(null),this.inboxFolder=i.observable(null),this.sentFolder=i.observable(null),this.draftsFolder=i.observable(null),this.spamFolder=i.observable(null),this.trashFolder=i.observable(null),this.countsCompletelyFilled=i.observable(!1),this.inboxFolder.subscribe(t(Ci.FolderTypes.User),this,"beforeChange"),this.sentFolder.subscribe(t(Ci.FolderTypes.User),this,"beforeChange"),this.draftsFolder.subscribe(t(Ci.FolderTypes.User),this,"beforeChange"),this.spamFolder.subscribe(t(Ci.FolderTypes.User),this,"beforeChange"),this.trashFolder.subscribe(t(Ci.FolderTypes.User),this,"beforeChange"),this.inboxFolder.subscribe(t(Ci.FolderTypes.Inbox)),this.sentFolder.subscribe(t(Ci.FolderTypes.Sent)),this.draftsFolder.subscribe(t(Ci.FolderTypes.Drafts)),this.spamFolder.subscribe(t(Ci.FolderTypes.Spam)),this.trashFolder.subscribe(t(Ci.FolderTypes.Trash)),this.inboxFolderFullName=i.computed(s(this.inboxFolder)),this.sentFolderFullName=i.computed(s(this.sentFolder)),this.draftsFolderFullName=i.computed(s(this.draftsFolder)),this.spamFolderFullName=i.computed(s(this.spamFolder)),this.trashFolderFullName=i.computed(s(this.trashFolder)),this.currentFolderFullName=i.computed(s(this.currentFolder)),this.currentFolderType=i.computed(function(){return this.currentFolder()?this.currentFolder().type():Ci.FolderTypes.User},this),this.delimiter=i.computed(function(){return this.inboxFolder()?this.inboxFolder().delimiter():""},this)}function at(){this.accountId=i.observable(Mi.Accounts.currentId()),this.folder=i.observable(""),this.uid=i.observable(""),this.subject=i.observable(""),this.emptySubject=i.computed(function(){return""===Ei.trim(this.subject())},this),this.subjectForDisplay=i.computed(function(){return this.emptySubject()?Ei.i18n("MAILBOX/EMPTY_SUBJECT"):this.subject()},this),this.messageId=i.observable(""),this.size=i.observable(0),this.friendlySize=i.computed(function(){return Ei.friendlySize(this.size())},this),this.textSize=i.observable(0),this.oDateModel=new tt,this.fullDate=i.observable(""),this.oFrom=new et,this.fullFrom=i.observable(""),this.oTo=new et,this.to=i.observable(""),this.fromOrToText=i.observable(""),this.oCc=new et,this.cc=i.observable(""),this.oBcc=new et,this.bcc=i.observable(""),this.oSender=new et,this.oReplyTo=new et,this.seen=i.observable(!1),this.flagged=i.observable(!1),this.partialFlagged=i.observable(!1),this.answered=i.observable(!1),this.forwarded=i.observable(!1),this.hasAttachments=i.observable(!1),this.hasIcalAttachment=i.observable(!1),this.hasVcardAttachment=i.observable(!1),this.showCalendarIcon=i.computed(function(){return Mi.User.AllowCalendar&&this.hasIcalAttachment()},this),this.folderObject=i.computed(function(){return Fi.MailCache.getFolderByFullName(this.accountId(),this.folder())},this),this.threadsAllowed=i.computed(function(){var e=this.folderObject(),t=e&&(e.type()===Ci.FolderTypes.Drafts||e.type()===Ci.FolderTypes.Spam||e.type()===Ci.FolderTypes.Trash);return Mi.User.useThreads()&&!t},this),this.otherSendersAllowed=i.computed(function(){var e=this.folderObject();return e&&e.type()!==Ci.FolderTypes.Drafts&&e.type()!==Ci.FolderTypes.Sent},this),this.threadPart=i.observable(!1),this.threadPart.subscribe(function(){this.threadPart()&&(this.partialFlagged(!1),this.threadSenders(!1))},this),this.threadParentUid=i.observable(""),this.threadUids=i.observableArray([]),this.threadSenders=i.observableArray([]),this.threadMoreSendersText=i.observable(""),this.threadSendersText=i.computed(function(){if(this.otherSendersAllowed()){var e=this.threadSenders();if(e.length>3)return this.threadMoreSendersText(Ei.i18n("MAILBOX/THREAD_MORE_SENDERS",{COUNT:e.length-1})),", "+e[0];if(this.threadMoreSendersText(""),e.length>0)return e.unshift(""),e.join(", ")}return""},this),this.threadSendersVisible=i.computed(function(){return this.threadSendersText().length>0},this),this.threadMoreSendersVisible=i.computed(function(){return this.threadMoreSendersText().length>0},this),this.threadCount=i.computed(function(){return this.threadUids().length},this),this.threadUnreadCount=i.observable(0),this.threadOpened=i.observable(!1),this.threadLoading=i.observable(!1),this.threadLoadingVisible=i.computed(function(){return this.threadsAllowed()&&this.threadOpened()&&this.threadLoading()},this),this.threadCountVisible=i.computed(function(){return this.threadsAllowed()&&this.threadCount()>0&&!this.threadLoading()},this),this.threadCountHint=i.computed(function(){return this.threadCount()>0?this.threadOpened()?Ei.i18n("MAILBOX/THREAD_TOOLTIP_FOLD"):this.threadUnreadCount()>0?Ei.i18n("MAILBOX/THREAD_TOOLTIP_HAS_UNSEEN_PLURAL",{},null,this.threadUnreadCount()):Ei.i18n("MAILBOX/THREAD_TOOLTIP_UNFOLD"):""},this),this.threadCountForLoad=i.observable(5),this.threadNextLoadingVisible=i.observable(!1),this.threadNextLoadingLinkVisible=i.observable(!1),this.threadFunctionLoadNext=null,this.threadShowAnimation=i.observable(!1),this.threadHideAnimation=i.observable(!1),this.importance=i.observable(Ci.Importance.Normal),this.draftInfo=i.observableArray([]),this.sensitivity=i.observable(Ci.Sensivity.Nothing),this.hash=i.observable(""),this.downloadLink=i.computed(function(){return this.hash().length>0?Ei.getDownloadLinkByHash(this.accountId(),this.hash()):""},this),this.completelyFilled=i.observable(!1),this.checked=i.observable(!1),this.checked.subscribe(function(e){if(!this.threadOpened()&&Fi.MailCache.useThreadsInCurrentList()){var t=Fi.MailCache.folderList().getFolderByFullName(this.folder());_.each(this.threadUids(),function(i){var s=t.oMessages[i];s&&s.checked(e)})}},this),this.selected=i.observable(!1),this.deleted=i.observable(!1),this.trimmed=i.observable(!1),this.trimmedTextSize=i.observable(0),this.inReplyTo=i.observable(""),this.references=i.observable(""),this.readingConfirmation=i.observable(""),this.isPlain=i.observable(!1),this.text=i.observable(""),this.textBodyForNewWindow=i.observable(""),this.$text=null,this.rtl=i.observable(!1),this.hasExternals=i.observable(!1),this.isExternalsShown=i.observable(!1),this.isExternalsAlwaysShown=i.observable(!1),this.foundedCids=i.observableArray([]),this.attachments=i.observableArray([]),this.usesAttachmentString=!1,this.allAttachmentsHash="",this.safety=i.observable(!1),this.sourceHeaders=i.observable(""),this.date=i.observable(""),this.ical=i.observable(null),this.vcard=i.observable(null),this.textRaw=i.observable(""),this.encryptedMessage=i.observable(!1),this.signedMessage=i.observable(!1),this.domMessageForPrint=i.observable(null),this.Custom={},Fi.nowMoment&&Fi.nowMoment.subscribe(function(){this.updateMomentDate()},this)}function lt(){this.resultCount=i.observable(-1),this.search=i.observable(""),this.filters=i.observable(""),this.collection=i.observableArray([]),this.threadUids={}}function ht(){this.uid=i.observable(""),this.file=i.observable(""),this.attendee=i.observable(""),this.type=i.observable(""),this.icalType=i.observable(""),this.icalConfig=i.observable(""),this.type.subscribe(function(){var e=this.type().split("-"),t=e.shift(),i=_.find(Ci.IcalType,function(e){return t===e},this),s=e.join("-"),o=_.find(Ci.IcalConfig,function(e){return s===e},this);t!==i&&(t=Ci.IcalType.Save),this.icalType(t),s!==o&&(s=Ci.IcalConfig.NeedsAction),this.icalConfig(s)},this),this.isRequestType=i.computed(function(){return this.icalType()===Ci.IcalType.Request},this),this.isCancelType=i.computed(function(){return this.icalType()===Ci.IcalType.Cancel},this),this.cancelDecision=i.observable(""),this.isReplyType=i.computed(function(){return this.icalType()===Ci.IcalType.Reply},this),this.replyDecision=i.observable(""),this.isSaveType=i.computed(function(){return this.icalType()===Ci.IcalType.Save},this),this.isJustSaved=i.observable(!1),this.fillDecisions(),this.isAccepted=i.computed(function(){return this.icalConfig()===Ci.IcalConfig.Accepted},this),this.isDeclined=i.computed(function(){return this.icalConfig()===Ci.IcalConfig.Declined},this),this.isTentative=i.computed(function(){return this.icalConfig()===Ci.IcalConfig.Tentative},this),this.location=i.observable(""),this.description=i.observable(""),this.when=i.observable(""),this.calendarId=i.observable(""),this.calendars=i.observableArray([]),Mi.SingleMode&&t.opener?(this.calendars(t.opener.App.CalendarCache.calendars()),t.opener.App.CalendarCache.calendars.subscribe(function(){this.calendars(t.opener.App.CalendarCache.calendars())},this)):(this.calendars(Fi.CalendarCache.calendars()),Fi.CalendarCache.calendars.subscribe(function(){this.calendars(Fi.CalendarCache.calendars())},this)),this.selectedCalendarId=i.observable(""),this.chosenCalendarName=i.computed(function(){var e=null;return""!==this.calendarId()&&(e=_.find(this.calendars(),function(e){return e.id===this.calendarId()},this)),e?e.name:""},this),this.calendarIsChosen=i.computed(function(){return""!==this.chosenCalendarName()},this),this.visibleCalendarDropdown=i.computed(function(){return!this.calendarIsChosen()&&this.calendars().length>1&&(this.isRequestType()||this.isSaveType())},this),this.visibleCalendarName=i.computed(function(){return this.calendarIsChosen()},this),this.visibleFirstCalendarName=i.computed(function(){return 1===this.calendars().length&&!this.calendarIsChosen()},this),this.visibleCalendarRow=i.computed(function(){return""!==this.attendee()&&(this.visibleCalendarDropdown()||this.visibleCalendarName()||this.visibleFirstCalendarName())},this),this.visibleRequestButtons=i.computed(function(){return this.isRequestType()&&""!==this.attendee()},this),this.animation=i.observable(!1)}function ct(){this.uid=i.observable(""),this.file=i.observable(""),this.name=i.observable(""),this.email=i.observable(""),this.isExists=i.observable(!1),this.isJustSaved=i.observable(!1)}function ut(){this.sEmailDefaultType=Ci.ContactEmailType.Personal,this.sPhoneDefaultType=Ci.ContactPhoneType.Mobile,this.sAddressDefaultType=Ci.ContactAddressType.Personal,this.voiceApp=null,Fi.Phone&&(this.voiceApp=Fi.Phone.voiceApp),this.idContact=i.observable(""),this.idUser=i.observable(""),this.global=i.observable(!1),this.itsMe=i.observable(!1),this.isNew=i.observable(!1),this.readOnly=i.observable(!1),this.edited=i.observable(!1),this.extented=i.observable(!1),this.personalCollapsed=i.observable(!1),this.businessCollapsed=i.observable(!1),this.otherCollapsed=i.observable(!1),this.groupsCollapsed=i.observable(!1),this.displayName=i.observable(""),this.firstName=i.observable(""),this.lastName=i.observable(""),this.nickName=i.observable(""),this.skype=i.observable(""),this.facebook=i.observable(""),this.displayNameFocused=i.observable(!1),this.primaryEmail=i.observable(this.sEmailDefaultType),this.primaryPhone=i.observable(this.sPhoneDefaultType),this.primaryAddress=i.observable(this.sAddressDefaultType),this.mainPrimaryEmail=i.computed({read:this.primaryEmail,write:function(e){this.primaryEmail(!Ei.isUnd(e)&&0<=Ei.inArray(e,[Ci.ContactEmailType.Personal,Ci.ContactEmailType.Business,Ci.ContactEmailType.Other])?e:Ci.ContactEmailType.Personal)},owner:this}),this.mainPrimaryPhone=i.computed({read:this.primaryPhone,write:function(e){this.primaryPhone(!Ei.isUnd(e)&&0<=Ei.inArray(e,[Ci.ContactPhoneType.Mobile,Ci.ContactPhoneType.Personal,Ci.ContactPhoneType.Business])?e:Ci.ContactPhoneType.Mobile)},owner:this}),this.mainPrimaryAddress=i.computed({read:this.primaryAddress,write:function(e){this.primaryAddress(!Ei.isUnd(e)&&0<=Ei.inArray(e,[Ci.ContactAddressType.Personal,Ci.ContactAddressType.Business])?e:Ci.ContactAddressType.Personal)},owner:this}),this.personalEmail=i.observable(""),this.personalStreetAddress=i.observable(""),this.personalCity=i.observable(""),this.personalState=i.observable(""),this.personalZipCode=i.observable(""),this.personalCountry=i.observable(""),this.personalWeb=i.observable(""),this.personalFax=i.observable(""),this.personalPhone=i.observable(""),this.personalMobile=i.observable(""),this.businessEmail=i.observable(""),this.businessCompany=i.observable(""),this.businessDepartment=i.observable(""),this.businessJob=i.observable(""),this.businessOffice=i.observable(""),this.businessStreetAddress=i.observable(""),this.businessCity=i.observable(""),this.businessState=i.observable(""),this.businessZipCode=i.observable(""),this.businessCountry=i.observable(""),this.businessWeb=i.observable(""),this.businessFax=i.observable(""),this.businessPhone=i.observable(""),this.otherEmail=i.observable(""),this.otherBirthdayMonth=i.observable("0"),this.otherBirthdayDay=i.observable("0"),this.otherBirthdayYear=i.observable("0"),this.otherNotes=i.observable(""),this.etag=i.observable(""),this.sharedToAll=i.observable(!1),this.birthdayIsEmpty=i.computed(function(){var e="0"===this.otherBirthdayMonth(),t="0"===this.otherBirthdayDay(),i="0"===this.otherBirthdayYear();return e||t||i},this),this.otherBirthday=i.computed(function(){var e="",t=Ei.pInt(this.otherBirthdayYear()),i=Ei.pInt(this.otherBirthdayMonth()),s=Ei.pInt(this.otherBirthdayDay()),o=new tt;if(!this.birthdayIsEmpty()){var n=moment().diff(moment(t+"/"+i+"/"+s,"YYYY/MM/DD"),"years"),r=Ei.i18n("CONTACTS/YEARS_TEXT_PLURAL",{COUNT:n},null,n);o.setDate(t,i>0?i-1:0,s),e=o.getShortDate()+" ("+r+")"}return e},this),this.groups=i.observableArray([]),this.groupsIsEmpty=i.computed(function(){return 0===this.groups().length},this),this.email=i.computed({read:function(){var e="";switch(this.primaryEmail()){case Ci.ContactEmailType.Personal:e=this.personalEmail();break;case Ci.ContactEmailType.Business:e=this.businessEmail();break;case Ci.ContactEmailType.Other:e=this.otherEmail()}return e},write:function(e){switch(this.primaryEmail()){case Ci.ContactEmailType.Personal:this.personalEmail(e);break;case Ci.ContactEmailType.Business:this.businessEmail(e);break;case Ci.ContactEmailType.Other:this.otherEmail(e);break;default:this.primaryEmail(this.sEmailDefaultType),this.email(e)}},owner:this}),this.personalIsEmpty=i.computed(function(){var e=this.personalEmail()!==this.email()?this.personalEmail():"";return""==""+e+this.personalStreetAddress()+this.personalCity()+this.personalState()+this.personalZipCode()+this.personalCountry()+this.personalWeb()+this.personalFax()+this.personalPhone()+this.personalMobile()},this),this.businessIsEmpty=i.computed(function(){var e=this.businessEmail()!==this.email()?this.businessEmail():"";return""==""+e+this.businessCompany()+this.businessDepartment()+this.businessJob()+this.businessOffice()+this.businessStreetAddress()+this.businessCity()+this.businessState()+this.businessZipCode()+this.businessCountry()+this.businessWeb()+this.businessFax()+this.businessPhone()},this),this.otherIsEmpty=i.computed(function(){var e=this.otherEmail()!==this.email()?this.otherEmail():"";return""==""+e+this.otherNotes()&&this.birthdayIsEmpty()},this),this.phone=i.computed({read:function(){var e="";switch(this.primaryPhone()){case Ci.ContactPhoneType.Mobile:e=this.personalMobile();break;case Ci.ContactPhoneType.Personal:e=this.personalPhone();break;case Ci.ContactPhoneType.Business:e=this.businessPhone()}return e},write:function(e){switch(this.primaryPhone()){case Ci.ContactPhoneType.Mobile:this.personalMobile(e);break;case Ci.ContactPhoneType.Personal:this.personalPhone(e);break;case Ci.ContactPhoneType.Business:this.businessPhone(e);break;default:this.primaryPhone(this.sEmailDefaultType),this.phone(e)}},owner:this}),this.address=i.computed({read:function(){var e="";switch(this.primaryAddress()){case Ci.ContactAddressType.Personal:e=this.personalStreetAddress();break;case Ci.ContactAddressType.Business:e=this.businessStreetAddress()}return e},write:function(e){switch(this.primaryAddress()){case Ci.ContactAddressType.Personal:this.personalStreetAddress(e);break;case Ci.ContactAddressType.Business:this.businessStreetAddress(e);break;default:this.primaryAddress(this.sEmailDefaultType),this.address(e)}},owner:this}),this.emails=i.computed(function(){var e=[];return""!==this.personalEmail()&&e.push({text:Ei.i18n("CONTACTS/OPTION_PERSONAL")+": "+this.personalEmail(),value:Ci.ContactEmailType.Personal}),""!==this.businessEmail()&&e.push({text:Ei.i18n("CONTACTS/OPTION_BUSINESS")+": "+this.businessEmail(),value:Ci.ContactEmailType.Business}),""!==this.otherEmail()&&e.push({text:Ei.i18n("CONTACTS/OPTION_OTHER")+": "+this.otherEmail(),value:Ci.ContactEmailType.Other}),e},this),this.phones=i.computed(function(){var e=[];return""!==this.personalMobile()&&e.push({text:Ei.i18n("CONTACTS/LABEL_MOBILE")+": "+this.personalMobile(),value:Ci.ContactPhoneType.Mobile}),""!==this.personalPhone()&&e.push({text:Ei.i18n("CONTACTS/OPTION_PERSONAL")+": "+this.personalPhone(),value:Ci.ContactPhoneType.Personal}),""!==this.businessPhone()&&e.push({text:Ei.i18n("CONTACTS/OPTION_BUSINESS")+": "+this.businessPhone(),value:Ci.ContactPhoneType.Business}),e},this),this.addresses=i.computed(function(){var e=[];return""!==this.personalStreetAddress()&&e.push({text:Ei.i18n("CONTACTS/OPTION_PERSONAL")+": "+this.personalStreetAddress(),value:Ci.ContactAddressType.Personal}),""!==this.businessStreetAddress()&&e.push({text:Ei.i18n("CONTACTS/OPTION_BUSINESS")+": "+this.businessStreetAddress(),value:Ci.ContactAddressType.Business}),e},this),this.hasEmails=i.computed(function(){return 0<this.emails().length},this),this.extented.subscribe(function(e){e&&(this.personalCollapsed(!this.personalIsEmpty()),this.businessCollapsed(!this.businessIsEmpty()),this.otherCollapsed(!this.otherIsEmpty()),this.groupsCollapsed(!this.groupsIsEmpty()))},this),this.birthdayMonthSelect=ut.birthdayMonthSelect,this.birthdayYearSelect=ut.birthdayYearSelect,this.birthdayDaySelect=i.computed(function(){for(var e=1,t=Ei.pInt(Ei.daysInMonth(this.otherBirthdayMonth(),this.otherBirthdayYear())),i="",s=[{text:Ei.i18n("DATETIME/DAY"),value:"0"}];t>=e;e++)i=e.toString(),s.push({text:i,value:i});return s},this);for(var e=new Date,t="",s=e.getFullYear(),o=1932;s>=o;s--)t=s.toString(),this.birthdayYearSelect.push({text:t,value:t});this.canBeSave=i.computed(function(){return""!==this.displayName()||!!this.emails().length},this),this.sendMailLink=i.computed(function(){return Pi?this.getSendMailLink(this.email()):"#"},this),this.sendMailToPersonalLink=i.computed(function(){return Pi?this.getSendMailLink(this.personalEmail()):"#"},this),this.sendMailToBusinessLink=i.computed(function(){return Pi?this.getSendMailLink(this.businessEmail()):"#"},this),this.sendMailToOtherLink=i.computed(function(){return Pi?this.getSendMailLink(this.otherEmail()):"#"},this)}function dt(){this.isNew=i.observable(!1),this.readOnly=i.observable(!1),this.idGroup=i.observable(""),this.idUser=i.observable(""),this.name=i.observable(""),this.isOrganization=i.observable(!1),this.email=i.observable(""),this.country=i.observable(""),this.city=i.observable(""),this.company=i.observable(""),this.fax=i.observable(""),this.phone=i.observable(""),this.state=i.observable(""),this.street=i.observable(""),this.web=i.observable(""),this.zip=i.observable(""),this.edited=i.observable(!1),this.nameFocused=i.observable(!1),this.canBeSave=i.computed(function(){return""!==this.name()},this),this.newContactsInGroupCount=i.observable(0),this.newContactsInGroupHint=i.computed(function(){var e=this.newContactsInGroupCount();return this.isNew()&&e>0?Ei.i18n("CONTACTS/CONTACT_ADD_TO_NEW_HINT_PLURAL",{COUNT:e},null,e):""},this),this.events=i.observableArray([])}function pt(){this.bIsGroup=!1,this.bIsOrganization=!1,this.bReadOnly=!1,this.bItsMe=!1,this.bGlobal=!1,this.sId="",this.sName="",this.sEmail="",this.bSharedToAll=!1,this.deleted=i.observable(!1),this.checked=i.observable(!1),this.selected=i.observable(!1),this.recivedAnim=i.observable(!1).extend({autoResetToFalse:500})}function mt(){this.id=0,this.cTag=0,this.name=i.observable(""),this.description=i.observable(""),this.owner=i.observable(""),this.isDefault=!1,this.isShared=i.observable(!1),this.isSharedToAll=i.observable(!1),this.sharedToAllAccess=Ci.CalendarAccess.Read,this.isPublic=i.observable(!1),this.url=i.observable(""),this.davUrl=i.observable(""),this.exportUrl=i.observable(""),this.pubUrl=i.observable(""),this.shares=i.observableArray([]),this.events=i.observableArray([]),this.eventsCount=i.computed(function(){return this.events().length},this),this.access=i.observable(Ci.CalendarAccess.Write),this.control=i.computed(function(){return!(this.access()===Ci.CalendarAccess.Read&&this.isSharedToAll())},this),this.color=i.observable(""),this.color.subscribe(function(){this.events(_.map(this.events(),function(e){return e.backgroundColor=e.borderColor=this.color(),e},this)),this.name.valueHasMutated()},this),this.active=i.observable(!0),this.startDateTime=0,this.endDateTime=0,this.account=Mi.Accounts?Mi.Accounts.getDefault():null}function gt(e){this.parentOnCalendarActiveChange=e.onCalendarActiveChange,this.parentOnCalendarCollectionChange=e.onCalendarCollectionChange,this.defaultCal=i.observable(null),this.currentCal=i.observable(null),this.collection=i.observableArray([]),this.collection.subscribe(function(){this.pickCurrentCalendar(this.defaultCal()),this.parentOnCalendarCollectionChange&&this.parentOnCalendarCollectionChange()},this),this.count=i.computed(function(){return this.collection().length},this),this.own=i.computed(function(){var e=_.filter(this.collection(),function(e){return!e.isShared()});return e},this),this.ownCount=i.computed(function(){return this.own().length},this),this.shared=i.computed(function(){var e=_.filter(this.collection(),function(e){return e.isShared()&&!e.isSharedToAll()});return e},this),this.sharedCount=i.computed(function(){return this.shared().length},this),this.sharedToAll=i.computed(function(){var e=_.filter(this.collection(),function(e){return e.isShared()&&e.isSharedToAll()});return e},this),this.sharedToAllCount=i.computed(function(){return this.sharedToAll().length},this),this.ids=i.computed(function(){return _.map(this.collection(),function(e){return e.id},this)},this)}function ft(){this.id=i.observable(""),this.fileName=i.observable(""),this.nameForEdit=i.observable(""),this.storageType=i.observable(Ci.FileStorageType.Personal),this.lastModified=i.observable(""),this.path=i.observable(""),this.fullPath=i.observable(""),this.publicHash=i.observable(""),this.selected=i.observable(!1),this.checked=i.observable(!1),this.isFolder=i.observable(!1),this.edited=i.observable(!1),this.isExternal=i.observable(!1),this.isLink=i.observable(!1),this.linkType=i.observable(0),this.linkUrl=i.observable(""),this.thumbnailExternalLink=i.observable(""),this.deleted=i.observable(!1),this.recivedAnim=i.observable(!1).extend({autoResetToFalse:500}),this.shared=i.observable(!1),this.owner=i.observable(""),this.ownerHeaderText=i.computed(function(){return Ei.i18n("FILESTORAGE/OWNER_HEADER_EMAIL",{OWNER:this.owner()})},this),this.lastModifiedHeaderText=i.computed(function(){return Ei.i18n("FILESTORAGE/OWNER_HEADER_LAST_MODIFIED_DATE_TEXT",{LASTMODIFIED:this.lastModified()})},this),st.call(this),this.fileName.subscribe(function(e){this.nameForEdit(e)},this),this.type=this.storageType,this.uploaded=i.observable(!0),this.downloadLink=i.computed(function(){return Ei.getFilestorageDownloadLinkByHash(Mi.Accounts?Mi.Accounts.currentId():null,this.hash(),this.publicHash())},this),this.viewLink=i.computed(function(){if(this.isLink())return this.linkUrl();var e=Ei.getFilestorageViewLinkByHash(Mi.Accounts?Mi.Accounts.currentId():null,this.hash(),this.publicHash());return this.iframedView()?Ei.getIframeWrappwer(Mi.Accounts?Mi.Accounts.currentId():null,e):e},this),this.isViewable=i.computed(function(){var e=!1,t=["JPEG","JPG","PNG","GIF","HTM","HTML","TXT","CSS","ASC","JS","PDF"];return _.indexOf(t,this.extension().toUpperCase())>=0&&(e=!0),(this.iframedView()||e||this.isLink())&&!this.isPopupItem()},this),this.visibleViewLink=this.isViewable,this.thumbnailLink=i.computed(function(){return this.isExternal()||this.isLink()&&this.linkType()===Ci.FileStorageLinkType.GoogleDrive?this.thumbnailExternalLink():this.thumb()?Ei.getFilestorageViewThumbnailLinkByHash(this.accountId(),this.hash(),this.publicHash()):""},this),this.edited.subscribe(function(e){e===!1&&this.nameForEdit(this.fileName())},this)}function bt(){this.Id=null,this.IdThread=null,this.IdOwner=null,this.sFrom="",this.sDate="",this.iDate=0,this.iType=null,this.bSysType=!1,this.bThreadOwner=null,this.sText="",this.collapsed=i.observable(!1),this.attachments=i.observableArray([]),this.allowDownloadAttachmentsLink=!0,this.itsMe=i.observable(!1),this.canBeDeleted=this.itsMe}function yt(){this.Id=null,this.ThreadHash="",this.IdOwner=null,this.ItsMe=!1,this.aOwner=[],this.sSubject="",this.sEmail="",this.sName="",this.sFrom="",this.sFromFull="",this.time=i.observable(0),this.state=i.observable(0),this.unseen=i.observable(!1),this.postsCount=i.observable(0),this.date=i.computed(function(){return moment(1e3*this.time()).fromNow(!1)},this),this.printableState=i.computed(function(){var e="",t=this.ItsMe?"_FOR_CLIENT":"";switch(this.state()){case Ci.HelpdeskThreadStates.Pending:e=Ei.i18n("HELPDESK/THREAD_STATE_PENDING"+t);break;case Ci.HelpdeskThreadStates.Resolved:e=Ei.i18n("HELPDESK/THREAD_STATE_RESOLVED"+t);break;case Ci.HelpdeskThreadStates.Waiting:e=Ei.i18n("HELPDESK/THREAD_STATE_WAITING"+t);break;case Ci.HelpdeskThreadStates.Answered:e=Ei.i18n("HELPDESK/THREAD_STATE_ANSWERED"+t);break;case Ci.HelpdeskThreadStates.Deferred:e=Ei.i18n("HELPDESK/THREAD_STATE_DEFERRED"+t)}return e},this),this.deleted=i.observable(!1),this.checked=i.observable(!1),this.selected=i.observable(!1)
}function St(){st.call(this),this.downloadLink=i.computed(function(){var e=!wi&&Mi&&Mi.Accounts?Mi.Accounts.currentId():0,t=wi&&Mi?Mi.TenantHash:"";return Ei.getDownloadLinkByHash(e,this.hash(),wi,t)},this),this.viewLink=i.computed(function(){var e=!wi&&Mi&&Mi.Accounts?Mi.Accounts.currentId():0,t=wi&&Mi?Mi.TenantHash:"";return Ei.getViewLinkByHash(e,this.hash(),wi,t)},this),this.thumbnailLink=i.computed(function(){var e=!wi&&Mi&&Mi.Accounts?Mi.Accounts.currentId():0,t=wi&&Mi?Mi.TenantHash:"",i=this.thumb()?Ei.getViewThumbnailLinkByHash(e,this.hash(),wi,t):"";return i},this)}function vt(){this.iAccountId=0,this.type=i.observable(!0),this.options=i.observable(0),this.signature=i.observable("")}function At(){this.iAccountId=0,this.enable=!1,this.subject="",this.message=""}function Ct(){this.FETCHER=!0,this.id=i.observable(0),this.accountId=i.observable(0),this.isEnabled=i.observable(!1),this.isLocked=i.observable(!1).extend({autoResetToFalse:1e3}),this.email=i.observable(""),this.userName=i.observable(""),this.folder=i.observable(""),this.signatureOptions=i.observable(!1),this.signature=i.observable(""),this.incomingMailServer=i.observable(""),this.incomingMailPort=i.observable(0),this.incomingMailLogin=i.observable(""),this.leaveMessagesOnServer=i.observable(""),this.isOutgoingEnabled=i.observable(!1),this.outgoingMailServer=i.observable(""),this.outgoingMailPort=i.observable(0),this.outgoingMailAuth=i.observable(!1),this.fullEmail=i.computed(function(){return""===this.userName()?this.email():this.userName()+" <"+this.email()+">"},this)}function Et(){this.accountId=0,this.collection=i.observableArray([])}function Tt(){this.iAccountId=0,this.enable=!1,this.email=""}function Ft(){this.iAccountId=0,this.collection=i.observableArray([])}function It(e){this.iAccountId=e,this.enable=i.observable(!0).extend({reversible:!0}),this.field=i.observable("").extend({reversible:!0}),this.condition=i.observable("").extend({reversible:!0}),this.filter=i.observable("").extend({reversible:!0}),this.action=i.observable("").extend({reversible:!0}),this.folder=i.observable("").extend({reversible:!0})}function Mt(){this.iAnimationDuration=500,this.iReportDuration=5e3,this.iErrorDuration=1e4,this.loadingMessage=i.observable(""),this.loadingHidden=i.observable(!0),this.loadingVisible=i.observable(!1),this.reportMessage=i.observable(""),this.reportHidden=i.observable(!0),this.reportVisible=i.observable(!1),this.reportVisibleClose=i.observable(!1),this.iReportTimeout=-1,this.errorMessage=i.observable(""),this.errorHidden=i.observable(!0),this.errorVisible=i.observable(!1),this.iErrorTimeout=-1,this.isHtmlError=i.observable(!1),this.gray=i.observable(!1)}function wt(){var e=this;this.mobileApp=Pi,this.mobileDevice=Ni,this.allowWebMail=Mi.App.AllowWebMail,this.currentAccountId=Mi.Accounts.currentId,this.currentAccountId.subscribe(function(){_.delay(function(){e.changeCurrentAccount()},300)},this),this.tabs=Fi.headerTabs,this.email=i.observable(""),this.accounts=Mi.Accounts.collection,this.currentTab=Fi.Screens.currentScreen,this.isMailboxTab=i.computed(function(){return this.currentTab()===Ci.Screens.Mailbox},this),this.helpdeskUnseenCount=Fi.helpdeskUnseenCount,this.helpdeskUnseenVisible=i.computed(function(){return this.currentTab()!==Ci.Screens.Helpdesk&&!!this.helpdeskUnseenCount()},this),this.helpdeskPendingCount=Fi.helpdeskPendingCount,this.helpdeskPendingVisible=i.computed(function(){return this.currentTab()!==Ci.Screens.Helpdesk&&!!this.helpdeskPendingCount()},this),this.mailUnseenCount=Fi.mailUnseenCount,this.mailUnseenVisible=i.computed(function(){return this.currentTab()!==Ci.Screens.Mailbox&&!!this.mailUnseenCount()},this),this.mailboxHash=Fi.Routing.lastMailboxHash,this.settingsHash=Fi.Routing.lastSettingsHash,this.contactsRecivedAnim=Fi.ContactsCache.recivedAnim,this.calendarRecivedAnim=Fi.CalendarCache.recivedAnim,this.appCustomLogo=i.observable(Mi.AppStyleImage||""),this.domMailHelperSmall=i.observable(null),this.domMailHelper=i.observable(null),this.mailHelperwidth=i.observable(null),i.computed(function(){var e=this,t=this.isMailboxTab()?this.domMailHelper():this.domMailHelperSmall();this.accounts(),this.email(),t&&_.delay(function(){0!==t.width()&&e.mailHelperwidth(t.outerWidth())},400)},this)}function Pt(){wt.call(this),this.oPhone=Fi.Phone?new Nt:null}function Rt(e,t){this.shown=!1,this.currentPage=i.observable(1),this.count=i.observable(e),this.perPage=i.observable(t),this.firstPage=i.observable(1),this.lastPage=i.observable(1),this.pagesCount=i.computed(function(){var e=Math.ceil(this.count()/this.perPage());return e>0?e:1},this),i.computed(function(){var e=20,t=4,i=this.pagesCount(),s=this.currentPage(),o=s,n=s;if(i>1)for(;;){if(e--,o>1&&(o--,t--),0===t)break;if(i>n&&(n++,t--),0===t)break;if(0===e)break}this.firstPage(o),this.lastPage(n)},this),this.visibleFirst=i.computed(function(){return this.firstPage()>1},this),this.visibleLast=i.computed(function(){return this.lastPage()<this.pagesCount()},this),this.clickPage=_.bind(this.clickPage,this),this.pages=i.computed(function(){var e=this.firstPage(),t=[];if(this.firstPage()<this.lastPage())for(;e<=this.lastPage();e++)t.push({number:e,current:e===this.currentPage(),clickFunc:this.clickPage});return t},this),this.hotKeysBind()}function Dt(e,s){this.mobileApp=Pi,this.oParent=s,this.creaId="creaId"+Math.random().toString().replace(".",""),this.textFocused=i.observable(!1),this.workareaDom=i.observable(),this.uploaderAreaDom=i.observable(),this.editorUploaderBodyDragOver=i.observable(!1),this.editorUploaderProgress=i.observable(!1),this.htmlEditorDom=i.observable(),this.colorPickerDropdownDom=i.observable(),this.insertLinkDropdownDom=i.observable(),this.insertImageDropdownDom=i.observable(),this.isEnable=i.observable(!0),this.isEnable.subscribe(function(){this.oCrea&&this.oCrea.setEditable(this.isEnable())},this),this.bInsertImageAsBase64=e,this.bAllowFileUpload=!(e&&void 0===t.File),this.allowInsertImage=i.observable(Mi.App.AllowInsertImage),this.lockFontSubscribing=i.observable(!1),this.bAllowImageDragAndDrop=!Fi.browser.ie10AndAbove,this.aFonts=["Arial","Arial Black","Courier New","Tahoma","Times New Roman","Verdana"],this.sDefaultFont=Mi.User.DefaultFontName,this.correctFontFromSettings(),this.selectedFont=i.observable(""),this.selectedFont.subscribe(function(){!this.oCrea||this.lockFontSubscribing()||this.inactive()||this.oCrea.fontName(this.selectedFont())},this),this.iDefaultSize=Mi.User.DefaultFontSize,this.selectedSize=i.observable(0),this.selectedSize.subscribe(function(){!this.oCrea||this.lockFontSubscribing()||this.inactive()||this.oCrea.fontSize(this.selectedSize())},this),this.visibleInsertLinkPopup=i.observable(!1),this.linkForInsert=i.observable(""),this.linkFocused=i.observable(!1),this.visibleLinkPopup=i.observable(!1),this.linkPopupTop=i.observable(0),this.linkPopupLeft=i.observable(0),this.linkHref=i.observable(""),this.visibleLinkHref=i.observable(!1),this.visibleImagePopup=i.observable(!1),this.visibleImagePopup.subscribe(function(){this.onImageOut()},this),this.imagePopupTop=i.observable(0),this.imagePopupLeft=i.observable(0),this.imageSelected=i.observable(!1),this.tooltipText=i.observable(""),this.tooltipPopupTop=i.observable(0),this.tooltipPopupLeft=i.observable(0),this.visibleInsertImagePopup=i.observable(!1),this.imageUploaderButton=i.observable(null),this.uploadedImagePathes=i.observableArray([]),this.imagePathFromWeb=i.observable(""),this.visibleFontColorPopup=i.observable(!1),this.oFontColorPicker=new _t(Ei.i18n("HTMLEDITOR/TEXT_COLOR_CAPTION"),this.setTextColorFromPopup,this),this.oBackColorPicker=new _t(Ei.i18n("HTMLEDITOR/BACKGROUND_COLOR_CAPTION"),this.setBackColorFromPopup,this),this.activitySource=i.observable(1),this.activitySourceSubscription=null,this.inactive=i.observable(!1),this.inactive.subscribe(function(){var e=this.removeAllTags(this.getText());this.inactive()?(""===e||"&nbsp;"===e)&&(this.setText('<span style="color: #AAAAAA;">'+Ei.i18n("HTMLEDITOR/SIGNATURE_PLACEHOLDER")+"</span>"),this.oCrea&&this.oCrea.setBlur()):e===Ei.i18n("HTMLEDITOR/SIGNATURE_PLACEHOLDER")&&this.setText("")},this),this.allowChangeInputDirection=Ei.isRTL()||Mi.User.AllowChangeInputDirection,this.disabled=i.observable(!1),this.textChanged=i.observable(!1)}function _t(e,t,s){this.aGreyColors=["rgb(0, 0, 0)","rgb(68, 68, 68)","rgb(102, 102, 102)","rgb(153, 153, 153)","rgb(204, 204, 204)","rgb(238, 238, 238)","rgb(243, 243, 243)","rgb(255, 255, 255)"],this.aBrightColors=["rgb(255, 0, 0)","rgb(255, 153, 0)","rgb(255, 255, 0)","rgb(0, 255, 0)","rgb(0, 255, 255)","rgb(0, 0, 255)","rgb(153, 0, 255)","rgb(255, 0, 255)"],this.aColorLines=[["rgb(244, 204, 204)","rgb(252, 229, 205)","rgb(255, 242, 204)","rgb(217, 234, 211)","rgb(208, 224, 227)","rgb(207, 226, 243)","rgb(217, 210, 233)","rgb(234, 209, 220)"],["rgb(234, 153, 153)","rgb(249, 203, 156)","rgb(255, 229, 153)","rgb(182, 215, 168)","rgb(162, 196, 201)","rgb(159, 197, 232)","rgb(180, 167, 214)","rgb(213, 166, 189)"],["rgb(224, 102, 102)","rgb(246, 178, 107)","rgb(255, 217, 102)","rgb(147, 196, 125)","rgb(118, 165, 175)","rgb(111, 168, 220)","rgb(142, 124, 195)","rgb(194, 123, 160)"],["rgb(204, 0, 0)","rgb(230, 145, 56)","rgb(241, 194, 50)","rgb(106, 168, 79)","rgb(69, 129, 142)","rgb(61, 133, 198)","rgb(103, 78, 167)","rgb(166, 77, 121)"],["rgb(153, 0, 0)","rgb(180, 95, 6)","rgb(191, 144, 0)","rgb(56, 118, 29)","rgb(19, 79, 92)","rgb(11, 83, 148)","rgb(53, 28, 117)","rgb(116, 27, 71)"],["rgb(102, 0, 0)","rgb(120, 63, 4)","rgb(127, 96, 0)","rgb(39, 78, 19)","rgb(12, 52, 61)","rgb(7, 55, 99)","rgb(32, 18, 77)","rgb(76, 17, 48)"]],this.caption=e,this.pickHandler=t,this.pickContext=s,this.colorPickerDom=i.observable(null)}function Nt(){this.phone=Fi.Phone,this.action=this.phone.action,this.report=this.phone.report,this.logs=i.observableArray([]),this.logsToShow=i.observableArray([]),this.spinner=i.observable(!0),this.tooltip=i.observable(Ei.i18n("PHONE/NOT_CONNECTED")),this.indicator=i.observable(Ei.i18n("PHONE/MISSED_CALLS")),this.dropdownShow=i.observable(!1),this.input=i.observable(""),this.input.subscribe(function(e){this.dropdownShow(""===e&&this.action()===Ci.PhoneAction.OnlineActive)},this),this.inputFocus=i.observable(!1),this.inputFocus.subscribe(function(e){e&&""===this.input()&&this.action()===Ci.PhoneAction.OnlineActive&&this.dropdownShow(!0)},this),this.phoneAutocompleteItem=i.observable(null),this.action.subscribe(function(e){switch(e){case Ci.PhoneAction.Offline:this.tooltip(Ei.i18n("PHONE/NOT_CONNECTED"));break;case Ci.PhoneAction.OfflineError:this.tooltip(Ei.i18n("Connection error"));break;case Ci.PhoneAction.OfflineInit:this.tooltip(Ei.i18n("PHONE/CONNECTING"));break;case Ci.PhoneAction.OfflineActive:break;case Ci.PhoneAction.Online:this.tooltip(Ei.i18n("PHONE/CONNECTED")),this.input(""),this.report(""),this.timer("stop");break;case Ci.PhoneAction.OnlineActive:break;case Ci.PhoneAction.Outgoing:this.timer("start");break;case Ci.PhoneAction.OutgoingConnect:this.tooltip(Ei.i18n("In Call"));break;case Ci.PhoneAction.Incoming:break;case Ci.PhoneAction.IncomingConnect:this.tooltip(Ei.i18n("In Call")),this.report(""),this.timer("start")}},this),e(document).on("click",_.bind(function(t){0===e(t.target).closest(".item.phone, .ui-autocomplete").length&&this.action()===Ci.PhoneAction.OnlineActive&&(this.action(Ci.PhoneAction.Online),this.dropdownShow(!1))},this))}function kt(){this.rtl=i.observable(Ei.isRTL()),this.allowRegistration=Mi.App.AllowRegistration,this.allowPasswordReset=Mi.App.AllowPasswordReset,this.oLoginViewModel=new Lt,this.allowRegistration&&(this.oRegisterViewModel=new xt),this.allowPasswordReset&&(this.oForgotViewModel=new Ot),this.gotoForgot=this.allowPasswordReset?this.oForgotViewModel.gotoForgot:i.observable(!1),this.gotoRegister=i.observable(!1),this.emailVisible=this.oLoginViewModel.emailVisible,this.loginVisible=this.oLoginViewModel.loginVisible,this.loginDescription=i.observable(Mi.App.LoginDescription||""),this.aLanguages=Mi.App.Languages,this.currentLanguage=i.observable(Mi.App.DefaultLanguage),this.allowLanguages=i.observable(Mi.App.AllowLanguageOnLogin),this.viewLanguagesAsDropdown=i.observable(!Mi.App.FlagsLangSelect),this.loginCustomLogo=i.observable(Mi.LoginStyleImage||""),Ii.runPluginHook&&Ii.runPluginHook("view-model-defined",[this.__name,this])}function Lt(){this.allowRegistration=Mi.App.AllowRegistration,this.allowPasswordReset=Mi.App.AllowPasswordReset,this.email=i.observable(""),this.login=i.observable(""),this.password=i.observable(""),this.emailFocus=i.observable(!1),this.loginFocus=i.observable(!1),this.passwordFocus=i.observable(!1),this.loading=i.observable(!1),this.changingLanguage=i.observable(!1),this.loginFocus.subscribe(function(e){e&&""===this.login()&&this.login(this.email())},this),this.loginFormType=i.observable(Mi.App.LoginFormType),this.loginAtDomainValue=i.observable(Mi.App.LoginAtDomainValue),this.loginAtDomainValueWithAt=i.computed(function(){var e=this.loginAtDomainValue();return""===e?"":"@"+e},this),this.emailVisible=i.computed(function(){return Ci.LoginFormType.Login!==this.loginFormType()},this),this.loginVisible=i.computed(function(){return Ci.LoginFormType.Email!==this.loginFormType()},this),this.signMeType=i.observable(Mi.App.LoginSignMeType),this.signMe=i.observable(Ci.LoginSignMeType.DefaultOn===this.signMeType()),this.signMeType.subscribe(function(){this.signMe(Ci.LoginSignMeType.DefaultOn===this.signMeType())},this),this.signMeFocused=i.observable(!1),this.emailDom=i.observable(null),this.loginDom=i.observable(null),this.passwordDom=i.observable(null),this.focusedField="",this.canBeLogin=i.computed(function(){return!this.loading()&&!this.changingLanguage()},this),this.signInButtonText=i.computed(function(){return Ei.i18n(this.loading()?"LOGIN/BUTTON_SIGNING_IN":"LOGIN/BUTTON_SIGN_IN")},this),this.loginCommand=Ei.createCommand(this,this.signIn,this.canBeLogin),this.email(Mi.App.DemoWebMailLogin||""),this.password(Mi.App.DemoWebMailPassword||""),Ii.runPluginHook&&Ii.runPluginHook("view-model-defined",[this.__name,this]),this.shake=i.observable(!1).extend({autoResetToFalse:800})}function Ot(){this.gotoForgot=i.observable(!1),this.gotoForgot.subscribe(function(){this.visibleEmailForm(!0),this.visibleQuestionForm(!1),this.visiblePasswordForm(!1)},this),this.visibleEmailForm=i.observable(!0),this.email=i.observable(""),this.emailFocus=i.observable(!1),this.gettingQuestion=i.observable(!1),this.getQuestionButtonText=i.computed(function(){return Ei.i18n(this.gettingQuestion()?"LOGIN/BUTTON_GETTING_QUESTION":"LOGIN/BUTTON_GET_QUESTION")},this),this.allowGetQuestion=i.computed(function(){return!this.gettingQuestion()&&""!==Ei.trim(this.email())},this),this.getQuestionCommand=Ei.createCommand(this,this.executeGetQuestion,this.allowGetQuestion),this.visibleQuestionForm=i.observable(!1),this.question=i.observable(""),this.answer=i.observable(""),this.answerFocus=i.observable(!1),this.validatingAnswer=i.observable(!1),this.validateAnswerButtonText=i.computed(function(){return Ei.i18n(this.validatingAnswer()?"LOGIN/BUTTON_VALIDATING_ANSWER":"LOGIN/BUTTON_VALIDATE_ANSWER")},this),this.allowValidatingAnswer=i.computed(function(){return!this.validatingAnswer()&&""!==Ei.trim(this.answer())},this),this.validateAnswerCommand=Ei.createCommand(this,this.executeValidateAnswer,this.allowValidatingAnswer),this.visiblePasswordForm=i.observable(!1),this.password=i.observable(""),this.confirmPassword=i.observable(""),this.passwordFocus=i.observable(!1),this.confirmPasswordFocus=i.observable(!1),this.changingPassword=i.observable(!1),this.changePasswordButtonText=i.computed(function(){return Ei.i18n(this.changingPassword()?"LOGIN/BUTTON_RESETTING_PASSWORD":"LOGIN/BUTTON_RESET_PASSWORD")},this),this.allowChangePassword=i.computed(function(){var e=Ei.trim(this.password()),t=Ei.trim(this.confirmPassword()),i=""===e||""===t;return!this.changingPassword()&&!i},this),this.changePasswordCommand=Ei.createCommand(this,this.executeChangePassword,this.allowChangePassword),Ii.runPluginHook&&Ii.runPluginHook("view-model-defined",[this.__name,this])}function xt(){this.name=i.observable(""),this.login=i.observable(""),this.password=i.observable(""),this.confirmPassword=i.observable(""),this.question=i.observable(""),this.yourQuestion=i.observable(""),this.answer=i.observable(""),this.allowQuestionPart=Ei.isNonEmptyArray(Mi.App.RegistrationQuestions),this.visibleYourQuestion=i.computed(function(){return this.question()===Ei.i18n("LOGIN/OPTION_YOUR_QUESTION")},this),this.nameFocus=i.observable(!1),this.loginFocus=i.observable(!1),this.passwordFocus=i.observable(!1),this.confirmPasswordFocus=i.observable(!1),this.questionFocus=i.observable(!1),this.answerFocus=i.observable(!1),this.yourQuestionFocus=i.observable(!1),this.domains=i.observable(Ei.isNonEmptyArray(Mi.App.RegistrationDomains)?Mi.App.RegistrationDomains:[]),this.domain=i.computed(function(){return 1===this.domains().length?this.domains()[0]:""},this),this.selectedDomain=i.observable(this.domains().length>0?this.domains()[0]:""),this.registrationQuestions=[],this.allowQuestionPart&&(this.registrationQuestions=_.map(_.union("",_.without(Mi.App.RegistrationQuestions,"*")),function(e){return{text:""!==e?e:Ei.i18n("LOGIN/LABEL_SELECT_QUESTION"),value:e}}),-1!==_.indexOf(Mi.App.RegistrationQuestions,"*")&&this.registrationQuestions.push({text:Ei.i18n("LOGIN/OPTION_YOUR_QUESTION"),value:Ei.i18n("LOGIN/OPTION_YOUR_QUESTION")})),this.loading=i.observable(!1),this.canBeRegister=i.computed(function(){var e=Ei.trim(this.login()),t=Ei.trim(this.password()),i=Ei.trim(this.confirmPassword()),s=Ei.trim(this.visibleYourQuestion()?this.yourQuestion():this.question()),o=Ei.trim(this.answer()),n=""===e||""===t||""===i||this.allowQuestionPart&&(""===s||""===o);return!this.loading()&&!n},this),this.registerButtonText=i.computed(function(){return Ei.i18n(this.loading()?"LOGIN/BUTTON_REGISTERING":"LOGIN/BUTTON_REGISTER")},this),this.registerCommand=Ei.createCommand(this,this.registerAccount,this.canBeRegister),Ii.runPluginHook&&Ii.runPluginHook("view-model-defined",[this.__name,this])}function Ut(){this.accounts=Mi.Accounts.collection,this.mobileApp=Pi,this.folderList=Fi.MailCache.folderList,this.manageFoldersHash=Fi.Routing.buildHashFromArray([Ci.Screens.Settings,Ci.SettingsTab.EmailAccounts,Ci.AccountSettingsTab.Folders]),this.quotaProc=i.observable(-1),this.quotaDesc=i.observable(""),i.computed(function(){if(!Mi.App||Mi.App&&!Mi.App.ShowQuotaBar)return!0;Fi.MailCache.quotaChangeTrigger();var e=Mi.Accounts.getCurrent(),t=e?e.quota():0,i=e?e.usedSpace():0,s=t>0?Math.ceil(i/t*100):-1;return s=s>100?100:s,this.quotaProc(s),this.quotaDesc(s>-1?Ei.i18n("MAILBOX/QUOTA_TOOLTIP",{PROC:s,QUOTA:Ei.friendlySize(1024*t)}):""),!0},this)}function Ht(e){this.isPublic=wi,this.uploaderArea=i.observable(null),this.bDragActive=i.observable(!1),this.bDragActiveComp=i.computed(function(){return this.bDragActive()},this),this.openMessageInNewWindowBinded=e,this.isFocused=i.observable(!1),this.messagesContainer=i.observable(null),this.searchInput=i.observable(""),this.searchInputFrom=i.observable(""),this.searchInputTo=i.observable(""),this.searchInputSubject=i.observable(""),this.searchInputText=i.observable(""),this.searchSpan=i.observable(""),this.highlightTrigger=i.observable(""),this.currentMessage=Fi.MailCache.currentMessage,this.currentMessage.subscribe(function(){this.isFocused(!1),this.selector.itemSelected(this.currentMessage())},this),this.folderList=Fi.MailCache.folderList,this.folderList.subscribe(this.onFolderListSubscribe,this),this.folderFullName=i.observable(""),this.folderType=i.observable(Ci.FolderTypes.User),this.filters=i.observable(""),this.uidList=Fi.MailCache.uidList,this.uidList.subscribe(function(){this.uidList().searchCountSubscription&&(this.uidList().searchCountSubscription.dispose(),this.uidList().searchCountSubscription=void 0),this.uidList().searchCountSubscription=this.uidList().resultCount.subscribe(function(){this.uidList().resultCount()>=0&&this.oPageSwitcher.setCount(this.uidList().resultCount())},this),this.uidList().resultCount()>=0&&this.oPageSwitcher.setCount(this.uidList().resultCount())},this),this.useThreads=i.computed(function(){var e=this.folderList().currentFolder(),t=e&&e.withoutThreads(),i=""===this.uidList().search()&&""===this.uidList().filters();return Mi.User.useThreads()&&!t&&i},this),this.collection=Fi.MailCache.messages,this._search=i.observable(""),this.search=i.computed({read:function(){return Ei.trim(this._search())},write:this._search,owner:this}),this.isEmptyList=i.computed(function(){return 0===this.collection().length},this),this.isNotEmptyList=i.computed(function(){return 0!==this.collection().length},this),this.isSearch=i.computed(function(){return this.search().length>0},this),this.isUnseenFilter=i.computed(function(){return this.filters()===Ci.FolderFilter.Unseen},this),this.isLoading=Fi.MailCache.messagesLoading,this.isError=Fi.MailCache.messagesLoadingError,this.visibleInfoLoading=i.computed(function(){return!this.isSearch()&&this.isLoading()},this),this.visibleInfoSearchLoading=i.computed(function(){return this.isSearch()&&this.isLoading()},this),this.visibleInfoSearchList=i.computed(function(){return this.isSearch()&&!this.isUnseenFilter()&&!this.isLoading()&&!this.isEmptyList()},this),this.visibleInfoMessageListEmpty=i.computed(function(){return!this.isLoading()&&!this.isSearch()&&""===this.filters()&&this.isEmptyList()&&!this.isError()},this),this.visibleInfoStarredFolderEmpty=i.computed(function(){return!this.isLoading()&&!this.isSearch()&&this.filters()===Ci.FolderFilter.Flagged&&this.isEmptyList()&&!this.isError()},this),this.visibleInfoSearchEmpty=i.computed(function(){return this.isSearch()&&!this.isUnseenFilter()&&this.isEmptyList()&&!this.isError()&&!this.isLoading()},this),this.visibleInfoMessageListError=i.computed(function(){return!this.isSearch()&&this.isError()},this),this.visibleInfoSearchError=i.computed(function(){return this.isSearch()&&this.isError()},this),this.visibleInfoUnseenFilterList=i.computed(function(){return this.isUnseenFilter()&&(this.isLoading()||!this.isEmptyList())},this),this.visibleInfoUnseenFilterEmpty=i.computed(function(){return this.isUnseenFilter()&&this.isEmptyList()&&!this.isError()&&!this.isLoading()},this),this.searchText=i.computed(function(){return Ei.i18n("MAILBOX/INFO_SEARCH_RESULT",{SEARCH:this.calculateSearchStringForDescription(),FOLDER:this.folderList().currentFolder()?this.folderList().currentFolder().displayName():""})},this),this.unseenFilterText=i.computed(function(){return""===this.search()?Ei.i18n("MAILBOX/INFO_UNSEEN_FILTER_RESULT",{FOLDER:this.folderList().currentFolder()?this.folderList().currentFolder().displayName():""}):Ei.i18n("MAILBOX/INFO_SEARCH_UNSEEN_FILTER_RESULT",{SEARCH:this.calculateSearchStringForDescription(),FOLDER:this.folderList().currentFolder()?this.folderList().currentFolder().displayName():""})},this),this.unseenFilterEmptyText=i.computed(function(){return Ei.i18n(""===this.search()?"MAILBOX/INFO_UNSEEN_FILTER_EMPTY":"MAILBOX/INFO_SEARCH_UNSEEN_FILTER_EMPTY")},this),this.isEnableGroupOperations=i.observable(!1).extend({throttle:250}),this.selector=new u(this.collection,_.bind(this.routeForMessage,this),_.bind(this.onDeletePress,this),_.bind(this.onMessageDblClick,this),_.bind(this.onEnterPress,this)),this.checkedUids=i.computed(function(){var e=this.selector.listChecked(),t=_.map(e,function(e){return e.uid()}),i=Fi.MailCache.folderList().currentFolder(),s=i?i.getThreadCheckedUidsFromList(e):[],o=_.union(t,s);return o},this),this.checkedOrSelectedUids=i.computed(function(){var e=this.checkedUids();return 0===e.length&&Fi.MailCache.currentMessage()&&!Fi.MailCache.currentMessage().deleted()&&(e=[Fi.MailCache.currentMessage().uid()]),e},this),i.computed(function(){this.isEnableGroupOperations(0<this.selector.listCheckedOrSelected().length)},this),this.checkAll=this.selector.koCheckAll(),this.checkAllIncomplite=this.selector.koCheckAllIncomplete(),this.pageSwitcherLocked=i.observable(!1),this.oPageSwitcher=new Rt(0,Mi.User.MailsPerPage),this.oPageSwitcher.currentPage.subscribe(function(e){var t=this.folderList().currentFolderFullName(),i=!Pi&&this.currentMessage()?this.currentMessage().uid():"",s=this.search();this.pageSwitcherLocked()||this.changeRoutingForMessageList(t,e,i,s,this.filters())},this),this.currentPage=i.observable(0),this.listChangedThrottle=Fi.browser.firefox||Fi.browser.ie?i.observable(!1).extend({throttle:10}):i.observable(!1),this.firstCompleteCollection=i.observable(!0),this.collection.subscribe(function(){this.collection().length>0&&this.firstCompleteCollection(!1)},this),this.currentAccountId=Mi.Accounts.currentId,this.listChanged=i.computed(function(){return[this.firstCompleteCollection(),this.currentAccountId(),this.folderFullName(),this.filters(),this.search(),this.oPageSwitcher.currentPage()]},this),this.listChanged.subscribe(function(){this.listChangedThrottle(!this.listChangedThrottle())},this),this.bAdvancedSearch=i.observable(!1),this.searchAttachmentsCheckbox=i.observable(!1),this.searchAttachments=i.observable(""),this.searchAttachments.subscribe(function(e){this.searchAttachmentsCheckbox(!!e)},this),this.panelTopDom=i.observable(null),this.extendedDom=i.observable(null),this.searchAttachmentsFocus=i.observable(!1),this.searchFromFocus=i.observable(!1),this.searchSubjectFocus=i.observable(!1),this.searchToFocus=i.observable(!1),this.searchTextFocus=i.observable(!1),this.searchTrigger=i.observable(null),this.searchDateStartFocus=i.observable(!1),this.searchDateEndFocus=i.observable(!1),this.searchDateStartDom=i.observable(null),this.searchDateStart=i.observable(""),this.searchDateEndDom=i.observable(null),this.searchDateEnd=i.observable(""),this.dateFormatDatePicker="yy.mm.dd",this.attachmentsPlaceholder=i.computed(function(){return Ei.i18n("MAILBOX/SEARCH_FIELD_HAS_ATTACHMENTS")},this),_.delay(_.bind(function(){this.createDatePickerObject(this.searchDateStartDom()),this.createDatePickerObject(this.searchDateEndDom())},this),1e3)}function Gt(e){this.openMessageInNewWindowBinded=e,this.singleMode=i.observable(Mi.SingleMode),this.isLoading=i.observable(!1),Fi.MailCache.folderList.subscribe(this.onFolderListSubscribe,this),this.messages=Fi.MailCache.messages,this.messages.subscribe(this.onMessagesSubscribe,this),this.currentMessage=Fi.MailCache.currentMessage,this.currentMessage.subscribe(this.onCurrentMessageSubscribe,this),Mi.User.defaultTimeFormat.subscribe(this.onCurrentMessageSubscribe,this),this.displayedMessageUid=i.observable(""),this.isCurrentMessage=i.computed(function(){return!!this.currentMessage()},this),this.isCurrentMessageLoaded=i.computed(function(){return this.isCurrentMessage()&&!this.isLoading()},this),this.visibleNoMessageSelectedText=i.computed(function(){return this.messages().length>0&&!this.isCurrentMessage()},this),this.prevMessageUid=Fi.MailCache.prevMessageUid,this.nextMessageUid=Fi.MailCache.nextMessageUid,this.isEnablePrevMessage=i.computed(function(){return"string"==typeof this.prevMessageUid()&&""!==this.prevMessageUid()},this),this.isEnableNextMessage=i.computed(function(){return"string"==typeof this.nextMessageUid()&&""!==this.nextMessageUid()},this),this.isEnableDelete=this.isCurrentMessage,this.isEnableReply=this.isCurrentMessageLoaded,this.isEnableReplyAll=this.isCurrentMessageLoaded,this.isEnableResend=this.isCurrentMessageLoaded,this.isEnableForward=this.isCurrentMessageLoaded,this.isEnablePrint=this.isCurrentMessageLoaded,this.isEnableSave=this.isCurrentMessage,this.allowSaveAsPdf=i.observable(!!Mi.AllowSaveAsPdf),this.isEnableSaveAsPdf=i.computed(function(){return this.isCurrentMessageLoaded()&&this.allowSaveAsPdf()},this),this.deleteCommand=Ei.createCommand(this,this.executeDeleteMessage,this.isEnableDelete),this.prevMessageCommand=Ei.createCommand(this,this.executePrevMessage,this.isEnablePrevMessage),this.nextMessageCommand=Ei.createCommand(this,this.executeNextMessage,this.isEnableNextMessage),this.replyCommand=Ei.createCommand(this,this.executeReply,this.isEnableReply),this.replyAllCommand=Ei.createCommand(this,this.executeReplyAll,this.isEnableReplyAll),this.resendCommand=Ei.createCommand(this,this.executeResend,this.isEnableResend),this.forwardCommand=Ei.createCommand(this,this.executeForward,this.isEnableForward),this.printCommand=Ei.createCommand(this,this.executePrint,this.isEnablePrint),this.saveCommand=Ei.createCommand(this,this.executeSave,this.isEnableSave),this.saveAsPdfCommand=Ei.createCommand(this,this.executeSaveAsPdf,this.isEnableSaveAsPdf),this.moreCommand=Ei.createCommand(this,null,this.isCurrentMessageLoaded),this.ical=i.observable(null),this.icalSubscription=this.ical.subscribe(function(){null!==this.ical()&&(Fi.CalendarCache.firstRequestCalendarList(),this.icalSubscription.dispose())},this),this.vcard=i.observable(null),this.processed=i.observable(!1),this.visiblePicturesControl=i.observable(!1),this.visibleShowPicturesLink=i.observable(!1),this.visibleAppointmentInfo=i.computed(function(){return null!==this.ical()},this),this.visibleVcardInfo=i.computed(function(){return null!==this.vcard()},this),this.sensitivityText=i.computed(function(){var e="";if(this.currentMessage())switch(this.currentMessage().sensitivity()){case Ci.Sensivity.Confidential:e=Ei.i18n("MESSAGE/SENSIVITY_CONFIDENTIAL");break;case Ci.Sensivity.Personal:e=Ei.i18n("MESSAGE/SENSIVITY_PERSONAL");break;case Ci.Sensivity.Private:e=Ei.i18n("MESSAGE/SENSIVITY_PRIVATE")}return e},this),this.visibleConfirmationControl=i.computed(function(){return this.currentMessage()&&""!==this.currentMessage().readingConfirmation()},this),this.isCurrentNotDraftOrSent=i.computed(function(){var e=Fi.MailCache.folderList().currentFolder();return e&&e.fullName().length>0&&e.type()!==Ci.FolderTypes.Drafts&&e.type()!==Ci.FolderTypes.Sent},this),this.isCurrentSentFolder=i.computed(function(){var e=Fi.MailCache.folderList().currentFolder();return e&&e.fullName().length>0&&e.type()===Ci.FolderTypes.Sent},this),this.isCurrentNotDraftFolder=i.computed(function(){var e=Fi.MailCache.folderList().currentFolder();return e&&e.fullName().length>0&&e.type()!==Ci.FolderTypes.Drafts},this),this.isVisibleReplyTool=this.isCurrentNotDraftOrSent,this.isVisibleResendTool=this.isCurrentSentFolder,this.isVisibleForwardTool=this.isCurrentNotDraftFolder,this.uid=i.observable(""),this.folder=i.observable(""),this.subject=i.observable(""),this.emptySubject=i.computed(function(){return""===Ei.trim(this.subject())},this),this.subjectForDisplay=i.computed(function(){return this.emptySubject()?Ei.i18n("MAILBOX/EMPTY_SUBJECT"):this.subject()},this),this.importance=i.observable(Ci.Importance.Normal),this.oFromAddr=i.observable(null),this.from=i.observable(""),this.fromEmail=i.observable(""),this.fullFrom=i.observable(""),this.to=i.observable(""),this.aToAddr=i.observableArray([]),this.cc=i.observable(""),this.aCcAddr=i.observableArray([]),this.bcc=i.observable(""),this.aBccAddr=i.observableArray([]),this.allRecipients=i.observable(""),this.aAllRecipients=i.observableArray([]),this.recipientsContacts=i.observableArray([]),this.currentAccountEmail=i.observable(),this.meSender=Ei.i18n("MESSAGE/ME_SENDER"),this.meRecipient=Ei.i18n("MESSAGE/ME_RECIPIENT"),this.fullDate=i.observable(""),this.midDate=i.observable(""),this.textBody=i.observable(""),this.textBodyForNewWindow=i.observable(""),this.domTextBody=i.observable(null),this.rtlMessage=i.observable(!1),this.contentHasFocus=i.observable(!1),this.decryptPassword=i.observable(""),this.visibleDecryptControl=i.observable(!1),this.visibleVerifyControl=i.observable(!1),this.fakeHeader=i.computed(function(){return!(this.visiblePicturesControl()||this.visibleConfirmationControl()||""!==this.sensitivityText()||this.visibleDecryptControl()||this.visibleVerifyControl())},this),this.mobileApp=Pi,this.attachments=i.observableArray([]),this.usesAttachmentString=!0,this.attachmentsInString=i.computed(function(){return _.map(this.attachments(),function(e){return e.fileName()
},this).join(", ")},this),this.notInlineAttachments=i.computed(function(){return _.filter(this.attachments(),function(e){return!e.linked()})},this),this.visibleDownloadAllAttachments=i.computed(function(){return Mi.ZipAttachments&&this.notInlineAttachments().length>1},this),this.visibleSaveAttachmentsToFiles=Mi.User.IsFilesSupported,this.visibleDownloadAllAttachmentsSeparately=i.computed(function(){return this.notInlineAttachments().length>1},this),this.visibleExtendedDownload=i.computed(function(){return!this.mobileApp&&(this.visibleDownloadAllAttachments()||this.visibleDownloadAllAttachmentsSeparately()||this.visibleSaveAttachmentsToFiles)},this),this.detailsVisible=i.observable(!1),this.detailsTooltip=i.computed(function(){return Ei.i18n(this.detailsVisible()?"MESSAGE/ACTION_HIDE_DETAILS":"MESSAGE/ACTION_SHOW_DETAILS")},this),this.hasNotInlineAttachments=i.computed(function(){return this.notInlineAttachments().length>0},this),this.hasBodyText=i.computed(function(){return this.textBody().length>0},this),this.visibleAddMenu=i.observable(!1),this.replyText=i.observable(""),this.replyTextFocus=i.observable(!1),this.replyPaneVisible=i.computed(function(){return this.currentMessage()&&this.currentMessage().completelyFilled()},this),this.replySendingStarted=i.observable(!1),this.replySavingStarted=i.observable(!1),this.replyAutoSavingStarted=i.observable(!1),this.requiresPostponedSending=i.observable(!1),this.replyAutoSavingStarted.subscribe(function(){!this.replyAutoSavingStarted()&&this.requiresPostponedSending()&&(Fi.MessageSender.sendPostponedMail(this.replyDraftUid()),this.requiresPostponedSending(!1))},this),i.computed(function(){(!this.replyTextFocus()||this.replyAutoSavingStarted()||this.replySavingStarted()||this.replySendingStarted())&&this.stopAutosaveTimer(),!this.replyTextFocus()||this.replyAutoSavingStarted()||this.replySavingStarted()||this.replySendingStarted()||this.startAutosaveTimer()},this),this.saveButtonText=i.computed(function(){return Ei.i18n(this.replyAutoSavingStarted()?"COMPOSE/TOOL_SAVING":"COMPOSE/TOOL_SAVE")},this),this.replyDraftUid=i.observable(""),this.replyLoadingText=i.computed(function(){return this.replySendingStarted()?Ei.i18n("COMPOSE/INFO_SENDING"):this.replySavingStarted()?Ei.i18n("COMPOSE/INFO_SAVING"):""},this),this.isEnableSendQuickReply=i.computed(function(){return this.isCurrentMessageLoaded()&&""!==this.replyText()&&!this.replySendingStarted()},this),this.isEnableSaveQuickReply=i.computed(function(){return this.isEnableSendQuickReply()&&!this.replySavingStarted()&&!this.replyAutoSavingStarted()},this),this.saveQuickReplyCommand=Ei.createCommand(this,this.executeSaveQuickReply,this.isEnableSaveQuickReply),this.sendQuickReplyCommand=Ei.createCommand(this,this.executeSendQuickReplyCommand,this.isEnableSendQuickReply),this.domMessageHeader=i.observable(null),this.domQuickReply=i.observable(null),this.domMessageForPrint=i.observable(null),this.replyTextFocusThrottled=i.observable(!1).extend({throttle:50}),this.replyTextFocus.subscribe(function(){this.replyTextFocusThrottled(this.replyTextFocus())},this),this.isQuickReplyActive=i.computed(function(){return this.replyText().length>0||this.replyTextFocusThrottled()},this),this.jqPanelHelper=null,this.visibleAttachments=i.observable(!1),this.showMessage=function(){this.visibleAttachments(!1)},this.showAttachments=function(){this.visibleAttachments(!0)},this.defaultFontName=Mi.User.DefaultFontName,Fi.nowMoment&&Fi.nowMoment.subscribe(function(){this.updateMomentDate()},this)}function Bt(){this.folderList=Fi.MailCache.folderList,this.domFolderList=i.observable(null),this.openMessageInNewWindowBinded=_.bind(this.openMessageInNewWindow,this),this.oFolderList=new Ut,this.oMessageList=new Ht(this.openMessageInNewWindowBinded),this.oMessagePane=new Gt(this.openMessageInNewWindowBinded),this.isEnableGroupOperations=this.oMessageList.isEnableGroupOperations,this.composeLink=i.observable(Fi.Routing.buildHashFromArray(Fi.Links.compose())),this.composeCommand=Ei.createCommand(this,this.executeCompose),this.checkMailCommand=Ei.createCommand(this,this.executeCheckMail),this.checkMailIndicator=i.observable(!0).extend({throttle:50}),i.computed(function(){this.checkMailIndicator(Fi.MailCache.checkMailStarted()||Fi.MailCache.messagesLoading())},this),this.markAsReadCommand=Ei.createCommand(this.oMessageList,this.oMessageList.executeMarkAsRead,this.isEnableGroupOperations),this.markAsUnreadCommand=Ei.createCommand(this.oMessageList,this.oMessageList.executeMarkAsUnread,this.isEnableGroupOperations),this.markAllReadCommand=Ei.createCommand(this.oMessageList,this.oMessageList.executeMarkAllRead),this.moveToFolderCommand=Ei.createCommand(this,Ei.emptyFunction,this.isEnableGroupOperations),this.deleteCommand=Ei.createCommand(this.oMessageList,this.oMessageList.executeDelete,this.isEnableGroupOperations),this.selectedCount=i.computed(function(){return this.oMessageList.checkedUids().length},this),this.emptyTrashCommand=Ei.createCommand(Fi.MailCache,Fi.MailCache.executeEmptyTrash,this.oMessageList.isNotEmptyList),this.emptySpamCommand=Ei.createCommand(Fi.MailCache,Fi.MailCache.executeEmptySpam,this.oMessageList.isNotEmptyList),this.spamCommand=Ei.createCommand(this.oMessageList,this.oMessageList.executeSpam,this.isEnableGroupOperations),this.notSpamCommand=Ei.createCommand(this.oMessageList,this.oMessageList.executeNotSpam,this.isEnableGroupOperations),this.bVisibleComposeMessage=Mi.User.AllowCompose,this.isVisibleReplyTool=i.computed(function(){return this.folderList().currentFolder()&&this.folderList().currentFolderFullName().length>0&&this.folderList().currentFolderType()!==Ci.FolderTypes.Drafts&&this.folderList().currentFolderType()!==Ci.FolderTypes.Sent},this),this.isVisibleForwardTool=i.computed(function(){return this.folderList().currentFolder()&&this.folderList().currentFolderFullName().length>0&&this.folderList().currentFolderType()!==Ci.FolderTypes.Drafts},this),this.isSpamFolder=i.computed(function(){return this.folderList().currentFolderType()===Ci.FolderTypes.Spam},this),this.allowedSpamAction=i.computed(function(){var e=Mi.Accounts.getCurrent();return e?e.extensionExists("AllowSpamFolderExtension")&&!this.isSpamFolder():!1},this),this.allowedNotSpamAction=i.computed(function(){var e=Mi.Accounts.getCurrent();return e?e.extensionExists("AllowSpamFolderExtension")&&this.isSpamFolder():!1},this),this.isTrashFolder=i.computed(function(){return this.folderList().currentFolderType()===Ci.FolderTypes.Trash},this),this.jqPanelHelper=null,this.mobileApp=Pi,this.selectedPanel=i.observable(Ci.MobilePanel.Items),Fi.MailCache.currentMessage.subscribe(function(){this.gotoMessagePane()},this)}function jt(){var s=this;this.toAddrDom=i.observable(),this.toAddrDom.subscribe(function(){this.initInputosaurus(this.toAddrDom,this.toAddr,this.lockToAddr,"to")},this),this.ccAddrDom=i.observable(),this.ccAddrDom.subscribe(function(){this.initInputosaurus(this.ccAddrDom,this.ccAddr,this.lockCcAddr,"cc")},this),this.bccAddrDom=i.observable(),this.bccAddrDom.subscribe(function(){this.initInputosaurus(this.bccAddrDom,this.bccAddr,this.lockBccAddr,"bcc")},this),this.folderList=Fi.MailCache.folderList,this.folderList.subscribe(function(){this.getMessageOnRoute()},this),this.singleMode=i.observable(Mi.SingleMode),this.isDemo=i.observable(Mi.User.IsDemo),this.sending=i.observable(!1),this.sending.subscribe(this.sendingAndSavingSubscription,this),this.saving=i.observable(!1),this.saving.subscribe(this.sendingAndSavingSubscription,this),this.oHtmlEditor=new Dt(!1,this),this.textFocused=this.oHtmlEditor.textFocused,this.visibleBcc=i.observable(!1),this.visibleBcc.subscribe(function(){Ri.toggleClass("screen-compose-bcc",this.visibleCc()),_.defer(_.bind(function(){e(this.bccAddrDom()).inputosaurus("resizeInput")},this))},this),this.visibleCc=i.observable(!1),this.visibleCc.subscribe(function(){Ri.toggleClass("screen-compose-cc",this.visibleCc()),_.defer(_.bind(function(){e(this.ccAddrDom()).inputosaurus("resizeInput")},this))},this),this.visibleCounter=i.observable(!1),this.readingConfirmation=i.observable(!1),this.saveMailInSentItems=i.observable(!0),this.useSaveMailInSentItems=i.observable(!1),this.composeUploaderButton=i.observable(null),this.composeUploaderButton.subscribe(function(){this.initUploader()},this),this.composeUploaderDropPlace=i.observable(null),this.composeUploaderBodyDragOver=i.observable(!1),this.composeUploaderDragOver=i.observable(!1),this.allowDragNDrop=i.observable(!1),this.uploaderBodyDragOver=i.computed(function(){return this.allowDragNDrop()&&this.composeUploaderBodyDragOver()},this),this.uploaderDragOver=i.computed(function(){return this.allowDragNDrop()&&this.composeUploaderDragOver()},this),this.selectedImportance=i.observable(Ci.Importance.Normal),this.selectedSensitivity=i.observable(Ci.Sensivity.Nothing),this.oSenderSelector=new Vt,this.senderAccountId=this.oSenderSelector.senderAccountId,this.senderList=this.oSenderSelector.senderList,this.visibleFrom=i.computed(function(){return this.senderList().length>1},this),this.selectedSender=this.oSenderSelector.selectedSender,this.selectedFetcherOrIdentity=this.oSenderSelector.selectedFetcherOrIdentity,this.selectedFetcherOrIdentity.subscribe(function(){this.oHtmlEditor.isEditing()||this.oHtmlEditor.clearUndoRedo()},this),this.signature=i.observable(""),this.prevSignature=i.observable(null),i.computed(function(){var e=Fi.MessageSender.getClearSignature(this.senderAccountId(),this.selectedFetcherOrIdentity());null===this.prevSignature()?(this.prevSignature(e),this.signature(e)):(this.prevSignature(this.signature()),this.signature(e),this.oHtmlEditor.changeSignatureContent(this.signature(),this.prevSignature()))},this),this.lockToAddr=i.observable(!1),this.toAddr=i.observable("").extend({reversible:!0}),this.toAddr.subscribe(function(){this.lockToAddr()||(e(this.toAddrDom()).val(this.toAddr()),e(this.toAddrDom()).inputosaurus("refresh"))},this),this.lockCcAddr=i.observable(!1),this.ccAddr=i.observable("").extend({reversible:!0}),this.ccAddr.subscribe(function(){this.lockCcAddr()||(e(this.ccAddrDom()).val(this.ccAddr()),e(this.ccAddrDom()).inputosaurus("refresh"))},this),this.lockBccAddr=i.observable(!1),this.bccAddr=i.observable("").extend({reversible:!0}),this.bccAddr.subscribe(function(){this.lockBccAddr()||(e(this.bccAddrDom()).val(this.bccAddr()),e(this.bccAddrDom()).inputosaurus("refresh"))},this),this.recipientEmails=i.computed(function(){var e=[this.toAddr(),this.ccAddr(),this.bccAddr()].join(",").split(","),t=[];return _.each(e,function(e){var i=Ei.trim(e),s=null;""!==i&&(s=Ei.getEmailParts(i),s.email&&t.push(s.email))}),t},this),this.subject=i.observable("").extend({reversible:!0}),this.counter=i.observable(0),this.plainText=i.observable(!1),this.textBody=i.observable(""),this.textBody.subscribe(function(){this.oHtmlEditor.setText(this.textBody(),this.plainText()),this.oHtmlEditor.commit()},this),this.focusedField=i.observable(),this.textFocused.subscribe(function(){this.textFocused()&&this.focusedField("text")},this),this.subjectFocused=i.observable(!1),this.subjectFocused.subscribe(function(){this.subjectFocused()&&this.focusedField("subject")},this),this.draftUid=i.observable(""),this.draftUid.subscribe(function(){Fi.MailCache.editedDraftUid(this.draftUid())},this),this.draftInfo=i.observableArray([]),this.routeType=i.observable(""),this.routeParams=i.observableArray([]),this.inReplyTo=i.observable(""),this.references=i.observable(""),this.bUploadStatus=!1,this.iUploadAttachmentsTimer=0,this.messageUploadAttachmentsStarted=i.observable(!1),this.messageUploadAttachmentsStarted.subscribe(function(e){t.clearTimeout(s.iUploadAttachmentsTimer),e?s.iUploadAttachmentsTimer=t.setTimeout(function(){s.bUploadStatus=!0,Fi.Api.showLoading(Ei.i18n("COMPOSE/INFO_ATTACHMENTS_LOADING"))},4e3):s.bUploadStatus?s.iUploadAttachmentsTimer=t.setTimeout(function(){s.bUploadStatus=!1,Fi.Api.hideLoading()},1e3):Fi.Api.hideLoading()},this),this.attachments=i.observableArray([]),this.attachmentsChanged=i.observable(!1),this.attachments.subscribe(function(){this.attachmentsChanged(!0)},this),this.notUploadedAttachments=i.computed(function(){return _.filter(this.attachments(),function(e){return!e.uploaded()})},this),this.allAttachmentsUploaded=i.computed(function(){return 0===this.notUploadedAttachments().length&&!this.messageUploadAttachmentsStarted()},this),this.notInlineAttachments=i.computed(function(){return _.filter(this.attachments(),function(e){return!e.linked()})},this),this.notInlineAttachments.subscribe(function(){Ri.toggleClass("screen-compose-attachments",this.notInlineAttachments().length>0)},this),this.allowStartSending=i.computed(function(){return!this.saving()},this),this.allowStartSending.subscribe(function(){this.allowStartSending()&&this.requiresPostponedSending()&&(Fi.MessageSender.sendPostponedMail(this.draftUid()),this.requiresPostponedSending(!1))},this),this.requiresPostponedSending=i.observable(!1),this.oJua=null,this.isDraftsCleared=i.observable(!1),this.autoSaveTimer=-1,this.shown=i.observable(!1),this.shown.subscribe(function(){this.shown()||this.stopAutosaveTimer()},this),this.backToListOnSendOrSave=i.observable(!1),this.enableOpenPgp=Mi.User.enableOpenPgp,this.pgpSecured=i.observable(!1),this.pgpSecured.subscribe(function(){this.oHtmlEditor.disabled(this.pgpSecured())},this),this.pgpEncrypted=i.observable(!1),this.fromDrafts=i.observable(!1),this.visibleDoPgpButton=i.computed(function(){return this.enableOpenPgp()&&(!this.pgpSecured()||this.pgpEncrypted()&&this.fromDrafts())},this),this.visibleUndoPgpButton=i.computed(function(){return this.enableOpenPgp()&&this.pgpSecured()&&(!this.pgpEncrypted()||!this.fromDrafts())},this),this.isEnableOpenPgpCommand=i.computed(function(){return this.enableOpenPgp()&&!this.pgpSecured()},this),this.backToListCommand=Ei.createCommand(this,this.executeBackToList),this.sendCommand=Ei.createCommand(this,this.executeSend,this.isEnableSending),this.saveCommand=Ei.createCommand(this,this.executeSaveCommand,this.isEnableSaving),this.openPgpCommand=Ei.createCommand(this,this.confirmOpenPgp,this.isEnableOpenPgpCommand),this.messageFields=i.observable(null),this.bottomPanel=i.observable(null),this.mobileApp=Pi,this.showHotkeysHints=!Ni&&!Pi,this.aHotkeys=[{value:"Ctrl+Enter",action:Ei.i18n("COMPOSE/HOTKEY_SEND")},{value:"Ctrl+S",action:Ei.i18n("COMPOSE/HOTKEY_SAVE")},{value:"Ctrl+Z",action:Ei.i18n("COMPOSE/HOTKEY_UNDO")},{value:"Ctrl+Y",action:Ei.i18n("COMPOSE/HOTKEY_REDO")},{value:"Ctrl+K",action:Ei.i18n("COMPOSE/HOTKEY_LINK")},{value:"Ctrl+B",action:Ei.i18n("COMPOSE/HOTKEY_BOLD")},{value:"Ctrl+I",action:Ei.i18n("COMPOSE/HOTKEY_ITALIC")},{value:"Ctrl+U",action:Ei.i18n("COMPOSE/HOTKEY_UNDERLINE")}],this.allowFiles=i.observable(!1),this.dropboxConnected=i.observable(!1),this.allowDropbox=i.computed(function(){return Mi.SocialDropbox&&this.dropboxConnected()},this),this.dropboxKey=Mi.SocialDropboxKey,this.googleConnected=i.observable(!1),this.allowGoogle=i.computed(function(){return Mi.SocialGoogle&&this.googleConnected()},this),this.closeBecauseSingleCompose=i.observable(!1),this.changedInPreviousWindow=i.observable(!1),this.minHeightAdjustTrigger=i.observable(!1).extend({autoResetToFalse:105}),this.minHeightRemoveTrigger=i.observable(!1).extend({autoResetToFalse:105}),this.jqContainers=e(".pSevenMain:first, .popup.compose_popup"),i.computed(function(){this.minHeightAdjustTrigger(),this.minHeightRemoveTrigger(),_.delay(function(){e(".compose_popup .panel_content .panels").trigger("resize")},200)},this),this.hasSomethingToSave=i.computed(function(){return this.isChanged()&&this.isEnableSaving()},this),this.saveAndCloseTooltip=i.computed(function(){return Ei.i18n(this.hasSomethingToSave()?"COMPOSE/TOOL_SAVE_CLOSE":"COMPOSE/TOOL_CLOSE")},this),t.opener&&setTimeout(function(){t.onbeforeunload=function(){return s.hasSomethingToSave()?(s.beforeHide(t.close),""):void 0}},1e3),this.splitterDom=i.observable()}function Vt(){this.senderList=i.observableArray([]),this.senderAccountId=i.observable(Mi.Accounts.currentId()),this.selectedFetcherOrIdentity=i.observable(null),this.lockSelectedSender=i.observable(!1),this.selectedSender=i.observable(""),this.selectedSender.subscribe(function(){if(!this.lockSelectedSender()){var e=Mi.Accounts.getAccount(this.senderAccountId()),t=this.selectedSender(),i=null;0===t.indexOf("fetcher")?e.fetchers()&&(t=t.replace("fetcher",""),i=_.find(e.fetchers().collection(),function(e){return e.id()===Ei.pInt(t)})):i=_.find(e.identities(),function(e){return e.id()===Ei.pInt(t)}),i&&this.selectedFetcherOrIdentity(i)}},this)}function Kt(){jt.call(this),this.minimized=i.observable(!1),this.minimizedTitle=i.computed(function(){return this.subject()||Ei.i18n("COMPOSE/TITLE_MINIMIZED_NEW_MESSAGE")},this)}function Wt(e){this.oJua=null,this.oParent=e,this.visibility=i.observable(!1),this.importing=i.observable(!1)}function qt(){this.isPublic=wi,this.uploaderArea=i.observable(null),this.bDragActive=i.observable(!1),this.bDragActiveComp=i.computed(function(){return this.bDragActive()},this),this.importingHelpLink=Fi.getHelpLink("ImportingContacts"),this.allowWebMail=Mi.App.AllowWebMail,this.loadingList=i.observable(!1),this.preLoadingList=i.observable(!1),this.loadingList.subscribe(function(e){this.preLoadingList(e)},this),this.loadingViewPane=i.observable(!1),this.showPersonalContacts=i.observable(!1),this.showGlobalContacts=i.observable(!1),this.showSharedToAllContacts=i.observable(!1),this.showAllContacts=i.computed(function(){return 1<[this.showPersonalContacts()?"1":"",this.showGlobalContacts()?"1":"",this.showSharedToAllContacts()?"1":""].join("").length},this),this.recivedAnimShare=i.observable(!1).extend({autoResetToFalse:500}),this.recivedAnimUnshare=i.observable(!1).extend({autoResetToFalse:500}),this.isGlobalGroupSelect=i.observable(!0),this.isAllOrSubOrGlobalGroupSelect=i.observable(!0),this.selectedGroupType=i.observable(Ci.ContactsGroupListType.Personal),this.selectedGroupType.subscribe(function(e){this.isGlobalGroupSelect(e===Ci.ContactsGroupListType.Global),this.isAllOrSubOrGlobalGroupSelect(e===Ci.ContactsGroupListType.SubGroup||e===Ci.ContactsGroupListType.Global||e===Ci.ContactsGroupListType.All)},this),this.selectedGroupInList=i.observable(null),this.selectedGroupInList.subscribe(function(){var e=this.selectedGroupInList();e&&e.selected(!1)},this,"beforeChange"),this.selectedGroupInList.subscribe(function(e){e&&this.showPersonalContacts()&&(e.selected(!0),this.selectedGroupType(Ci.ContactsGroupListType.SubGroup),this.requestContactList())},this),this.selectedGroup=i.observable(null),this.selectedContact=i.observable(null),this.selectedGroupContactsList=i.observable(null),this.currentGroupId=i.observable(0),this.oContactModel=new ut,this.oGroupModel=new dt,this.oContactImportViewModel=new Wt(this),this.selectedOldItem=i.observable(null),this.selectedItem=i.computed({read:function(){return this.selectedContact()||this.selectedGroup()||null},write:function(e){e instanceof ut?(this.oContactImportViewModel.visibility(!1),this.selectedGroup(null),this.selectedContact(e)):e instanceof dt?(this.oContactImportViewModel.visibility(!1),this.selectedContact(null),this.selectedGroup(e),this.currentGroupId(e.idGroup())):(this.selectedGroup(null),this.selectedContact(null)),this.loadingViewPane(!1)},owner:this}),this.sortOrder=i.observable(!0),this.sortType=i.observable(Ci.ContactSortType.Name),this.collection=i.observableArray([]),this.contactUidForRequest=i.observable(""),this.collection.subscribe(function(){this.collection().length>0&&""!==this.contactUidForRequest()&&(this.requestContact(this.contactUidForRequest()),this.contactUidForRequest(""))},this),this.isSearchFocused=i.observable(!1),this.searchInput=i.observable(""),this.search=i.observable(""),this.groupFullCollection=i.observableArray([]),this.selectedContact.subscribe(function(e){if(e){var t=e.groups();_.each(this.groupFullCollection(),function(e){e.checked(e&&0<=Ei.inArray(e.Id(),t))})}},this),this.selectedGroupType.subscribe(function(e){Ci.ContactsGroupListType.All!==e||this.showAllContacts()?Ci.ContactsGroupListType.Personal===e&&!this.showPersonalContacts()&&this.showGlobalContacts()?this.selectedGroupType(Ci.ContactsGroupListType.Global):Ci.ContactsGroupListType.Global===e&&!this.showGlobalContacts()&&this.showPersonalContacts()?this.selectedGroupType(Ci.ContactsGroupListType.Personal):(Ci.ContactsGroupListType.Personal===e||Ci.ContactsGroupListType.Global===e||Ci.ContactsGroupListType.SharedToAll===e||Ci.ContactsGroupListType.All===e)&&(this.selectedGroupInList(null),this.selectedItem(null),this.selector.listCheckedOrSelected(!1),this.requestContactList()):this.selectedGroupType(Ci.ContactsGroupListType.Personal)},this),this.pageSwitcherLocked=i.observable(!1),this.oPageSwitcher=new Rt(0,Mi.User.ContactsPerPage),this.oPageSwitcher.currentPage.subscribe(function(){var e=this.selectedGroupType(),t=e===Ci.ContactsGroupListType.SubGroup?this.currentGroupId():"";this.pageSwitcherLocked()||Fi.Routing.setHash(Fi.Links.contacts(e,t,this.search(),this.oPageSwitcher.currentPage()))},this),this.currentPage=i.observable(1),this.search.subscribe(function(e){this.searchInput(e)},this),this.searchSubmitCommand=Ei.createCommand(this,function(){var e=this.selectedGroupType(),t=e===Ci.ContactsGroupListType.SubGroup?this.currentGroupId():"";Fi.Routing.setHash(Fi.Links.contacts(e,t,this.searchInput()))}),this.selector=new u(this.collection,_.bind(function(e){if(e){var t=this.selectedGroupType(),i=t===Ci.ContactsGroupListType.SubGroup?this.currentGroupId():"";Fi.Routing.setHash(Fi.Links.contacts(t,i,this.search(),this.oPageSwitcher.currentPage(),e.sId))}},this),_.bind(this.executeDelete,this),_.bind(this.onContactDblClick,this)),this.checkAll=this.selector.koCheckAll(),this.checkAllIncomplite=this.selector.koCheckAllIncomplete(),this.allowContactsSharing=!!Mi.App.AllowContactsSharing,this.isCheckedOrSelected=i.computed(function(){return 0<this.selector.listCheckedOrSelected().length},this),this.isEnableAddContacts=this.isCheckedOrSelected,this.isEnableRemoveContactsFromGroup=this.isCheckedOrSelected,this.isEnableDeleting=this.isCheckedOrSelected,this.isEnableSharing=this.isCheckedOrSelected,this.visibleShareCommand=i.computed(function(){return this.showPersonalContacts()&&this.showSharedToAllContacts()&&this.selectedGroupType()===Ci.ContactsGroupListType.Personal},this),this.visibleUnshareCommand=i.computed(function(){return this.showPersonalContacts()&&this.showSharedToAllContacts()&&this.selectedGroupType()===Ci.ContactsGroupListType.SharedToAll},this),this.isSelectedGroupTypeNotGlobal=i.computed(function(){return this.selectedGroupType()!==Ci.ContactsGroupListType.Global},this),this.newContactCommand=Ei.createCommand(this,this.executeNewContact,this.isSelectedGroupTypeNotGlobal),this.newGroupCommand=Ei.createCommand(this,this.executeNewGroup),this.addContactsCommand=Ei.createCommand(this,Ei.emptyFunction,this.isEnableAddContacts),this.deleteCommand=Ei.createCommand(this,this.executeDelete,this.isEnableDeleting),this.shareCommand=Ei.createCommand(this,this.executeShare,this.isEnableSharing),this.removeFromGroupCommand=Ei.createCommand(this,this.executeRemoveFromGroup,this.isEnableRemoveContactsFromGroup),this.importCommand=Ei.createCommand(this,this.executeImport),this.exportCSVCommand=Ei.createCommand(this,this.executeCSVExport),this.exportVCFCommand=Ei.createCommand(this,this.executeVCFExport),this.saveCommand=Ei.createCommand(this,this.executeSave),this.updateSharedToAllCommand=Ei.createCommand(this,this.executeUpdateSharedToAll,function(){return 1===this.selector.listCheckedOrSelected().length}),this.newMessageCommand=Ei.createCommand(this,function(){var e=this.selector.listCheckedOrSelected(),t=[];_.isArray(e)&&0<e.length&&(t=_.map(e,function(e){return e.EmailAndName()}),t=_.compact(t),Fi.Api.composeMessageToAddresses(t.join(", ")))},function(){return 0<this.selector.listCheckedOrSelected().length}),this.selector.listCheckedOrSelected.subscribe(function(e){this.oGroupModel.newContactsInGroupCount(e.length)},this),this.isSearch=i.computed(function(){return""!==this.search()},this),this.isEmptyList=i.computed(function(){return 0===this.collection().length},this),this.inGroup=i.computed(function(){return Ci.ContactsGroupListType.SubGroup===this.selectedGroupType()},this),this.searchText=i.computed(function(){return Ei.i18n("CONTACTS/INFO_SEARCH_RESULT",{SEARCH:this.search()})},this),this.mobileApp=Pi,this.selectedPanel=i.observable(Ci.MobilePanel.Items),this.selectedItem.subscribe(function(){var e=this.selectedItem()&&this.selectedItem()instanceof dt&&!this.selectedItem().isNew();this.selectedItem()&&!e?this.gotoViewPane():this.gotoContactList()},this)}function Yt(){this.aTabs=[],Mi.App.AllowUsersChangeInterfaceSettings&&this.aTabs.push(new zt),Mi.App.AllowWebMail&&this.aTabs.push(new Qt),Mi.App.AllowUsersChangeInterfaceSettings&&Mi.User.AllowCalendar&&this.aTabs.push(new $t),(Mi.User.IsFilesSupported||Mi.SocialGoogle&&Mi.SocialGoogleApiKey&&Mi.SocialGoogleId||Mi.SocialDropbox&&Mi.SocialDropboxKey)&&this.aTabs.push(new ci),Mi.User.MobileSyncEnable&&this.aTabs.push(new Jt),Mi.User.OutlookSyncEnable&&this.aTabs.push(new Xt),Mi.User.IsHelpdeskSupported&&this.aTabs.push(new hi),Mi.App.AllowOpenPgp&&this.aTabs.push(new Zt),Ii&&Ii.getPluginsSettingsTabs&&_.each(Ii.getPluginsSettingsTabs(),_.bind(function(e){this.aTabs.push(new e)},this)),this.tab=i.observable(Ci.SettingsTab.Common),Mi.Accounts.currentId.subscribe(function(){Fi.Routing.lastSettingsHash(Ci.Screens.Settings)},this),this.allowFolderListOrder=i.computed(function(){var e=Mi.Accounts.getEdited();return e?!e.extensionExists("DisableFoldersManualSort"):!1},this),this.folderListOrderUpdateDebounce=_.debounce(_.bind(this.folderListOrderUpdate,this),3e3),this.afterSortableFolderMoveBinded=_.bind(this.afterSortableFolderMove,this)}function zt(){this.allowWebMail=Mi.App.AllowWebMail,this.isRtl=Ei.isRTL(),this.aSkins=Mi.App.Themes,this.selectedSkin=i.observable(Mi.User.DefaultTheme),this.aLanguages=Mi.App.Languages,this.selectedLanguage=i.observable(Mi.User.DefaultLanguage),this.loading=i.observable(!1),this.rangeOfNumbers=[10,20,30,50,75,100,150,200],this.messagesPerPageValues=i.observableArray(this.rangeOfNumbers),this.messagesPerPage=i.observable(this.rangeOfNumbers[0]),this.setMessagesPerPage(Mi.User.MailsPerPage),this.contactsPerPageValues=i.observableArray(this.rangeOfNumbers),this.contactsPerPage=i.observable(this.rangeOfNumbers[0]),this.setContactsPerPage(Mi.User.ContactsPerPage),this.autocheckmailInterval=i.observable(Mi.User.AutoCheckMailInterval),this.timeFormat=i.observable(Mi.User.defaultTimeFormat()),this.aDateFormats=Ei.getDateFormatsForSelector(),this.dateFormat=i.observable(Mi.User.DefaultDateFormat),this.useThreads=i.observable(Mi.User.useThreads()),this.saveRepliedToCurrFolder=i.observable(Mi.User.SaveRepliedToCurrFolder),this.allowChangeInputDirection=i.observable(Mi.User.AllowChangeInputDirection),this.desktopNotifications=i.observable(Mi.User.DesktopNotifications),this.desktopNotifications.subscribe(function(e){var i=this;e&&"default"===t.Notification.permission&&t.Notification.requestPermission(function(e){"denied"===e&&(i.desktopNotifications(!1),i.desktopNotificationsIsEnable(!1))})},this),this.desktopNotificationsIsEnable=i.observable(t.Notification&&"denied"!==t.Notification.permission),this.isMailto=i.observable(Fi.browser.firefox||Fi.browser.chrome),this.bAllowContacts=Mi.User.ShowContacts,this.bAllowCalendar=Mi.User.AllowCalendar,this.bAllowThreads=Mi.User.ThreadsEnabled,this.firstState=this.getState()}function Qt(){this.accounts=Mi.Accounts.collection,this.onlyOneAccount=i.computed(function(){var e=1===this.accounts().length&&!Mi.App.AllowUsersAddNewAccounts;return e&&(this.TabTitle=Ei.i18n("SETTINGS/TAB_EMAIL_ACCOUNT")),e},this),this.title=i.computed(function(){return Ei.i18n(this.onlyOneAccount()?"SETTINGS/TITLE_EMAIL_ACCOUNT":"SETTINGS/TITLE_EMAIL_ACCOUNTS")},this),this.currentAccountId=Mi.Accounts.currentId,this.editedAccountId=Mi.Accounts.editedId,this.defaultAccountId=Mi.Accounts.defaultId,this.defaultAccount=Mi.Accounts.getDefault(),this.isAllowFetcher=!!Mi.User.AllowFetcher,this.isAllowIdentities=!!Mi.AllowIdentities,this.oAccountProperties=new ei(this),this.oAccountSignature=new ii(this),this.oAccountFilters=new ni(this),this.oAccountAutoresponder=new oi(this),this.oAccountForward=new si(this),this.oAccountFolders=new ti(this),this.oFetcherIncoming=new ri(this),this.oFetcherOutgoing=new ai(this),this.oFetcherSignature=new li(this),this.oIdentityProperties=new ui(this,!1),this.fetcher=i.observable(null),this.fetchers=i.observable(null),this.firstFetcher=i.observable(null),this.editedFetcherId=i.observable(null),this.editedIdentityId=i.observable(null),this.defaultAccount.fetchers.subscribe(function(e){if(e){var t=this.defaultAccount.fetchers(),i=t.collection()[0],s=i.id(),o=this.isFetcherTab(this.tab());this.fetchers(t),this.firstFetcher(i),o&&(this.editedFetcherId(s),this.editedIdentityId(null),this.onChangeFetcher(s))}else this.onChangeAccount(this.defaultAccountId())},this),this.tab=i.observable(Ci.AccountSettingsTab.Properties),this.allowUsersAddNewAccounts=Mi.App.AllowUsersAddNewAccounts,this.allowUsersChangeInterfaceSettings=Mi.App.AllowUsersChangeInterfaceSettings,this.allowAutoresponderExtension=i.observable(!1),this.allowForwardExtension=i.observable(!1),this.allowSieveFiltersExtension=i.observable(!1),this.onChangeAccount(this.editedAccountId())}function $t(){this.showWeekends=i.observable(Mi.User.CalendarShowWeekEnds),this.loading=i.observable(!1),this.availableTimes=i.observableArray(this.getDisplayedTimes(Mi.User.defaultTimeFormat()!==Ci.TimeFormat.F24?"hh:mm A":"HH:mm")),Mi.User.defaultTimeFormat.subscribe(function(){this.availableTimes(this.getDisplayedTimes(Mi.User.defaultTimeFormat()!==Ci.TimeFormat.F24?"hh:mm A":"HH:mm"))},this),this.selectedWorkdayStarts=i.observable(Mi.User.CalendarWorkDayStarts),this.selectedWorkdayEnds=i.observable(Mi.User.CalendarWorkDayEnds),this.showWorkday=i.observable(Mi.User.CalendarShowWorkDay),this.weekStartsOn=i.observable(Mi.User.CalendarWeekStartsOn),this.defaultTab=i.observable(Mi.User.CalendarDefaultTab),this.firstState=this.getState()}function Jt(){this.mobileSync=Mi.User.mobileSync,this.mobileSync.subscribe(this.onMobileSyncSubscribe,this),this.enableDav=i.observable(!1),this.davLogin=i.observable(""),this.davServer=i.observable(""),this.davCalendars=i.observable([]),this.visibleCalendars=i.computed(function(){return this.davCalendars().length>0},this),this.davPersonalContactsUrl=i.observable(""),this.davCollectedAddressesUrl=i.observable(""),this.davGlobalAddressBookUrl=i.observable(""),this.davSharedWithAllUrl=i.observable(""),this.bVisiblePersonalContacts=Mi.User.ShowPersonalContacts,this.bVisibleGlobalContacts=Mi.User.ShowGlobalContacts,this.bVisibleSharedWithAllContacts=!!Mi.App.AllowContactsSharing,this.bVisibleContacts=Mi.User.ShowContacts,this.bVisibleCalendar=Mi.User.AllowCalendar,this.bVisibleFiles=Mi.User.IsFilesSupported,this.bVisibleIosLink=Di,this.visibleDavViaUrls=i.computed(function(){return this.visibleCalendars()||this.bVisibleContacts},this),this.bChanged=!1,this.isDemo=Mi.User.IsDemo,this.credentialsHintText=i.observable(Ei.i18n("SETTINGS/MOBILE_CREDENTIALS_TITLE",{EMAIL:Mi.Accounts.getDefault().email()}))}function Xt(){this.outlookSync=Mi.User.outlookSync,this.outlookSync.subscribe(this.onOutlookSyncSubscribe,this),this.visibleOutlookSync=i.observable(!1),this.server=i.observable(""),this.bChanged=!1,this.isDemo=Mi.User.IsDemo,this.outlookSyncPlugin32=Fi.getHelpLink("OutlookSyncPlugin32"),this.outlookSyncPlugin64=Fi.getHelpLink("OutlookSyncPlugin64"),this.outlookSyncPluginReadMore=Fi.getHelpLink("OutlookSyncPluginReadMore"),this.credentialsHintText=i.observable(Ei.i18n("SETTINGS/OUTLOOKSYNC_CREDENTIALS_TITLE",{EMAIL:Mi.Accounts.getDefault().email()}))}function Zt(){this.pgp=null,this.pgpLoaded=i.observable(!1),this.keys=i.observableArray([]),this.publicKeys=i.computed(function(){var e=_.filter(this.keys(),function(e){return e.isPublic()
});return _.map(e,function(e){return{user:e.getUser(),armor:e.getArmor(),key:e,"private":!1}})},this),this.privateKeys=i.computed(function(){var e=_.filter(this.keys(),function(e){return e.isPrivate()});return _.map(e,function(e){return{user:e.getUser(),armor:e.getArmor(),key:e}})},this),this.loading=i.observable(!1),this.enableOpenPgp=i.observable(Mi.User.enableOpenPgp()),this.allowAutosaveInDrafts=i.observable(Mi.User.AllowAutosaveInDrafts),this.autosignOutgoingEmails=i.observable(Mi.User.AutosignOutgoingEmails),this.bAllowAutoSave=Mi.App.AutoSave,this.firstState=this.getState()}function ei(){this.allowUsersChangeInterfaceSettings=Mi.App.AllowUsersChangeInterfaceSettings,this.allowUsersChangeEmailSettings=Mi.App.AllowUsersChangeEmailSettings,this.isAllowIdentities=!!Mi.AllowIdentities,this.account=i.observable(0),this.isInternal=i.observable(!0),this.isLinked=i.observable(!0),this.isDefault=i.observable(!1),this.removeHint=i.observable(""),this.friendlyName=i.observable(""),this.email=i.observable(""),this.incomingMailLogin=i.observable(""),this.incomingMailPassword=i.observable(""),this.incomingMailPort=i.observable(0),this.incomingMailServer=i.observable(""),this.outgoingMailLogin=i.observable(""),this.outgoingMailPassword=i.observable(""),this.outgoingMailPort=i.observable(0),this.outgoingMailServer=i.observable(""),this.loading=i.observable(!1),this.allowChangePassword=i.observable(!1),this.useSmtpAuthentication=i.observable(!1),this.incLoginFocused=i.observable(!1),this.incLoginFocused.subscribe(function(){this.incLoginFocused()&&""===this.incomingMailLogin()&&this.incomingMailLogin(this.email())},this),this.outServerFocused=i.observable(!1),this.outServerFocused.subscribe(function(){this.outServerFocused()&&""===this.outgoingMailServer()&&this.outgoingMailServer(this.incomingMailServer())},this),this.firstState=null}function ti(e){this.parent=e,this.highlighted=i.observable(!1).extend({autoResetToFalse:500}),this.collection=i.observableArray(Fi.MailCache.editedFolderList().collection()),this.totalMessageCount=i.observable(0),this.enableButtons=i.computed(function(){return Fi.MailCache.editedFolderList().bInitialized()},this),Fi.MailCache.editedFolderList.subscribe(function(e){this.collection(e.collection()),this.setTotalMessageCount()},this),this.addNewFolderCommand=Ei.createCommand(this,this.onAddNewFolderClick,this.enableButtons),this.systemFoldersCommand=Ei.createCommand(this,this.onSystemFoldersClick,this.enableButtons),this.showMovedWithMouseItem=i.computed(function(){var e=Mi.Accounts.getEdited();return e?!Ni&&!e.extensionExists("DisableFoldersManualSort"):!1},this),Ii.runPluginHook&&Ii.runPluginHook("view-model-defined",[this.__name,this])}function ii(e){this.parent=e,this.account=i.observable(0),this.type=i.observable(!1),this.useSignature=i.observable(0),this.signature=i.observable(""),this.loading=i.observable(!1),this.account.subscribe(function(){this.getSignature()},this),this.oHtmlEditor=new Dt(!0),this.enableImageDragNDrop=i.observable(!1),this.enabled=i.observable(!0),this.signature.subscribe(function(){this.oHtmlEditor.setText(this.signature())},this),this.getSignature(),this.firstState=null}function si(){this.account=i.observable(0),this.available=i.computed(function(){var e=this.account();return e&&e.forward()},this),this.loading=i.observable(!1),this.enable=i.observable(!1),this.email=i.observable(""),this.emailFocus=i.observable(!1),this.account.subscribe(function(){this.getForward()},this),this.firstState=null}function oi(){this.account=i.observable(0),this.available=i.computed(function(){var e=this.account();return e&&e.autoresponder()},this),this.loading=i.observable(!1),this.enable=i.observable(!1),this.subject=i.observable(""),this.message=i.observable(""),this.account.subscribe(function(){this.getAutoresponder()},this),this.firstState=null}function ni(){this.account=i.observable(0),this.folderList=i.observable(Fi.MailCache.editedFolderList()),Fi.MailCache.editedFolderList.subscribe(function(e){e&&0!==e.iAccountId&&this.folderList(e)},this),this.foldersOptions=i.computed(function(){return this.folderList()?this.folderList().getOptions(Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_NOT_SELECTED"),!0,!0,!1):[]},this),this.foldersOptions.subscribe(function(){this.getFilters()},this),this.available=i.computed(function(){var e=this.account();return!(!e||!e.filters())},this),this.loading=i.observable(!0),this.saving=i.observable(!1),this.collection=i.observableArray([]),this.fieldOptions=[{text:Ei.i18n("SETTINGS/ACCOUNT_FILTERS_FIELD_FROM"),value:0},{text:Ei.i18n("SETTINGS/ACCOUNT_FILTERS_FIELD_TO"),value:1},{text:Ei.i18n("SETTINGS/ACCOUNT_FILTERS_FIELD_SUBJECT"),value:2}],this.conditionOptions=[{text:Ei.i18n("SETTINGS/ACCOUNT_FILTERS_COND_CONTAIN_SUBSTR"),value:0},{text:Ei.i18n("SETTINGS/ACCOUNT_FILTERS_COND_EQUAL_TO"),value:1},{text:Ei.i18n("SETTINGS/ACCOUNT_FILTERS_COND_NOT_CONTAIN_SUBSTR"),value:2}],this.actionOptions=[{text:Ei.i18n("SETTINGS/ACCOUNT_FILTERS_ACTION_MOVE"),value:3},{text:Ei.i18n("SETTINGS/ACCOUNT_FILTERS_ACTION_DELETE"),value:1}],this.phaseArray=[""],_.each(Ei.i18n("SETTINGS/ACCOUNT_FILTERS_PHRASE").split(/\s/),function(e){var t=this.phaseArray.length-1;"%"===e.substr(0,1)||"%"===this.phaseArray[t].substr(-1,1)?this.phaseArray.push(e):this.phaseArray[t]+=" "+e},this),this.firstState=null}function ri(){this.defaultAccountId=Mi.Accounts.defaultId,this.folderList=Fi.MailCache.folderList,this.loading=i.observable(!1),this.fetcher=i.observable(null),this.idFetcher=i.observable(null),this.isEnabled=i.observable(!0),this.incomingMailServer=i.observable(""),this.incomingMailPort=i.observable(110),this.incomingMailLogin=i.observable(""),this.incomingMailPassword=i.observable(""),this.folder=i.observable(""),this.options=i.computed(function(){return this.folderList().getOptions("",!0,!1,!1)},this),this.leaveMessagesOnServer=i.observable(!1),this.folderList.subscribe(function(){this.folder(this.fetcher()?this.fetcher().folder():"")},this),this.serverIsSelected=i.observable(!1),this.loginIsSelected=i.observable(!1),this.passwordIsSelected=i.observable(!1),this.defaultOptionsAfterRender=Ei.defaultOptionsAfterRender,this.firstState=null}function ai(){this.defaultAccountId=Mi.Accounts.defaultId,this.loading=i.observable(!1),this.fetcher=i.observable(null),this.idFetcher=i.observable(null),this.isEnabled=i.observable(!0),this.email=i.observable(""),this.userName=i.observable(""),this.isOutgoingEnabled=i.observable(!1),this.outgoingMailServer=i.observable(""),this.outgoingMailPort=i.observable(25),this.outgoingMailAuth=i.observable(!1),this.serverIsSelected=i.observable(!1),this.firstState=null}function li(e){this.defaultAccountId=Mi.Accounts.defaultId,this.idFetcher=i.observable(null),this.fetcher=i.observable(null),this.signature=i.observable(""),this.loading=i.observable(!1),this.type=i.observable(!1),this.useSignature=i.observable(0),this.oHtmlEditor=new Dt(!0),this.enableImageDragNDrop=i.observable(!1),this.enabled=e.oFetcherIncoming.isEnabled,this.enabled.subscribe(function(){this.oHtmlEditor.isEnable(this.enabled())},this),this.signature.subscribe(function(){this.oHtmlEditor.setText(this.signature())},this),this.firstState=null}function hi(){this.allowNotifications=i.observable(Mi.User.AllowHelpdeskNotifications),this.loading=i.observable(!1)}function ci(){this.loading=i.observable(!1),this.allowFiles=Mi.User.IsFilesSupported,this.enableFiles=i.observable(Mi.User.filesEnable()),this.firstState=this.getState(),Ii.runPluginHook&&Ii.runPluginHook("view-model-defined",[this.__name,this])}function ui(e,t){this.defaultAccountId=Mi.Accounts.defaultId,this.oEmailAccountsSettings=e,this.oAccountProperties=e.oAccountProperties,this.bCreate=t,this.loading=i.observable(!1),this.disableCheckbox=i.observable(!1),this.identity=i.observable(null),this.oHtmlEditor=new Dt(!0),this.enabled=i.observable(!0),this.isDefault=i.observable(!1),this.email=i.observable(""),this.loyal=i.observable(!1),this.friendlyName=i.observable(""),this.friendlyNameHasFocus=i.observable(!1),this.signature=i.observable(""),this.useSignature=i.observable(0),this.enableImageDragNDrop=i.observable(!1),this.signature.subscribe(function(){this.oHtmlEditor.setText(this.signature())},this),this.firstState=null}function di(){var e=this;this.initialized=i.observable(!1),this.isPublic=wi,this.uploaderArea=i.observable(null),this.bDragActive=i.observable(!1),this.bDragActiveComp=i.computed(function(){return this.bDragActive()},this),this.defaultAccount=Mi.Accounts?Mi.Accounts.getDefault():null,this.todayDate=new Date,this.aDayNames=Ei.i18n("DATETIME/DAY_NAMES").split(" "),this.publicCalendarId=this.isPublic?Mi.CalendarPubHash:"",this.publicCalendarName=i.observable(""),this.timeFormat=Mi.User.defaultTimeFormat()===Ci.TimeFormat.F24?"HH:mm":"hh:mm A",this.dateFormat=Mi.User.DefaultDateFormat,this.dateTitle=i.observable(""),this.dateTitleHelper=i.observableArray(Ei.i18n("DATETIME/MONTH_NAMES").split(" ")),this.selectedView=i.observable(""),this.visibleWeekdayHeader=i.computed(function(){return"month"===this.selectedView()},this),this.selectedView.subscribe(function(){this.resize()},this),this.$calendarGrid=null,this.calendarGridDom=i.observable(null),this.$datePicker=null,this.datePickerDom=i.observable(null),this.calendars=new gt({onCalendarCollectionChange:function(){e.refreshView()},onCalendarActiveChange:function(){e.refreshView()}}),this.colors=["#f09650","#f68987","#6fd0ce","#8fbce2","#b9a4f5","#f68dcf","#d88adc","#4afdb4","#9da1ff","#5cc9c9","#77ca71","#aec9c9"],this.busyDays=i.observableArray([]),this.$inlineEditedEvent=null,this.inlineEditedEventText=null,this.checkStarted=i.observable(!1),this.loaded=!1,this.startDateTime=0,this.endDateTime=0,this.needsToReload=!1,this.calendarListClick=function(e){e.active(!e.active())},this.currentCalendarDropdown=i.observable(!1),this.currentCalendarDropdownOffset=i.observable(0),this.calendarDropdownToggle=function(t,i){if(i&&t){var s=i.position(),o=i.outerHeight();e.currentCalendarDropdownOffset(parseInt(s.top,10)+o)}e.currentCalendarDropdown(t)},this.dayNamesResizeBinding=_.throttle(_.bind(this.resize,this),50),this.customscrollTop=i.observable(0),this.fullcalendarOptions={handleWindowResize:!0,eventLimit:10,header:!1,editable:!this.isPublic,selectable:!this.isPublic,allDayText:Ei.i18n("CALENDAR/TITLE_ALLDAY"),dayNames:this.aDayNames,isRTL:Ei.isRTL(),scrollTime:moment.duration(8,"hours"),forceEventDuration:!0,columnFormat:{month:"dddd",week:"dddd D",day:"dddd D"},titleFormat:{month:"MMMM YYYY",week:"MMMM D[ YYYY]{ '-'[ MMMM] D YYYY}",day:"MMMM D, YYYY"},displayEventEnd:{month:!0,basicWeek:!0,"default":!0},select:_.bind(this.createEventFromGrid,this),eventClick:_.bind(this.eventClickCallback,this),eventDragStart:_.bind(this.onEventDragStart,this),eventDragStop:_.bind(this.onEventDragStop,this),eventResizeStart:_.bind(this.onEventResizeStart,this),eventResizeStop:_.bind(this.onEventResizeStop,this),eventDrop:_.bind(this.moveEvent,this),eventResize:_.bind(this.resizeEvent,this),eventAfterRender:_.bind(function(){},this),viewRender:_.bind(this.viewRenderCallback,this),events:_.bind(this.eventsSource,this)},this.revertFunction=null,this.calendarSharing=Mi.User.AllowCalendar&&Mi.User.CalendarSharing,this.defaultViewName=i.computed(function(){var e="month";switch(Mi.User.CalendarDefaultTab){case Ci.CalendarDefaultTab.Day:e="agendaDay";break;case Ci.CalendarDefaultTab.Week:e="agendaWeek";break;case Ci.CalendarDefaultTab.Month:e="month"}return e},this),this.iAutoReloadTimer=-1,this.dragEventTrigger=!1,this.delayOnEventResult=!1,this.delayOnEventResultData=[],this.refreshView=_.throttle(_.bind(this.refreshViewSingle,this),100),this.defaultCalendarId=i.computed(function(){var e=this.calendars.defaultCal();return e?e.id:void 0},this),this.uploadCalendarId=i.observable(""),this.changeFullCalendarDate=!0,this.domScrollWrapper=null}function pi(){this.allowWebMail=!(!Mi.App||!Mi.App.AllowWebMail),this.error=i.observable(!1),this.loaded=i.observable(!1),this.isPublic=wi,this.publicHash=wi?Mi.FileStoragePubHash:"",this.IsCollaborationSupported=Mi.User.IsCollaborationSupported,this.AllowFilesSharing=Mi.User.AllowFilesSharing,this.storages=i.observableArray(),this.folders=i.observableArray(),this.files=i.observableArray(),this.uploadingFiles=i.observableArray(),this.selected=i.observable(!1),this.rootPath=i.observable(Ei.i18n("FILESTORAGE/TAB_PERSONAL_FILES")),this.storageType=i.observable(Ci.FileStorageType.Personal),this.storageType.subscribe(function(){var e=null;this.isPublic?this.rootPath(Mi.FileStoragePubParams.Name):(e=this.getStorageByType(this.storageType()),e&&this.rootPath(e.displayName())),this.selector.listCheckedAndSelected(!1)},this),this.iPathIndex=i.observable(-1),this.pathItems=i.observableArray(),this.dropPath=i.observable(""),this.path=i.computed(function(){var e=_.map(this.pathItems(),function(e){return e.id()});return e.join("/")},this),this.path.subscribe(function(e){this.dropPath(e)},this),this.collection=i.computed(function(){var e=_.union(this.files(),this.getUploadingFiles());return e.sort(function(e,t){return e.fileName()===t.fileName()?0:e.fileName()<t.fileName()?-1:1}),_.union(this.folders(),e)},this),this.columnCount=i.observable(1),this.selector=new u(this.collection,null,_.bind(this.onItemDelete,this),_.bind(this.onItemDblClick,this),_.bind(this.onEnter,this),this.columnCount,!0,!0,!0),this.searchPattern=i.observable(""),this.isSearchFocused=i.observable(!1),this.renameCommand=Ei.createCommand(this,this.executeRename,function(){var e=this.selector.listCheckedAndSelected();return 1===e.length}),this.deleteCommand=Ei.createCommand(this,this.executeDelete,function(){var e=this.selector.listCheckedAndSelected();return 0<e.length}),this.downloadCommand=Ei.createCommand(this,this.executeDownload,function(){var e=this.selector.listCheckedAndSelected();return 1===e.length&&!e[0].isFolder()}),this.shareCommand=Ei.createCommand(this,this.executeShare,function(){var e=this.selector.listCheckedAndSelected();return 1===e.length&&!e[0].isLink()}),this.sendCommand=Ei.createCommand(this,this.executeSend,function(){var e=this.selector.listCheckedAndSelected(),t=_.filter(e,function(e){return!e.isFolder()},this);return t.length>0}),this.uploaderButton=i.observable(null),this.uploaderArea=i.observable(null),this.bDragActive=i.observable(!1),this.bDragActiveComp=i.computed(function(){var e=this.bDragActive();return e&&""===this.searchPattern()},this),this.uploadError=i.observable(!1),this.quota=i.observable(0),this.used=i.observable(0),this.quotaDesc=i.observable(""),this.quotaProc=i.observable(-1),i.computed(function(){if(!Mi.App||Mi.App&&!Mi.App.ShowQuotaBar)return!0;var e=this.quota(),t=this.used(),i=e>0?Math.ceil(t/e*100):-1;return i=i>100?100:i,this.quotaProc(i),this.quotaDesc(i>-1?Ei.i18n("MAILBOX/QUOTA_TOOLTIP",{PROC:i,QUOTA:Ei.friendlySize(e)}):""),!0},this),this.dragover=i.observable(!1),this.loading=i.observable(!1),this.loadedFiles=i.observable(!1),this.fileListInfoText=i.computed(function(){var e="";return this.loading()?e=Ei.i18n("FILESTORAGE/INFO_LOADING"):this.loadedFiles()?0===this.collection().length&&(e=Ei.i18n(this.isPublic?"FILESTORAGE/INFO_PUBLIC_FOLDER_NOT_EXIST":""!==this.searchPattern()||this.isPublic?"FILESTORAGE/INFO_NO_ITEMS_FOUND":""!==this.path()||this.isPopup?"FILESTORAGE/INFO_FOLDER_IS_EMPY":"FILESTORAGE/INFO_FILESTORAGE_IS_EMTY")):this.error()&&(e=Ei.i18n("FILESTORAGE/ERROR_FILESTORAGE")),e},this),this.dragAndDropHelperBinded=_.bind(this.dragAndDropHelper,this),this.isPopup=!1,this.isCurrentStorageExternal=i.computed(function(){var e=this.getStorageByType(this.storageType());return e&&e.isExternal()},this),this.timerId=null}function mi(){var e=this,t=function(t){return function(){e.executeChangeState(t),e.isQuickReplyHidden(!e.bAgent),t===Ci.HelpdeskThreadStates.Resolved&&(e.selectedItem(null),Fi.Routing.setHash([Ci.Screens.Helpdesk,""]))}};this.bRtl=Ei.isRTL(),this.iAutoCheckTimer=0,this.bExtApp=wi,this.ajaxSendFunc=this.bExtApp?"sendExt":"send",this.bAgent=Mi.User.IsHelpdeskAgent,this.singleMode=Mi.SingleMode,this.externalUrl=i.observable(Mi.HelpdeskIframeUrl),this.loadingList=i.observable(!0),this.loadingViewPane=i.observable(!1),this.loadingMoreMessages=i.observable(!1),this.threads=i.observableArray([]),this.posts=i.observableArray([]),this.iPingInterval=-1,this.iPingStartTimer=-1,this.selectedItem=i.observable(null),this.previousSelectedItem=i.observable(null),this.state=i.observable(0),this.selectedItem.subscribe(function(e){this.previousSelectedItem(e)},this,"beforeChange"),this.selectedItem.subscribe(function(e){this.state(e?e.state():0),this.subject(this.selectedItem()?this.bExtApp?this.selectedItem().sSubject:this.selectedItem().sFromFull:""),this.internalNote(!1),!this.bExtApp&&this.selectedItem()&&Fi.ContactsCache.getContactByEmail(this.selectedItem().sEmail,this.onOwnerContactResponse,this),clearInterval(this.iPingInterval),clearTimeout(this.iPingStartTimer),this.watchers([]),this.selectedItem()&&(this.iPingStartTimer=setTimeout(_.bind(function(){this.executeThreadPing(this.selectedItem().Id),clearInterval(this.iPingInterval),this.iPingInterval=setInterval(_.bind(function(){this.executeThreadPing(this.selectedItem().Id)},this),18e4)},this),5e3))},this),this.listFilter=i.observable(this.bAgent?Ci.HelpdeskFilters.Open:Ci.HelpdeskFilters.All),this.listFilter.subscribe(function(){this.requestThreadsList()},this),this.prevListFilter=i.observable(""),this.hasMorePosts=i.computed(function(){var e=this.selectedItem();return e&&e.postsCount()>this.posts().length},this).extend({throttle:1}),this.selector=new u(this.threads,_.bind(this.onItemSelect,this),_.bind(this.onItemDelete,this),null,null,null,!1,!1,!1,!0),this.checkStarted=i.observable(!1),this.checkAll=this.selector.koCheckAll(),this.checkAllIncomplite=this.selector.koCheckAllIncomplete(),this.ThreadsPerPage=10,this.oPageSwitcher=new Rt(0,this.ThreadsPerPage),this.oPageSwitcher.currentPage.subscribe(function(){this.requestThreadsList()},this),this.isSearchFocused=i.observable(!1),this.search=i.observable(""),this.searchText=i.computed(function(){return Ei.i18n("HELPDESK/INFO_SEARCH_RESULT",{SEARCH:this.search()})},this),this.deleteCommand=Ei.createCommand(this,this.executeDelete,this.isEnableListActions),this.openNewWindowCommand=Ei.createCommand(this,this.executeOpenNewWindow,this.isEnableListActions),this.checkCommand=Ei.createCommand(this,function(){this.requestThreadsList(),this.requestPosts(),this.startAutocheckmail()}),this.closeCommand=Ei.createCommand(this,t(Ci.HelpdeskThreadStates.Resolved),this.isEnableListActions),this.waitCommand=Ei.createCommand(this,t(Ci.HelpdeskThreadStates.Waiting),this.isEnableListActions),this.pendingCommand=Ei.createCommand(this,t(Ci.HelpdeskThreadStates.Pending),this.isEnableListActions),this.deferCommand=Ei.createCommand(this,t(Ci.HelpdeskThreadStates.Deferred),this.isEnableListActions),this.answerCommand=Ei.createCommand(this,t(Ci.HelpdeskThreadStates.Answered),this.isEnableListActions),this.postCommand=Ei.createCommand(this,this.executePostCreate,function(){return!!this.selectedItem()&&this.replyText().length>0&&this.allAttachmentsUploaded()}),this.visibleNewThread=i.observable(!1),this.newThreadText=i.observable(""),this.newThreadCreating=i.observable(!1),this.createThreadCommand=Ei.createCommand(this,this.executeThreadCreate,function(){return this.visibleNewThread()&&this.newThreadText().length>0&&!this.newThreadCreating()}),this.createThreadButtonText=i.computed(function(){return Ei.i18n(this.newThreadCreating()?"HELPDESK/BUTTON_SENDING":"HELPDESK/BUTTON_CREATE")},this),this.commandGetOlderPosts=function(){var e=this.posts(),t=e[0]?e[0].Id:0;this.requestPosts(null,t)},this.externalContentUrl=i.observable(""),Mi.HelpdeskIframeUrl&&(this.bAgent?this.externalContentUrl=i.computed(function(){var e="",t=this.selectedItem();return t&&(e=t.Email()),e?Mi.HelpdeskIframeUrl.replace(/\[EMAIL\]/g,e):""},this):Mi.User.Email&&(this.externalContentUrl=i.computed(function(){return Mi.HelpdeskIframeUrl.replace(/\[EMAIL\]/g,Mi.User.Email)},this))),this.clientDetailsVisible=i.observable(Fi.Storage.hasData("HelpdeskUserDetails")?Fi.Storage.getData("HelpdeskUserDetails"):!0),this.clientDetailsVisible.subscribe(function(e){Fi.Storage.setData("HelpdeskUserDetails",e)},this),this.subject=i.observable(""),this.watchers=i.observableArray([]),this.ownerExistsInContacts=i.observable(!1),this.ownerContactInfoReceived=i.observable(!1),this.ownerContact=i.observable(this.bExtApp?null:new ut),this.hasOwnerContact=i.computed(function(){return!this.singleMode&&this.ownerContactInfoReceived()&&this.ownerExistsInContacts()},this),this.visibleAddToContacts=i.computed(function(){return!this.singleMode&&this.ownerContactInfoReceived()&&!this.ownerExistsInContacts()},this),this.contactCardWidth=i.observable(0),this.uploadedFiles=i.observableArray([]),this.allAttachmentsUploaded=i.computed(function(){var e=_.filter(this.uploadedFiles(),function(e){return!e.uploaded()});return 0===e.length},this),this.uploaderButton=i.observable(null),this.uploaderButtonCompose=i.observable(null),this.uploaderArea=i.observable(null),this.bDragActive=i.observable(!1),this.internalNote=i.observable(!1),this.isQuickReplyHidden=i.observable(!this.bAgent),this.domQuickReply=i.observable(null),this.replySendingStarted=i.observable(!1),this.replyPaneVisible=i.observable(!0),this.replyText=i.observable(""),this.replyTextFocus=i.observable(!1),this.isQuickReplyActive=i.observable(!1),this.replyTextFocus.subscribe(function(){this.replyTextFocus()&&this.isQuickReplyActive(!0)},this),this.isQuickReplyActive.subscribe(function(){this.isQuickReplyActive()&&this.replyTextFocus(!0)},this),this.isEmptyQuickReplyPane=i.computed(function(){return 0===this.replyText().length&&!this.internalNote()&&0===this.uploadedFiles().length},this),this.isSearch=i.computed(function(){return""!==this.search()},this),this.isEmptyList=i.computed(function(){return 0===this.threads().length},this),this.dynamicEmptyListInfo=this.bAgent?i.computed(function(){return Ei.i18n(this.isEmptyList()&&this.isSearch()?"HELPDESK/INFO_SEARCH_EMPTY":"HELPDESK/INFO_EMPTY_OPEN_THREAD_LIST_AGENT")},this):i.computed(function(){return Ei.i18n(this.isEmptyList()&&this.isSearch()?"HELPDESK/INFO_SEARCH_EMPTY":"HELPDESK/INFO_EMPTY_THREAD_LIST")},this),this.simplePreviewPane=i.computed(function(){var e=this.selectedItem();return e?e.ItsMe:!this.bAgent},this),this.allowInternalNote=i.computed(function(){return!this.simplePreviewPane()},this),this.scrollToTopTrigger=i.observable(!1),this.scrollToBottomTrigger=i.observable(!1),this.allowDownloadAttachmentsLink=!1,this.newThreadButtonWidth=i.observable(0),this.requestFromLogin()}function gi(){var s=e(t);this.resizeAll=_.debounce(function(){s.resize()},100),this.oScreens={},this.currentScreen=i.observable(""),this.informationScreen=i.observable(null),this.popups=[]}function fi(){this.currentAccountId=Mi.Accounts.currentId,this.currentAccountId.subscribe(function(e){var t=Mi.Accounts.getAccount(e),i=this.oFolderListItems[e],s={Action:"FoldersGetList",AccountID:e};t&&(t.quotaRecieved(!1),this.messagesLoadingError(!1),i?this.folderList(i):(this.messagesLoading(!0),this.folderList(new rt),this.messages([]),this.currentMessage(null),Fi.Ajax.send(s,this.onFoldersGetListResponse,this)))},this),this.editedAccountId=Mi.Accounts.editedId,this.editedAccountId.subscribe(function(e){var t=this.oFolderListItems[e],i={};t?this.editedFolderList(t):this.currentAccountId()!==e&&(this.editedFolderList(new rt),i={Action:"FoldersGetList",AccountID:e},Fi.Ajax.send(i,this.onFoldersGetListResponse,this))},this),this.oFolderListItems={},this.quotaChangeTrigger=i.observable(!1),this.checkMailStarted=i.observable(!1),this.checkMailStartedAccountId=i.observable(0),this.defaultFolderList=i.observable(new rt),this.folderList=i.observable(new rt),this.folderListLoading=i.observable(!1),this.editedFolderList=i.observable(new rt),this.newMessagesCount=i.computed(function(){var e=this.folderList().inboxFolder();return e?e.unseenMessageCount():0},this),this.newMessagesCount.subscribe(function(e){Fi.mailUnseenCount(e>99?"99+":e)},this),this.messages=i.observableArray([]),this.messages.subscribe(function(){this.messages().length>0&&this.messagesLoadingError(!1)},this),this.uidList=i.observable(new lt),this.page=i.observable(1),this.messagesLoading=i.observable(!0),this.messagesLoadingError=i.observable(!1),this.currentMessage=i.observable(null),this.currentMessage.subscribe(function(){this.currentMessage()&&Ii.runPluginHook("view-message",[Mi.Accounts.currentId(),this.currentMessage().folder(),this.currentMessage().uid()])},this),this.nextMessageUid=i.computed(function(){var e="",i="",s=null,o=null,n=!1;return this.currentMessage()&&Mi.SingleMode&&(n=this.currentMessage().threadPart()&&""!==this.currentMessage().threadParentUid(),s=this.folderList().getFolderByFullName(this.currentMessage().folder()),e=this.currentMessage().uid(),Mi.ThreadLevel||n?(Mi.ThreadLevel=!0,n&&(o=s.getMessageByUid(this.currentMessage().threadParentUid()),o&&(_.each(o.threadUids(),function(t,s,o){t===e&&s>0&&(i=o[s-1])}),(Ei.isUnd(i)||""===i)&&(i=o.uid())))):(_.each(this.uidList().collection(),function(t,s,o){t===e&&s>0&&(i=o[s-1])}),Ei.isUnd(i)&&(i=""),""===i&&t.opener&&t.opener.App&&t.opener.App.Prefetcher&&t.opener.App.Prefetcher.prefetchNextPage(e))),i},this),this.prevMessageUid=i.computed(function(){var e=this.currentMessage()?this.currentMessage().uid():"",i="",s=null,o=null,n=!1;return this.currentMessage()&&Mi.SingleMode&&(n=this.currentMessage().threadPart()&&""!==this.currentMessage().threadParentUid(),s=this.folderList().getFolderByFullName(this.currentMessage().folder()),e=this.currentMessage().uid(),Mi.ThreadLevel||n?(Mi.ThreadLevel=!0,n?(o=s.getMessageByUid(this.currentMessage().threadParentUid()),o&&(_.each(o.threadUids(),function(t,s,o){t===e&&s+1<o.length&&(i=o[s+1])}),Ei.isUnd(i)&&(i=""))):this.currentMessage().threadCount()>0&&(i=this.currentMessage().threadUids()[0])):(_.each(this.uidList().collection(),function(t,s,o){t===e&&s+1<o.length&&(i=o[s+1])}),Ei.isUnd(i)&&(i=""),""===i&&t.opener&&t.opener.App&&t.opener.App.Prefetcher&&t.opener.App.Prefetcher.prefetchPrevPage(e))),i},this),this.savingDraftUid=i.observable(""),this.editedDraftUid=i.observable(""),this.disableComposeAutosave=i.observable(!1),this.aResponseHandlers=[],Mi.User.useThreads.subscribe(function(){_.each(this.oFolderListItems,function(e){_.each(e.collection(),function(e){e.markHasChanges(),e.removeAllMessageListsFromCacheIfHasChanges()},this)},this),this.messages([])},this),this.iAutoCheckMailTimer=-1,this.waitForUnseenMessages=i.observable(!0),this.iMessageSetSeenCount=0,this.__name="CMailCache"}function bi(){this.contacts={},this.responseHandlers={},this.vcardAttachments=[],this.recivedAnim=i.observable(!1).extend({autoResetToFalse:500})}function yi(){this.calendars=i.observableArray([]),this.calendarsLoadingStarted=i.observable(!1),this.icalAttachments=[],this.recivedAnim=i.observable(!1).extend({autoResetToFalse:500}),this.calendarSettingsChanged=i.observable(!1),this.calendarChanged=i.observable(!1),this.canRequestCalendarList=i.observable(!1)}function Si(){this.browser=new n,this.favico=!this.browser.ie8AndBelow&&t.Favico?new t.Favico({animation:"none"}):null,this.Ajax=new r,this.Screens=new gi,this.Api=new d,this.Storage=new p,this.helpdeskUnseenCount=i.observable(0),this.helpdeskPendingCount=i.observable(0),this.mailUnseenCount=i.observable(0),this.InternetConnectionError=!1}function vi(){Si.call(this),this.headerTabs=i.observableArray([]),this.screensTitle={},this.Phone=null,this.Routing=new a,this.Links=new l,this.MessageSender=new h,this.Prefetcher=new c,this.MailCache=null,this.ContactsCache=new bi,this.CalendarCache=new yi,this.currentScreen=this.Screens.currentScreen,this.currentScreen.subscribe(this.setTitle,this),this.focused=i.observable(!0),this.focused.subscribe(function(){Mi.SingleMode||t.opener||this.setTitle()},this),this.filesRecievedAnim=i.observable(!1).extend({autoResetToFalse:500}),this.init(),this.newMessagesCount=this.MailCache.newMessagesCount,this.newMessagesCount.subscribe(this.setTitle,this),this.currentMessage=this.MailCache.currentMessage,this.currentMessage.subscribe(this.setTitle,this),this.notification=null,this.initHeaderInfo(),this.sessionTimeoutFunctions=[],this.initSessionTimeout()}function Ai(){vi.call(this)}var Ci={},Ei={},Ti=t.pSevenI18N||{},Fi={},Ii={},Mi=t.pSevenAppData||{},wi=!1,Pi=!1,Ri=e("html"),Di=-1<navigator.userAgent.indexOf("iPhone")||-1<navigator.userAgent.indexOf("iPod")||-1<navigator.userAgent.indexOf("iPad"),_i=-1<navigator.userAgent.toLowerCase().indexOf("android"),Ni=Di||_i,ki=["image/jpeg","image/png","image/gif","text/html","text/plain","text/css","text/rfc822-headers","message/delivery-status","application/x-httpd-php","application/javascript","application/pdf"];if(t.Modernizr&&navigator&&t.Modernizr.addTest("pdf",function(){for(var e=navigator.mimeTypes,t=0,i=e.length;i>t;t++)if("application/pdf"===e[t].type)return!0;return!1}),Date.now||(Date.now=function(){return(new Date).getTime()}),n.prototype.getIeVersion=function(){var e=navigator.userAgent.toLowerCase(),t=Ei.pInt(e.slice(e.indexOf("msie")+4,e.indexOf(";",e.indexOf("msie")+4)));return this.ie11&&(t=11),t},r.prototype.AddActionsWithoutAuthForSendExt=function(e){e=Ei.isUnd(e)?"":e,""!==e&&-1===_.indexOf(this.aActionsWithoutAuthForSendExt,e)&&this.aActionsWithoutAuthForSendExt.push(e)},r.prototype.AddActionsWithoutAuthForSend=function(e){e=Ei.isUnd(e)?"":e,""!==e&&-1===_.indexOf(this.aActionsWithoutAuthForSend,e)&&this.aActionsWithoutAuthForSend.push(e)},r.prototype.hasOpenedRequests=function(e){return e=Ei.isUnd(e)?"":e,this.requests(_.filter(this.requests(),function(t){var i=t&&4===t.Xhr.readyState,s=!t||0===t.Xhr.readyState&&"abort"===t.Xhr.statusText,o=""===e||t&&t.Parameters.Action===e;return t&&!i&&!s&&o})),this.requests().length>0},r.prototype.isSearchMessages=function(){var e=!1;return _.each(this.requests(),function(t){t&&t.Parameters&&"MessagesGetList"===t.Parameters.Action&&""!==t.Parameters.Search&&(e=!0)},this),e},r.prototype.isAllowedActionWithoutAuth=function(e){return-1!==_.indexOf(this.aActionsWithoutAuthForSend,e)},r.prototype.isAllowedExtAction=function(e){return"SocialRegister"===e||"HelpdeskRegister"===e||"HelpdeskForgot"===e||"HelpdeskLogin"===e||"SystemLogout"===e},r.prototype.doSend=function(t,i,s,o){var n=_.bind(o||null,this,t,i,s),r=_.bind(this.fail,this,t,i,s),a=_.bind(this.always,this,t),l=null;Ii.runPluginHook&&Ii.runPluginHook("ajax-default-request",[t.Action,t]),Mi.Token&&(t.Token=Mi.Token),this.abortRequests(t),Ei.log("Ajax request send",t.Action,t),l=e.ajax({url:this.sUrl,type:"POST",async:!0,dataType:"json",data:t,success:n,error:r,complete:a}),this.requests().push({Parameters:t,Xhr:l})},r.prototype.send=function(e,t,i){var s=void 0===e.AccountID,o=s||Mi.Accounts.hasAccountWithId(e.AccountID);e&&(Mi.Auth&&o||this.isAllowedActionWithoutAuth(e.Action))&&(s&&"Login"!==e.Action&&(e.AccountID=Mi.Accounts.currentId()),this.doSend(e,t,i,this.done))},r.prototype.sendExt=function(e,t,i){var s=-1!==_.indexOf(this.aActionsWithoutAuthForSendExt,e.Action);e&&(Mi.Auth||s)&&(Mi.TenantHash&&(e.TenantHash=Mi.TenantHash),this.doSend(e,t,i,this.doneExt))},r.prototype.abortRequests=function(e){switch(e.Action){case"MessageMove":case"MessageDelete":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder}),this.abortRequestByActionName("MessageGet");break;case"MessagesGetList":case"MessageSetSeen":case"MessageSetFlagged":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder});break;case"MessagesSetAllSeen":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder}),this.abortRequestByActionName("MessagesGetListByUids",{Folder:e.Folder});break;case"FolderClear":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder}),this.abortRequestByActionName("FoldersGetRelevantInformation");break;case"ContactList":case"ContactGlobalList":this.abortRequestByActionName("ContactList"),this.abortRequestByActionName("ContactGlobalList");
break;case"ContactGet":case"ContactGlobal":this.abortRequestByActionName("ContactGet"),this.abortRequestByActionName("ContactGlobal");break;case"CalendarEventUpdate":this.abortRequestByActionName("CalendarEventUpdate",{calendarId:e.calendarId,uid:e.uid});break;case"CalendarList":this.abortRequestByActionName("CalendarList");break;case"CalendarEventList":this.abortRequestByActionName("CalendarEventList")}},r.prototype.abortRequestByActionName=function(e,t){var i;_.each(this.requests(),function(s,o){if(i=!1,s&&s.Parameters.Action===e)switch(e){case"MessagesGetList":t.Folder===s.Parameters.Folder&&(i=!0);break;case"CalendarEventUpdate":t.calendarId===s.Parameters.calendarId&&t.uid===s.Parameters.uid&&(i=!0);break;default:i=!0}i&&(s.Xhr.abort(),this.requests()[o]=void 0)},this),this.requests(_.compact(this.requests()))},r.prototype.abortAllRequests=function(){_.each(this.requests(),function(e){e&&e.Xhr.abort()},this),this.requests([])},r.prototype.done=function(e,t,i,s,o){var n=this.isAllowedActionWithoutAuth(e.Action),r=Mi.Accounts.hasAccountWithId(e.AccountID),a=e.AccountID===Mi.Accounts.defaultId();if(Ei.log("Ajax request done",e.Action,o,Ei.getAjaxDataForLog(e.Action,s),e),n||r){if(s&&!s.Result)switch(s.ErrorCode){case Ci.Errors.InvalidToken:n||Fi.tokenProblem();break;case Ci.Errors.AuthError:a&&!n&&(this.abortAllRequests(),Fi.authProblem())}this.executeResponseHandler(t,i,s,e)}},r.prototype.doneExt=function(e,t,i,s){this.executeResponseHandler(t,i,s,e)},r.prototype.fail=function(e,t,i,s,o,n){var r={Result:!1,ErrorCode:0};switch(Ei.log("Ajax request fail",e.Action,o,e),o){case"abort":r={Result:!1,ErrorCode:Ci.Errors.NotDisplayedError};break;default:case"error":case"parseerror":r=""===n?{Result:!1,ErrorCode:Ci.Errors.NotDisplayedError}:{Result:!1,ErrorCode:Ci.Errors.DataTransferFailed}}this.executeResponseHandler(t,i,r,e)},r.prototype.executeResponseHandler=function(e,t,i,s){i||(i={Result:!1,ErrorCode:0}),Ii.runPluginHook&&Ii.runPluginHook("ajax-default-response",[s.Action,i]),"function"!=typeof e||i.StopExecuteResponse||e.apply(t,[i,s])},r.prototype.always=function(e,t,i){_.each(this.requests(),function(t,i){t&&_.isEqual(t.Parameters,e)&&(this.requests()[i]=void 0)},this),this.requests(_.compact(this.requests())),Ei.checkConnection(e.Action,i),Fi.Prefetcher&&"abort"!==i&&"parsererror"!==i&&!this.hasOpenedRequests()&&Fi.Prefetcher.start()},Ci.Screens={Login:"login",Information:"information",Header:"header",Mailbox:"mailbox",SingleMessageView:"single-message-view",Compose:"compose",SingleCompose:"single-compose",Settings:"settings",Contacts:"contacts",Calendar:"calendar",FileStorage:"files",Helpdesk:"helpdesk",SingleHelpdesk:"single-helpdesk"},Ci.CalendarDefaultTab={Day:1,Week:2,Month:3},Ci.TimeFormat={F24:"0",F12:"1"},Ci.Errors={InvalidToken:101,AuthError:102,DataBaseError:104,LicenseProblem:105,DemoLimitations:106,Captcha:107,AccessDenied:108,CanNotGetMessage:202,ImapQuota:205,NotSavedInSentItems:304,NoRequestedMailbox:305,CanNotChangePassword:502,AccountOldPasswordNotCorrect:503,FetcherIncServerNotAvailable:702,FetcherLoginNotCorrect:703,HelpdeskThrowInWebmail:805,HelpdeskUserNotExists:807,HelpdeskUserNotActivated:808,IncorrectFileExtension:811,MailServerError:901,DataTransferFailed:1100,NotDisplayedError:1155},Ci.FolderTypes={Inbox:1,Sent:2,Drafts:3,Spam:4,Trash:5,Virus:6,Starred:7,System:9,User:10},Ci.FolderFilter={Flagged:"flagged",Unseen:"unseen"},Ci.LoginFormType={Email:0,Login:3,Both:4},Ci.LoginSignMeType={DefaultOff:0,DefaultOn:1,Unuse:2},Ci.ReplyType={Reply:"reply",ReplyAll:"reply-all",Resend:"resend",Forward:"forward"},Ci.Importance={Low:5,Normal:3,High:1},Ci.Sensivity={Nothing:0,Confidential:1,Private:2,Personal:3},Ci.ContactEmailType={Personal:"Personal",Business:"Business",Other:"Other"},Ci.ContactPhoneType={Mobile:"Mobile",Personal:"Personal",Business:"Business"},Ci.ContactAddressType={Personal:"Personal",Business:"Business"},Ci.ContactSortType={Email:"Email",Name:"Name",Frequency:"Frequency"},Ci.SaveMail={Hidden:0,Checked:1,Unchecked:2},Ci.SettingsTab={Common:"common",EmailAccounts:"accounts",Calendar:"calendar",MobileSync:"mobile_sync",OutLookSync:"outlook_sync",Helpdesk:"helpdesk",Pgp:"pgp",Services:"services"},Ci.AccountSettingsTab={Properties:"properties",Signature:"signature",Filters:"filters",Autoresponder:"autoresponder",Forward:"forward",Folders:"folders",FetcherInc:"fetcher-inc",FetcherOut:"fetcher-out",FetcherSig:"fetcher-sig",IdentityProperties:"identity-properties",IdentitySignature:"identity-signature"},Ci.ContactsGroupListType={Personal:0,SubGroup:1,Global:2,SharedToAll:3,All:4},Ci.IcalType={Request:"REQUEST",Reply:"REPLY",Cancel:"CANCEL",Save:"SAVE"},Ci.IcalConfig={Accepted:"ACCEPTED",Declined:"DECLINED",Tentative:"TENTATIVE",NeedsAction:"NEEDS-ACTION"},Ci.IcalConfigInt={Accepted:1,Declined:2,Tentative:3,NeedsAction:0},Ci.Key={Tab:9,Enter:13,Shift:16,Ctrl:17,Esc:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,Up:38,Down:40,Left:37,Right:39,Del:46,Six:54,a:65,b:66,c:67,f:70,i:73,k:75,n:78,p:80,q:81,r:82,s:83,u:85,v:86,y:89,z:90,F5:116,Comma:188,Dot:190,Dash:192,Apostrophe:222},Ci.MouseKey={Left:0,Middle:1,Right:2},Ci.FileStorageType={Personal:"personal",Corporate:"corporate",Shared:"shared",GoogleDrive:"google",Dropbox:"dropbox"},Ci.FileStorageLinkType={Unknown:0,GoogleDrive:1,Dropbox:2},Ci.HelpdeskThreadStates={None:0,Pending:1,Waiting:2,Answered:3,Resolved:4,Deferred:5},Ci.HelpdeskPostType={Normal:0,Internal:1,System:2},Ci.HelpdeskFilters={All:0,Pending:1,Resolved:2,InWork:3,Open:4,Archived:9},Ci.CalendarAccess={Full:0,Write:1,Read:2},Ci.CalendarEditRecurrenceEvent={None:0,OnlyThisInstance:1,AllEvents:2},Ci.CalendarRepeatPeriod={None:0,Daily:1,Weekly:2,Monthly:3,Yearly:4},Ci.PhoneAction={Offline:"offline",OfflineError:"offline_error",OfflineInit:"offline_init",OfflineActive:"offline_active",Online:"online",OnlineActive:"online_active",Incoming:"incoming",IncomingConnect:"incoming_connect",Outgoing:"outgoing",OutgoingConnect:"outgoing_connect",Settings:"settings"},Ci.HtmlEditorImageSizes={Small:"small",Medium:"medium",Large:"large",Original:"original"},Ci.MobilePanel={Groups:1,Items:2,View:3},Ci.PgpAction={Import:"import",Generate:"generate",Encrypt:"encrypt",Sign:"sign",EncryptSign:"encrypt-sign",Verify:"ferify",DecryptVerify:"decrypt-ferify"},Ci.SocialType={Unknown:0,Google:1,Dropbox:2,Facebook:3,Twitter:4,Vkontakte:5},Ci.notificationPermission={Granted:"granted",Denied:"denied",Default:"default"},Ci.AnotherMessageComposedAnswer={Discard:"Discard",SaveAsDraft:"SaveAsDraft",Cancel:"Cancel"},Ei.inArray=e.inArray,Ei.isFunc=e.isFunction,Ei.trim=e.trim,Ei.emptyFunction=function(){},Ei.isUnd=function(e){return void 0===e},Ei.isNull=function(e){return null===e},Ei.isNormal=function(e){return!Ei.isUnd(e)&&!Ei.isNull(e)},Ei.isNumeric=function(e){return Ei.isNormal(e)?/^[1-9]+[0-9]*$/.test(e.toString()):!1},Ei.pInt=function(e){var i=t.parseInt(e,10);return isNaN(i)&&(i=0),i},Ei.pString=function(e){return Ei.isNormal(e)?e.toString():""},Ei.isNonEmptyArray=function(e,t){return t=t||1,_.isArray(e)&&t<=e.length},Ei.pImport=function(e,t,i){e[t]=i},Ei.pExport=function(e,t,i){return Ei.isUnd(e[t])?i:e[t]},Ei.encodeHtml=function(e){return e?e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""},Ei.i18n=function(e,t,i,s){var o="",n=Ei.isUnd(Ti[e])?Ei.isNormal(i)?i:e:Ti[e];if(Ei.isUnd(s)||(n=function(e,t){var i=Ei.getPlural(Mi.User.DefaultLanguage,e),s=t.split("|");return s&&s[i]?s[i]:s&&s[0]?s[0]:t}(s,n)),Ei.isNormal(t))for(o in t)t.hasOwnProperty(o)&&(n=n.replace("%"+o+"%",t[o]));return n},Ei.roundNumber=function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},Ei.friendlySize=function(e){var t=1024,i=t*t,s=t*t*t;return e=Ei.pInt(e),e>=s?Ei.roundNumber(e/s,1)+Ei.i18n("MAIN/GIGABYTES"):e>=i?Ei.roundNumber(e/i,1)+Ei.i18n("MAIN/MEGABYTES"):e>=t?Ei.roundNumber(e/t,0)+Ei.i18n("MAIN/KILOBYTES"):e+Ei.i18n("MAIN/BYTES")},Ei.timeOutAction=function(){var e={};return function(i,s,o){Ei.isUnd(e[i])&&(e[i]=0),t.clearTimeout(e[i]),e[i]=t.setTimeout(s,o)}}(),Ei.$log=null,Ei.aLog=[],Ei.log=function(){function t(e,t){return"string"==typeof t&&t.length>50?t.substring(0,50):t}if(Mi&&Mi.ClientDebug&&Fi.browser&&!Fi.browser.ie9AndBelow){var i=Ei.$log||e('<div style="display: none;"></div>').appendTo("body"),s=[];_.each(arguments,function(e){var i="string"==typeof e?e:JSON.stringify(e,t);0===s.length&&(i=" *** "+i+" *** "),s.push(i)}),s.push(moment().format(" *** D MMMM, YYYY, HH:mm:ss *** ")),Ei.$log=i,Ei.aLog.length>200&&Ei.aLog.shift(),Ei.aLog.push(Ei.encodeHtml(s.join(", "))),i.html(Ei.aLog.join("<br /><br />"))}},Ei.getAjaxDataForLog=function(e,t){var i=t;if(t&&t.Result)switch(e){case"MessagesGetList":case"MessagesGetListByUids":i={Result:{Uids:t.Result.Uids,UidNext:t.Result.UidNext,FolderHash:t.Result.FolderHash,MessageCount:t.Result.MessageCount,MessageUnseenCount:t.Result.MessageUnseenCount,MessageResultCount:t.Result.MessageResultCount}};break;case"MessageGet":i={Result:{Folder:t.Result.Folder,Uid:t.Result.Uid,Subject:t.Result.Subject,Size:t.Result.Size,TextSize:t.Result.TextSize,From:t.Result.From,To:t.Result.To}};break;case"MessagesGetBodies":i={Result:_.map(t.Result,function(e){return{Uid:e.Uid,Subject:e.Subject}})}}else t&&(i={Result:t.Result,ErrorCode:t.ErrorCode});return i},Ei.getEmailParts=function(e){for(var t=e.indexOf('"'),i=e.indexOf('"',t+1),s=e.indexOf("<",i),o=-1,n=-1,r="",a="";-1!==s;)o=s,s=e.indexOf("<",s+1);return s=o,n=e.indexOf(">",s+1),-1===s?a=Ei.trim(e):(r=Ei.trim(-1===t?e.substring(0,s):e.substring(t+1,i)),a=Ei.trim(e.substring(s+1,n))),{name:r,email:a,FullEmail:e}},Ei.isCorrectEmail=function(e){return!!e.match(/^[A-Z0-9\"!#\$%\^\{\}`~&'\+\-=_\.]+@[A-Z0-9\.\-]+$/i)},Ei.getIncorrectEmailsFromAddressString=function(e){for(var t=e.replace(/"[^"]*"/g,"").replace(/;/g,",").split(","),i=[],s=0,o=t.length,n="",r=null;o>s;s++)n=Ei.trim(t[s]),n.length>0&&(r=Ei.getEmailParts(Ei.trim(t[s])),Ei.isCorrectEmail(r.email)||i.push(r.email));return i},Ei.getArrayRecipients=function(e,t){if(!e)return[];for(var i=[],s=Ei.trim(e)+" ",o=0,n=0,r=!1,a='"',l=!1,h=!1,c=0,u=s.length,d="",p="",m=null,g=!1,f=0,b=0;u>c;){switch(d=s.substring(c,c+1)){case"'":case'"':r?a===d&&(r=!1):l||h||(a=d,r=!0);break;case"<":r||l||h||(l=!0);break;case">":l&&(l=!1);break;case"(":r||l||h||(h=!0);break;case")":h&&(h=!1);break;default:if(","!==d&&";"!==d&&c!==u-1)break;if(!l&&!h&&!r){if(n=c!==u-1?c:u,p=s.substring(o,n),Ei.trim(p).length>0){for(m=Ei.getEmailParts(p),g=!1,f=i.length,b=0;f>b;b++)i[b].email===m.email&&(g=!0);g||!t&&!Ei.isCorrectEmail(m.email)||i.push(m)}o=c+1}}c++}return i},Ei.getImportContactsLink=function(){return"?/ImportContacts/"},Ei.getExportContactsLink=function(e){return"?/Raw/Contacts"+e+"/"},Ei.getExportCalendarLinkByHash=function(e,t){return"?/Raw/Calendar/"+e+"/"+t},Ei.getDownloadLinkByHash=function(e,t,i,s){return i=Ei.isUnd(i)?!1:!!i,s=Ei.isUnd(s)?"":s,"?/Raw/Download/"+e+"/"+t+"/"+(i?"1":"0")+(""===s?"":"/"+s)},Ei.getViewLinkByHash=function(e,t,i,s){return i=Ei.isUnd(i)?!1:!!i,s=Ei.isUnd(s)?"":s,"?/Raw/View/"+e+"/"+t+"/"+(i?"1":"0")+(""===s?"":"/"+s)},Ei.getIframeLinkByHash=function(e,t,i,s){return i=Ei.isUnd(i)?!1:!!i,s=Ei.isUnd(s)?"":s,"?/Raw/Iframe/"+e+"/"+t+"/"+(i?"1":"0")+(""===s?"":"/"+s)},Ei.getIframeWrappwer=function(e,i){return"?/Raw/Iframe/"+e+"/"+t.encodeURIComponent(i)+"/"},Ei.getViewThumbnailLinkByHash=function(e,t,i,s){return i=Ei.isUnd(i)?!1:!!i,s=Ei.isUnd(s)?"":s,"?/Raw/Thumbnail/"+e+"/"+t+"/"+(i?"1":"0")+(""===s?"":"/"+s)},Ei.getFilestorageDownloadLinkByHash=function(e,t,i){var s="?/Raw/FilesDownload/"+e+"/"+t;return Ei.isUnd(i)||(s=s+"/0/"+i),s},Ei.getFilestorageViewLinkByHash=function(e,t,i){var s="?/Raw/FilesView/"+e+"/"+t;return Ei.isUnd(i)||(s=s+"/0/"+i),s},Ei.getFilestorageViewThumbnailLinkByHash=function(e,t,i){var s="?/Raw/FilesThumbnail/"+e+"/"+t;return Ei.isUnd(i)||(s=s+"/0/"+i),s},Ei.getFilestoragePublicViewLinkByHash=function(e){return"?/Window/Files/0/"+e},Ei.getFilestoragePublicDownloadLinkByHash=function(e){return"?/Raw/FilesPub/0/"+e},Ei.daysInMonth=function(e,t){return e>0&&13>e&&t>0?new Date(t,e,0).getDate():31},Ei.getAppPath=function(){return t.location.protocol+"//"+t.location.host+t.location.pathname},Ei.WindowOpener={_iDefaultRatio:.8,_aOpenedWins:[],openMessage:function(e,t){if(e){var i=e.folder(),s=e.uid(),o="",n=null;o=Fi.Routing.buildHashFromArray(t?[Ci.Screens.SingleCompose,"drafts",i,s]:[Ci.Screens.SingleMessageView,i,"msg"+s]),n=this.openTab(o)}},openTab:function(i,s){e.cookie("aft-cache-ctrl","1");var o=null;return o=t.open(i,"_blank"),o.focus(),o.name=s?s:Mi.Accounts?Mi.Accounts.currentId():0,this._aOpenedWins.push(o),o},open:function(e,i,s){var o=s?",menubar=yes":",menubar=no",n="location=no,toolbar=no,status=no,scrollbars=yes,resizable=yes"+o,r=null;return i=i.replace(/\W/g,""),n+=this._getSizeParameters(),r=t.open(e,i,n),r.focus(),r.name=Mi.Accounts?Mi.Accounts.currentId():0,this._aOpenedWins.push(r),r},getOpenedDraftUids:function(){this._aOpenedWins=_.filter(this._aOpenedWins,function(e){return!e.closed});var e=_.map(this._aOpenedWins,function(e){return e.App?e.App.MailCache.editedDraftUid():""});return Fi.Screens.hasOpenedMinimizedPopups()&&e.push(Fi.MailCache.editedDraftUid()),_.uniq(_.compact(e))},closeComposesWithDraftUids:function(e){_.each(this._aOpenedWins,function(t){t.App&&-1!==Ei.inArray(t.App.MailCache.editedDraftUid(),e)&&t.close()}),-1!==Ei.inArray(Fi.MailCache.editedDraftUid(),e)&&Fi.Api.closeComposePopup()},closeAll:function(){for(var e=this._aOpenedWins.length,t=0,i=null;e>t;t++)i=this._aOpenedWins[t],i.closed||i.close();this._aOpenedWins=[]},_getSizeParameters:function(){var e=t.screen.width,i=Math.ceil(e*this._iDefaultRatio),s=Math.ceil((e-i)/2),o=t.screen.height,n=Math.ceil(o*this._iDefaultRatio),r=Math.ceil((o-n)/2);return",width="+i+",height="+n+",top="+r+",left="+s}},Ei.delegateRun=function(e,t,i){e&&e[t]&&e[t].apply(e,_.isArray(i)?i:[])},Ei.strRepeat=function(e,t){return new Array(t+1).join(e)},Ei.deferredUpdate=function(e,i,s,o){!e.__interval&&i?(e.__state=!0,o(e,!0),e.__interval=t.setInterval(function(){e.__state||(o(e,!1),t.clearInterval(e.__interval),e.__interval=null)},s)):i||(e.__state=!1)},Ei.draggableMessages=function(){return e('<div class="draggable draggableMessages"><div class="content"><span class="count-text"></span></div></div>').appendTo("#pSevenHidden")},Ei.draggableContacts=function(){return e('<div class="draggable draggableContacts"><div class="content"><span class="count-text"></span></div></div>').appendTo("#pSevenHidden")},Ei.removeActiveFocus=function(){if(document&&document.activeElement&&document.activeElement.blur){var t=e(document.activeElement);(t.is("input")||t.is("textarea"))&&document.activeElement.blur()}},Ei.uiDropHelperAnim=function(i,s){var o=0,n=0,r=0,a=0,l=0,h=0,c=s.helper.clone().appendTo("#pSevenHidden"),u=e(i.target).find(".animGoal"),d=null;u=e(u[0]?u[0]:i.target),d=u&&u[0]?u.offset():null,d&&(o=t.Math.round(d.left),n=t.Math.round(d.top),l=u.width(),h=u.height(),r=o,l>0&&(r+=t.Math.round(l/2)),a=n,h>0&&(a+=t.Math.round(h/2)),c.animate({left:r+"px",top:a+"px","font-size":"0px",opacity:0},800,"easeOutQuint",function(){e(this).remove()}))},Ei.isTextFieldFocused=function(){var e=document&&document.activeElement?document.activeElement:null,t=e?e.tagName:null,i=e&&e.type?e.type.toLowerCase():null,s=e?e.contentEditable:null;return"INPUT"===t&&("text"===i||"password"===i||"email"===i)||"TEXTAREA"===t||"IFRAME"===t||"true"===s},Ei.removeSelection=function(){t.getSelection?t.getSelection().removeAllRanges():document.selection&&document.selection.empty()},Ei.getMonthNamesArray=function(){for(var e=Ei.i18n("DATETIME/MONTH_NAMES").split(" "),t=12,i=e.length;t>i;i++)e[i]="";return e},Ei.getPlural=function(e,t){var i=0;switch(t=Ei.pInt(t),e){case"Arabic":i=0===t?0:1===t?1:2===t?2:t%100>=3&&10>=t%100?3:t%100>=11?4:5;break;case"Bulgarian":i=1===t?0:1;break;case"Chinese-Simplified":i=0;break;case"Chinese-Traditional":i=1===t?0:1;break;case"Czech":i=1===t?0:t>=2&&4>=t?1:2;break;case"Danish":i=1===t?0:1;break;case"Dutch":i=1===t?0:1;break;case"English":i=1===t?0:1;break;case"Estonian":i=1===t?0:1;break;case"Finish":i=1===t?0:1;break;case"French":i=1===t?0:1;break;case"German":i=1===t?0:1;break;case"Greek":i=1===t?0:1;break;case"Hebrew":i=1===t?0:1;break;case"Hungarian":i=1===t?0:1;break;case"Italian":i=1===t?0:1;break;case"Japanese":i=0;break;case"Korean":i=0;break;case"Latvian":i=t%10===1&&t%100!==11?0:0!==t?1:2;break;case"Lithuanian":i=t%10===1&&t%100!==11?0:t%10>=2&&(10>t%100||t%100>=20)?1:2;break;case"Norwegian":i=1===t?0:1;break;case"Persian":i=0;break;case"Polish":i=1===t?0:t%10>=2&&4>=t%10&&(10>t%100||t%100>=20)?1:2;break;case"Portuguese-Portuguese":i=1===t?0:1;break;case"Portuguese-Brazil":i=1===t?0:1;break;case"Romanian":i=1===t?0:0===t||t%100>0&&20>t%100?1:2;break;case"Russian":i=t%10===1&&t%100!==11?0:t%10>=2&&4>=t%10&&(10>t%100||t%100>=20)?1:2;break;case"Serbian":i=t%10===1&&t%100!==11?0:t%10>=2&&4>=t%10&&(10>t%100||t%100>=20)?1:2;break;case"Spanish":i=1===t?0:1;break;case"Swedish":i=1===t?0:1;break;case"Thai":i=0;break;case"Turkish":i=1===t?0:1;break;case"Ukrainian":i=t%10===1&&t%100!==11?0:t%10>=2&&4>=t%10&&(10>t%100||t%100>=20)?1:2;break;default:i=0}return i},Ei.getFileExtension=function(e){var t="",i=e.lastIndexOf(".");return i>-1&&(t=e.substr(i+1)),t},Ei.getFileNameWithoutExtension=function(e){var t=e,i=e.lastIndexOf(".");return i>-1&&(t=e.substr(0,i)),t},Ei.defaultOptionsAfterRender=function(e,t){t&&(Ei.isUnd(t.disable)||i.applyBindingsToNode(e,{disable:t.disable},t))},Ei.getDateFormatForMoment=function(e){var t="MM/DD/YYYY";switch(e){case"MM/DD/YYYY":t="MM/DD/YYYY";break;case"DD/MM/YYYY":t="DD/MM/YYYY";break;case"DD Month YYYY":t="DD MMMM YYYY"}return t},Ei.getDateFormatForDatePicker=function(e){var t="mm/dd/yy";switch(e){case"MM/DD/YYYY":t="mm/dd/yy";break;case"DD/MM/YYYY":t="dd/mm/yy";break;case"DD Month YYYY":t="dd MM yy"}return t},Ei.getDateFormatsForSelector=function(){return _.map(Mi.App.DateFormats,function(e){switch(e){case"MM/DD/YYYY":return{name:Ei.i18n("DATETIME/DATEFORMAT_MMDDYYYY"),value:e};case"DD/MM/YYYY":return{name:Ei.i18n("DATETIME/DATEFORMAT_DDMMYYYY"),value:e};case"DD Month YYYY":return{name:Ei.i18n("DATETIME/DATEFORMAT_DDMONTHYYYY"),value:e};default:return{name:e,value:e}}})},Ei.getTitleForEvent=function(e){var t=e?Ei.trim(e.replace(/[\n\r]/," ")):"",i=t.indexOf(" ",180);return i>=0&&(t=t.substring(0,i)+"..."),t.length>200&&(t=t.substring(0,200)+"..."),t},Ei.desktopNotify=function(){var e=[],i=0;return function(s){if(Mi.User.DesktopNotifications&&t.Notification&&!Fi.focused())if(s&&"show"===s.action&&t.Notification.permission!==Ci.notificationPermission.Denied){var o,n={body:s.body||"",dir:s.dir||"auto",lang:s.lang||"",tag:s.tag||Math.floor(900*Math.random()+100),icon:s.icon||!1},r=function(){o=new t.Notification(s.title,n),o.onclick=function(){s.callback&&s.callback(),o.close()},o.onshow=function(){},o.onclose=function(){},o.onerror=function(){},s.timeout&&(i=setTimeout(function(){o.close()},s.timeout)),e.push(o)};"granted"===t.Notification.permission?r():"default"===t.Notification.permission&&t.Notification.requestPermission(function(e){"granted"===e&&r()})}else s&&"hide"===s.action?_.each(e,function(t,i){s.tag===t.tag&&(t.close(),e.splice(i,1))}):s&&"hideAll"===s.action&&(_.each(e,function(e){e.close()}),e.length=0)}}(),Ei.isRTL=function(){return Ri.hasClass("rtl")},Ei.validateFileOrFolderName=function(e){return e=Ei.trim(e),""!==e&&!/["\/\\*?<>|:]/.test(e)},Ei.shadeColor=function(e,i){var s=!1,o=0,n=0,r=0,a=0;return"#"===e[0]&&(e=e.slice(1),s=!0),o=t.parseInt(e,16),n=(o>>16)+i,n>255?n=255:0>n&&(n=0),r=(o>>8&255)+i,r>255?r=255:0>r&&(r=0),a=(255&o)+i,a>255?a=255:0>a&&(a=0),(s?"#":"")+(a|r<<8|n<<16).toString(16)},Ei.extend=function(e,t){var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e},Ei.thumbQueue=function(){var e={},t={},i=2;return function(s,o,n){o&&n?!(s in t)||t[s]>0?(s in t||(t[s]=i,e[s]=[]),t[s]--,n(o)):e[s].push({imageSrc:o,imageSrcObserver:n,messageUid:s}):e[s]&&e[s].length&&(e[s][0].imageSrcObserver(e[s][0].imageSrc),e[s].shift())}}(),Ei.checkConnection=function(){var e=-1,t=(new Date).getTime(),i=0,s=!1;return setInterval(function(){i=(new Date).getTime(),s=i>t+5e3+1e3,t=i,s&&Fi.Api.hideError(!0)},5e3),function(t,i){clearTimeout(e),"error"!==i?(Fi.InternetConnectionError=!1,Fi.Api.hideError(!0)):"SystemPing"===t?(Fi.InternetConnectionError=!0,Fi.Api.showError(Ei.i18n("WARNING/NO_INTERNET_CONNECTION"),!1,!0,!0),e=setTimeout(function(){Fi.Ajax.send({Action:"SystemPing"})},6e4)):Fi.Ajax.send({Action:"SystemPing"})}}(),Ei.loadScript=function(e,i,s,o){var n=document.createElement("script");!Ei.isUnd(o)&&i&&(t[o]=i),Ei.isUnd(s)&&(s={}),_.each(s,function(e,t){n.setAttribute(t,e)}),n.type="text/javascript",n.src=e,document.body.appendChild(n)},Ei.registerMailto=function(e){!t.navigator||!Ei.isFunc(t.navigator.registerProtocolHandler)||e&&1===Fi.Storage.getData("MailtoAsked")||(t.navigator.registerProtocolHandler("mailto",Ei.getAppPath()+"#"+Ci.Screens.Compose+"/to/%s",""!==Mi.App.SiteName?Mi.App.SiteName:"WebMail"),Fi.Storage.setData("MailtoAsked",1))},Ei.CustomTooltip={_$Region:null,_$ArrowTop:null,_$Text:null,_$ArrowBottom:null,_iArrowBorderLeft:0,_iArrowMarginLeft:0,_iLeftShift:0,_bInitialized:!1,_bShown:!1,init:function(){this._bInitialized||(this._$Region=e('<span class="custom_tooltip"></span>').appendTo("body").hide(),this._$ArrowTop=e('<span class="custom_tooltip_arrow top"></span>').appendTo(this._$Region),this._$Text=e('<span class="custom_tooltip_text"></span>').appendTo(this._$Region),this._$ArrowBottom=e('<span class="custom_tooltip_arrow bottom"></span>').appendTo(this._$Region),this._iArrowMarginLeft=Ei.pInt(this._$ArrowTop.css("margin-left")),this._iArrowBorderLeft=Ei.pInt(this._$ArrowTop.css("border-left-width")),this._iLeftShift=Ei.pInt(this._$Region.css("margin-left"))+this._iArrowMarginLeft+this._iArrowBorderLeft,this._bInitialized=!0),this._$ArrowTop.show(),this._$ArrowBottom.hide(),this._$ArrowTop.css({"margin-left":this._iArrowMarginLeft+"px"}),this._$ArrowBottom.css({"margin-left":this._iArrowMarginLeft+"px"})},show:function(t,i){this.init();var s=i.offset(),o=i.width(),n=70>o?o/2:o/4,r=Ei.pInt(i.css("padding-left")),a=e("body");this._$Text.html(t),this._bShown=!0,this._$Region.fadeIn(260,_.bind(function(){this._bShown||this._$Region.hide()},this)).css({top:s.top+i.outerHeight()+1,left:s.left+r+n-this._iLeftShift,right:"auto"}),a.outerHeight()<this._$Region.outerHeight()+this._$Region.offset().top&&(this._$ArrowTop.hide(),this._$ArrowBottom.show(),this._$Region.css({top:s.top-this._$Region.outerHeight()})),setTimeout(function(){a.width()<this._$Region.outerWidth(!0)+this._$Region.offset().left&&(this._$Region.css({left:"auto",right:0}),this._$ArrowTop.css({"margin-left":n+s.left-this._$Region.offset().left-this._iArrowBorderLeft+"px"}),this._$ArrowBottom.css({"margin-left":n+s.left-this._$Region.offset().left-this._iArrowBorderLeft+Ei.pInt(this._$Region.css("margin-right"))+"px"}))}.bind(this),1)},hide:function(){this._bInitialized&&(this._bShown=!1,this._$Region.hide())}},Ei.getRequestParam=function(e){var t=[],i=[],s=[],o=location.search,n=null;if(""!==o){t=o.substr(1).split("&");for(var r=0;r<t.length;r++)i=t[r].split("="),s[i[0]]=i[1]}return Ei.isUnd(s[e])||(n=s[e]),n},Ei.htmlStartsWithBlockquote=function(e){var t=e.split("<blockquote"),i=t.length>0?t[0]:"",s=Ei.trim(i.replace(/<[^>]*>/g,""));return""===s},i.bindingHandlers.command={init:function(t,s,o,n){var r=e(t),a=s();if(!a||!a.enabled||!a.canExecute)throw new Error("You are not using command function");r.addClass("command"),i.bindingHandlers[r.is("form")?"submit":"click"].init.apply(n,arguments)},update:function(t,i){var s=!0,o=e(t),n=i();s=n.enabled(),o.toggleClass("command-not-enabled",!s),s&&(s=n.canExecute(),o.toggleClass("unavailable",!s)),o.toggleClass("command-disabled disable disabled",!s),o.toggleClass("command-disabled",!s)}},i.bindingHandlers.simpleTemplate={init:function(t){var i=e(t);i.length>0&&"replaced"!==i.data("replaced")&&(i.html(i.html().replace(/&lt;script(.*?)&gt;/i,"<script$1>").replace(/&lt;\/script(.*?)&gt;/i,"</script>")),i.data("replaced","replaced"))}},i.bindingHandlers.findFocused={init:function(t){var i=e(t),s=null;s=i.find(".catch-focus"),s&&1===s.length&&s[0]&&s.on("blur",function(){i.removeClass("focused")}).on("focus",function(){i.addClass("focused")})}},i.bindingHandlers.findFilled={init:function(t){var i=e(t),s=null,o=null;s=i.find(".catch-filled"),s&&1===s.length&&s[0]&&(o=function(){i.toggleClass("filled",""!==s.val())},o(),_.delay(o,200),s.on("change",o))}},i.bindingHandlers.alert={init:function(e,s){t.alert(i.utils.unwrapObservable(s()))},update:function(e,s){t.alert(i.utils.unwrapObservable(s()))}},i.bindingHandlers.onEnter={init:function(s,o,n,r){i.bindingHandlers.event.init(s,function(){return{keyup:function(i,n){n&&13===t.parseInt(n.keyCode,10)&&(e(s).trigger("change"),o().call(this,i))}}},n,r)}},i.bindingHandlers.onCtrlEnter={init:Pi?null:function(s,o,n,r){i.bindingHandlers.event.init(s,function(){return{keydown:function(i,n){return n&&13===t.parseInt(n.keyCode,10)&&n.ctrlKey?(e(s).trigger("change"),o().call(this,i),!1):!0}}},n,r)}},i.bindingHandlers.onEsc={init:Pi?null:function(s,o,n,r){i.bindingHandlers.event.init(s,function(){return{keyup:function(i,n){n&&27===t.parseInt(n.keyCode,10)&&(e(s).trigger("change"),o().call(this,i))}}},n,r)}},i.bindingHandlers.onFocusSelect={init:function(e,t,s,o){i.bindingHandlers.event.init(e,function(){return{focus:function(){e.select()}}},s,o)}},i.bindingHandlers.onEnterChange={init:function(s,o,n,r){i.bindingHandlers.event.init(s,function(){return{keyup:function(i,o){o&&13===t.parseInt(o.keyCode,10)&&e(s).trigger("change")}}},n,r)}},i.bindingHandlers.fadeIn={update:function(t,s){i.utils.unwrapObservable(s())&&e(t).hide().fadeIn("fast")}},i.bindingHandlers.fadeOut={update:function(t,s){i.utils.unwrapObservable(s())&&e(t).fadeOut()}},i.bindingHandlers.csstext={init:function(t,s){t&&t.styleSheet&&!Ei.isUnd(t.styleSheet.cssText)?t.styleSheet.cssText=i.utils.unwrapObservable(s()):e(t).text(i.utils.unwrapObservable(s()))},update:function(t,s){t&&t.styleSheet&&!Ei.isUnd(t.styleSheet.cssText)?t.styleSheet.cssText=i.utils.unwrapObservable(s()):e(t).text(i.utils.unwrapObservable(s()))}},i.bindingHandlers.i18n={init:function(t,i){var s=e(t).data("i18n"),o=s?Ei.i18n(s):s;if(""!==o)switch(i()){case"value":e(t).val(o);break;case"text":e(t).text(o);break;case"html":e(t).html(o);break;case"title":e(t).attr("title",o);break;case"placeholder":e(t).attr({placeholder:o})}}},i.bindingHandlers.link={init:function(t,s){e(t).attr("href",i.utils.unwrapObservable(s()))}},i.bindingHandlers.title={init:function(t,s){e(t).attr("title",i.utils.unwrapObservable(s()))},update:function(t,s){e(t).attr("title",i.utils.unwrapObservable(s()))}},i.bindingHandlers.initDom={init:function(t,i){if(i())if(_.isArray(i()))for(var s=i(),o=s.length-1;o>=0;o--)s[o](e(t));else i()(e(t))}},i.bindingHandlers.customScrollbar={init:Pi?null:function(t,i){if(!Ni){var s=e(t),o=i();o=o,s.addClass("scroll-wrap").customscroll(o),Ei.isUnd(o.reset)||(t._customscroll_reset=_.throttle(function(){s.data("customscroll").reset()},100)),!Ei.isUnd(o.scrollToTopTrigger)&&Ei.isFunc(o.scrollToTopTrigger.subscribe)&&o.scrollToTopTrigger.subscribe(function(){s.data("customscroll")&&s.data("customscroll").scrollToTop()}),!Ei.isUnd(o.scrollToBottomTrigger)&&Ei.isFunc(o.scrollToBottomTrigger.subscribe)&&o.scrollToBottomTrigger.subscribe(function(){s.data("customscroll")&&s.data("customscroll").scrollToBottom()}),!Ei.isUnd(o.scrollTo)&&Ei.isFunc(o.scrollTo.subscribe)&&o.scrollTo.subscribe(function(){s.data("customscroll")&&s.data("customscroll").scrollTo(o.scrollTo())})}},update:Pi?null:function(t,i){Ni||(t._customscroll_reset&&t._customscroll_reset(),Ei.isUnd(i().top)||e(t).data("customscroll").vertical.set(i().top))}},i.bindingHandlers.customOptions={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,s,o,n){for(var r=0,a=0,l=i.utils.arrayMap(i.utils.arrayFilter(e.childNodes,function(e){return e.tagName&&"OPTION"===e.tagName&&e.selected}),function(e){return i.selectExtensions.readValue(e)||e.innerText||e.textContent}),h=e.scrollTop,c=i.utils.unwrapObservable(t());e.length>0;)i.cleanNode(e.options[0]),e.remove(0);if(c){"number"!=typeof c.length&&(c=[c]);var u=s().optionsBind;for(r=0,a=c.length;a>r;r++){var d=document.createElement("OPTION"),p=i.utils.unwrapObservable(c[r]);i.selectExtensions.writeValue(d,p),d.appendChild(document.createTextNode(p)),e.appendChild(d),u&&(d.setAttribute("data-bind",u),i.applyBindings(n.createChildContext(p),d))}var m=e.getElementsByTagName("OPTION"),g=0,f=navigator.userAgent.indexOf("MSIE 6")>=0;for(r=0,a=m.length;a>r;r++)i.utils.arrayIndexOf(l,i.selectExtensions.readValue(m[r]))>=0&&(f?m[r].setAttribute("selected",!0):m[r].selected=!0,g++);e.scrollTop=h,g<l.length&&i.utils.triggerEvent(e,"change")}}},i.bindingHandlers.splitter={init:Pi?null:function(t,i){setTimeout(function(){e(t).splitter(i())},1)}},i.bindingHandlers.dropdown={init:function(i,s,o,n){var r,a,l,h=e(i),c=_.defaults(s(),{disabled:"disabled",expand:"expand",control:!0,container:".dropdown_content",scrollToTopContainer:".scroll-inner",passClick:!0,trueValue:!0}),u=c.control?h.find(".control"):h,d=h.find(".dropdown"),p=h.find(".dropdown_helper"),m=h.find(".dropdown_arrow"),g=h.find(".dropdown_arrow.bottom"),f=e(document),b=!1,y=function(){Ei.isUnd(c.callback)||c.callback.call(n,h.hasClass(c.expand)?c.trueValue:!1,h)},S=function(e){e.stopPropagation()},v=function(){c.scrollToTopContainer&&h.find(c.scrollToTopContainer).scrollTop(0)},A=function(e){Ei.isUnd(e)&&(e=!h.hasClass(c.expand)),!e&&h.hasClass(c.expand)&&v(),h.toggleClass(c.expand,e),g.length>0&&h.hasClass(c.expand)&&d.css({top:h.position().top-p.height()+"px",left:h.position().left+"px",width:"auto"})},C=function(i){r=p.offset(),Ei.isUnd(r)||(a=r.left+10,l=e(t).width()-(a+p.outerWidth(!0)),l>0&&(l=0),p.css("left",i||l+"px"),m.css("left",i||Math.abs(l?l+parseInt(m.css("margin-left")):0)+"px"))};c.passClick||(h.find(c.container).click(S),u.click(S)),A(!1),c.close&&c.close.subscribe&&c.close.subscribe(function(e){e||(f.unbind("click.dropdown"),A(!1)),y()}),h.on("mousedown",function(t){b=e(t.target).hasClass("customscroll-scrollbar")||e(t.target.parentElement).hasClass("customscroll-scrollbar")}),u.click(function(){h.hasClass(c.disabled)||b||(A(),_.defer(function(){y()}),h.hasClass(c.expand)&&(c.close&&c.close.subscribe&&c.close(!0),_.defer(function(){f.on("click.dropdown",function(e){!c.passClick&&e.button===Ci.MouseKey.Right||b||(f.unbind("click.dropdown"),c.close&&c.close.subscribe&&c.close(!1),A(!1),y(),C(0)),b=!1})}),C()))})}},i.bindingHandlers.customSelect={init:function(t,i,s,o){var n=e(t),r=_.defaults(i(),{disabled:"disabled",selected:"selected",expand:"expand",control:!0,input:!1,expandState:function(){}}),a=[],l=r.control?n.find(".control"):n,h=n.find(".dropdown_content"),c=n.find(".link"),u=function(t){_.each(a,function(e){e.removeClass(r.selected)});var i=_.find(r.options,function(e){return e[r.optionsValue]===t});return Ei.isUnd(i)?i=r.options[0]:(a[_.indexOf(r.options,i)].addClass(r.selected),c.text(e.trim(i[r.optionsText]))),i[r.optionsValue]},d=function(t){h.empty(),a=[],_.each(t?t:r.options,function(t){var i=e('<span class="item"></span>').text(t[r.optionsText]).data("value",t[r.optionsValue]),s=t.isDisabled;s?i.data("isDisabled",s).addClass("disabled"):i.data("isDisabled",s).removeClass("disabled"),a.push(i),h.append(i)},this)};d(),h.on("click",".item",function(){var t=e(this);t.data("isDisabled")||r.value(t.data("value"))}),!r.input&&r.value&&r.value.subscribe&&(r.value.subscribe(function(){var e=u(r.value());r.value()!==e&&r.value(e)},o),r.value.valueHasMutated()),r.input&&r.value&&r.value.subscribe&&(r.value.subscribe(function(){u(r.value())},o),r.value.valueHasMutated()),r.input&&r.value&&r.value.subscribe&&(r.value.subscribe(function(){u(r.value())
},o),r.value.valueHasMutated()),r.alarmOptions&&r.alarmOptions.subscribe(function(){d()},o),r.timeOptions&&r.timeOptions.subscribe(function(e){d(e)},o),n.removeClass(r.expand),l.click(function(){if(!n.hasClass(r.disabled)&&(n.toggleClass(r.expand),r.expandState(n.hasClass(r.expand)),n.hasClass(r.expand))){var t=n.find(".dropdown_content"),i=t.find(".selected");i.position()&&(t.scrollTop(0),t.scrollTop(i.position().top-100)),_.defer(function(){e(document).one("click",function(){n.removeClass(r.expand),r.expandState(!1)})})}})}},i.bindingHandlers.moveToFolderFilter={init:function(t,i){var s=e(t),o=i(),n=e(t).find(o.container),r=_.isArray(o.options)?o.options:o.options(),a=o.value?o.value():"",l=_.find(r,function(e){return e[o.optionsValue]===a});l||(a="",o.value("")),s.removeClass("expand"),n.empty(),_.each(r,function(t){var i=e('<span class="item"></span>').text(t[o.optionsText]).data("value",t[o.optionsValue]);a===t[o.optionsValue]&&i.addClass("selected"),t.jq=i,n.append(i)}),n.on("click",".item",function(){var t=e(this).data("value");o.value(t)}),s.click(function(){s.toggleClass("expand"),s.hasClass("expand")&&_.defer(function(){e(document).one("click",function(){s.removeClass("expand")})})})},update:function(t,i){var s=e(t),o=i(),n=_.isArray(o.options)?o.options:o.options(),r=o.value?o.value():"",a=_.find(n,function(e){return e[o.optionsValue]===r}),l=s.find(".link");_.each(n,function(e){e.jq&&e.jq.toggleClass("selected",r===e[o.optionsValue])}),a&&l.text(e.trim(a[o.optionsText]))}},i.bindingHandlers.contactCardInMessage={update:Pi||Ni?null:function(i,s){var o=e(i),n=s(),r=n.address,a=e("div.item_viewer[data-email='"+r+"']"),l=!1,h=0,c=function(){a&&o&&(l=!0,clearTimeout(h),setTimeout(function(){var i,s,n,r=o.offset();l&&r.left+r.top!==0&&(i=r.left+10,s=r.top+o.height()+6,n=e(t).width()-(i+396),n>0&&(n=0),a.addClass("expand").offset({top:s,left:i+n}))},180))},u=function(){l&&a&&o&&(l=!1,h=setTimeout(function(){l||a.removeClass("expand")},200))};a.length>0?(o.off().on("mouseover",function(){a.off().on("mouseenter",c).on("mouseleave",u).find(".link, .button").off(".links").on("click.links",function(){l=!1,a.removeClass("expand")}),setTimeout(function(){a.find(".link, .button").off("click.links").on("click.links",function(){l=!1,a.removeClass("expand")})}.bind(this),100),c()}).on("mouseout",u),l=!1,a.removeClass("expand")):o.off()}},i.bindingHandlers.contactcard={init:Pi||Ni?null:function(t,i){var s=e(t),o=!1,n=_.defaults(i(),{disabled:"disabled",expand:"expand",control:!0}),r=n.control?s.find(".control"):s;void 0!==n.trigger&&void 0!==n.trigger.subscribe&&(s.removeClass(n.expand),r.bind({mouseover:function(){!s.hasClass(n.disabled)&&n.trigger()&&(o=!0,_.delay(function(){o&&(void 0!==n.controlWidth&&void 0!==n.controlWidth.subscribe&&n.controlWidth(r.width()),s.addClass(n.expand))},200))},mouseout:function(){n.trigger()&&(o=!1,_.delay(function(){o||s.removeClass(n.expand)},200))}}))}},i.bindingHandlers.checkmail={update:function(t,i){var s=t.oOptions||null,o=t.jqElement||null,n=t.oIconIE||null,r=i(),a=r.state;void 0!==r.state&&(o||(t.jqElement=o=e(t)),s||(t.oOptions=s=_.defaults(r,{activeClass:"process",duration:800})),Ei.deferredUpdate(o,a,s.duration,function(e,i){if(Fi.browser.ie9AndBelow)if(n||(t.oIconIE=n=o.find(".icon")),!n.__intervalIE&&i){var r=0,a="";n.__intervalIE=setInterval(function(){a="0px -"+20*r+"px",r=7>r?r+1:0,n.css({"background-position":a})},1e3/12)}else n.css({"background-position":"0px 0px"}),clearInterval(n.__intervalIE),n.__intervalIE=null;else e.toggleClass(s.activeClass,i)}))}},i.bindingHandlers.heightAdjust={update:function(t,i){var s=t.jqElement||null,o=0,n=i().location,r=i().delay||400;s||(t.jqElement=s=e(t)),_.delay(function(){_.each(i().elements,function(e){var t=e();t&&(o+=t.is(":visible")?t.outerHeight():0)}),"top"===n||void 0===n?s.css({"padding-top":o,"margin-top":-o}):"bottom"===n&&s.css({"padding-bottom":o,"margin-bottom":-o})},r)}},i.bindingHandlers.minHeightAdjust={update:function(t,i){var s=e(t),o=i(),n=o.adjustElement||e("body"),r=o.minHeight||0;o.removeTrigger&&n.css("min-height","inherit"),o.trigger&&_.delay(function(){n.css({"min-height":s.outerHeight(!0)+r})},100)}},i.bindingHandlers.watchWidth={init:function(t,i){var s=!1;s||i().subscribe(function(){i()(e(t).outerWidth()),s=!0},this)}},i.bindingHandlers.columnCalc={init:function(i,s){var o=e(i),n=s().prop,r=null,a=0;r=o.find(s().itemSelector),void 0!==r[0]&&(a=r.outerWidth(!0),a=1>=a?1:a,n&&e(t).bind("resize",function(){var e=o.width();n(e>0?Math.floor(e/a):1)}))}},i.bindingHandlers.listWithMoreButton={init:function(t){var i=e(t),s=!1;i.closest("div.panel.left_panel").resize(function(){var t=i.find("span.hotkey"),o=i.find("span.item"),n=i.find("span.more_hints").show(),r=i.width(),a=n.width(),l=!0;s?s=!1:(_.each(t,function(t,i){var n=e(t),h=n.width();l&&r>a+h?(s=!1,n.show(),e(o[i]).hide(),a+=h):(s=!0,l=!1,n.hide(),e(o[i]).show())}),l&&n.hide())})}},i.bindingHandlers.quickReplyAnim={update:Pi?null:function(t,i){var s=t.jqTextarea||null,o=t.jqStatus||null,n=t.jqButtons||null,r=t.jqElement||null,a=t.oPrevActions||null,l=i(),h=null;h=_.defaults(l,{saveAction:!1,sendAction:!1,activeAction:!1}),r||(t.jqElement=r=e(t),t.jqTextarea=s=r.find("textarea"),t.jqStatus=o=r.find(".status"),t.jqButtons=n=r.find(".buttons"),t.oPrevActions=a={saveAction:null,sendAction:null,activeAction:null}),r.is(":visible")&&(Fi.browser.ie9AndBelow?(!s||r.defualtHeight||s.defualtHeight||(r.defualtHeight=r.outerHeight(),s.defualtHeight=s.outerHeight(),o.defualtHeight=n.outerHeight(),n.defualtHeight=n.outerHeight()),_.defer(function(){var e=a.activeAction!==h.activeAction,t=a.sendAction!==h.sendAction,i=a.saveAction!==h.saveAction;e&&(h.activeAction?(s.animate({height:s.defualtHeight+50},300),r.animate({"max-height":r.defualtHeight+n.defualtHeight+50},300)):(s.animate({height:s.defualtHeight},300),r.animate({"max-height":r.defualtHeight},300))),(t||i)&&(h.sendAction?(r.animate({"max-height":"30px"},300),o.animate({"max-height":"30px",opacity:1},300)):h.saveAction?r.animate({"max-height":0},300):(r.animate({"max-height":r.defualtHeight+n.defualtHeight+50},300),o.animate({"max-height":0,opacity:0},300)))})):(r.toggleClass("saving",h.saveAction),r.toggleClass("sending",h.sendAction),r.toggleClass("active",h.activeAction))),_.defer(function(){a=h})}},i.extenders.reversible=function(e){var t=e();return e.commit=function(){t=e()},e.revert=function(){e(t)},e.commitedValue=function(){return t},e.changed=function(){return t!==e()},e},i.extenders.autoResetToFalse=function(e,i){return e.iTimeout=0,e.subscribe(function(s){s&&(t.clearTimeout(e.iTimeout),e.iTimeout=t.setTimeout(function(){e.iTimeout=0,e(!1)},Ei.pInt(i)))}),e},Ei.createCommand=function(e,t,s){var o=t?function(){return o.canExecute&&o.canExecute()?t.apply(e,Array.prototype.slice.call(arguments)):!1}:function(){};return o.enabled=i.observable(!0),s=Ei.isUnd(s)?!0:s,o.canExecute=i.computed(Ei.isFunc(s)?function(){return o.enabled()&&s.call(e)}:function(){return o.enabled()&&!!s}),o},i.bindingHandlers.autocomplete={init:function(t,i){function s(e){return e.split(/,\s*/)}function o(e){return s(e).pop()}var n=i(),r=e(t);n&&r&&r[0]&&r.autocomplete({minLength:1,autoFocus:!0,source:function(e,t){n(o(e.term),t)},search:function(){var e=o(this.value);return e.length<1?!1:!0},focus:function(){return!1},select:function(e,t){var i=s(this.value),o=null;return i.pop(),i.push(t.item.value),i.push(""),this.value=i.join(", ").slice(0,-2),r.trigger("change"),o=function(e){var t=e.value.length;e.blur(),e.focus(),e.setSelectionRange&&e.setSelectionRange(t,t)},o(r[0]),!1}})}},i.bindingHandlers.autocompleteSimple={init:function(t,i){var s=e(t),o=i(),n=o.callback,r=o.dataAccessor;n&&s&&s[0]&&s.autocomplete({minLength:1,autoFocus:!0,position:{collision:"flip"},source:function(e,t){n(e.term,t)},focus:function(){return!1},select:function(e,t){return _.delay(function(){s.trigger("change")},5),r&&r(t.item),!0}})}},i.bindingHandlers.draggablePlace={init:Pi?null:function(t,s,o,n){if(null===s())return null;var r=o?o():null;e(t).draggable({distance:20,handle:".dragHandle",cursorAt:{top:0,left:0},helper:function(e){return s().apply(n,e&&e.target?[i.dataFor(e.target),e.ctrlKey]:null)},start:r&&r.draggableDragStartCallback?r.draggableDragStartCallback:Ei.emptyFunction,stop:r&&r.draggableDragStopCallback?r.draggableDragStopCallback:Ei.emptyFunction}).on("mousedown",function(){Ei.removeActiveFocus()})}},i.bindingHandlers.droppable={init:Pi?null:function(t,i){var s=i(),o=s.valueFunc,n=s.switchObserv;!1!==o&&e(t).droppable({hoverClass:"droppableHover",drop:function(e,t){o(e,t)}}),n&&o!==!1&&(n.subscribe(function(i){e(t).data().droppable&&e(t).droppable(i?"disable":"enable")},this),n.valueHasMutated())}},i.bindingHandlers.draggable={init:Pi?null:function(t,s){e(t).attr("draggable",i.utils.unwrapObservable(s()))}},i.bindingHandlers.autosize={init:function(t,i){var s=e(t),o=i(),n=s.height(),r=s.outerHeight(),a=s.innerHeight(),l=r-a,h=a-n,c=o.minHeight?o.minHeight:0,u=o.maxHeight?o.maxHeight:0,d=o.scrollableHeight?o.scrollableHeight:1e3,p=o.autosizeTrigger?o.autosizeTrigger:null,m=function(e){var t=0;Fi.browser.firefox&&(t=2*parseInt(s.css("padding-top"),10)),u?setTimeout(function(){s.prop("scrollHeight")<u?(s.height(c-h-l),s.height(s.prop("scrollHeight")+t-h)):s.height(u-h-l)},100):(e||s.prop("scrollHeight")<d)&&setTimeout(function(){s.height(c-h-l),s.height(s.prop("scrollHeight")+t-h)},100)};s.on("keydown",function(){m()}),s.on("paste",function(){m()}),p&&p.subscribe(function(e){m(e)},this),m()}},i.bindingHandlers.customBind={init:function(e,t,s,o){var n=t(),r=n.onKeydown?n.onKeydown:null,a=n.onKeyup?n.onKeyup:null,l=n.onPaste?n.onPaste:null,h=n.onInput?n.onInput:null,c=n.valueObserver?n.valueObserver:null;i.bindingHandlers.event.init(e,function(){return{keydown:function(t,i){return r&&r.call(this,e,i,c),!0},keyup:function(t,i){return a&&a.call(this,e,i,c),!0},paste:function(t,i){return l&&l.call(this,e,i,c),!0},input:function(t,i){return h&&h.call(this,e,i,c),!0}}},s,o)}},i.bindingHandlers.fade={init:function(t,i){var s=e(t),o=e('<span class="faded"></span>'),n=_.defaults(i(),{color:null,css:"fadeout"}),r=n.color,a=n.css,l=function(e){if(""!==e){var t=h(e),i="rgba("+t.r+","+t.g+","+t.b;c(e,i)}},h=function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return e=e.replace(t,function(e,t,i,s){return t+t+i+i+s+s}),i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},c=function(e,t){Ei.isRTL()?o.css("filter","progid:DXImageTransform.Microsoft.gradient(startColorstr='"+e+"', endColorstr='"+e+"',GradientType=1 )").css("background-image","-webkit-gradient(linear, left top, right top, color-stop(0%,"+t+",1)), color-stop(100%,"+t+",0)))").css("background-image","-moz-linear-gradient(left, "+t+",1)0%, "+t+",0)100%)").css("background-image","-webkit-linear-gradient(left, "+t+"1)0%,"+t+",0)100%)").css("background-image","-o-linear-gradient(left, "+t+",1)0%,"+t+",0)100%)").css("background-image","-ms-linear-gradient(left, "+t+",1)0%,"+t+",0)100%)").css("background-image","linear-gradient(left, "+t+",1)0%,"+t+",0)100%)"):o.css("filter","progid:DXImageTransform.Microsoft.gradient(startColorstr='"+e+"', endColorstr='"+e+"',GradientType=1 )").css("background-image","-webkit-gradient(linear, left top, right top, color-stop(0%,"+t+",0)), color-stop(100%,"+t+",1)))").css("background-image","-moz-linear-gradient(left, "+t+",0)0%, "+t+",1)100%)").css("background-image","-webkit-linear-gradient(left, "+t+",0)0%,"+t+",1)100%)").css("background-image","-o-linear-gradient(left, "+t+",0)0%,"+t+",1)100%)").css("background-image","-ms-linear-gradient(left, "+t+",0)0%,"+t+",1)100%)").css("background-image","linear-gradient(left, "+t+",0)0%,"+t+",1)100%)")};s.parent().addClass(a),s.after(o),void 0!==n.color.subscribe&&(l(r()),r.subscribe(function(e){l(e)},this))}},i.bindingHandlers.highlighter={init:function(s,o,n,r){function a(t){if(A){var i=0,s=c.text(),o=s.split(f),n=[],r='<span class="search_highlight">$&</span>';e.each(o,function(t,i){_.any(g,function(e){return e===i})?e.each(i,function(t,i){n.push(e(i.replace(/(.)/,r)))}):e.each(i,function(e,t){n.push(" "===t?document.createTextNode(""):document.createTextNode(t))})}),t?c.empty().append(n):(i=l(),c.empty().append(n),h(i))}}function l(){var e,i,o,n,r=0;return"undefined"!=typeof t.getSelection?(e=t.getSelection().getRangeAt(0),i=e.cloneRange(),i.selectNodeContents(s),i.setEnd(e.endContainer,e.endOffset),r=i.toString().length):"undefined"!=typeof document.selection&&"Control"!==document.selection.type&&(o=document.selection.createRange(),n=document.body.createTextRange(),n.moveToElementText(s),n.setEndPoint("EndToEnd",o),r=n.text.length),r}function h(e){var i,o,n;if(!s)return!1;if(document.createRange)i=document.createRange(),i.selectNodeContents(s),i.setStart(s,e),i.setEnd(s,e),o=t.getSelection(),o.removeAllRanges(),o.addRange(i);else{if(s.createTextRange)return n=s.createTextRange(),n.collapse(!0),n.moveEnd(e),n.moveStart(e),n.select(),!0;if(s.setSelectionRange)return s.setSelectionRange(e,e),!0}return!1}var c=e(s),u=o(),d=u.valueObserver?u.valueObserver:null,p=u.highlighterValueObserver?u.highlighterValueObserver:null,m=u.highlightTrigger?u.highlightTrigger:null,g=["from:","to:","subject:","text:","email:","has:","date:","text:","body:"],f=function(){var t="";return e.each(g,function(e,i){t=e?t+"|\\b"+i:t+"\\b"+i}),new RegExp("("+t+")","g")}(),b=function(e){return e.replace(/\xC2\xA0/g," ").replace(/\xA0/g," ").replace(/[\s]+/g," ")},y=-1,S=t.navigator.language||t.navigator.userLanguage,v=["zh","zh-TW","zh-CN","zh-HK","zh-SG","zh-MO","ja","ja-JP","ko","ko-KR","vi","vi-VN","th","th-TH"],A=!_.include(v,S);i.bindingHandlers.event.init(s,function(){return{keydown:function(e,t){return t.keyCode!==Ci.Key.Enter},keyup:function(e,t){var i=[Ci.Key.Left,Ci.Key.Right,Ci.Key.Home,Ci.Key.End],s=-1!==Ei.inArray(t.keyCode,i);return t.keyCode===Ci.Key.Shift||t.keyCode===Ci.Key.Ctrl||t.keyCode===Ci.Key.Dash||t.keyCode===Ci.Key.Apostrophe||t.keyCode===Ci.Key.Six&&t.shiftKey||s||(t.ctrlKey||y===Ci.Key.Ctrl)&&t.keyCode===Ci.Key.a||(d(b(c.text())),a(!1)),y=t.keyCode,!0},paste:function(){return setTimeout(function(){d(b(c.text())),a(!1)},0),!0}}},n,r),setTimeout(function(){a(!0)},0),m.notifySubscribers(),m.subscribe(function(e){setTimeout(function(){a(!!e)},0)},this),p.subscribe(function(){c.text(d())},this)}},i.bindingHandlers.quoteText={init:function(t,i,s,o){var n=(e(t),e('<span class="button_quote">'+Ei.i18n("HELPDESK/BUTTON_QUOTE")+"</span>")),r=i(),a=r.actionHandler,l=!1,h=null,c="";e("#pSevenContent").append(n),e(document.body).on("click",function(t){l=!!e(t.target).parents(".posts")[0],document.getSelection?(h=document.getSelection(),h&&(c=h.toString())):c=document.selection.createRange().text,l&&""!==c.replace(/[\n\r\s]/,"")?n.css({top:t.clientY+20,left:t.clientX+20}).show():n.hide()}),n.on("click",function(){a.call(o,c)})}},i.bindingHandlers.adjustHeightToContent={init:function(t){var i=e(t),s=null,o=null,n=null;_.delay(_.bind(function(){s=e(_.max(i.find(".title .text"),function(e){return e.offsetWidth})),o=s.parent(),n=o.find(".icon"),i.css("min-width",parseInt(o.css("margin-left"))+parseInt(o.css("padding-left"))+parseInt(n.width())+parseInt(n.css("margin-left"))+parseInt(n.css("margin-right"))+parseInt(n.css("padding-left"))+parseInt(n.css("padding-right"))+parseInt(s.width())+parseInt(s.css("margin-left"))+parseInt(s.css("padding-left"))+10)},this),1)}},i.bindingHandlers.customTooltip={init:Ni||Pi?null:function(t,i){var s,o,n=Ei.i18n(i()),r=e(t),a=r.find("span.dropdown"),l=!1,h=function(){var t=e(this);t.hasClass("expand")||(clearTimeout(o),l=!0,clearTimeout(s),s=setTimeout(function(){l&&(t.hasClass("expand")?(l=!1,clearTimeout(s),Ei.CustomTooltip.hide()):Ei.CustomTooltip.show(n,t))},100))},c=function(){clearTimeout(o),o=setTimeout(function(){l=!1,clearTimeout(s),Ei.CustomTooltip.hide()},10)},u=function(){},d=function(){r.unbind("mouseover",h),r.unbind("mouseout",c),r.unbind("click",c),a.unbind("mouseover",c),a.unbind("mouseout",u),""!==n&&(r.bind("mouseover",h),r.bind("mouseout",c),r.bind("click",c),a.bind("mouseover",c),a.bind("mouseout",u))},p=null;"function"==typeof n&&(n=n()),d(),"function"==typeof i().subscribe&&null===p&&(p=i().subscribe(function(e){n=e,d()}))}},a.prototype.init=function(e){this.defaultScreen=e,o.initialized.removeAll(),o.changed.removeAll(),o.initialized.add(this.parseRouting,this),o.changed.add(this.parseRouting,this),o.init(),o.initialized.removeAll()},a.prototype.finalize=function(){o.dispose(),this.setHashFromString("")},a.prototype.setHashFromString=function(e){var t=location.hash===decodeURIComponent(e);return t||(location.hash=e),t},a.prototype.replaceHashWithoutMessageUid=function(e){if("string"==typeof e&&""!==e){var t=location.hash.replace("/msg"+e,"");this.replaceHashFromString(t)}},a.prototype.replaceHashFromString=function(e){location.hash!==e&&location.replace(e)},a.prototype.setHash=function(e){return this.setHashFromString(this.buildHashFromArray(e))},a.prototype.replaceHash=function(e){this.replaceHashFromString(this.buildHashFromArray(e))},a.prototype.replaceHashDirectly=function(e){o.stop(),this.replaceHashFromString(this.buildHashFromArray(e)),o.init()},a.prototype.setPreviousHash=function(){location.hash=this.previousHash()},a.prototype.buildHashFromArray=function(e){var t=0,i=0,s="";if(_.isArray(e))for(i=e.length;i>t;t++)e[t]=encodeURIComponent(e[t]);else e=[encodeURIComponent(e.toString())];return s=e.join("/"),""!==s&&(s="#"+s),s},a.prototype.getHashFromHref=function(){var e=location.href.indexOf("#"),t="";return-1!==e&&(t=location.href.substr(e+1)),t},a.prototype.isSingleMode=function(){var e=this.getScreenFromHash(),t=e===Ci.Screens.SingleMessageView||e===Ci.Screens.SingleCompose||e===Ci.Screens.SingleHelpdesk;return this.currentScreen=e,t},a.prototype.goDirectly=function(e,t){o.stop(),this.setHash(e),this.parseRouting(t),o.init()},a.prototype.historyBackWithoutParsing=function(){o.stop(),location.hash=this.currentHash(),o.init()},a.prototype.getScreenFromHash=function(){var e=this.getHashFromHref(),t=e.split("/");return decodeURIComponent(t.shift())||this.defaultScreen},a.prototype.parseRouting=function(e){var t=Fi.Screens.getCurrentScreenModel(),i=_.bind(this.chooseScreen,this,e);t&&Ei.isFunc(t.beforeHide)?t.beforeHide(i):i()},a.prototype.chooseScreen=function(t){var i=this.getHashFromHref(),s=i.split("/"),o=decodeURIComponent(s.shift())||this.defaultScreen,n=!!_.find(Ci.Screens,function(e){return e===o}),r=0,a=s.length;for(o===Ci.Screens.Mailbox&&this.lastMailboxHash(i),o===Ci.Screens.Helpdesk&&this.lastHelpdeskHash(i),o===Ci.Screens.Settings&&this.lastSettingsHash(i),this.previousHash(this.currentHash()),this.currentHash(i);a>r;r++)s[r]=decodeURIComponent(s[r]);switch(e.isArray(t)&&(s=_.union(s,t)),this.currentScreen=o,o){case Ci.Screens.SingleMessageView:case Ci.Screens.SingleCompose:case Ci.Screens.SingleHelpdesk:Mi.SingleMode=!0,Fi.Screens.showCurrentScreen(o,s);break;default:n||(o=this.defaultScreen),Mi.SingleMode=!1,Fi.Screens.showNormalScreen(Ci.Screens.Header),Fi.Screens.showCurrentScreen(o,s);break;case Ci.Screens.Mailbox:Mi.SingleMode=!1,Fi.Screens.showNormalScreen(Ci.Screens.Header),Fi.Screens.showCurrentScreen(Ci.Screens.Mailbox,s)}},l.prototype.mailbox=function(e,t,i,s,o){var n=[Ci.Screens.Mailbox];return t=Ei.isNormal(t)?Ei.pInt(t):1,i=Ei.isNormal(i)?Ei.pString(i):"",s=Ei.isNormal(s)?Ei.pString(s):"",o=Ei.isNormal(o)?Ei.pString(o):"",e&&""!==e&&n.push(e),o&&""!==o&&n.push("filter:"+o),t>1&&n.push("p"+t),i&&""!==i&&n.push("msg"+i),s&&""!==s&&n.push(s),n},l.prototype.inbox=function(){return this.mailbox()},l.prototype.parseMailbox=function(e){var t="INBOX",i=1,s="",o="",n="",r="",a=0;return Ei.isNonEmptyArray(e)&&(t=Ei.pString(e[a]),a++,e.length>a&&(r=Ei.pString(e[a]),r==="filter:"+Ci.FolderFilter.Flagged&&(n=Ci.FolderFilter.Flagged,a++),r==="filter:"+Ci.FolderFilter.Unseen&&(n=Ci.FolderFilter.Unseen,a++)),e.length>a&&(r=Ei.pString(e[a]),this.isPageParam(r)&&(i=Ei.pInt(r.substr(1)),0>=i&&(i=1),a++)),e.length>a&&(r=Ei.pString(e[a]),this.isMsgParam(r)&&(s=r.substr(3),a++)),e.length>a&&(o=Ei.pString(e[a]))),{Folder:t,Page:i,Uid:s,Search:o,Filters:n}},l.prototype.contacts=function(e,t,i,s,o){var n=[Ci.Screens.Contacts];return"number"==typeof e&&n.push(e),t&&""!==t&&n.push(t),i&&""!==i&&n.push(i),Ei.isNumeric(s)&&n.push("p"+s),o&&""!==o&&n.push("cnt"+o),n},l.prototype.parseContacts=function(e){var t=0,i=[Ci.ContactsGroupListType.Personal,Ci.ContactsGroupListType.SharedToAll,Ci.ContactsGroupListType.Global,Ci.ContactsGroupListType.All],s=Ci.ContactsGroupListType.All,o="",n="",r=1,a="";return Ei.isNonEmptyArray(e)&&(s=Ei.pInt(e[t]),t++,-1===Ei.inArray(s,i)&&(s=Ci.ContactsGroupListType.SubGroup),s===Ci.ContactsGroupListType.SubGroup&&(e.length>t?(o=Ei.pString(e[t]),t++):s=Ci.ContactsGroupListType.Personal),e.length>t&&!this.isPageParam(e[t])&&!this.isContactParam(e[t])&&(n=Ei.pString(e[t]),t++),e.length>t&&this.isPageParam(e[t])&&(r=Ei.pInt(e[t].substr(1)),t++,0>=r&&(r=1)),e.length>t&&this.isContactParam(e[t])&&(a=Ei.pString(e[t].substr(3)),t++)),{Type:s,GroupId:o,Search:n,Page:r,Uid:a}},l.prototype.isPageParam=function(e){return"p"===e.substr(0,1)&&/^[1-9][\d]*$/.test(e.substr(1))},l.prototype.isContactParam=function(e){return"cnt"===e.substr(0,3)&&/^[1-9][\d]*$/.test(e.substr(3))},l.prototype.isMsgParam=function(e){return"msg"===e.substr(0,3)&&/^[1-9][\d]*$/.test(e.substr(3))},l.prototype.compose=function(){var e=Mi.SingleMode?Ci.Screens.SingleCompose:Ci.Screens.Compose;return[e]},l.prototype.composeFromMessage=function(e,t,i,s){var o=s||Mi.SingleMode?Ci.Screens.SingleCompose:Ci.Screens.Compose;return[o,e,t,i]},l.prototype.composeWithToField=function(e){var t=Mi.SingleMode?Ci.Screens.SingleCompose:Ci.Screens.Compose;return[t,"to",e]},l.prototype.parseToAddr=function(e){var t=decodeURI(Ei.pString(e)),i=-1!==t.indexOf("mailto:"),s=[],o=[],n="",r="",a="",l="";return i&&(s=t.replace(/^mailto:/,"").split("?"),t=s[0],2===s.length&&(o=s[1].split("&"),_.each(o,function(e){var t=e.split("=");if(2===t.length)switch(t[0]){case"subject":n=t[1];break;case"cc":r=t[1];break;case"bcc":a=t[1];break;case"body":l=t[1]}}))),{to:t,hasMailto:i,subject:n,cc:r,bcc:a,body:l}},h.prototype.setReplyData=function(e,t){this.replyText(e),this.replyDraftUid(t)},h.prototype.send=function(e,i,s,o,n,r,a){var l=i.AccountID,h=Fi.MailCache.oFolderListItems[l],c="",u=h?h.sentFolderFullName():"",d=h?h.draftsFolderFullName():"",p=Mi.Accounts.getEmail(l),m=i.To.indexOf(p)>-1||i.Cc.indexOf(p)>-1||i.Bcc.indexOf(p)>-1,g=Mi.SingleMode&&t.opener&&t.opener.App?t.opener.App:Fi;switch(Mi.User.SaveRepliedToCurrFolder&&!m&&Ei.isNonEmptyArray(i.DraftInfo,3)&&(u=i.DraftInfo[2]),i.Action=e,i.ShowReport=o,e){case"MessageSend":c=Ei.i18n("COMPOSE/INFO_SENDING"),s&&(i.SentFolder=u),""!==i.DraftUid&&(i.DraftFolder=d,g.MailCache.removeOneMessageFromCacheForFolder(i.AccountID,i.DraftFolder,i.DraftUid),g.Routing.replaceHashWithoutMessageUid(i.DraftUid));break;case"MessageSave":c=Ei.i18n("COMPOSE/INFO_SAVING"),i.DraftFolder=d,Fi.MailCache.savingDraftUid(i.DraftUid),g.MailCache.startMessagesLoadingWhenDraftSaving(i.AccountID,i.DraftFolder),g.Routing.replaceHashWithoutMessageUid(i.DraftUid)}o&&Fi.Api.showLoading(c),a?this.postponedMailData={Parameters:i,MessageSendResponseHandler:n,MessageSendResponseContext:r}:Fi.Ajax.send(i,n,r)},h.prototype.sendPostponedMail=function(e){var i=this.postponedMailData,s=i.Parameters,o=s.AccountID,n=Fi.MailCache.oFolderListItems[o],r=n?n.draftsFolderFullName():"",a=Mi.SingleMode&&t.opener&&t.opener.App?t.opener.App:Fi;""!==e&&(s.DraftUid=e,s.DraftFolder=r,a.MailCache.removeOneMessageFromCacheForFolder(s.AccountID,s.DraftFolder,s.DraftUid),a.Routing.replaceHashWithoutMessageUid(s.DraftUid)),this.postponedMailData&&(Fi.Ajax.send(s,i.MessageSendResponseHandler,i.MessageSendResponseContext),this.postponedMailData=null)},h.prototype.sendReplyMessage=function(e,t,i,s,o,n){var r=null,a=Fi.MailCache.currentMessage(),l=[],h=null;a&&(l=a.oTo.aCollection.concat(a.oCc.aCollection),h=this.getFirstFetcherOrIdentityByRecipientsOrDefault(l,a.accountId()),r=this.getReplyDataFromMessage(a,Ci.ReplyType.ReplyAll,a.accountId(),h,!1,t,i),r.AccountID=a.accountId(),h&&(r.FetcherID=h&&h.FETCHER?h.id():"",r.IdentityID=h&&!h.FETCHER?h.id():""),r.Bcc="",r.Importance=Ci.Importance.Normal,r.Sensivity=Ci.Sensivity.Nothing,r.ReadingConfirmation="0",r.IsQuickReply="1",r.IsHtml="1",r.Attachments=this.convertAttachmentsForSending(r.Attachments),this.send(e,r,Mi.User.getSaveMailInSentItems(),!1,s,o,n))},h.prototype.convertAttachmentsForSending=function(e){var t={};return _.each(e,function(e){t[e.tempName()]=[e.fileName(),e.cid(),e.inline()?"1":"0",e.linked()?"1":"0",e.contentLocation()]}),t},h.prototype.onMessageSendOrSaveResponse=function(e,i,s){var o,n,r,a=Mi.SingleMode&&t.opener&&t.opener.App?t.opener.App:Fi,l=!!e.Result;switch(s||Fi.Api.hideLoading(),i.Action){case"MessageSave":l?(i.ShowReport&&!s&&Fi.Api.showReport(Ei.i18n("COMPOSE/REPORT_MESSAGE_SAVED")),e.Result.NewUid||(Mi.User.AllowAutosaveInDrafts=!1)):i.ShowReport&&Fi.Api.showErrorByCode(e,Ei.i18n("COMPOSE/ERROR_MESSAGE_SAVING"));break;case"MessageSend":l||e.ErrorCode===Ci.Errors.NotSavedInSentItems?(l||e.ErrorCode!==Ci.Errors.NotSavedInSentItems?i.IsQuickReply?Fi.Api.showReport(Ei.i18n("COMPOSE/REPORT_MESSAGE_SENT")):a.Api.showReport(Ei.i18n("COMPOSE/REPORT_MESSAGE_SENT")):Fi.Api.showError(Ei.i18n("WARNING/SENT_EMAIL_NOT_SAVED")),_.isArray(i.DraftInfo)&&3===i.DraftInfo.length&&(r=i.DraftInfo[0],n=i.DraftInfo[1],o=i.DraftInfo[2],Fi.MailCache.markMessageReplied(i.AccountID,o,n,r))):Fi.Api.showErrorByCode(e,Ei.i18n("COMPOSE/ERROR_MESSAGE_SENDING")),i.SentFolder&&a.MailCache.removeMessagesFromCacheForFolder(i.AccountID,i.SentFolder)}return i.DraftFolder&&!s&&a.MailCache.removeMessagesFromCacheForFolder(i.AccountID,i.DraftFolder),{Action:i.Action,Result:l,NewUid:e.Result?e.Result.NewUid:""}},h.prototype.getReplyDataFromMessage=function(e,t,i,s,o,n,r){var a={DraftInfo:[],DraftUid:"",To:"",Cc:"",Bcc:"",Subject:"",Attachments:[],InReplyTo:e.messageId(),References:this.getReplyReferences(e)},l=[],h=e.oReplyTo.getFull(),c=e.oTo.getFull();switch((""===h||e.oFrom.getFirstEmail()===e.oReplyTo.getFirstEmail()&&""===e.oReplyTo.getFirstName())&&(h=e.oFrom.getFull()),n&&""!==n||(n=this.replyText(),this.replyText("")),"forward"===t?a.Text=n+this.getForwardMessageBody(e,i,s):"resend"===t?(a.Text=e.getConvertedHtml(),a.Cc=e.cc(),a.Bcc=e.bcc()):a.Text=n+this._getReplyMessageBody(e,i,s,o),r?a.DraftUid=r:(a.DraftUid=this.replyDraftUid(),this.replyDraftUid("")),t){case Ci.ReplyType.Reply:a.DraftInfo=[Ci.ReplyType.Reply,e.uid(),e.folder()],a.To=h,a.Subject=this.subjectCompiler(e.subject(),!0),l=_.filter(e.attachments(),function(e){return e.linked()});break;case Ci.ReplyType.ReplyAll:a.DraftInfo=[Ci.ReplyType.ReplyAll,e.uid(),e.folder()],a.To=h,a.Cc=this._getReplyAllCcAddr(e,i,s),a.Subject=this.subjectCompiler(e.subject(),!0),l=_.filter(e.attachments(),function(e){return e.linked()});break;case Ci.ReplyType.Resend:a.DraftInfo=[Ci.ReplyType.Resend,e.uid(),e.folder(),e.cc(),e.bcc()],a.To=c,a.Subject=e.subject(),l=e.attachments();break;case Ci.ReplyType.Forward:a.DraftInfo=[Ci.ReplyType.Forward,e.uid(),e.folder()],a.Subject=this.subjectCompiler(e.subject(),!1),l=e.attachments()}return _.each(l,function(e){if(e.getCopy){var t=e.getCopy(),i=Date.now().toString();t.getInThumbQueue(i),a.Attachments.push(t)}}),a},h.prototype.getReplyReferences=function(e){var t=e.references(),i=e.messageId(),s=t.indexOf(i);return-1===s&&(t+=" "+i),t},h.prototype._getReplyMessageBody=function(e,t,i,s){var o=Ei.i18n("COMPOSE/REPLY_MESSAGE_TITLE",{DATE:e.oDateModel.getDate(),TIME:e.oDateModel.getTime(),SENDER:Ei.encodeHtml(e.oFrom.getFull())}),n="<br /><br />"+this.getSignatureText(t,i,s)+'<br /><br /><div data-anchor="reply-title">'+o+"</div><blockquote>"+e.getConvertedHtml()+"</blockquote>";return n},h.prototype.getClearSignature=function(e,t){var i=Mi.Accounts.getAccount(e),s=!!(t?t.useSignature?t.useSignature():t.signatureOptions():!0),o="";return i&&s&&(o=t&&t.accountId()===i.id()?t.signature():i.signature()&&parseInt(i.signature().options())?i.signature().signature():""),o},h.prototype.getSignatureText=function(e,t,i){var s=this.getClearSignature(e,t);return i?'<div data-anchor="signature">'+s+"</div>":"<div>"+s+"</div>"},h.prototype.getFirstFetcherOrIdentityByRecipientsOrDefault=function(e,t){var i=Mi.Accounts.getAccount(t),s=this.getAccountFetchersIdentitiesList(i),o=[],n=null;return _.each(e,function(e){if(!n)switch(o=_.filter(s,function(t){return e.sEmail===t.email}),o.length){case 0:break;case 1:n=o[0];break;default:n=_.find(o,function(t){return e.sEmail===t.email&&e.sName===t.name}),n||(n=_.find(o,function(e){return e.default}),n||(n=o[0]))}}),n||(n=_.find(s,function(e){return e.default})),n&&n.result},h.prototype.getAccountFetchersIdentitiesList=function(e){var t=[];return e&&(e.fetchers()&&_.each(e.fetchers().collection(),function(e){t.push({email:e.email(),name:e.userName(),"default":!1,result:e})}),_.each(e.identities(),function(e){t.push({email:e.email(),name:e.friendlyName(),"default":e.isDefault(),result:e})})),t},h.prototype.getForwardMessageBody=function(e,t,i){var s=Ei.encodeHtml(e.oCc.getFull()),o=""!==s?Ei.i18n("COMPOSE/FORWARD_MESSAGE_BODY_CC",{CCADDR:s}):"",n=Ei.i18n("COMPOSE/FORWARD_MESSAGE_TITLE",{FROMADDR:Ei.encodeHtml(e.oFrom.getFull()),TOADDR:Ei.encodeHtml(e.oTo.getFull()),CCPART:o,FULLDATE:e.oDateModel.getFullDate(),SUBJECT:e.subject()}),r="<br /><br />"+this.getSignatureText(t,i,!0)+'<br /><br /><div data-anchor="reply-title">'+n+"</div><br /><br />"+e.getConvertedHtml();return r},h.prototype._getReplyAllCcAddr=function(e,t,i){var s=new et,o=_.union(e.oTo.aCollection,e.oCc.aCollection,e.oBcc.aCollection),n=_.find(Mi.Accounts.collection(),function(e){return e.id()===t},this),r=new Z,a=new Z;return r.sEmail=n.email(),a.sEmail=i?i.email():"",s.addCollection(o),s.excludeCollection(_.union(e.oFrom.aCollection,[r,a])),s.getFull()},h._subjectPrefixes=_.map(_.uniq([Ei.i18n("COMPOSE/REPLY_PREFIX"),Ei.i18n("COMPOSE/FORWARD_PREFIX"),"Re","Fwd","","HA"]),function(e){return e.toUpperCase()}),h.prototype.subjectCompiler=function(e,i){e=Ei.trim(e.replace(/[\s]+/g," "));var s=!0,o=Ei.i18n("COMPOSE/REPLY_PREFIX"),n=Ei.i18n("COMPOSE/FORWARD_PREFIX"),r=o.toUpperCase(),a=n.toUpperCase(),l=!1,c=!1,u={},d=[],p=[],m=e.split(":");return u[i?o:n]=1,_.each(m,function(e){if(l)p.push(e);else{e=Ei.trim(e);var i=e.toUpperCase();e&&-1<_.indexOf(h._subjectPrefixes,i)?(e=r===i?o:e,e=a===i?n:e,u[e]=Ei.isUnd(u[e])?1:0+u[e]+1):(c=!1,e&&!l&&_.each(h._subjectPrefixes,function(s){if(!c){var l="",h=new t.RegExp("^"+s+"\\s?[\\[\\(]([\\d]+)[\\]\\)]$","gi").exec(i);h&&h[1]&&(l=Ei.trim(e.replace(/[\s]*[\[\(][\d]+[\]\)]$/g,"")),c=!0,l=r===i?o:l,l=a===i?n:l,u[l]=Ei.isUnd(u[l])?Ei.pInt(h[1]):0+u[l]+Ei.pInt(h[1]))}}),c||(l=!0,p.push(e)))}}),_.each(u,function(e,t){e&&d.push(t+(s&&e>1?"["+e+"]":""))}),Ei.trim((d.join(": ")+(d.length?": ":"")+p.join(":")).replace(/[\s]+/g," "))},h.prototype.getHtmlFromText=function(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/\r/g,"").replace(/\n/g,"<br />")},c.prototype.init=function(){setInterval(_.bind(function(){this.start()},this),1e4)},c.prototype.start=function(){!Mi.Auth||Mi.SingleMode||Fi.InternetConnectionError||Fi.Ajax.hasOpenedRequests()||(this.prefetchStarted(!1),this.prefetchAll())},c.prototype.prefetchAll=function(){this.prefetchFetchersIdentities(),Mi.App.AllowPrefetch?(this.startMessagesPrefetch(),this.startThreadListPrefetch(),this.doServerInitializations(),this.prefetchStarredMessageList(),this.startOtherPagesPrefetch(),this.prefetchUnseenMessageList(),this.prefetchAccountQuota(),this.startOtherFoldersPrefetch(),this.prefetchCalendarList(),this.initHelpdesk()):(this.doServerInitializations(),this.prefetchStarredMessageList(),this.prefetchAccountQuota(),this.prefetchCalendarList(),this.initHelpdesk())
},c.prototype.prefetchCalendarList=function(){this.prefetchStarted()||this.prefetchStarted(Fi.CalendarCache.firstRequestCalendarList())},c.prototype.prefetchFetchersIdentities=function(){Mi.SingleMode||this.fetchersIdentitiesPrefetched()||this.prefetchStarted()||!Mi.User.AllowFetcher&&!Mi.AllowIdentities||(Mi.Accounts.populateFetchersIdentities(),this.fetchersIdentitiesPrefetched(!0),this.prefetchStarted(!0))},c.prototype.initHelpdesk=function(){!Mi.User.IsHelpdeskSupported||this.prefetchStarted()||this.helpdeskInitialized()||(Fi.Screens.initHelpdesk(),this.helpdeskInitialized(!0),this.prefetchStarted(!0))},c.prototype.doServerInitializations=function(){Mi.SingleMode||this.prefetchStarted()||this.serverInitializationsDone()||(Fi.Ajax.send({Action:"SystemDoServerInitializations"}),this.serverInitializationsDone(!0),this.prefetchStarted(!0))},c.prototype.prefetchStarredMessageList=function(){if(!this.prefetchStarted()){var e=Fi.MailCache.folderList(),t=e?e.inboxFolder():null,i=null;t&&!t.hasChanges()&&(i=Fi.MailCache.requestMessageList(t.fullName(),1,"",Ci.FolderFilter.Flagged,!1,!1),i.RequestStarted&&this.prefetchStarted(!0))}},c.prototype.prefetchUnseenMessageList=function(){if(!this.prefetchStarted()){var e=Fi.MailCache.folderList(),t=e?e.inboxFolder():null,i=null;t&&!t.hasChanges()&&(i=Fi.MailCache.requestMessageList(t.fullName(),1,"",Ci.FolderFilter.Unseen,!1,!1),i.RequestStarted&&this.prefetchStarted(!0))}},c.prototype.startOtherPagesPrefetch=function(){this.prefetchStarted()||this.startPagePrefetch(Fi.MailCache.page()+1),this.prefetchStarted()||this.startPagePrefetch(Fi.MailCache.page()-1)},c.prototype.prefetchNextPage=function(e){var t=Fi.MailCache.uidList(),i=_.indexOf(t.collection(),e),s=Math.ceil(i/Mi.User.MailsPerPage)+1;this.startPagePrefetch(s-1)},c.prototype.prefetchPrevPage=function(e){var t=Fi.MailCache.uidList(),i=_.indexOf(t.collection(),e),s=Math.ceil((i+1)/Mi.User.MailsPerPage)+1;this.startPagePrefetch(s)},c.prototype.startPagePrefetch=function(e){var t=Fi.MailCache.folderList().currentFolder(),i=Fi.MailCache.uidList(),s=(e-1)*Mi.User.MailsPerPage,o=e>0&&s<i.resultCount(),n=null,r=null;t&&!t.hasChanges()&&o&&(n={folder:t.fullName(),page:e,search:i.search()},t.hasListBeenRequested(n)||(r=Fi.MailCache.requestMessageList(n.folder,n.page,n.search,"",!1,!1),r&&r.RequestStarted&&this.prefetchStarted(!0)))},c.prototype.startOtherFoldersPrefetch=function(){if(!this.prefetchStarted()){var e=Fi.MailCache.folderList(),t=e.currentFolderFullName(),i=Mi.Accounts.getCurrentFetchersAndFiltersFolderNames(),s=e?[e.inboxFolderFullName(),e.sentFolderFullName(),e.draftsFolderFullName(),e.spamFolderFullName()]:[],o=i.length<3?this.getOtherFolderNames(3-i.length):[],n=_.uniq(_.compact(_.union(s,i,o)));_.each(n,_.bind(function(i){t!==i&&this.startFolderPrefetch(e.getFolderByFullName(i))},this))}},c.prototype.getOtherFolderNames=function(e){var t=Fi.MailCache.folderList().inboxFolder(),i=t?t.subfolders():[],s=_.filter(Fi.MailCache.folderList().collection(),function(e){return!e.isSystem()},this),o=_.first(_.union(i,s),e);return _.map(o,function(e){return e.fullName()})},c.prototype.startFolderPrefetch=function(e){if(!this.prefetchStarted()&&e){var t=1,i="",s={folder:e.fullName(),page:t,search:i},o=null;e.hasListBeenRequested(s)||(o=Fi.MailCache.requestMessageList(s.folder,s.page,s.search,"",!1,!1),o&&o.RequestStarted&&this.prefetchStarted(!0))}},c.prototype.startThreadListPrefetch=function(){if(!this.prefetchStarted()){var e=[],t=Fi.MailCache.getCurrentFolder();_.each(Fi.MailCache.messages(),function(i){i.threadCount()>0&&_.each(i.threadUids(),function(i){var s=t.oMessages[i];s&&t.hasThreadUidBeenRequested(i)||e.push(i)})},this),e.length>0&&(e=e.slice(0,Mi.User.MailsPerPage),t.addRequestedThreadUids(e),t.loadThreadMessages(e),this.prefetchStarted(!0))}},c.prototype.startMessagesPrefetch=function(){if(!this.prefetchStarted()){var e=Fi.MailCache.currentAccountId(),t=Fi.MailCache.getCurrentFolder(),i=0,s=Mi.App.MaxPrefetchBodiesSize,o=[],n=null,r=2048,a=function(e){var n=!e.deleted()&&!e.completelyFilled(),a=!_.find(o,function(t){return t===e.uid()},this),l=!t.hasUidBeenRequested(e.uid());s>i&&n&&a&&l&&(o.push(e.uid()),i+=e.trimmedTextSize()+r)};t&&t.selected()&&(_.each(Fi.MailCache.messages(),a),_.each(t.oMessages,a),o.length>0&&(t.addRequestedUids(o),n={AccountID:e,Action:"MessagesGetBodies",Folder:t.fullName(),Uids:o},Fi.Ajax.send(n,this.onMessagesGetBodiesResponse,this),this.prefetchStarted(!0)))}},c.prototype.onMessagesGetBodiesResponse=function(e,t){var i=Fi.MailCache.getFolderByFullName(t.AccountID,t.Folder);_.isArray(e.Result)&&_.each(e.Result,function(e){i.parseAndCacheMessage(e,!1,!1)})},c.prototype.prefetchAccountQuota=function(){var e=Mi.Accounts.getCurrent(),t=Mi.App&&Mi.App.ShowQuotaBar,i=e&&!e.quotaRecieved();!this.prefetchStarted()&&t&&i&&(e.updateQuotaParams(),this.prefetchStarted(!0))},u.prototype.iTimer=0,u.prototype.bResetCheckedOnClick=!1,u.prototype.bCheckOnSelect=!1,u.prototype.bUnselectOnCtrl=!1,u.prototype.bDisableMultiplySelection=!1,u.prototype.setBeforeSelectCallback=function(e){this.fBeforeSelectCallback=e||null},u.prototype.getLastOrSelected=function(){var e=0,t=null;return _.each(this.list(),function(i){i.checked()&&e++,i.selected()&&(t=i)}),0===e&&t?t:this.oLast},u.prototype.initOnApplyBindings=function(t,s,o,n,r){e(document).on("keydown",this.onKeydownBinded),this.oListScope=n,this.oScrollScope=r,this.sActionSelector=t,this.sSelectabelSelector=s,this.sCheckboxSelector=o;var a=this,l=function(e,t,i){var s=0,o=0,n=null,r=!1,l=!1,h=[],c=!1;if(t=t?t:null,i&&i.shiftKey&&null!==t&&null!==e&&t!==e)for(h=a.list(),c=t.checked(),s=0,o=h.length;o>s;s++)n=h[s],r=!1,(n===e||n===t)&&(r=!0),r&&(l=!l),(l||r)&&n.checked(c);t&&(a.oLast=t)};e(this.oListScope).on("dblclick",t,function(e){var t=i.dataFor(this);!t||!e||e.ctrlKey||e.altKey||e.shiftKey||a.onDblClick(t)}),Ni&&e(this.oListScope).on("touchstart",t,function(t){if(t){var i=t.timeStamp,s=e(this).data("lastTouch")||i,o=i-s,n=t.originalEvent&&t.originalEvent.touches?t.originalEvent.touches.length:0;e(this).data("lastTouch",i),!o||o>250||n>1||(t.preventDefault(),e(this).trigger("dblclick"))}}),e(this.oListScope).on("click",t,function(e){var t=!0,s=null,o=a.getLastOrSelected(),n=i.dataFor(this);n&&e&&(e.shiftKey?(t=!1,a.bDisableMultiplySelection||(null===a.oLast&&(a.oLast=n),n.checked(!n.checked()),l(o,n,e))):e.ctrlKey&&(t=!1,a.bDisableMultiplySelection||(a.oLast=n,s=a.itemSelected(),!s||s.checked()||n.checked()||s.checked(!0),a.bUnselectOnCtrl&&n===a.itemSelected()?(n.checked(!n.selected()),a.itemSelected(null)):n.checked(!n.checked()))),t&&(a.onSelect(n),a.scrollToSelected()))}),e(this.oListScope).on("click",o,function(e){var t=i.dataFor(this);t&&e&&!a.bDisableMultiplySelection&&(e.shiftKey?(null===a.oLast&&(a.oLast=t),l(a.getLastOrSelected(),t,e)):a.oLast=t),e&&e.stopPropagation&&e.stopPropagation()}),e(this.oListScope).on("dblclick",o,function(e){e&&e.stopPropagation&&e.stopPropagation()})},u.prototype.getResultSelection=function(e,t){var i=this,s=!1,o=!1,n=null,r=this.iFactor,a=!!this.multiplyLineFactor,l=0,h=0,c=[];if(!e&&-1<Ei.inArray(t,[this.KeyUp,this.KeyDown,this.KeyLeft,this.KeyRight,Ci.Key.PageUp,Ci.Key.PageDown,Ci.Key.Home,Ci.Key.End]))c=this.list(),c&&0<c.length&&(-1<Ei.inArray(t,[this.KeyDown,this.KeyRight,Ci.Key.PageUp,Ci.Key.Home])?n=c[0]:-1<Ei.inArray(t,[this.KeyUp,this.KeyLeft,Ci.Key.PageDown,Ci.Key.End])&&(n=c[c.length-1]));else if(e&&(c=this.list(),h=c?c.length:0,h>0))if(Ci.Key.Home===t||Ci.Key.PageUp===t||Ci.Key.End===t||Ci.Key.PageDown===t||a&&(Ci.Key.Left===t||Ci.Key.Right===t)||!a&&(Ci.Key.Up===t||Ci.Key.Down===t))_.each(c,function(r){if(!s)switch(t){case i.KeyUp:case i.KeyLeft:e===r?s=!0:n=r;break;case Ci.Key.Home:case Ci.Key.PageUp:n=r,s=!0;break;case i.KeyDown:case i.KeyRight:o?(n=r,s=!0):e===r&&(o=!0);break;case Ci.Key.End:case Ci.Key.PageDown:n=r}});else if(a&&this.KeyDown===t){for(;h>l;l++)if(e===c[l]){l+=r,l>h-1&&(l-=r),n=c[l];break}}else if(a&&this.KeyUp===t)for(l=h;l>=0;l--)if(e===c[l]){l-=r,0>l&&(l+=r),n=c[l];break}return n},u.prototype.shiftClickResult=function(e,t,i){if(t){var s=!!this.multiplyLineFactor,o=!1,n=!1;-1<Ei.inArray(i,s?[Ci.Key.Left,Ci.Key.Right]:[Ci.Key.Up,Ci.Key.Down])?t.checked(!t.checked()):-1<Ei.inArray(i,s?[Ci.Key.Up,Ci.Key.Down,Ci.Key.PageUp,Ci.Key.PageDown,Ci.Key.Home,Ci.Key.End]:[Ci.Key.Left,Ci.Key.Right,Ci.Key.PageUp,Ci.Key.PageDown,Ci.Key.Home,Ci.Key.End])&&(n=!t.checked(),_.each(this.list(),function(i){var s=!1;(i===e||t===i)&&(o=!o,s=!0),(o||s)&&(i.checked(n),s=!1)}),s&&e&&(i===Ci.Key.Up||i===Ci.Key.Down)&&e.checked(!e.checked()))}},u.prototype.clickNewSelectPosition=function(e,i){var s=this,o=0,n=null,r=this.itemSelected();n=this.getResultSelection(r,e),n?(i&&this.shiftClickResult(n,r,e),n&&this.fBeforeSelectCallback?(this.fBeforeSelectCallback(n,function(e){e&&(s.itemSelected(n),o=0===s.iTimer?50:150,0!==s.iTimer&&t.clearTimeout(s.iTimer),s.iTimer=t.setTimeout(function(){s.iTimer=0,s.onSelect(n,!1)},o),this.scrollToSelected())}),this.scrollToSelected()):(this.itemSelected(n),o=0===this.iTimer?50:150,0!==this.iTimer&&t.clearTimeout(this.iTimer),this.iTimer=t.setTimeout(function(){s.iTimer=0,s.onSelect(n)},o),this.scrollToSelected())):r&&i&&-1<Ei.inArray(e,[this.KeyUp,this.KeyDown,this.KeyLeft,this.KeyRight,Ci.Key.PageUp,Ci.Key.PageDown,Ci.Key.Home,Ci.Key.End])&&r.checked(!r.checked())},u.prototype.onKeydown=function(e){var t=!0,i=0;return this.useKeyboardKeys()&&e&&!Ei.isTextFieldFocused()&&!Fi.Screens.hasOpenedMaximizedPopups()&&(i=e.keyCode,e.ctrlKey||this.KeyUp!==i&&this.KeyDown!==i&&this.KeyLeft!==i&&this.KeyRight!==i&&Ci.Key.PageUp!==i&&Ci.Key.PageDown!==i&&Ci.Key.Home!==i&&Ci.Key.End!==i?Ci.Key.Del!==i||e.ctrlKey||e.shiftKey?Ci.Key.Enter===i?0<this.list().length&&!e.ctrlKey&&(this.onEnter(this.itemSelected()),t=!1):!e.ctrlKey||e.altKey||e.shiftKey||Ci.Key.a!==i||(this.checkAll(!(this.checkAll()&&!this.isIncompleteChecked())),t=!1):0<this.list().length&&(this.onDelete(),t=!1):(this.clickNewSelectPosition(i,e.shiftKey),t=!1)),t},u.prototype.onDelete=function(){this.fDeleteCallback.call(this,this.listCheckedOrSelected())},u.prototype.onEnter=function(e){var t=this;e&&this.fBeforeSelectCallback?this.fBeforeSelectCallback(e,function(i){i&&(t.itemSelected(e),t.fEnterCallback.call(this,e))}):(this.itemSelected(e),this.fEnterCallback.call(this,e))},u.prototype.selectionFunc=function(e){this.itemSelected(null),this.bResetCheckedOnClick&&this.listChecked(!1),this.itemSelected(e),this.fSelectCallback.call(this,e)},u.prototype.onSelect=function(e,t){if(t=Ei.isUnd(t)?!0:!!t,this.fBeforeSelectCallback&&t){var i=this;this.fBeforeSelectCallback(e,function(t){t&&i.selectionFunc(e)})}else this.selectionFunc(e)},u.prototype.onDblClick=function(e){this.fDblClickCallback.call(this,e)},u.prototype.koCheckAll=function(){return i.computed({read:this.checkAll,write:this.checkAll,owner:this})},u.prototype.koCheckAllIncomplete=function(){return i.computed({read:this.isIncompleteChecked,write:this.isIncompleteChecked,owner:this})},u.prototype.scrollToSelected=function(){if(!this.oListScope||!this.oScrollScope)return!1;var t=20,i=e(this.sSelectabelSelector,this.oScrollScope),s=i.position(),o=this.oScrollScope.height(),n=i.outerHeight();return s&&(s.top<0||s.top+n>o)?(this.oScrollScope.scrollTop(s.top<0?this.oScrollScope.scrollTop()+s.top-t:this.oScrollScope.scrollTop()+s.top-o+n+t),!0):!1},function(e){e.fn.splitter=function(i){return i=i||{},this.each(function(){var s=!1,o=i.collapse?i.collapse:!1,n=i.name,r=0,a=0,l=0,h={},c={},u=function(t){s=!0,v.addClass(b.activeClass),b._posSplit=-((A?y._overallWidth-t[b.eventPos]:t[b.eventPos])-S.get(0)[b.pxSplit]),e("body").attr({unselectable:"on"}).addClass("unselectable"),e(document).bind("mousemove",d).bind("mouseup",p)},d=function(e){var t=(A?y._overallWidth-e[b.eventPos]:e[b.eventPos])+b._posSplit;m(t),Ei.isFunc(i.resizeFunc)&&i.resizeFunc()},p=function C(){v.removeClass(b.activeClass),e("body").attr({unselectable:"off"}).removeClass("unselectable"),n&&Fi.Storage.setData(n+"ResizerWidth",S.get(0)[b.pxSplit]),e(document).unbind("mousemove",d).unbind("mouseup",C),Ei.isFunc(i.resizeFunc)&&i.resizeFunc()},m=function(e,i){var s=S.get(0)._min,n=l-e>0;l=e,o&&n&&s-e>150&&(e=5,i=!0),i||(e=t.Math.max(s,y._overallWidth-S.get(1)._max,t.Math.min(e,S.get(0)._max,y._overallWidth-S.get(1)._min))),S.get(0).$.css(b.split,e),S.get(1).$.css(b.split,y._overallWidth-e),Fi.browser.ie8AndBelow||S.trigger("resize")},g=function(e){for(var i=0,s=1;s<arguments.length;s++)i+=t.Math.max(t.parseInt(e.css(arguments[s]),10)||0,0);return i},f=(i.splitHorizontal?"h":i.splitVertical?"v":i.type)||"v",b=e.extend({activeClass:"active",pxPerKey:8,tabIndex:0,accessKey:""},{v:{keyLeft:39,keyRight:37,type:"v",eventPos:"pageX",origin:"left",split:"width",pxSplit:"offsetWidth",side1:"Left",side2:"Right",fixed:"height",pxFixed:"offsetHeight",side3:"Top",side4:"Bottom"},h:{keyTop:40,keyBottom:38,type:"h",eventPos:"pageY",origin:"top",split:"height",pxSplit:"offsetHeight",side1:"Top",side2:"Bottom",fixed:"width",pxFixed:"offsetWidth",side3:"Left",side4:"Right"}}[f],i),y=e(this),S=e(">*:not(css3pie)",y).each(function(){this.$=e(this)}),v=e(".resize_handler",S.get(0)).attr({unselectable:"on"}).bind("mousedown",u),A="rtl"===y.css("direction");S.get(0)._paneName=b.side1,S.get(1)._paneName=b.side2,S.each(function(){this._min=b["min"+this._paneName]||g(this.$,"min-"+b.split),this._max=b["max"+this._paneName]||g(this.$,"max-"+b.split)||9999,this._init=void 0===b["size"+this._paneName]?t.parseInt(e.css(this,b.split),10):b["size"+this._paneName]}),r=n?Fi.Storage.getData(n+"ResizerWidth")||S.get(0)._init:S.get(0)._init,isNaN(r)&&(r=y[0][b.pxSplit],r=t.Math.round(r/S.length)),b.resizeToWidth&&!Fi.browser.ie8AndBelow&&e(t).bind("resize",function(e){e.target===this&&y.trigger("resize")}),y.bind("resize",function(e,t,i,o){var n=e.target.className+"_"+i;s&&(h={}),e.target===this&&(y._overallWidth=y[0][b.pxSplit],y._overallWidth<=0||(a=b.sizeRight||b.sizeBottom?y._overallWidth-S.get(1)[b.pxSplit]:S.get(0)[b.pxSplit],isNaN(t)?t=a:i&&(s=!1,h[n]?(t=h[n],h[n]=null):(t===a?(h[n]=null,t=c[n]):h[n]=c[n]=a,_.each(h,function(e,t){t!==n&&(h[t]=null)}))),m(t,o)))}).trigger("resize",[r])})}}(jQuery),function(e){e.ui.autocomplete.prototype._renderItem=function(t,i){return i.label=Ei.trim(i.label),i.label=i.label.replace(/\([^\)]+\)$/i,function(e){return"~~1~~"+e+"~~2~~"}),i.label=i.label.replace(/<[^>]+>$/i,function(e){return"~~1~~"+e+"~~2~~"}),i.label=Ei.encodeHtml(i.label),i.label=i.label.replace(/~~1~~/,'<span style="opacity: 0.5">').replace(/~~2~~/,"</span>"),e("<li>").append("<a>"+i.label+"</a>").appendTo(t)},e.ui.autocomplete.prototype._renderMenu=function(t,i){var s=this,o="";e.each(i,function(e,i){i&&i.category&&i.category!==o&&(o=i.category,t.append('<li class="ui-autocomplete-category">'+i.category+"</li>")),s._renderItemData(t,i)})}}(jQuery),d.prototype.composeMessage=function(){Fi.Routing.setHash([Ci.Screens.Compose])},d.prototype.composeMessageFromDrafts=function(e,t){var i=Fi.Links.composeFromMessage("drafts",e,t);Fi.Routing.setHash(i)},d.prototype.composeMessageAsReplyOrForward=function(e,t,i){var s=Fi.Links.composeFromMessage(e,t,i);Fi.Routing.setHash(s)},d.prototype.composeMessageToAddresses=function(e){var t=Fi.Links.composeWithToField(e);Fi.Routing.setHash(t)},d.prototype.composeMessageWithVcard=function(e){var t=["vcard",e];Fi.Routing.goDirectly(Fi.Links.compose(),t)},d.prototype.composeMessageWithPgpKey=function(e,t){var i=["data-as-file",e,t];Fi.Routing.goDirectly(Fi.Links.compose(),i)},d.prototype.composeMessageWithFiles=function(e){var t=["file",e];Fi.Routing.goDirectly(Fi.Links.compose(),t)},d.prototype.closeComposePopup=function(){},d.prototype.downloadByUrl=function(i){var s=null;Ni?t.open(i):(s=e('<iframe style="display: none;"></iframe>').appendTo(document.body),s.attr("src",i),setTimeout(function(){s.remove()},6e4))},d.prototype.isPgpSupported=function(){return!(!t.crypto||!t.crypto.getRandomValues)},d.prototype.pgp=function(i,s){if(Ei.isFunc(i))if(this.openPgp)i(this.openPgp);else if(this.isPgpSupported()){null!==this.openPgpCallbacks?this.openPgpCallbacks.push(i):i(!1);var o=this;this.openPgpRequest||(this.openPgpRequest=!0,e.ajax({url:"static/js/openpgp.js",dataType:"script",cache:!0,complete:function(){o.openPgp=t.openpgp?new y(t.openpgp,"user_"+(s||"0")+"_"):!1,null!==o.openPgpCallbacks&&_.each(o.openPgpCallbacks,function(e){e(o.openPgp)}),o.openPgpCallbacks=null}}))}else i(!1)},d.prototype.showLoading=function(e){Fi.Screens.showLoading(e)},d.prototype.hideLoading=function(){Fi.Screens.hideLoading()},d.prototype.showReport=function(e,t){Fi.Screens.showReport(e,t)},d.prototype.showError=function(e,t,i,s){Fi.Screens.showError(e,t,i,s)},d.prototype.hideError=function(e){Fi.Screens.hideError(e)},d.prototype.showPgpErrorByCode=function(e,t,i){var s=Ei.isNonEmptyArray(e.errors)?e.errors:[],o=Ei.isNonEmptyArray(e.notices)?e.notices:[],n=[],r=[],a="",l=!1,h=!0;if(_.each(_.union(s,o),function(e){if(2===e.length)switch(e[0]){case v.Enum.GenerateKeyError:a=Ei.i18n("OPENPGP/ERROR_GENERATE_KEY");break;case v.Enum.ImportKeyError:a=Ei.i18n("OPENPGP/ERROR_IMPORT_KEY");break;case v.Enum.ImportNoKeysFoundError:a=Ei.i18n("OPENPGP/ERROR_IMPORT_NO_KEY_FOUNDED");break;case v.Enum.PrivateKeyNotFoundError:case v.Enum.PrivateKeyNotFoundNotice:r.push(e[1]);break;case v.Enum.PublicKeyNotFoundError:h=!1,n.push(e[1]);break;case v.Enum.PublicKeyNotFoundNotice:n.push(e[1]);break;case v.Enum.KeyIsNotDecodedError:t===Ci.PgpAction.DecryptVerify?a=Ei.i18n("OPENPGP/ERROR_DECRYPT")+" "+Ei.i18n("OPENPGP/ERROR_KEY_NOT_DECODED",{USER:e[1]}):(t===Ci.PgpAction.Sign||t===Ci.PgpAction.EncryptSign)&&(a=Ei.i18n("OPENPGP/ERROR_SIGN")+" "+Ei.i18n("OPENPGP/ERROR_KEY_NOT_DECODED",{USER:e[1]}));break;case v.Enum.SignError:a=Ei.i18n("OPENPGP/ERROR_SIGN");break;case v.Enum.VerifyError:a=Ei.i18n("OPENPGP/ERROR_VERIFY");break;case v.Enum.EncryptError:a=Ei.i18n("OPENPGP/ERROR_ENCRYPT");break;case v.Enum.DecryptError:a=Ei.i18n("OPENPGP/ERROR_DECRYPT");break;case v.Enum.SignAndEncryptError:a=Ei.i18n("OPENPGP/ERROR_ENCRYPT_OR_SIGN");break;case v.Enum.VerifyAndDecryptError:a=Ei.i18n("OPENPGP/ERROR_DECRYPT_OR_VERIFY");break;case v.Enum.DeleteError:a=Ei.i18n("OPENPGP/ERROR_DELETE_KEY");break;case v.Enum.VerifyErrorNotice:a=Ei.i18n("OPENPGP/ERROR_VERIFY");break;case v.Enum.NoSignDataNotice:l=!0}}),n.length>0?(n=_.without(n,""),n.length>0?a=Ei.i18n("OPENPGP/ERROR_NO_PUBLIC_KEYS_FOR_USERS_PLURAL",{USERS:n.join(", ")},null,n.length):t===Ci.PgpAction.Verify&&(a=Ei.i18n("OPENPGP/ERROR_NO_PUBLIC_KEY_FOUND_FOR_VERIFY")),h&&""!==a&&(a+=" "+Ei.i18n("OPENPGP/ERROR_MESSAGE_WAS_NOT_VERIFIED"))):r.length>0&&(r=_.without(r,""),r.length>0?a=Ei.i18n("OPENPGP/ERROR_NO_PRIVATE_KEYS_FOR_USERS_PLURAL",{USERS:r.join(", ")},null,r.length):t===Ci.PgpAction.DecryptVerify&&(a=Ei.i18n("OPENPGP/ERROR_NO_PRIVATE_KEY_FOUND_FOR_DECRYPT"))),""===a&&!l){switch(t){case Ci.PgpAction.Generate:a=Ei.i18n("OPENPGP/ERROR_GENERATE_KEY");break;case Ci.PgpAction.Import:a=Ei.i18n("OPENPGP/ERROR_IMPORT_KEY");break;case Ci.PgpAction.DecryptVerify:a=Ei.i18n("OPENPGP/ERROR_DECRYPT");break;case Ci.PgpAction.Verify:a=Ei.i18n("OPENPGP/ERROR_VERIFY");break;case Ci.PgpAction.Encrypt:a=Ei.i18n("OPENPGP/ERROR_ENCRYPT");break;case Ci.PgpAction.EncryptSign:a=Ei.i18n("OPENPGP/ERROR_ENCRYPT_OR_SIGN");break;case Ci.PgpAction.Sign:a=Ei.i18n("OPENPGP/ERROR_SIGN")}a=i}return""!==a&&Fi.Api.showError(a),l},d.prototype.showErrorByCode=function(e,t,i){var s=e.ErrorCode,o=e.ErrorMessage||"",n="";switch(s){default:n=t;break;case Ci.Errors.AuthError:n=Ei.i18n("WARNING/LOGIN_PASS_INCORRECT");break;case Ci.Errors.DataBaseError:n=Ei.i18n("WARNING/DATABASE_ERROR");break;case Ci.Errors.LicenseProblem:n=Ei.i18n("WARNING/INVALID_LICENSE");break;case Ci.Errors.DemoLimitations:n=Ei.i18n("DEMO/WARNING_THIS_FEATURE_IS_DISABLED");break;case Ci.Errors.Captcha:n=Ei.i18n("WARNING/CAPTCHA_IS_INCORRECT");break;case Ci.Errors.CanNotGetMessage:n=Ei.i18n("MESSAGE/ERROR_MESSAGE_DELETED");break;case Ci.Errors.NoRequestedMailbox:n=t+" "+Ei.i18n("COMPOSE/ERROR_INVALID_ADDRESS",{ADDRESS:e.Mailbox||""});break;case Ci.Errors.CanNotChangePassword:n=Ei.i18n("WARNING/UNABLE_CHANGE_PASSWORD");break;case Ci.Errors.AccountOldPasswordNotCorrect:n=Ei.i18n("WARNING/CURRENT_PASSWORD_NOT_CORRECT");break;case Ci.Errors.FetcherIncServerNotAvailable:n=Ei.i18n("WARNING/FETCHER_SAVE_ERROR");break;case Ci.Errors.FetcherLoginNotCorrect:n=Ei.i18n("WARNING/FETCHER_SAVE_ERROR");break;case Ci.Errors.HelpdeskUserNotExists:n=Ei.i18n("HELPDESK/ERROR_FORGOT_NO_ACCOUNT");break;case Ci.Errors.MailServerError:n=Ei.i18n("WARNING/CANT_CONNECT_TO_SERVER");break;case Ci.Errors.DataTransferFailed:n=Ei.i18n("WARNING/DATA_TRANSFER_FAILED");break;case Ci.Errors.NotDisplayedError:n=""}""!==n?(""!==o&&(n+=" ("+o+")"),this.showError(n,!1,!!i)):""!==o&&this.showError(o)},d.prototype.showErrorIfAttachmentSizeLimit=function(e,t){var i=Ei.i18n("COMPOSE/UPLOAD_ERROR_FILENAME_SIZE",{FILENAME:e,MAXSIZE:Ei.friendlySize(Mi.App.AttachmentSizeLimit)});return Mi.App.AttachmentSizeLimit>0&&t>Mi.App.AttachmentSizeLimit?(Fi.Screens.showPopup(C,[i]),!0):!1},d.prototype.deleteMessages=function(e,t,i){Ei.isFunc(i)||(i=function(){});var s=Fi.MailCache.folderList(),o=s.currentFolderFullName(),n=s.trashFolder(),r=n&&o===n.fullName(),a=s.spamFolder(),l=a&&o===a.fullName(),h=function(s){s&&(t.MailCache.deleteMessages(e),i())};l?(t.MailCache.deleteMessages(e),i()):r?Fi.Screens.showPopup(E,[Ei.i18n("MAILBOX/CONFIRM_MESSAGES_DELETE"),h]):n?(t.MailCache.moveMessagesToFolder(n.fullName(),e),i()):n||Fi.Screens.showPopup(E,[Ei.i18n("MAILBOX/CONFIRM_MESSAGES_DELETE_NO_TRASH_FOLDER"),h])},d.prototype.composeMessage=function(){Fi.Screens.showPopup(Kt)},d.prototype.composeMessageFromDrafts=function(e,t){var i=Fi.Links.composeFromMessage("drafts",e,t);i.shift(),Fi.Screens.showPopup(Kt,[i])},d.prototype.composeMessageAsReplyOrForward=function(e,t,i){var s=Fi.Links.composeFromMessage(e,t,i);Mi.SingleMode?Fi.Routing.setHash(s):(s.shift(),Fi.Screens.showPopup(Kt,[s]))},d.prototype.composeMessageToAddresses=function(e){var t=Fi.Links.composeWithToField(e);Mi.SingleMode?Fi.Routing.setHash(t):(t.shift(),Fi.Screens.showPopup(Kt,[t]))},d.prototype.composeMessageWithVcard=function(e){var t=["vcard",e];Fi.Screens.showPopup(Kt,[t])},d.prototype.composeMessageWithPgpKey=function(e,t){var i=["data-as-file",e,t];Fi.Screens.showPopup(Kt,[i])},d.prototype.composeMessageWithFiles=function(e){var t=["file",e];Fi.Screens.showPopup(Kt,[t])},d.prototype.closeComposePopup=function(){Fi.Screens.showPopup(Kt,[["close"]])},Ii.addScreenToHeader=function(e,t,i,s,o){Fi.addScreenToHeader(e,t,i,s,o,!0)},Ii.setDefaultTab=function(e){var t=!!_.find(Ci.Screens,function(t){return t===e});t&&(Mi.App.DefaultTab=e)},Ii.aSettingsTabs=[],Ii.addSettingsTab=function(e){e.prototype.TabName&&(Ci.SettingsTab[e.prototype.TabName]=e.prototype.TabName,Ii.aSettingsTabs.push(e))},Ii.getPluginsSettingsTabs=function(){return Ii.aSettingsTabs},Ii.getSetting=function(e){return Mi.App[e]},Ii.getPluginSettings=function(e){return Mi&&Mi.Plugins?Mi.Plugins[e]:null},Ii.oPluginHooks={},Ii.addPluginHook=function(t,i){Ei.isFunc(i)&&(e.isArray(this.oPluginHooks[t])||(this.oPluginHooks[t]=[]),this.oPluginHooks[t].push(i))},Ii.runPluginHook=function(t,i){e.isArray(this.oPluginHooks[t])&&(i=i||[],_.each(this.oPluginHooks[t],function(e){e.apply(null,i)}))},Ii.sendAjaxRequest=function(e,t,i){Fi.Ajax.send(e,t,i)},Ii.i18n=Ei.i18n,Ii.getArrayRecipients=Ei.getArrayRecipients,Ii.getEmailParts=Ei.getEmailParts,Ii.showAlertPopup=function(e){Fi.Screens.showPopup(C,[e])},Ii.showConfirmPopup=function(e,t){Fi.Screens.showPopup(E,[e,t])},Ii.showPopup=function(e,t){Fi.Screens.showPopup(e,t)},Ii.showReport=function(e,t){Fi.Screens.showReport(e,t)},Ii.showError=function(e){Fi.Screens.showError(e)},Ii.getPrimaryAccountData=function(){var e=Mi.Accounts.getDefault();return{Id:e.id(),Email:e.email(),FriendlyName:e.friendlyName()}},Ii.getCurrentAccountData=function(){var e=Mi.Accounts.getCurrent();return{Id:e.id(),Email:e.email(),FriendlyName:e.friendlyName()}},Ii.isMobile=function(){return this.getAppDataItem("IsMobile")},Ii.getRequestParam=Ei.getRequestParam,Ii.editedFolderList=function(){return Fi.MailCache.editedFolderList},Ii.FileSizeLimit=Mi.App.FileSizeLimit,Ii.isFunc=Ei.isFunc,Ii.isUnd=Ei.isUnd,Ii.getAppDataItem=function(e){return Mi&&Mi[e]?Mi[e]:null},p.prototype.setData=function(e,t){Data.setVar(e,t)},p.prototype.removeData=function(e){Data.setVar(e,"")},p.prototype.getData=function(e){return Data.getVar(e)},p.prototype.hasData=function(e){return Data.hasVar(e)},m.prototype.init=function(){e.ajaxSettings.cache=!0,this.provider="sip"===Mi.User.VoiceProvider?new g:new b,this.action(Ci.PhoneAction.OfflineInit)},m.prototype.log=function(){},m.prototype.onGetScript=function(e){e&&"success"===e?this.log("*************** gettingScript_success"):(this.log("*************** gettingScript_unknownError"),this.action(Ci.PhoneAction.OfflineError))},m.prototype.showError=function(e){1===Ei.pInt(e)&&Fi.Api.showError(Ei.i18n("PHONE/ERROR_SERVER_UNAVAILABLE"),!1,!0)},m.prototype.phoneSupport=function(e,t){var i=function(){try{try{var e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.6");try{e.AllowScriptAccess="always"}catch(t){return"6,0,0"}}catch(t){}return new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version").replace(/\D+/g,",").match(/^,?(.+),?$/)[1]}catch(t){try{if(navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin)return(navigator.plugins["Shockwave Flash 2.0"]||navigator.plugins["Shockwave Flash"]).description.replace(/\D+/g,",").match(/^,?(.+),?$/)[1]}catch(i){}}return"0,0,0"};!e||Fi.browser.chrome||t||Di?Di?this.log("*************** Device not supported"):t&&"0,0,0"===i()?this.log("*************** Please install flash player"):t&&i()<t&&this.log("*************** Please reinstall flash player"):this.log("*************** Browser not supported")},m.prototype.incomingCall=function(t){var i,s,o;this.action(Ci.PhoneAction.Incoming),t&&(i=this,s={Action:"ContactSuggestions",Search:t,PhoneOnly:"1"},o=function(e){i.report(Ei.i18n("PHONE/INCOMING_CALL_FROM")+" "+e),Fi.Screens.showPopup(V,[{text:e}]),Fi.desktopNotify({action:"show",title:e+" calling...",body:"Click here to answer.\r\n To drop the call, click End in the web interface.",callback:_.bind(function(){i.action(Ci.PhoneAction.IncomingConnect)},i),timeout:6e4})},Fi.Ajax.send(s,function(i){if(i&&i.Result&&i.Result.List&&i.Result.List[0]&&i.Result.List[0].Phones){var s="";e.each(i.Result.List[0].Phones,function(e,n){var r=i.Result.List[0],a=/[()\s_\-]/g,l=t.replace(a,""),h=n.replace(a,"");return l===h?(s=""===r.Name?r.Email+" "+n:r.Name+" "+n,o(s),!1):void 0},this),""===s&&o(t)}else o(t)},this),this.missedCalls(!0))},m.prototype.getFormattedPhone=function(e){e=e.toString();var t={8:"7"},i=/#/g.test(e)?e.split("#")[1]:e.replace(/[()\s_\-+]/g,"");return _.each(t,function(e,t){i=i.replace(new RegExp("^"+t,"g"),e)}),i},m.prototype.getLogs=function(e,t){this.missedCalls(!1),this.provider.getLogs(e,t)},m.prototype.getCleanedPhone=function(e){return e=e?e:"",e.replace("client:","")},g.prototype.init=function(){var t=this;e.getScript("static/js/sipml.js",function(e,i){t.phone.onGetScript(i),"success"===i&&(t.setConfigs(),SIPml.setDebugLevel("fatal"),SIPml.init(t.createStackBinded,t.createStackErrorBinded))})},g.prototype.setConfigs=function(){this.stackConf({realm:Mi.User.SipRealm,impi:Mi.User.SipImpi,impu:"sip:"+Mi.User.SipImpi+"@"+Mi.User.SipRealm,password:Mi.User.SipPassword,enable_rtcweb_breaker:!0,websocket_proxy_url:Mi.User.SipWebsocketProxyUrl,ice_servers:'[{ url: "stun:stun.afterlogic.com:3478"}]',events_listener:{events:"*",listener:this.eventSessionBinded}}),this.registerConf({audio_remote:this.audioRemote,expires:3600,events_listener:{events:"*",listener:this.eventSessionBinded},sip_caps:[{name:"+g.oma.sip-im",value:null},{name:"+audio",value:null},{name:"+sip.ice"},{name:"language",value:'"en,fr"'}]}),this.hangupConf({events_listener:{events:"*",listener:this.eventSessionBinded}})},g.prototype.createStack=function(){this.stack(new SIPml.Stack(this.stackConf())),this.stack().start()},g.prototype.createStackError=function(){this.phone.log("*************** Failed to initialize the engine")},g.prototype.register=function(){this.registerSession(this.stack().newSession("register",this.registerConf())),this.registerSession().register()},g.prototype.eventSession=function(e){this.phone.log("*************** "+e.type+" ("+e.description+")");var t=e.type;switch(t){case"starting":break;case"started":Fi.Api.hideError(),this.isStarted(!0),this.register();break;case"stopping":case"stopped":this.isStarted(!1),this.createStack();break;case"failed_to_stop":break;case"failed_to_start":this.phone.action(Ci.PhoneAction.OfflineError),this.isStarted(!1),this.reconnect(30);break;case"connecting":break;case"connected":"Connected"===e.description?this.phone.action(Ci.PhoneAction.Online):"In call"===e.description&&Fi.desktopNotify("hide");break;case"terminating":case"terminated":this.phone.action(Ci.PhoneAction.Online),"Disconnected"===e.description&&this.createStack();break;case"i_ao_request":break;case"media_added":break;case"media_removed":break;case"m_stream_video_remote_added":break;case"m_stream_audio_local_added":break;case"m_stream_audio_remote_added":break;case"i_request":break;case"o_request":break;case"sent_request":break;case"cancelled_request":break;case"i_new_call":this.callSession(e.newSession),this.callSession().setConfiguration(this.registerConf()),this.phone.incomingCall(this.callSession().getRemoteFriendlyName());break;case"i_new_message":break;case"m_permission_requested":break;case"m_permission_accepted":break;case"m_permission_refused":break;case"transport_error":break;case"global_error":break;case"message_error":break;case"webrtc_error":}},g.prototype.call=function(e){this.isStarted()?(this.action("outgoing"),this.callSession(this.stack().newSession("call-audio",this.registerConf())),this.callSession().call(e),this.phone.log("*************** "+this.callSession().getRemoteFriendlyName())):this.createStack()},g.prototype.answer=function(){this.callSession()&&this.callSession().accept(this.registerConf())},g.prototype.hangup=function(){this.callSession()&&(this.callSession().hangup(this.hangupConf()),this.callSession().hangup({events_listener:{events:"*",listener:this.eventSessionBinded}}))},g.prototype.reconnect=function(){var e=0;return function(t){clearInterval(e),t&&(e=setInterval(_.bind(function(){},this),t))}}(),g.prototype.getLogs=function(e,t){e.call(t)},f.prototype.init=function(){var t=this;e.getScript("static/js/swfobject.js",function(e,i){"success"===i&&(t.voiceApp(!0),swfobject.embedSWF("static/freeswitch.swf","flash","214","137","9.0.0","expressInstall.swf",{rtmp_url:"rtmp://217.199.220.26/phone"},{allowScriptAccess:"always",bgcolor:"#ece9e0"},[],!1),t.callbacks())})},f.prototype.log=function(){},f.prototype.showPrivacy=function(){Fi.Screens.showPopup(V,[{Action:Ci.PhoneAction.Settings,Callback:this.launchFlash.bind(this)}]);var t=e("#fake_flash"),i=t.offset(),s=t.width();this.jqFlash.css("left",i.left+s/2-107),this.jqFlash.css("top",i.top),this.jqFlash.css("visibility","visible"),this.flash.showPrivacy()},f.prototype.checkMic=function(){return this.flash.isMuted()},f.prototype.login=function(e,t){this.flash.login(e,t)},f.prototype.newCall=function(){},f.prototype.call=function(){this.flash.makeCall("sip:7002@217.199.220.24","7003@217.199.220.26",[])},f.prototype.answer=function(e){this.flash.answer(e)},f.prototype.hangup=function(e){this.flash.hangup(e)},f.prototype.addCall=function(){},f.prototype.launchFlash=function(){this.jqFlash.css("top","-200px")},f.prototype.callbacks=function(){var i=this;t.onInit=function(){i.log("**************** onInit"),i.initStatus(!0)},t.onConnected=function(t){i.log("**************** onConnected ("+t+")"),i.connectStatus(!0),i.sessionid(t),i.jqFlash=e("#flash"),i.flash=i.jqFlash[0],i.checkMic()&&i.showPrivacy(),i.login("7003@217.199.220.26","7003voippassword")
},t.onDisconnected=function(){i.log("**************** onDisconnected")},t.onEvent=function(e){i.log("**************** onEvent ("+e+")")},t.onLogin=function(e,t,s){i.log("**************** onLogin ("+e+", "+t+", "+s+")")},t.onLogout=function(e,t){i.log("**************** onLogout ("+e+", "+t+")")},t.onMakeCall=function(e,t,s){i.log("**************** onMakeCall ("+e+", "+t+", "+s+")")},t.onHangup=function(e,t){i.log("**************** onHangup ("+e+", "+t+")")},t.onIncomingCall=function(e,t,s,o,n){i.log("**************** onIncomingCall ("+e+", "+t+", "+s+", "+o+", "+n+")"),i.addCall(e,t,s)},t.onDisplayUpdate=function(e,t,s){i.log("**************** onDisplayUpdate ("+e+", "+t+", "+s+")")},t.onCallState=function(e,t){i.log("**************** onCallState ("+e+", "+t+")"),i.callState(t)},t.onDebug=function(e){i.log("**************** onDebug ("+e+")")},t.onAttach=function(e){i.log("**************** onAttach ("+e+")")}},b.prototype.init=function(){Fi.Ajax.send({Action:"TwilioGetToken"},this.onTokenResponse,this)},b.prototype.onTokenResponse=function(t){var i=this;t&&t.Result?(this.phone.log("*************** twilioToken_requestTrue"),e.ajaxSettings.cache=!0,e.getScript("//static.twilio.com/libs/twiliojs/1.2/twilio.min.js",function(e,s){i.phone.onGetScript(s),"success"===s&&(i.token=t.Result,i.setupDevice(t.Result))})):i.phone.onGetScript()},b.prototype.setupDevice=function(e){var i=this;this.phone.log("*************** setup"),this.phone.phoneSupport(!1,"10,1,000"),this.device=Twilio.Device,this.device.setup(e,{}),this.device.ready(function(e){i.phone.log("*************** ready ",e),i.webSocket=t.socket,i.action(Ci.PhoneAction.Online)}),this.device.offline(function(e){i.phone.log("*************** offline ",e),i.action(Ci.PhoneAction.Offline)}),this.device.error(function(e){switch(i.phone.log("*************** error ",e),e.message){case"This AccessToken is no longer valid":case"Cannot register. Token not validated":i.token=null,i.device.destroy()}i.action(Ci.PhoneAction.OfflineError)}),this.device.connect(function(e){i.phone.log("*************** connect ",e),"outbound"===e.message.Direction?i.action(Ci.PhoneAction.Outgoing):"inbound"===e.message.Direction&&i.action(Ci.PhoneAction.Incoming)}),this.device.disconnect(function(e){i.phone.log("*************** disconnect ",e),i.action(Ci.PhoneAction.Online)}),this.device.incoming(function(e){i.phone.log("*************** incoming ",e),i.connection=e,i.phone.incomingCall(e.parameters.From)}),this.device.cancel(function(e){i.phone.log("*************** cancel ",e),i.action(Ci.PhoneAction.Online)}),this.device.presence(function(e){i.phone.log("*************** presence ",e)})},b.prototype.call=function(e){this.connection=this.device.connect({PhoneNumber:e,AfterlogicCall:1})},b.prototype.answer=function(){this.connection.accept()},b.prototype.hangup=function(){this.connection&&(this.connection.status&&"pending"===this.connection.status()?this.connection.reject():this.connection.disconnect(),"closed"!==this.connection.status()&&_.delay(_.bind(function(){this.hangup()},this),1e3))},b.prototype.reconnect=function(){var e=0;return function(t){clearInterval(e),t&&(e=setInterval(_.bind(function(){this.device&&this.token?this.device.setup(this.token):this.init()},this),t))}}(),b.prototype.getLogs=function(e,t){var i={Action:"TwilioGetLogs",StartTime:moment().subtract("months",3).format("YYYY-MM-DD")};Fi.Ajax.send(i,e,t)},y.prototype.pgp=null,y.prototype.pgpKeyring=null,y.prototype.keys=[],y.prototype.getKeys=function(){return this.keys()},y.prototype.getKeysObservable=function(){return this.keys},y.prototype.reloadKeysFromStorage=function(){var e=[],t=this.pgpKeyring.getAllKeys();_.each(t,function(t){t&&t.primaryKey&&e.push(new S(t))}),this.keys(e)},y.prototype.convertToNativeKeys=function(e){return _.map(e,function(e){return e&&e.pgpKey?e.pgpKey:e})},y.prototype.cloneKey=function(e){var t=null;return e&&(t=this.pgp.key.readArmored(e.armor()),t&&!t.err&&t.keys&&t.keys[0]?(t=t.keys[0],t&&t.primaryKey||(t=null)):t=null),t},y.prototype.decryptKeyHelper=function(e,t,i,s){if(t)try{t.decrypt(Ei.pString(i)),t&&t.primaryKey&&t.primaryKey.isDecrypted||e.addError(v.Enum.KeyIsNotDecodedError,s||"")}catch(o){e.addExceptionMessage(o,v.Enum.KeyIsNotDecodedError,s||"")}else e.addError(v.Enum.KeyIsNotDecodedError,s||"")},y.prototype.verifyMessageHelper=function(e,t,i){var s=!1,o=null,n=[],r=[],a=[];if(i&&i.getSigningKeyIds)if(r=i.getSigningKeyIds(),r&&0<r.length)if(a=this.findKeysByEmails([t],!0),a&&0!==a.length){n=[];try{n=i.verify(this.convertToNativeKeys(a))}catch(l){e.addNotice(v.Enum.VerifyErrorNotice,t)}n&&0<n.length&&(o=_.find(n,function(e){return e&&e.keyid&&e.valid}),o&&o.keyid&&a&&a[0]&&o.keyid.toHex().toLowerCase()===a[0].getId()?s=!0:e.addNotice(v.Enum.VerifyErrorNotice,t))}else e.addNotice(v.Enum.PublicKeyNotFoundNotice,t);else e.addNotice(v.Enum.NoSignDataNotice);else e.addError(v.Enum.UnknownError);return s||e.hasNotices()||e.addNotice(v.Enum.VerifyErrorNotice),s},y.prototype.generateKey=function(e,t,i){var s=new v,o=null;try{o=this.pgp.generateKeyPair({userId:e,numBits:Ei.pInt(i),passphrase:Ei.trim(t)})}catch(n){s.addExceptionMessage(n)}if(o&&o.privateKeyArmored)try{this.pgpKeyring.privateKeys.importKey(o.privateKeyArmored),this.pgpKeyring.publicKeys.importKey(o.publicKeyArmored),this.pgpKeyring.store()}catch(n){s.addExceptionMessage(n,v.Enum.GenerateKeyError)}else s.addError(v.Enum.GenerateKeyError);return this.reloadKeysFromStorage(),s},y.prototype.splitKeys=function(e){var t=[],i=0,s=30,o=null,n=Ei.trim(e),r=/[\-]{3,6}BEGIN[\s]PGP[\s](PRIVATE|PUBLIC)[\s]KEY[\s]BLOCK[\-]{3,6}[\s\S]+?[\-]{3,6}END[\s]PGP[\s](PRIVATE|PUBLIC)[\s]KEY[\s]BLOCK[\-]{3,6}/gi;for(n=n.replace(/[\r\n]([a-zA-Z0-9]{2,}:[^\r\n]+)[\r\n]+([a-zA-Z0-9\/\\+=]{10,})/g,"\n$1---xyx---$2").replace(/[\n\r]+/g,"\n").replace(/---xyx---/g,"\n\n");;){if(o=r.exec(n),!o||0>s)break;o[0]&&o[1]&&o[2]&&o[1]===o[2]&&("PRIVATE"===o[1]||"PUBLIC"===o[1])&&(t.push([o[1],o[0]]),i++),s--}return t},y.prototype.importKeys=function(e){e=Ei.trim(e);var t=0,i=0,s=new v,o=null,n=[];if(!e)return s.addError(v.Enum.InvalidArgumentErrors);for(n=this.splitKeys(e),t=0;t<n.length;t++)if(o=n[t],"PRIVATE"===o[0])try{this.pgpKeyring.privateKeys.importKey(o[1]),i++}catch(r){s.addExceptionMessage(r,v.Enum.ImportKeyError,"private")}else if("PUBLIC"===o[0])try{this.pgpKeyring.publicKeys.importKey(o[1]),i++}catch(r){s.addExceptionMessage(r,v.Enum.ImportKeyError,"public")}return i>0?this.pgpKeyring.store():s.addError(v.Enum.ImportNoKeysFoundError),this.reloadKeysFromStorage(),s},y.prototype.getArmorInfo=function(e){e=Ei.trim(e);var t=0,i=0,s=null,o=[],n=null,r=[];if(!e)return!1;for(r=this.splitKeys(e),t=0;t<r.length;t++)if(n=r[t],"PRIVATE"===n[0])try{s=this.pgp.key.readArmored(n[1]),s&&!s.err&&s.keys&&s.keys[0]&&o.push(new S(s.keys[0])),i++}catch(a){o.push(null)}else if("PUBLIC"===n[0])try{s=this.pgp.key.readArmored(n[1]),s&&!s.err&&s.keys&&s.keys[0]&&o.push(new S(s.keys[0])),i++}catch(a){o.push(null)}return o},y.prototype.findKeyByID=function(e,t){t=!!t,e=e.toLowerCase();var i=_.find(this.keys(),function(i){var s=!1,o=null;return i&&t===i.isPublic()&&(o=i.pgpKey.getKeyIds(),o&&(s=_.find(o,function(t){return t&&t.toHex&&e===t.toHex().toLowerCase()}))),!!s});return i?i:null},y.prototype.findKeysByEmails=function(e,t,i){t=!!t;var s=[],o=this.keys();return _.each(e,function(e){var n=_.find(o,function(i){return i&&t===i.isPublic()&&e===i.getEmail()});n?s.push(n):i&&i.addError(t?v.Enum.PublicKeyNotFoundError:v.Enum.PrivateKeyNotFoundError,e)}),s},y.prototype.decryptAndVerify=function(e,t,i,s){var o=this,n=null,r=null,a=null,l=null,h=null,c=new v,u=[];if(n=this.pgp.message.readArmored(e),n&&n.decrypt)if(u=n.getEncryptionKeyIds(),u&&(a=null,r=null,_.each(u,function(e){r||(r=o.findKeyByID(e.toHex(),!1),r&&t!==r.getEmail()&&(r=null))}),r&&(a=r),a||_.each(u,function(e){a||(a=o.findKeyByID(e.toHex(),!1))})),a){if(l=this.cloneKey(this.convertToNativeKeys([a])[0]),this.decryptKeyHelper(c,l,s,a.getEmail()),l&&!c.hasErrors())try{h=n.decrypt(l)}catch(d){c.addExceptionMessage(d,v.Enum.DecryptError),h=null}h&&!c.hasErrors()&&(this.verifyMessageHelper(c,i,h),c.result=h.getText())}else c.addError(v.Enum.PrivateKeyNotFoundError);return c},y.prototype.verify=function(e,t){var i=null,s=new v;return i=this.pgp.cleartext.readArmored(e),i&&i.getText&&i.verify?(this.verifyMessageHelper(s,t,i),s.result=i.getText()):s.addError(v.Enum.CanNotReadMessage),s},y.prototype.encrypt=function(e,t){var i=new v,s=this.findKeysByEmails(t,!0,i);if(!i.hasErrors())try{i.result=this.pgp.encryptMessage(this.convertToNativeKeys(s),e)}catch(o){i.addExceptionMessage(o,v.Enum.EncryptError)}return i},y.prototype.sign=function(e,t,i){var s=new v,o=null,n=null,r=this.findKeysByEmails([t],!1,s);if(!s.hasErrors()&&(o=this.convertToNativeKeys(r)[0],n=this.cloneKey(o),this.decryptKeyHelper(s,n,i,t),n&&!s.hasErrors()))try{s.result=this.pgp.signClearMessage([n],e)}catch(a){s.addExceptionMessage(a,v.Enum.SignError,t)}return s},y.prototype.signAndEncrypt=function(e,t,i,s){var o=null,n=null,r=new v,a=this.findKeysByEmails([t],!1,r),l=this.findKeysByEmails(i,!0,r);if(!r.hasErrors()&&(o=this.convertToNativeKeys(a)[0],n=this.cloneKey(o),this.decryptKeyHelper(r,n,s,t),n&&!r.hasErrors()))try{r.result=this.pgp.signAndEncryptMessage(this.convertToNativeKeys(l),n,e)}catch(h){r.addExceptionMessage(h,v.Enum.SignAndEncryptError)}return r},y.prototype.deleteKey=function(e){var t=new v;if(e)try{this.pgpKeyring[e.isPrivate()?"privateKeys":"publicKeys"].removeForId(e.getFingerprint()),this.pgpKeyring.store()}catch(i){t.addExceptionMessage(i,v.Enum.DeleteError)}else t.addError(e?v.Enum.UnknownError:v.Enum.InvalidArgumentError);return this.reloadKeysFromStorage(),t},S.prototype.pgpKey=null,S.prototype.emailParts=null,S.prototype.user="",S.prototype.getId=function(){return this.pgpKey.primaryKey.getKeyId().toHex().toLowerCase()},S.prototype.getEmail=function(){return this.emailParts.email||this.user},S.prototype.getUser=function(){return this.user},S.prototype.getFingerprint=function(){return this.pgpKey.primaryKey.getFingerprint()},S.prototype.getBitSize=function(){return this.pgpKey.primaryKey.getBitSize()},S.prototype.getArmor=function(){return this.pgpKey.armor()},S.prototype.isPrivate=function(){return!!this.pgpKey.isPrivate()},S.prototype.isPublic=function(){return!this.isPrivate()},v.Enum={UnknownError:0,UnknownNotice:1,InvalidArgumentError:2,GenerateKeyError:10,ImportKeyError:20,ImportNoKeysFoundError:21,PrivateKeyNotFoundError:30,PublicKeyNotFoundError:31,KeyIsNotDecodedError:32,SignError:40,VerifyError:41,EncryptError:42,DecryptError:43,SignAndEncryptError:44,VerifyAndDecryptError:45,CanNotReadMessage:50,CanNotReadKey:51,DeleteError:60,PublicKeyNotFoundNotice:70,PrivateKeyNotFoundNotice:71,VerifyErrorNotice:72,NoSignDataNotice:73},v.prototype.result=!1,v.prototype.errors=null,v.prototype.notices=null,v.prototype.addError=function(e,t){return this.result=!1,this.errors=this.errors||[],this.errors.push([e||v.Enum.UnknownError,t||""]),this},v.prototype.addNotice=function(e,t){return this.notices=this.notices||[],this.notices.push([e||v.Enum.UnknownNotice,t||""]),this},v.prototype.addExceptionMessage=function(e,t,i){return e&&(this.result=!1,this.exceptions=this.exceptions||[],this.exceptions.push(""+(e.name||"unknown")+": "+(e.message||""))),Ei.isUnd(t)||this.addError(t,i),this},v.prototype.hasErrors=function(){return this.errors&&0<this.errors.length},v.prototype.hasNotices=function(){return this.notices&&0<this.notices.length},A.prototype.onShow=function(e){Ei.isFunc(e)&&(this.fConfirmCallback=e),this.shown=!0},A.prototype.onHide=function(){this.shown=!1},A.prototype.popupTemplate=function(){return"Popups_ConfirmAnotherMessageComposedPopupViewModel"},A.prototype.onDiscardClick=function(){this.shown&&this.fConfirmCallback&&this.fConfirmCallback(Ci.AnotherMessageComposedAnswer.Discard),this.closeCommand()},A.prototype.onSaveAsDraftClick=function(){this.shown&&this.fConfirmCallback&&this.fConfirmCallback(Ci.AnotherMessageComposedAnswer.SaveAsDraft),this.closeCommand()},A.prototype.onCancelClick=function(){this.fConfirmCallback&&this.fConfirmCallback(Ci.AnotherMessageComposedAnswer.Cancel),this.closeCommand()},A.prototype.onEnterHandler=function(){this.onSaveAsDraftClick()},A.prototype.onEscHandler=function(){this.onCancelClick()},C.prototype.onShow=function(e,t,i,s){this.alertDesc(e),this.closeCallback=t||null,this.title(i||""),this.okButtonText(s||Ei.i18n("MAIN/BUTTON_OK"))},C.prototype.popupTemplate=function(){return"Popups_AlertPopupViewModel"},C.prototype.onEnterHandler=function(){this.close()},C.prototype.close=function(){Ei.isFunc(this.closeCallback)&&this.closeCallback(),this.closeCommand()},E.prototype.onShow=function(e,t,i,s,o){this.title(i||""),this.okButtonText(s||Ei.i18n("MAIN/BUTTON_OK")),this.cancelButtonText(o||Ei.i18n("MAIN/BUTTON_CANCEL")),Ei.isFunc(t)&&(this.fConfirmCallback=t,this.confirmDesc(e)),this.shown=!0},E.prototype.onHide=function(){this.shown=!1},E.prototype.popupTemplate=function(){return"Popups_ConfirmPopupViewModel"},E.prototype.onEnterHandler=function(){this.yesClick()},E.prototype.yesClick=function(){this.shown&&this.fConfirmCallback&&this.fConfirmCallback(!0),this.closeCommand()},E.prototype.noClick=function(){this.fConfirmCallback&&this.fConfirmCallback(!1),this.closeCommand()},E.prototype.onEscHandler=function(){this.noClick()},T.prototype.popupTemplate=function(){return"Popups_AccountCreatePopupViewModel"},T.prototype.init=function(){this.isFirstStep(!0),this.friendlyName(""),this.email(""),this.incomingMailLogin(""),this.incomingLoginFocused(!1),this.incomingMailPassword(""),this.outgoingMailLogin(""),this.outgoingMailPassword(""),this.outServerFocused(!1),this.clearServers()},T.prototype.clearServers=function(){this.incomingMailPort(143),this.incomingMailServer(""),this.outgoingMailPort(25),this.outgoingMailServer(""),this.useSmtpAuthentication(!0)},T.prototype.onShow=function(){this.emailFocus(!0),this.init()},T.prototype.onFirstSaveClick=function(){if(this.isEmptyFirstFields())this.loading(!1);else{var e={Action:"DomainGetDataByEmail",Email:this.email()};this.loading(!0),Fi.Ajax.send(e,this.onDomainGetDataByEmailResponse,this)}},T.prototype.onSecondSaveClick=function(){if(this.isEmptySecondFields())this.loading(!1);else{var e={Action:"AccountCreate",AccountID:this.editedAccountId(),FriendlyName:this.friendlyName(),Email:this.email(),IncomingMailLogin:this.incomingMailLogin(),IncomingMailPassword:this.incomingMailPassword(),IncomingMailServer:this.incomingMailServer(),IncomingMailPort:parseInt(this.incomingMailPort(),10),OutgoingMailServer:this.outgoingMailServer(),OutgoingMailLogin:this.outgoingMailLogin(),OutgoingMailPassword:this.outgoingMailPassword(),OutgoingMailPort:parseInt(this.outgoingMailPort(),10),OutgoingMailAuth:this.useSmtpAuthentication()?2:0};this.loading(!0),Fi.Ajax.send(e,this.onAccountCreateResponse,this)}},T.prototype.onSaveClick=function(){this.loading()||(this.isFirstStep()?this.onFirstSaveClick():this.onSecondSaveClick())},T.prototype.onCancelClick=function(){this.closeCommand(),this.init()},T.prototype.onDomainGetDataByEmailResponse=function(e){this.incomingMailLogin(this.email()),e.Result?(this.incomingMailPort(e.Result.IncomingMailPort),this.incomingMailServer(e.Result.IncomingMailServer),this.outgoingMailPort(e.Result.OutgoingMailPort),this.outgoingMailServer(e.Result.OutgoingMailServer),this.onSecondSaveClick()):(this.loading(!1),this.isFirstStep(!1),this.incomingLoginFocused(!0))},T.prototype.onAccountCreateResponse=function(e,t){if(this.loading(!1),e.Result){var i=new J,s=parseInt(e.Result.IdAccount,10);i.init(s,t.Email,t.FriendlyName),i.updateExtended(t),i.setExtensions(e.Result.Extensions),Mi.Accounts.addAccount(i),Mi.Accounts.populateIdentities(),this.closeCommand()}else Fi.Api.showErrorByCode(e,Ei.i18n("WARNING/CREATING_ACCOUNT_ERROR"))},T.prototype.isEmptyFirstFields=function(){switch(""){case this.email():return this.emailFocus(!0),!0;case this.incomingMailPassword():return this.incomingMailFocus(!0),!0;default:return!1}},T.prototype.isEmptySecondFields=function(){switch(""){case this.email():return this.emailFocus(!0),!0;case this.incomingMailLogin():return this.incomingLoginFocused(!0),!0;case this.incomingMailServer():return this.incomingServerFocused(!0),!0;case this.outgoingMailServer():return this.outServerFocused(!0),!0;default:return!1}},F.prototype.popupTemplate=function(){return"Popups_AccountCreateIdentityPopupViewModel"},F.prototype.onShow=function(e){var t=Mi.Accounts.getAccount(e),i=new it;i.accountId(e),i.email(t.email()),this.oIdentityPropertiesViewModel.populate(i),this.oIdentityPropertiesViewModel.friendlyNameHasFocus(!0)},F.prototype.cancel=function(){this.closeCommand()},I.prototype.popupTemplate=function(){return"Popups_FetcherAddPopupViewModel"},I.prototype.onShow=function(){this.incomingMailServer(""),this.incomingMailPort(110),this.incomingMailLogin(""),this.incomingMailPassword(""),this.folder(""),this.outgoingMailServer(""),this.outgoingMailPort(25),this.leaveMessagesOnServer(!0)},I.prototype.onSaveClick=function(){if(this.isEmptyRequiredFields())Fi.Api.showError(Ei.i18n("WARNING/FETCHER_CREATE_ERROR"));else{var e={Action:"AccountFetcherCreate",AccountID:this.defaultAccountId(),Folder:this.folder(),IncomingMailServer:this.incomingMailServer(),IncomingMailPort:parseInt(this.incomingMailPort(),10),IncomingMailLogin:this.incomingMailLogin(),IncomingMailPassword:""===this.incomingMailPassword()?"******":this.incomingMailPassword(),LeaveMessagesOnServer:this.leaveMessagesOnServer()?1:0};this.loading(!0),Fi.Ajax.send(e,this.onAccountFetcherCreateResponse,this)}},I.prototype.onAccountFetcherCreateResponse=function(e){this.loading(!1),e.Result?(Mi.Accounts.populateFetchers(),this.closeCommand()):Fi.Api.showErrorByCode(e)},I.prototype.onCancelClick=function(){this.newFolderCreating()||this.closeCommand()},I.prototype.onEscHandler=function(){this.onCancelClick()},I.prototype.isEmptyRequiredFields=function(){switch(""){case this.incomingMailServer():return this.serverIsSelected(!0),!0;case this.incomingMailLogin():return this.loginIsSelected(!0),!0;case this.incomingMailPassword():return this.passwordIsSelected(!0),!0;default:return!1}},I.prototype.onAddNewFolderClick=function(){this.newFolderCreating(!0),Fi.Screens.showPopup(w,[_.bind(this.chooseFolderInList,this)])},I.prototype.chooseFolderInList=function(e,t){var i=this.folderList().delimiter(),s=[];""!==e&&""!==t&&_.each(this.options(),_.bind(function(o){e===o.name&&(s=o.fullName.split(i),s.pop(),t===s.join(i)&&this.folder(o.fullName))},this)),this.newFolderCreating(!1)},M.prototype.onShow=function(){var e=Fi.MailCache.editedFolderList();this.sentFolderFullName(e.sentFolderFullName()),this.draftsFolderFullName(e.draftsFolderFullName()),this.allowSpamFolderEditing()&&this.spamFolderFullName(e.spamFolderFullName()),this.trashFolderFullName(e.trashFolderFullName()),this.options(this.folders().getOptions(Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_NO_USAGE_ASSIGNED"),!1,!1,!1))},M.prototype.popupTemplate=function(){return"Popups_FolderSystemPopupViewModel"},M.prototype.onResponseFoldersSetupSystem=function(e){e.Result===!1&&(Fi.Api.showErrorByCode(e,Ei.i18n("ACCOUNT_FOLDERS_ERROR_SETUP_SPECIAL_FOLDERS")),Fi.MailCache.getFolderList(Mi.Accounts.editedId()))},M.prototype.onOKClick=function(){var e=this.folders(),t=!1,i=null;this.sentFolderFullName()!==e.sentFolderFullName()&&(e.sentFolderFullName(this.sentFolderFullName()),t=!0),this.draftsFolderFullName()!==e.draftsFolderFullName()&&(e.draftsFolderFullName(this.draftsFolderFullName()),t=!0),this.allowSpamFolderEditing()&&this.spamFolderFullName()!==e.spamFolderFullName()&&(e.spamFolderFullName(this.spamFolderFullName()),t=!0),this.trashFolderFullName()!==e.trashFolderFullName()&&(e.trashFolderFullName(this.trashFolderFullName()),t=!0),t&&(i={Action:"FoldersSetupSystem",AccountID:Mi.Accounts.editedId(),Sent:e.sentFolderFullName(),Drafts:e.draftsFolderFullName(),Trash:e.trashFolderFullName(),Spam:e.spamFolderFullName()},Fi.Ajax.send(i,this.onResponseFoldersSetupSystem,this)),this.closeCommand()},M.prototype.onCancelClick=function(){this.closeCommand()},M.prototype.onEscHandler=function(){this.onCancelClick()},w.prototype.popupTemplate=function(){return"Popups_FolderCreatePopupViewModel"},w.prototype.onShow=function(e){this.fCallback=e,this.folderName(""),this.parentFolder(""),this.folderNameFocus(!0)},w.prototype.onResponseFolderCreate=function(e){e.Result?Fi.MailCache.getFolderList(Mi.Accounts.editedId()):(this.loading(!1),Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_CANT_CREATE_FOLDER")))},w.prototype.onOKClick=function(){var e=""===this.parentFolder()?this.namespace():this.parentFolder(),t={Action:"FolderCreate",AccountID:Mi.Accounts.editedId(),FolderNameInUtf8:this.folderName(),FolderParentFullNameRaw:e,Delimiter:this.folders().delimiter()};this.loading(!0),Fi.Ajax.send(t,this.onResponseFolderCreate,this)},w.prototype.onCancelClick=function(){this.loading()||(this.fCallback&&this.fCallback("",""),this.closeCommand())},w.prototype.onEscHandler=function(){this.onCancelClick()},P.prototype.onShow=function(e){this.isHelpdesk(e),this.init()},P.prototype.popupTemplate=function(){return"Popups_ChangePasswordPopupViewModel"},P.prototype.init=function(){this.currentPassword(""),this.newPassword(""),this.confirmPassword("")},P.prototype.onUpdatePasswordResponse=function(e){e.Result===!1?Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ACCOUNT_PROPERTIES_NEW_PASSWORD_UPDATE_ERROR")):(Fi.Api.showReport(Ei.i18n("SETTINGS/ACCOUNT_PROPERTIES_CHANGE_PASSWORD_SUCCESS")),this.closeCommand(),this.init())},P.prototype.onOKClick=function(){var e=null;this.confirmPassword()!==this.newPassword()?Fi.Api.showError(Ei.i18n("WARNING/PASSWORDS_DO_NOT_MATCH")):this.newPassword().length<Mi.App.PasswordMinLength?Fi.Api.showError(Ei.i18n("WARNING/PASSWORDS_MIN_LENGTH_ERROR").replace("%N%",Mi.App.PasswordMinLength)):!Mi.App.PasswordMustBeComplex||this.newPassword().match(/([0-9])/)&&this.newPassword().match(/([!,%,&,@,#,$,^,*,?,_,~])/)?this.isHelpdesk()?(e={Action:"HelpdeskUserUpdatePassword",CurrentPassword:this.currentPassword(),NewPassword:this.newPassword()},Fi.Ajax.sendExt(e,this.onUpdatePasswordResponse,this)):(e={Action:"AccountUpdatePassword",AccountID:Mi.Accounts.editedId(),CurrentIncomingMailPassword:this.currentPassword(),NewIncomingMailPassword:this.newPassword()},Fi.Ajax.send(e,this.onUpdatePasswordResponse,this)):Fi.Api.showError(Ei.i18n("WARNING/PASSWORD_MUST_BE_COMPLEX"))},P.prototype.onCancelClick=function(){this.closeCommand()},R.prototype.onShow=function(e){this.folderName(""),this.folderName.focus(!0),this.folderName.error(""),Ei.isFunc(e)&&(this.fCallback=e)},R.prototype.popupTemplate=function(){return"Popups_FileStorage_FolderCreatePopupViewModel"},R.prototype.onOKClick=function(){if(this.folderName.error(""),this.fCallback){var e=this.fCallback(this.folderName());e?this.folderName.error(""+e):this.closeCommand()}else this.closeCommand()},R.prototype.onCancelClick=function(){this.closeCommand()},D.prototype.onShow=function(e){this.link(""),this.linkFocus(!0),Ei.isFunc(e)&&(this.fCallback=e),this.checkTimer=setTimeout(_.bind(this.checkUrl,this),2e3)},D.prototype.popupTemplate=function(){return"Popups_FileStorage_LinkCreatePopupViewModel"},D.prototype.checkUrl=function(){clearTimeout(this.checkTimer),this.link()!==this.linkPrev()&&(this.linkPrev(this.link()),Fi.Ajax.send({Action:"FilesCheckUrl",Url:this.link()},this.onFilesCheckUrlResponse,this)),this.checkTimer=setTimeout(_.bind(this.checkUrl,this),1e3)},D.prototype.onFilesCheckUrlResponse=function(e){var t=new st;e.Result?(t.isPopupItem(!0),t.linkUrl(this.link()),t.fileName(e.Result.Name),t.size(e.Result.Size),t.allowDownload(!1),e.Result.Thumb&&(t.thumb(!0),t.thumbnailSrc(e.Result.Thumb)),this.fileItem(t),this.urlChecked(!0)):this.urlChecked(!1)},D.prototype.executeSave=function(){this.fCallback&&(this.fCallback(this.fileItem()),this.link(""),this.linkPrev(""),this.urlChecked(!1)),clearTimeout(this.checkTimer),this.closeCommand()},D.prototype.onCancelClick=function(){this.link(""),this.linkPrev(""),this.urlChecked(!1),clearTimeout(this.checkTimer),this.closeCommand()},D.prototype.onEscHandler=function(){this.onCancelClick()},N.prototype.onShow=function(e,t){this.item=e,this.item.nameForEdit(this.item.fileName()),this.name(this.item.nameForEdit()),this.name.focus(!0),this.name.error(""),Ei.isFunc(t)&&(this.fCallback=t)},N.prototype.popupTemplate=function(){return"Popups_FileStorage_RenamePopupViewModel"},N.prototype.onOKClick=function(){if(this.name.error(""),this.fCallback){this.item.nameForEdit(this.name());var e=this.fCallback(this.item);e?this.name.error(""+e):this.closeCommand()}else this.closeCommand()},N.prototype.onCancelClick=function(){this.closeCommand()},k.prototype.onShow=function(e){this.item=e,this.pub(""),Fi.Ajax.send({Action:"FilesCreatePublicLink",Account:Mi.Accounts.defaultId(),Type:e.storageType(),Path:e.path(),Name:e.fileName(),Size:e.size(),IsFolder:e.isFolder()?"1":"0"},this.onFilesCreatePublicLinkResponse,this)},k.prototype.onFilesCreatePublicLinkResponse=function(e){e.Result&&(this.pub(e.Result),this.pubFocus(!0),this.item.shared(!0))},k.prototype.popupTemplate=function(){return"Popups_FileStorage_SharePopupViewModel"},k.prototype.onOKClick=function(){this.closeCommand()},k.prototype.onFilesDeletePublicLinkResponse=function(){this.closeCommand()},k.prototype.onCancelSharingClick=function(){this.item&&(Fi.Ajax.send({Action:"FilesPublicLinkDelete",Account:Mi.Accounts.defaultId(),Type:this.item.storageType(),Path:this.item.path(),Name:this.item.fileName()},this.onFilesDeletePublicLinkResponse,this),this.item.shared(!1))},L.prototype.onShow=function(e){Ei.isFunc(e)&&(this.fCallback=e),this.fileStorageViewModel.onShow()},L.prototype.onApplyBindings=function(e){this.fileStorageViewModel.onApplyBindings(e)},L.prototype.popupTemplate=function(){return"Popups_FileStorage_FileStoragePopupViewModel"},L.prototype.onSelectClick=function(){var e=this.fileStorageViewModel.selector.listCheckedAndSelected(),t=_.filter(e,function(e){return!e.isFolder()},this);this.fCallback&&this.fCallback(t),this.closeCommand()},L.prototype.onCancelClick=function(){this.closeCommand()},O.prototype.clearFields=function(){this.calendarName(""),this.calendarDescription(""),this.selectedColor(this.colors[0]),this.calendarId(null)},O.prototype.onShow=function(t,i,s){this.clearFields(),Ei.isFunc(t)&&(this.fCallback=t),Ei.isUnd(i)||(this.colors(i),this.selectedColor(i[0])),Ei.isUnd(s)?this.popupTitle(Ei.i18n("CALENDAR/TITLE_CREATE_CALENDAR")):(this.popupTitle(Ei.i18n(s.name()?"CALENDAR/TITLE_EDIT_CALENDAR":"CALENDAR/TITLE_CREATE_CALENDAR")),this.calendarName(s.name?s.name():""),this.calendarDescription(s.description?s.description():""),this.selectedColor(s.color?s.color():""),this.calendarId(s.id?s.id:null)),e(document).on("keyup.calendar_create",_.bind(function(e){e.keyCode===Ci.Key.Enter&&this.onSaveClick()},this))},O.prototype.onHide=function(){e(document).off("keyup.calendar_create")},O.prototype.popupTemplate=function(){return"Popups_Calendar_CalendarPopupViewModel"},O.prototype.onSaveClick=function(){""===this.calendarName()?Fi.Screens.showPopup(C,[Ei.i18n("CALENDAR/WARNING_BLANK_CALENDAR_NAME")]):(this.fCallback&&(this.fCallback(this.calendarName(),this.calendarDescription(),this.selectedColor(),this.calendarId()),this.clearFields()),this.closeCommand())},O.prototype.onCancelClick=function(){this.closeCommand()},x.prototype.onShow=function(e,t){Ei.isFunc(e)&&(this.fCallback=e),Ei.isUnd(t)||(this.color(t.color?t.color():""),this.calendarId(t.id?t.id:""))},x.prototype.popupTemplate=function(){return"Popups_Calendar_ImportPopupViewModel"},x.prototype.onApplyBindings=function(t){var i=this;this.oJua=new Jua({action:"?/Upload/Calendars/",name:"jua-uploader",queueSize:1,clickElement:e("#jue_import_button",t),hiddenElementsPosition:Ei.isRTL()?"right":"left",disableAjaxUpload:!1,disableDragAndDrop:!0,disableMultiple:!0,hidden:{Token:function(){return Mi.Token},AccountID:function(){return Mi.Accounts.currentId()},AdditionalData:function(){return JSON.stringify({CalendarID:i.calendarId()})}}}),this.oJua.on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)),this.allowDragNDrop(this.oJua.isDragAndDropSupported())},x.prototype.onFileUploadStart=function(){this.importing(!0)},x.prototype.onFileUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1;s?Fi.Api.showError(i.ErrorCode&&i.ErrorCode===Ci.Errors.IncorrectFileExtension?Ei.i18n("CONTACTS/ERROR_INCORRECT_FILE_EXTENSION"):Ei.i18n("WARNING/ERROR_UPLOAD_FILE")):(this.importing(!1),this.fCallback(),this.closeCommand())},x.prototype.onCancelClick=function(){this.closeCommand()},U.prototype.onShow=function(e,t){Ei.isFunc(e)&&(this.fCallback=e),Ei.isUnd(t)||(this.selectedColor(t.color()),this.calendarId(t.id),this.calendarUrl(t.davUrl()+t.url()),this.exportUrl(t.exportUrl()),this.icsLink(t.davUrl()+t.url()+"?export"),this.isPublic(t.isPublic()),this.owner(t.owner()),this.populateShares(t.shares()),this.sharedToAll(t.isSharedToAll()),this.sharedToAllAccess(t.sharedToAllAccess))},U.prototype.popupTemplate=function(){return"Popups_Calendar_SharePopupViewModel"},U.prototype.onSaveClick=function(){this.fCallback&&this.fCallback(this.calendarId(),this.isPublic(),this.getShares(),this.sharedToAll(),this.sharedToAllAccess()),this.closePopup()},U.prototype.onCancelClick=function(){this.closePopup()},U.prototype.onEscHandler=function(){this.onCancelClick()},U.prototype.closePopup=function(){this.cleanAll(),this.closeCommand()},U.prototype.cleanAll=function(){this.newShare(""),this.newShareAccess(Ci.CalendarAccess.Read),this.shareToAllAccess=i.observable(Ci.CalendarAccess.Read),this.canAdd(!1)},U.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e,GlobalOnly:"1"};e=Ei.trim(e),""!==e?Fi.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result&&e.Result.List&&(i=_.map(e.Result.List,function(e){return e&&e.Email&&e.Email!==this.owner()?e.Name&&0<Ei.trim(e.Name).length?e.ForSharedToAll?{value:e.Name,name:e.Name,email:e.Email,frequency:e.Frequency}:{value:'"'+e.Name+'" <'+e.Email+">",name:e.Name,email:e.Email,frequency:e.Frequency}:{value:e.Email,name:"",email:e.Email,frequency:e.Frequency}:null},this),i=_.sortBy(_.compact(i),function(e){return e.frequency}).reverse()),t(i)},this):t([])},U.prototype.itsMe=function(e){return e===this.defaultAccount.email()},U.prototype.initInputosaurus=function(t,i,s){t()&&e(t()).length>0&&e(t()).inputosaurus({width:"auto",parseOnBlur:!0,autoCompleteSource:_.bind(function(e,t){this.autocompleteCallback(e.term,t)},this),change:_.bind(function(e){s(!0),this.setRecipient(i,e.target.value),s(!1)},this),copy:_.bind(function(e){this.inputosaurusBuffer=e},this),paste:_.bind(function(){var e=this.inputosaurusBuffer||"";return this.inputosaurusBuffer="",e},this),mobileDevice:Ni})},U.prototype.setRecipient=function(e,t){e()===t?e.valueHasMutated():e(t)},U.prototype.getShares=function(){return e.merge(_.map(Ei.getArrayRecipients(this.guests()),function(e){return{name:e.name,email:e.email,access:Ci.CalendarAccess.Read}}),_.map(Ei.getArrayRecipients(this.owners()),function(e){return{name:e.name,email:e.email,access:Ci.CalendarAccess.Write}}))},U.prototype.populateShares=function(e){var t="",i="";_.each(e,function(e){e.access===Ci.CalendarAccess.Read?t=""!==e.name?t+e.name+" <"+e.email+">,":t+e.email+", ":e.access===Ci.CalendarAccess.Write&&(i=""!==e.name?i+e.name+" <"+e.email+">,":i+e.email+", ")},this),this.setRecipient(this.guests,t),this.setRecipient(this.owners,i)},H.prototype.onShow=function(e,t){Ei.isFunc(e)&&(this.fCallback=e),Ei.isUnd(t)||(this.selectedColor(t.color()),this.calendarId(t.id),this.calendarUrl(t.davUrl()+t.url()),this.exportUrl(t.exportUrl()),this.icsLink(t.davUrl()+t.url()+"?export"),this.isPublic(t.isPublic()),this.pubUrl(t.pubUrl()),this.exportUrl(t.exportUrl()))
},H.prototype.popupTemplate=function(){return"Popups_Calendar_GetLinkPopupViewModel"},H.prototype.onCancelClick=function(){this.fCallback&&this.fCallback(this.calendarId(),this.isPublic()),this.closeCommand()},H.prototype.onEscHandler=function(){this.onCancelClick()},G.prototype.createDatePickerObject=function(t,i){e(t).datepicker({showOtherMonths:!0,selectOtherMonths:!0,monthNames:Ei.getMonthNamesArray(),dayNamesMin:Ei.i18n("DATETIME/DAY_NAMES_MIN").split(" "),nextText:"",prevText:"",firstDay:Mi.User.CalendarWeekStartsOn,showOn:"both",buttonText:"",buttonImage:"skins/Default/images/calendar-icon.png",buttonImageOnly:!0,dateFormat:this.dateFormatDatePicker,onSelect:i}),e(t).mousedown(function(){e("#ui-datepicker-div").toggle()})},G.prototype.initializeDatePickers=function(){this.createDatePickerObject(this.startDom(),this.selectStartDate.bind(this)),this.createDatePickerObject(this.endDom(),this.selectEndDate.bind(this)),this.createDatePickerObject(this.repeatEndDom(),Ei.emptyFunction()),this.startDom().datepicker("option","dateFormat",this.dateFormatDatePicker),this.endDom().datepicker("option","dateFormat",this.dateFormatDatePicker),this.repeatEndDom().datepicker("option","dateFormat",this.dateFormatDatePicker)},G.prototype.onShow=function(e){var t=this.defaultAccount,i=t?t.email():"",s=t?t.friendlyName():"",o=e.End?e.End.clone():null,n=e.Start.clone(),r="",a=null,l="";this.differenceInMinutes=null,this.FCMoment=e.FCMoment,this.calendarId(e.SelectedCalendar),this.calendars=e.Calendars,a=this.calendars.getCalendarById(this.calendarId()),a&&(l=a.owner()),this.isMyEvent(i===(e.Owner||l)),this.callbackSave=e.CallbackSave,this.callbackDelete=e.CallbackDelete,this.callbackAttendeeActionDecline=e.CallbackAttendeeActionDecline,this.timeFormatMoment=e.TimeFormat,this.dateFormatMoment=Ei.getDateFormatForMoment(e.DateFormat),this.dateFormatDatePicker=Ei.getDateFormatForDatePicker(e.DateFormat),this.ampmTimeFormat(Mi.User.defaultTimeFormat()!==Ci.TimeFormat.F24),this.initializeDatePickers(),this.allDay(e.AllDay),this.setStartDate(n,!0),this.startTime(n.format(this.timeFormatMoment)),o&&this.allDay()&&o.subtract(1,"days"),o||(o=n),this.setEndDate(o,!0),this.endTime(o.format(this.timeFormatMoment)),this.calendars&&this.calendarsList(_.filter(this.calendars.collection(),function(e){return e.isEditable()})),this.selectedCalendarId(e.SelectedCalendar),this.selectedCalendarId.valueHasMutated(),this.editableSwitch(this.selectedCalendarIsShared(),this.selectedCalendarIsEditable(),this.isMyEvent()),this.changeCalendarColor(this.selectedCalendarId()),this.id(e.ID||null),this.uid(e.Uid||null),this.recurrenceId(e.RecurrenceId||null),this.subject(e.Subject||""),this.location(e.Location||""),this.description(e.Description||""),this.allEvents(e.AllEvents||Ci.CalendarEditRecurrenceEvent.AllEvents),this.populateAlarms(e.Alarms),this.appointment(e.Appointment),this.attendees(e.Attendees||[]),Mi.Accounts&&(r=Mi.Accounts.getAttendee(_.map(this.attendees(),function(e){return e.email},this))),this.setCurrentAttenderStatus(r,e.Attendees||[]),this.owner(e.Owner||i),this.ownerName(e.OwnerName||(this.isMyEvent()&&this.owner()===t.email()?s:"")),this.guestAutocomplete(""),this.excluded(e.Excluded||!1),this.repeatRuleParse(e.RRule||null),null===this.id()&&this.subjectFocus(!0),this.autosizeTrigger.notifySubscribers(!0),this.modified=!1,this.isAppointmentButtonsVisible(this.appointment()&&this.selectedCalendarIsEditable()&&_.find(this.attendees(),function(e){return e.email===i}))},G.prototype.popupTemplate=function(){return"Popups_Calendar_EventPopupViewModel"},G.prototype.changeCalendarColor=function(e){if(Ei.isFunc(this.calendars.getCalendarById)){var t=this.calendars.getCalendarById(e);t&&(this.calendarColor(""),this.calendarColor(t.color()))}},G.prototype.onSaveClick=function(){if(""===this.subject())Fi.Screens.showPopup(C,[Ei.i18n("CALENDAR/WARNING_EVENT_BLANK_SUBJECT"),_.bind(function(){this.subjectFocus(!0)},this)]);else{if(this.callbackSave){var e=this.repeatPeriod(),t="",i=null,s=0,o=moment(this.getDateTime(this.startDom(),this.startTime())),n=moment(this.getDateTime(this.endDom(),this.endTime())),r={calendarId:this.calendarId(),newCalendarId:this.selectedCalendarId(),id:this.id(),uid:this.uid(),recurrenceId:this.recurrenceId(),allEvents:this.allEvents(),subject:this.subject(),title:Ei.getTitleForEvent(this.subject()),start:o,allDay:this.allDay(),location:this.location(),description:this.description(),alarms:this.getAlarmsArray(this.displayedAlarms()),attendees:this.attendees(),owner:this.owner(),modified:this.modified};this.allDay()&&n.add(1,"days"),r.end=n,e&&(t=this.repeatEndDom().datepicker("getDate"),i=t?moment(t).unix():null,s=this.repeatInterval(),e===Ci.CalendarRepeatPeriod.Daily?r.rrule={byDays:[],count:null,end:2,interval:1,period:e,until:i,weekNum:null}:e===Ci.CalendarRepeatPeriod.Weekly?(this.setDayOfWeek(),r.rrule={byDays:this.getDays(),count:null,end:2,interval:s,period:e,until:i,weekNum:null}):e===Ci.CalendarRepeatPeriod.Monthly?r.rrule={byDays:[],count:null,end:0,interval:1,period:e,until:null,weekNum:null}:e===Ci.CalendarRepeatPeriod.Yearly&&(r.rrule={byDays:[],count:null,end:0,interval:1,period:e,until:null,weekNum:null})),this.callbackSave(r)}this.closePopup()}},G.prototype.onEscHandler=function(){_.delay(_.bind(this.closePopup,this),100)},G.prototype.closePopup=function(){this.hideAll(),this.cleanAll(),this.closeCommand()},G.prototype.hideAll=function(){this.dateEdit(!1),this.repeatEdit(!1),this.guestsEdit(!1)},G.prototype.cleanAll=function(){this.subject(""),this.description(""),this.location(""),this.isRepeat(!1),this.allDay(!1),this.repeatPeriod(Ci.CalendarRepeatPeriod.None),this.repeatInterval(1),this.repeatCount(null),this.repeatWeekNum(null),this.startDate(""),this.startTime(""),this.endDate(""),this.endTime(""),this.repeatEndDate(""),this.displayedAlarms([]),this.weekMO(!1),this.weekTU(!1),this.weekWE(!1),this.weekTH(!1),this.weekFR(!1),this.weekSA(!1),this.weekSU(!1),this.attendees([]),this.selectedCalendarId(""),this.attendees([])},G.prototype.onDeleteClick=function(){if(this.callbackDelete){var e={calendarId:this.selectedCalendarId(),id:this.id(),uid:this.uid(),recurrenceId:this.recurrenceId(),allEvents:this.allEvents(),subject:this.subject(),title:Ei.getTitleForEvent(this.subject()),start:moment(this.getDateTime(this.startDom(),this.startTime())),end:moment(this.getDateTime(this.endDom(),this.endTime())),allDay:this.allDay(),location:this.location(),description:this.description()};this.callbackDelete(e)}this.closePopup()},G.prototype.showDates=function(e,t){t.stopPropagation(),this.dateEdit(!this.dateEdit())},G.prototype.showGuests=function(){if(this.attendees().length>0){var e=Ei.i18n("CALENDAR/CONFIRM_CLOSE_ATTENDEERS"),t=_.bind(function(e){e&&(this.guestsEdit(!1),this.guestEmailFocus(!1),this.attendees([]))},this);Fi.Screens.showPopup(E,[e,t])}else this.guestsEdit(!this.guestsEdit()),this.guestEmailFocus(!this.guestEmailFocus())},G.prototype.onAddGuestClick=function(){var e=this.guestAutocompleteItem(),t=this.guestAutocomplete(),i=e||{name:"",email:t},s=_.any(this.attendees(),function(e){return e.email===i.email});""===i.email?Fi.Api.showError(Ei.i18n("CALENDAR/EVENT_ERROR_ENTER_EMAIL")):i.email===this.owner()?this.recivedAnim(!0):s?this.recivedAnim(!0):this.attendees.push({status:0,name:i.name,email:i.email}),this.whomAnimate(i.email),this.guestAutocomplete("")},G.prototype.populateAlarms=function(e){e?(this.alarmOptions(this.getDisplayedAlarms(_.union(this.defaultAlarms(),e))),this.displayedAlarms(this.getDisplayedAlarms(e))):this.alarmOptions(this.getDisplayedAlarms(this.defaultAlarms()))},G.prototype.getDisplayedAlarms=function(e){var t,s,o=[];return e&&_.each(e,function(e){t=this["alarm"+e]=i.observable(e),t.subscribe(function(){this.disableAlarms()},this),s=e>0&&60>e?Ei.i18n("CALENDAR/ALARM_MINUTES_PLURAL",{COUNT:e},null,e):e>=60&&1440>e?Ei.i18n("CALENDAR/ALARM_HOURS_PLURAL",{COUNT:e/60},null,e/60):e>=1440&&10080>e?Ei.i18n("CALENDAR/ALARM_DAYS_PLURAL",{COUNT:e/1440},null,e/1440):Ei.i18n("CALENDAR/ALARM_WEEKS_PLURAL",{COUNT:e/10080},null,e/10080),o.push({value:e,alarm:t,text:s,isDisabled:!1})},this),_.sortBy(o,function(e){return e.value})},G.prototype.getDisplayedPeriods=function(){return[{label:Ei.i18n("CALENDAR/EVENT_REPEAT_NEVER"),value:0},{label:Ei.i18n("CALENDAR/EVENT_REPEAT_DAILY"),value:1},{label:Ei.i18n("CALENDAR/EVENT_REPEAT_WEEKLY"),value:2},{label:Ei.i18n("CALENDAR/EVENT_REPEAT_MONTHLY"),value:3},{label:Ei.i18n("CALENDAR/EVENT_REPEAT_YEARLY"),value:4}]},G.prototype.getDisplayedIntervals=function(){for(var e=1,t=[];30>=e;e++)t.push({label:e+Ei.i18n("th"),value:e});return t},G.prototype.getAlarmsArray=function(e){var t=[];return _.each(e,function(e){t.push(e.alarm())},this),_.sortBy(t,function(e){return-e})},G.prototype.addFirstAlarm=function(){if(this.displayedAlarms().length){var e=Ei.i18n("CALENDAR/CONFIRM_CLOSE_ALARMS"),t=_.bind(function(e){e&&this.displayedAlarms.removeAll()},this);Fi.Screens.showPopup(E,[e,t])}else this.displayedAlarms(this.getDisplayedAlarms([this.alarmOptions()[0].value]))},G.prototype.addAlarm=function(){var e,t,s=0;t=_.sortBy(this.displayedAlarms(),function(e){return e.alarm()}),_.each(t,function(e){var t=e.alarm();5!==t&&5>=s?s=5:10!==t&&10>=s?s=10:15!==t&&15>=s?s=15:30!==t&&30>=s?s=30:1440!==t&&1440>=s&&(s=1440)}),e=this.getDisplayedAlarms([s])[0],this["alarm"+s]=i.observable(s),this.displayedAlarms.push(e)},G.prototype.removeAlarm=function(e){this.displayedAlarms.remove(e)},G.prototype.removeGuest=function(e){this.attendees.remove(e)},G.prototype.disableAlarms=function(){_.each(this.alarmOptions(),function(e){e.isDisabled=_.any(this.displayedAlarms(),function(t){return t.alarm()===e.value})},this),this.alarmOptions.valueHasMutated()},G.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e,GlobalOnly:"0"};this.guestAutocompleteItem(null),e=Ei.trim(e),""!==e?Fi.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result&&e.Result.List&&(i=_.map(e.Result.List,function(e){return e&&e.Email&&e.Email!==this.owner()?e.Name&&0<Ei.trim(e.Name).length?{value:'"'+e.Name+'" <'+e.Email+">",name:e.Name,email:e.Email,frequency:e.Frequency}:{value:e.Email,name:"",email:e.Email,frequency:e.Frequency}:null},this),i=_.sortBy(_.compact(i),function(e){return e.frequency}).reverse()),t(i)},this):t([])},G.prototype.repeatRuleParse=function(e){var t=this.allEvents();this.repeatEndDom().datepicker("option","minDate",this.getDateTime(this.endDom())),e&&t===Ci.CalendarEditRecurrenceEvent.AllEvents&&(e.until&&this.repeatEndDom().datepicker("setDate",new Date(1e3*e.until)),e.byDays.length&&_.each(e.byDays,function(e){this["week"+e](!0)},this),this.repeatPeriod(e.period),this.repeatInterval(e.interval),this.repeatCount(e.count),this.repeatWeekNum(e.weekNum))},G.prototype.getDays=function(){var e=[];return this.weekMO()&&e.push("MO"),this.weekTU()&&e.push("TU"),this.weekWE()&&e.push("WE"),this.weekTH()&&e.push("TH"),this.weekFR()&&e.push("FR"),this.weekSA()&&e.push("SA"),this.weekSU()&&e.push("SU"),e},G.prototype.onMainPanelClick=function(){this.dateEdit()&&this.dateEdit(!1)},G.prototype.onKeydown=function(e,t){(t.keyCode===Ci.Key.Enter||t.keyCode===Ci.Key.Esc)&&t.preventDefault()},G.prototype.onKeyup=function(e,t){"event_subject"!==t.target.id&&"event_location"!==t.target.id||t.keyCode!==Ci.Key.Enter||this.onSaveClick()},G.prototype.onPaste=function(e,t,i){var s=i().replace(/[\r\n\t]+/gm," ");i(s)},G.prototype.getDateWithoutYearIfMonthWord=function(e){var t=e.split(" "),i=moment(),s=i.format("YYYY");return 3===t.length&&s===t[2]?t[0]+" "+t[1]:e},G.prototype.setStartDate=function(t,i){i&&this.startDom().datepicker("setDate",t.toDate()),this.startDate(this.getDateWithoutYearIfMonthWord(e(this.startDom()).val())),this.yearlyDayText(Ei.i18n("CALENDAR/EVENT_REPEAT_YEARLY_DAYMONTH",{DAYMONTH:t.format(this.getDateMonthFormat())})),this.monthlyDayText(Ei.i18n("CALENDAR/EVENT_REPEAT_MONTHLY_DAY",{DAY:t.format("DD")}))},G.prototype.selectStartDate=function(){if(!this.lockSelectStartEndDate()&&this.startDate()&&this.endDate()){this.lockSelectStartEndDate(!0);var e=this.FCMoment||moment,t=this.getDateTime(this.startDom(),this.startTime()),i=e(t),s=this.getDateTime(this.endDom(),this.endTime()),o=e(s);Ei.isNormal(this.differenceInMinutes)&&(o=i.clone().add(this.differenceInMinutes,"minutes"),s=o.toDate(),this.setEndDate(o,!0),this.endTime(o.format(this.timeFormatMoment))),o.diff(i,"minutes")<0&&(this.setEndDate(i,!0),this.endTime(i.format(this.timeFormatMoment))),this.isEvOneDay(0===o.diff(i,"days")),this.isEvOneTime(0===o.diff(i,"minutes")),this.setStartDate(i,!1),this.startTime(i.format(this.timeFormatMoment)),this.lockSelectStartEndDate(!1)}},G.prototype.getDateMonthFormat=function(){var e=this.dateFormatMoment.slice(0,-5);return-1===Ei.inArray(e,["MM/DD","DD/MM","DD MMMM"])&&(e="MM/DD"),e},G.prototype.setEndDate=function(t,i){i&&this.endDom().datepicker("setDate",t.toDate()),this.endDate(this.getDateWithoutYearIfMonthWord(e(this.endDom()).val()))},G.prototype.selectEndDate=function(){if(!this.lockSelectStartEndDate()&&this.endDate()&&this.startDate()){this.lockSelectStartEndDate(!0);var e=this.FCMoment||moment,t=this.getDateTime(this.startDom(),this.startTime()),i=e(t),s=this.getDateTime(this.endDom(),this.endTime()),o=e(s);this.differenceInMinutes=o.diff(i,"minutes"),this.differenceInMinutes<0&&(this.setStartDate(o,!0),this.startTime(o.format(this.timeFormatMoment)),this.differenceInMinutes=0),this.isEvOneDay(0===o.diff(i,"days")),this.isEvOneTime(0===o.diff(i,"minutes")),this.setEndDate(o,!1),this.endTime(o.format(this.timeFormatMoment)),this.repeatEndDom().datepicker("option","minDate",s),this.isRepeat()||this.repeatEndDom().datepicker("setDate",o.add("days",7).toDate()),this.lockSelectStartEndDate(!1)}},G.prototype.getDateTime=function(e,t){t=t?moment(t,this.timeFormatMoment).format("HH:mm"):"";var i=e.datepicker("getDate"),s=t?t.split(":"):[];return 2===s.length&&(i.setHours(s[0]),i.setMinutes(s[1])),i},G.prototype.setActualTime=function(){if(!this.lockSelectStartEndDate()&&this.endDate()&&this.startDate()){this.lockSelectStartEndDate(!0);var e=this.FCMoment||moment,t=e(),i=t.format(this.timeFormatMoment),s=this.getDateTime(this.startDom(),i),o=e(s),n=this.getDateTime(this.endDom(),i),r=e(n);o.minutes()>30?(o.add(60-o.minutes(),"minutes"),r.add(90-r.minutes(),"minutes")):(o.add(30-o.minutes(),"minutes"),r.add(60-r.minutes(),"minutes")),this.differenceInMinutes=r.diff(o,"minutes"),this.setStartDate(o,!0),this.startTime(o.format(this.timeFormatMoment)),this.setEndDate(r,!0),this.endTime(r.format(this.timeFormatMoment)),this.lockSelectStartEndDate(!1)}},G.prototype.onCalendarAppointmentSetActionResponse=function(e){e.Result||Fi.Api.showErrorByCode(e,Ei.i18n("WARNING/UNKNOWN_ERROR"))},G.prototype.setAppointmentAction=function(e){var t=Ci.IcalConfigInt.NeedsAction,i=this.attendees(),s=Mi.Accounts?Mi.Accounts.getAttendee(_.map(this.attendees(),function(e){return e.email},this)):"",o=_.find(this.attendees(),function(e){return e.email===s},this),n=this.calendars.getCalendarById(this.selectedCalendarId()),r={Action:"CalendarAppointmentSetAction",AppointmentAction:e,CalendarId:this.selectedCalendarId(),EventId:this.uid(),Attendee:s};if(o){switch(e){case Ci.IcalConfig.Accepted:t=Ci.IcalConfigInt.Accepted,Fi.CalendarCache.markIcalAccepted(this.uid());break;case Ci.IcalConfig.Tentative:t=Ci.IcalConfigInt.Tentative,Fi.CalendarCache.markIcalTentative(this.uid());break;case Ci.IcalConfig.Declined:t=Ci.IcalConfigInt.Declined,Fi.CalendarCache.markIcalNonexistent(this.uid())}Fi.Ajax.send(r,this.onCalendarAppointmentSetActionResponse,this),o.status=t,this.attendees([]),this.attendees(i),this.setCurrentAttenderStatus(o.email,this.attendees()),e===Ci.IcalConfig.Declined&&n&&this.callbackAttendeeActionDecline&&Ei.isFunc(this.callbackAttendeeActionDecline)&&(this.callbackAttendeeActionDecline(n,this.id()),this.closePopup())}},G.prototype.editableSwitch=function(e,t,i){this.isEditable(e&&t&&i||!e&&t&&i||e&&t&&!i),this.isEditableReminders(t)},G.prototype.setCurrentAttenderStatus=function(e,t){var i=_.find(t,function(t){return t.email===e});this.attenderStatus(i?i.status:0)},G.prototype.getAttenderTextStatus=function(e){switch(e){case 0:e="pending";break;case 1:e="accepted";break;case 2:e="declined";break;case 3:e="tentative"}return e},G.prototype.setDayOfWeek=function(){if(this.repeatPeriod()===Ci.CalendarRepeatPeriod.Weekly&&!this.getDays().length){var e=this.getDateTime(this.startDom()).getUTCDay();switch(e){case 0:this.weekMO(!0);break;case 1:this.weekTU(!0);break;case 2:this.weekWE(!0);break;case 3:this.weekTH(!0);break;case 4:this.weekFR(!0);break;case 5:this.weekSA(!0);break;case 6:this.weekSU(!0)}}},G.prototype.getDisplayedTimes=function(e){var t=[];switch(e){case"HH:mm":t=[{text:"00:00",value:"00:00"},{text:"00:30",value:"00:30"},{text:"01:00",value:"01:00"},{text:"01:30",value:"01:30"},{text:"02:00",value:"02:00"},{text:"02:30",value:"02:30"},{text:"03:00",value:"03:00"},{text:"03:30",value:"03:30"},{text:"04:00",value:"04:00"},{text:"04:30",value:"04:30"},{text:"05:00",value:"05:00"},{text:"05:30",value:"05:30"},{text:"06:00",value:"06:00"},{text:"06:30",value:"06:30"},{text:"07:00",value:"07:00"},{text:"07:30",value:"07:30"},{text:"08:00",value:"08:00"},{text:"08:30",value:"08:30"},{text:"09:00",value:"09:00"},{text:"09:30",value:"09:30"},{text:"10:00",value:"10:00"},{text:"10:30",value:"10:30"},{text:"11:00",value:"11:00"},{text:"11:30",value:"11:30"},{text:"12:00",value:"12:00"},{text:"12:30",value:"12:30"},{text:"13:00",value:"13:00"},{text:"13:30",value:"13:30"},{text:"14:00",value:"14:00"},{text:"14:30",value:"14:30"},{text:"15:00",value:"15:00"},{text:"15:30",value:"15:30"},{text:"16:00",value:"16:00"},{text:"16:30",value:"16:30"},{text:"17:00",value:"17:00"},{text:"17:30",value:"17:30"},{text:"18:00",value:"18:00"},{text:"18:30",value:"18:30"},{text:"19:00",value:"19:00"},{text:"19:30",value:"19:30"},{text:"20:00",value:"20:00"},{text:"20:30",value:"20:30"},{text:"21:00",value:"21:00"},{text:"21:30",value:"21:30"},{text:"22:00",value:"22:00"},{text:"22:30",value:"22:30"},{text:"23:00",value:"23:00"},{text:"23:30",value:"23:30"}];break;case"hh:mm A":t=[{text:"12:00 AM",value:"12:00 AM"},{text:"12:30 AM",value:"12:30 AM"},{text:"01:00 AM",value:"01:00 AM"},{text:"01:30 AM",value:"01:30 AM"},{text:"02:00 AM",value:"02:00 AM"},{text:"02:30 AM",value:"02:30 AM"},{text:"03:00 AM",value:"03:00 AM"},{text:"03:30 AM",value:"03:30 AM"},{text:"04:00 AM",value:"04:00 AM"},{text:"04:30 AM",value:"04:30 AM"},{text:"05:00 AM",value:"05:00 AM"},{text:"05:30 AM",value:"05:30 AM"},{text:"06:00 AM",value:"06:00 AM"},{text:"06:30 AM",value:"06:30 AM"},{text:"07:00 AM",value:"07:00 AM"},{text:"07:30 AM",value:"07:30 AM"},{text:"08:00 AM",value:"08:00 AM"},{text:"08:30 AM",value:"08:30 AM"},{text:"09:00 AM",value:"09:00 AM"},{text:"09:30 AM",value:"09:30 AM"},{text:"10:00 AM",value:"10:00 AM"},{text:"10:30 AM",value:"10:30 AM"},{text:"11:00 AM",value:"11:00 AM"},{text:"11:30 AM",value:"11:30 AM"},{text:"12:00 PM",value:"12:00 PM"},{text:"12:30 PM",value:"12:30 PM"},{text:"01:00 PM",value:"01:00 PM"},{text:"01:30 PM",value:"01:30 PM"},{text:"02:00 PM",value:"02:00 PM"},{text:"02:30 PM",value:"02:30 PM"},{text:"03:00 PM",value:"03:00 PM"},{text:"03:30 PM",value:"03:30 PM"},{text:"04:00 PM",value:"04:00 PM"},{text:"04:30 PM",value:"04:30 PM"},{text:"05:00 PM",value:"05:00 PM"},{text:"05:30 PM",value:"05:30 PM"},{text:"06:00 PM",value:"06:00 PM"},{text:"06:30 PM",value:"06:30 PM"},{text:"07:00 PM",value:"07:00 PM"},{text:"07:30 PM",value:"07:30 PM"},{text:"08:00 PM",value:"08:00 PM"},{text:"08:30 PM",value:"08:30 PM"},{text:"09:00 PM",value:"09:00 PM"},{text:"09:30 PM",value:"09:30 PM"},{text:"10:00 PM",value:"10:00 PM"},{text:"10:30 PM",value:"10:30 PM"},{text:"11:00 PM",value:"11:00 PM"},{text:"11:30 PM",value:"11:30 PM"}]}return t},G.prototype.displayReminderPart=function(e,t){var i="";return i="%REMINDERS%"===e?"Reminders":"Text",t+i},B.prototype.onShow=function(e){Ei.isFunc(e)&&(this.fCallback=e)},B.prototype.popupTemplate=function(){return"Popups_Calendar_EditRecurrenceEventPopupViewModel"},B.prototype.onlyThisInstanceButtonClick=function(){this.fCallback&&this.fCallback(Ci.CalendarEditRecurrenceEvent.OnlyThisInstance),this.closeCommand()},B.prototype.allEventsButtonClick=function(){this.fCallback&&this.fCallback(Ci.CalendarEditRecurrenceEvent.AllEvents),this.closeCommand()},B.prototype.cancelButtonClick=function(){this.fCallback&&this.fCallback(Ci.CalendarEditRecurrenceEvent.None),this.closeCommand()},B.prototype.onEscHandler=function(){this.cancelButtonClick()},j.prototype.onShow=function(e){this.fCallback=e.CallbackSave,this.fProceedUploading=e.ProceedUploading,this.calendars=e.Calendars,this.calendarsList(e.EditableCalendars),this.selectedCalendarId(e.DefaultCalendarId),this.changeCalendarColor(this.selectedCalendarId())},j.prototype.popupTemplate=function(){return"Popups_Calendar_CalendarSelectCalendarsPopupViewModel"},j.prototype.onSaveClick=function(){this.fCallback&&this.fCallback(this.selectedCalendarId(),this.fProceedUploading),this.closeCommand()},j.prototype.onCancelClick=function(){this.closeCommand()},j.prototype.changeCalendarColor=function(e){if(Ei.isFunc(this.calendars.getCalendarById)){var t=this.calendars.getCalendarById(e);t&&(this.calendarColor(""),this.calendarColor(t.color()))}},V.prototype.popupTemplate=function(){return"Popups_PhonePopupViewModel"},V.prototype.onShow=function(e){this.text(e.text),this.callback=e.Callback||Ei.emptyFunction},V.prototype.onCancelClick=function(){this.closeCommand()},V.prototype.onOKClick=function(){this.closeCommand(),this.callback()},V.prototype.answer=function(){this.action(Ci.PhoneAction.IncomingConnect)},V.prototype.hangup=function(){this.action(Ci.PhoneAction.Online)},K.prototype.onShow=function(e){this.pgp=e,this.emails(Mi.Accounts.getAllFullEmails()),this.selectedEmail(""),this.password(""),this.selectedKeyLength(2048),this.process(!1)},K.prototype.popupTemplate=function(){return"Popups_GenerateOpenPgpKeyPopupViewModel"},K.prototype.generate=function(){this.pgp&&(this.process(!0),_.delay(_.bind(function(){var e=this.pgp.generateKey(this.selectedEmail(),this.password(),this.selectedKeyLength());e&&e.result&&Fi.Api.showReport(Ei.i18n("OPENPGP/REPORT_KEY_SUCCESSFULLY_GENERATED")),e&&!e.result?(this.process(!1),Fi.Api.showPgpErrorByCode(e,Ci.PgpAction.Generate)):this.closeCommand()},this),50))},W.prototype.onShow=function(e){this.armor(e.getArmor()),this.user(e.getUser()),this.private(e.isPrivate())},W.prototype.popupTemplate=function(){return"Popups_ShowOpenPgpKeyArmorPopupViewModel"},W.prototype.send=function(){""!==this.armor()&&""!==this.downloadLinkFilename()&&(Fi.Api.composeMessageWithPgpKey(this.armor(),this.downloadLinkFilename()),this.closeCommand())},W.prototype.select=function(){var e=this.domKey()&&1===this.domKey().length?this.domKey()[0]:null,i=null,s=null;e&&t.getSelection&&document.createRange&&(s=document.createRange(),s.setStart(e,0),s.setEnd(e,1),i=t.getSelection(),i.removeAllRanges(),i.addRange(s))},q.prototype.onShow=function(e,t){this.pgp=e,this.keyArmor(t||""),this.keyArmorFocused(!0),this.keys([]),this.hasExistingKeys(!1),""!==this.keyArmor()&&this.checkArmor()},q.prototype.popupTemplate=function(){return"Popups_ImportOpenPgpKeyPopupViewModel"},q.prototype.checkArmor=function(){var e=null,t=[],s=this.pgp,o=!1;""===this.keyArmor()?this.keyArmorFocused(!0):s&&(e=s.getArmorInfo(this.keyArmor()),Ei.isNonEmptyArray(e)&&_.each(e,function(e){if(e){var n=s.findKeyByID(e.getId(),e.isPublic()),r=null!==n,a=e.isPublic()?"OPENPGP/PUBLIC_KEY_ADD_INFO":"OPENPGP/PRIVATE_KEY_ADD_INFO";o=o||r,t.push({armor:e.getArmor(),email:e.user,id:e.getId(),addInfo:Ei.i18n(a,{LENGTH:e.getBitSize()}),needToImport:i.observable(!r),disabled:r})}}),0===t.length&&Fi.Api.showError(Ei.i18n("OPENPGP/ERROR_IMPORT_NO_KEY_FOUNDED")),this.keys(t),this.hasExistingKeys(o))},q.prototype.importKey=function(){var e=null,t=[];this.pgp&&(_.each(this.keys(),function(e){e.needToImport()&&t.push(e.armor)}),t.length>0?(e=this.pgp.importKeys(t.join("")),e&&e.result&&Fi.Api.showReport(Ei.i18n("OPENPGP/REPORT_KEY_SUCCESSFULLY_IMPORTED_PLURAL",{},null,t.length)),e&&!e.result&&Fi.Api.showPgpErrorByCode(e,Ci.PgpAction.Import,Ei.i18n("OPENPGP/ERROR_IMPORT_KEY")),this.closeCommand()):Fi.Api.showError(Ei.i18n("OPENPGP/ERROR_IMPORT_NO_KEY_SELECTED")))},Y.prototype.onShow=function(e,t,i,s,o,n){this.data(e),this.fromEmail(t),this.emails(i),this.okCallback=o,this.cancelCallback=n,this.sign(!0),this.password(""),this.encrypt(!s),this.signAndSend(s)},Y.prototype.popupTemplate=function(){return"Popups_OpenPgpEncryptPopupViewModel"},Y.prototype.executeSignEncrypt=function(){var e=_.bind(function(e){e&&this.signEncrypt(e)},this);Fi.Api.pgp(e,Mi.User.IdUser)},Y.prototype.signEncrypt=function(e){var t=this.data(),i=this.sign()?this.fromEmail():"",s=this.emails(),o=this.sign()?this.password():"",n=null,r="",a="";this.encrypt()?0===s.length?Fi.Api.showError(Ei.i18n("OPENPGP/ERROR_TO_ENCRYPT_SPECIFY_RECIPIENTS")):this.sign()?(a=Ci.PgpAction.EncryptSign,r=Ei.i18n("OPENPGP/REPORT_MESSAGE_SIGNED_ENCRYPTED_SUCCSESSFULLY"),n=e.signAndEncrypt(t,i,s,o)):(a=Ci.PgpAction.Encrypt,r=Ei.i18n("OPENPGP/REPORT_MESSAGE_ENCRYPTED_SUCCSESSFULLY"),n=e.encrypt(t,s)):this.sign()&&(a=Ci.PgpAction.Sign,r=Ei.i18n("OPENPGP/REPORT_MESSAGE_SIGNED_SUCCSESSFULLY"),n=e.sign(t,i,o)),n&&(n.result?(this.closeCommand(),this.okCallback&&(this.signAndSend()||Fi.Api.showReport(r),this.okCallback(n.result,this.encrypt()))):Fi.Api.showPgpErrorByCode(n,a))},Y.prototype.cancel=function(){this.cancelCallback&&this.cancelCallback(),this.closeCommand()},Y.prototype.onEscHandler=function(){this.cancel()},z.prototype.onShow=function(e){var i=null;Ei.isFunc(e)&&(this.fCallback=e),this.pickerApiLoaded&&this.googleApiLoaded&&(i=t.gapi.auth.getToken(),!i||_.isEmpty(i)||i.error?this.doGoogleAuth():this.createPicker())},z.prototype.onApplyBindings=function(){this.allowGoogle&&Ei.loadScript("https://apis.google.com/js/api.js?onload=onGoogleApiLoad",_.bind(this.onGoogleApiLoad,this),null,"onGoogleApiLoad")},z.prototype.popupTemplate=function(){return"Popups_GooglePickerPopupViewModel"},z.prototype.onEscHandler=function(){this.onCancelClick()},z.prototype.onCancelClick=function(){this.closeCommand(),this.pickerApiLoaded&&this.picker&&this.picker.setVisible(!1)},z.prototype.onGoogleApiLoad=function(){this.googleApiLoaded=!0,t.gapi.load("auth",{callback:_.bind(this.doGoogleAuth,this)}),t.gapi.load("picker",{callback:_.bind(this.onPickerApiLoad,this)})},z.prototype.doGoogleAuth=function(){var e=t.gapi.auth.getToken();(!e||_.isEmpty(e)||e&&e.error)&&t.gapi.auth.init(_.bind(this.checkGoogleAuth,this,!0))},z.prototype.checkGoogleAuth=function(e){this.checkTimer=t.setTimeout(_.bind(this.ckeckPickerCreate,this),5e3),t.gapi.auth.authorize({client_id:this.googleClientId,scope:["https://www.googleapis.com/auth/drive"],immediate:!!e},_.bind(this.handleGoogleAuthResult,this))},z.prototype.handleGoogleAuthResult=function(e){e&&(e.error?"immediate_failed"===e.error&&(t.clearTimeout(this.checkTimer),this.checkGoogleAuth(!1)):this.createPicker())},z.prototype.onPickerApiLoad=function(){this.pickerApiLoaded=!0},z.prototype.ckeckPickerCreate=function(){t.clearTimeout(this.checkTimer),this.pickerCreated||(this.closeCommand(),Fi.Api.showError(Ei.i18n("COMPOSE/ERROR_GOOGLE_PICKER_POPUP")))},z.prototype.createPicker=function(){var e=null,i=t.gapi.auth.getToken(),s=this;this.pickerApiLoaded&&i&&!i.error&&(e=(new t.google.picker.DocsView).setIncludeFolders(!0),this.picker=(new t.google.picker.PickerBuilder).addView(e).setOAuthToken(i.access_token).setDeveloperKey(s.googleKey).setOrigin(t.location.protocol+"//"+t.location.host).setCallback(_.bind(s.pickerCallback,s,i.access_token)).enableFeature(t.google.picker.Feature.NAV_HIDDEN).enableFeature(t.google.picker.Feature.MULTISELECT_ENABLED).setLocale(Mi.User.DefaultLanguageShort).build(),this.picker.setVisible(!0),this.picker.A.style.zIndex=2e3,this.pickerCreated=!0)},z.prototype.pickerCallback=function(e,i){i[t.google.picker.Response.ACTION]===t.google.picker.Action.PICKED?(this.fCallback&&this.fCallback(i[t.google.picker.Response.DOCUMENTS],e),this.closeCommand()):i[t.google.picker.Response.ACTION]===t.google.picker.Action.CANCEL&&this.closeCommand()},Q.prototype.parse=function(e){this.AllowWebMail=!!e.AllowWebMail,this.AllowUsersChangeInterfaceSettings=!!e.AllowUsersChangeInterfaceSettings,this.AllowUsersChangeEmailSettings=!!e.AllowUsersChangeEmailSettings,this.AllowUsersAddNewAccounts=!!e.AllowUsersAddNewAccounts||this.AllowUsersChangeEmailSettings,this.SiteName=Ei.pString(e.SiteName),this.Languages=e.Languages,this.Themes=e.Themes,this.DateFormats=e.DateFormats,this.AttachmentSizeLimit=Ei.pInt(e.AttachmentSizeLimit),this.ImageUploadSizeLimit=Ei.pInt(e.ImageUploadSizeLimit),this.FileSizeLimit=Ei.pInt(e.FileSizeLimit),this.AutoSave=!!e.AutoSave,this.IdleSessionTimeout=60*Ei.pInt(e.IdleSessionTimeout)*1e3,this.AllowInsertImage=!!e.AllowInsertImage,this.AllowBodySize=!!e.AllowBodySize,this.MaxBodySize=Ei.pInt(e.MaxBodySize),this.MaxSubjectSize=Ei.pInt(e.MaxSubjectSize),this.AllowPrefetch=!!e.AllowPrefetch,this.LoginFormType=Ei.pInt(e.LoginFormType),this.LoginSignMeType=Ei.pInt(e.LoginSignMeType),this.LoginAtDomainValue=Ei.pString(e.LoginAtDomainValue),this.AllowRegistration=!!e.AllowRegistration,this.AllowPasswordReset=!!e.AllowPasswordReset,this.RegistrationDomains=e.RegistrationDomains,this.RegistrationQuestions=_.without(e.RegistrationQuestions,""),this.DemoWebMail=!!e.DemoWebMail,this.DemoWebMailLogin=Ei.pString(e.DemoWebMailLogin),this.DemoWebMailPassword=Ei.pString(e.DemoWebMailPassword),this.GoogleAnalyticsAccount=e.GoogleAnalyticsAccount,this.ShowQuotaBar=!!e.ShowQuotaBar,this.ServerUseUrlRewrite=!!e.ServerUseUrlRewrite,this.AllowLanguageOnLogin=!Pi&&!!e.AllowLanguageOnLogin,this.FlagsLangSelect=!!e.FlagsLangSelect,this.DefaultLanguage=Ei.pString(e.DefaultLanguage),this.LoginDescription=Ei.pString(e.LoginDescription),this.CustomLoginUrl=Ei.pString(e.CustomLoginUrl),this.CustomLogoutUrl=Ei.pString(e.CustomLogoutUrl),this.IosDetectOnLogin=!!e.IosDetectOnLogin,this.AllowContactsSharing=!!e.AllowContactsSharing,""!==e.DefaultLanguageShort&&(this.DefaultLanguageShort=e.DefaultLanguageShort),this.DefaultTab=e.DefaultTab,this.AllowIosProfile=!!e.AllowIosProfile,this.PasswordMinLength=e.PasswordMinLength,this.PasswordMustBeComplex=!!e.PasswordMustBeComplex},$.prototype.fillDefaultFontName=function(){var e=Ei.pString(Mi.HtmlEditorDefaultFontName);""!==e&&(this.DefaultFontName=e)},$.prototype.fillDefaultFontSize=function(){var e=Ei.pInt(Mi.HtmlEditorDefaultFontSize);-1!==Ei.inArray(e,[2,3,5,7])&&(this.DefaultFontSize=e)},$.prototype.getSaveMailInSentItems=function(){var e=!0;switch(this.SaveMail){case Ci.SaveMail.Unchecked:e=!1;break;case Ci.SaveMail.Checked:case Ci.SaveMail.Hidden:e=!0}return e},$.prototype.getUseSaveMailInSentItems=function(){var e=!1;switch(this.SaveMail){case Ci.SaveMail.Unchecked:case Ci.SaveMail.Checked:e=!0;break;case Ci.SaveMail.Hidden:e=!1}return e},$.prototype.parse=function(e){var t=null;null!==e&&(this.IdUser=Ei.pInt(e.IdUser),this.MailsPerPage=Ei.pInt(e.MailsPerPage),this.ContactsPerPage=Ei.pInt(e.ContactsPerPage),this.AutoCheckMailInterval=Ei.pInt(e.AutoCheckMailInterval),this.DefaultTheme=Ei.pString(e.DefaultTheme),this.DefaultLanguage=Ei.pString(e.DefaultLanguage),this.DefaultLanguageShort=Ei.pString(e.DefaultLanguageShort),this.DefaultDateFormat=Ei.pString(e.DefaultDateFormat),this.defaultTimeFormat(Ei.pString(e.DefaultTimeFormat)),this.ThreadsEnabled=!!e.ThreadsEnabled,this.useThreads(!!e.UseThreads),this.SaveRepliedToCurrFolder=!!e.SaveRepliedMessagesToCurrentFolder,this.DesktopNotifications=!!e.DesktopNotifications,this.AllowChangeInputDirection=!!e.AllowChangeInputDirection,this.AllowCompose=!!e.AllowCompose,this.AllowReply=!!e.AllowReply,this.AllowForward=!!e.AllowForward,this.SaveMail=Ei.pInt(e.SaveMail),this.AllowFetcher=!!e.AllowFetcher,this.OutlookSyncEnable=!!e.OutlookSyncEnable,this.MobileSyncEnable=!!e.MobileSyncEnable,this.ShowPersonalContacts=!!e.ShowPersonalContacts,this.ShowGlobalContacts=!!e.ShowGlobalContacts,this.ShowContacts=this.ShowPersonalContacts||this.ShowGlobalContacts,this.IsFilesSupported=!!e.IsFilesSupported&&!Pi,this.filesEnable(!!e.FilesEnable&&!Pi),this.IsHelpdeskSupported=!!e.IsHelpdeskSupported&&!Pi,this.IsHelpdeskAgent=!!e.IsHelpdeskAgent,this.LastLogin=Ei.pInt(e.LastLogin),this.AllowCalendar=!!e.AllowCalendar&&!Pi,this.CalendarSharing=!!e.CalendarSharing,this.CalendarAppointments=!!e.CalendarAppointments,this.IsDemo=!!e.IsDemo,this.AllowVoice=!!e.AllowVoice,this.SipRealm=e.SipRealm,this.SipWebsocketProxyUrl=e.SipWebsocketProxyUrl,this.SipOutboundProxyUrl=e.SipOutboundProxyUrl,this.SipCallerID=e.SipCallerID,this.SipImpi=e.SipImpi,this.SipImpu=e.SipImpu,this.SipPassword=e.SipPassword,this.VoiceProvider=e.VoiceProvider,this.AllowHelpdeskNotifications=e.AllowHelpdeskNotifications,this.IsCollaborationSupported=!!e.IsCollaborationSupported,this.AllowFilesSharing=!!e.AllowFilesSharing,this.enableOpenPgp(!!e.EnableOpenPgp),this.AllowAutosaveInDrafts=!!e.AllowAutosaveInDrafts&&(Mi.App?Mi.App.AutoSave:!1),t=e.Calendar,t&&(this.CalendarShowWeekEnds=!!t.ShowWeekEnds,this.CalendarShowWorkDay=!!t.ShowWorkDay,this.CalendarWorkDayStarts=Ei.pInt(t.WorkDayStarts),this.CalendarWorkDayEnds=Ei.pInt(t.WorkDayEnds),this.CalendarWeekStartsOn=Ei.pInt(t.WeekStartsOn),this.CalendarDefaultTab=Ei.pInt(t.DefaultTab)),this.SocialAccounts(e.SocialAccounts))
},$.prototype.updateCommonSettings=function(e,t,i,s,o,n,r,a,l,h,c){var u=this.defaultTimeFormat()!==r;this.MailsPerPage=e,this.ContactsPerPage=t,this.AutoCheckMailInterval=i,Fi.MailCache.setAutocheckmailTimer(),this.DefaultTheme=s,this.DefaultLanguage=o,this.DefaultDateFormat=n,this.defaultTimeFormat(r),this.useThreads("1"===a),this.SaveRepliedToCurrFolder="1"===l,this.AllowChangeInputDirection="1"===c,this.DesktopNotifications="1"===h,u&&Fi.nowMoment.valueHasMutated()},$.prototype.updateOpenPgpSettings=function(e,t){this.enableOpenPgp("1"===e),this.AllowAutosaveInDrafts="1"===t},$.prototype.updateCalendarSettings=function(e,t,i,s,o,n){this.CalendarShowWeekEnds=e,this.CalendarShowWorkDay=t,this.CalendarWorkDayStarts=i,this.CalendarWorkDayEnds=s,this.CalendarWeekStartsOn=o,this.CalendarDefaultTab=n},$.prototype.updateHelpdeskSettings=function(e){this.AllowHelpdeskNotifications=e},$.prototype.onUserSettingsGetSyncResponse=function(e){e.Result?(this.mobileSync(e.Result.Mobile),this.outlookSync(e.Result.Outlook)):Fi.Api.showErrorByCode(e)},$.prototype.requestSyncSettings=function(){(null===this.mobileSync()||null===this.outlookSync())&&Fi.Ajax.send({Action:"UserSettingsGetSync"},this.onUserSettingsGetSyncResponse,this)},J.prototype.init=function(e,t,i){this.id(e),this.email(t),this.friendlyName(i)},J.prototype.onAccountGetQuotaResponse=function(e){e&&e.Result&&_.isArray(e.Result)&&1<e.Result.length&&(this.quota(Ei.pInt(e.Result[1])),this.usedSpace(Ei.pInt(e.Result[0])),Fi.MailCache.quotaChangeTrigger(!Fi.MailCache.quotaChangeTrigger())),this.quotaRecieved(!0)},J.prototype.updateQuotaParams=function(){var e={Action:"AccountGetQuota",AccountID:this.id()};Mi.App&&Mi.App.ShowQuotaBar&&Fi.Ajax.send(e,this.onAccountGetQuotaResponse,this)},J.prototype.parse=function(e,t){var i=new vt;this.init(parseInt(e.AccountID,10),Ei.pString(e.Email),Ei.pString(e.FriendlyName)),i.parse(this.id(),e.Signature),this.signature(i),this.isCurrent(t===this.id()),this.isEdited(t===this.id())},J.prototype.requestExtensions=function(){if(!this.extensionsRequested()&&Fi.Ajax){var e=t.jstz?t.jstz.determine():null;Fi.Ajax.send({AccountID:this.id(),Action:"SystemIsAuth",ClientTimeZone:e?e.name():""},this.onSystemIsAuthResponse,this)}},J.prototype.onSystemIsAuthResponse=function(e){var t=!!e.Result,i=t?e.Result.Extensions:[];t&&(this.setExtensions(i),this.extensionsRequested(!0))},J.prototype.setExtensions=function(e){_.isArray(e)&&this.extensions(e)},J.prototype.extensionExists=function(e){return-1===_.indexOf(this.extensions(),e)?!1:!0},J.prototype.updateExtended=function(e){e&&(this.isExtended(!0),Ei.isNormal(e.FriendlyName)&&this.friendlyName(e.FriendlyName),Ei.isNormal(e.IncomingMailLogin)&&this.incomingMailLogin(e.IncomingMailLogin),Ei.isNormal(e.IncomingMailPort)&&this.incomingMailPort(e.IncomingMailPort),Ei.isNormal(e.IncomingMailServer)&&this.incomingMailServer(e.IncomingMailServer),Ei.isNormal(e.IsInternal)&&this.isInternal(e.IsInternal),Ei.isNormal(e.IsLinked)&&this.isLinked(e.IsLinked),Ei.isNormal(e.IsDefault)&&this.isDefault(e.IsDefault),Ei.isNormal(e.OutgoingMailAuth)&&this.outgoingMailAuth(e.OutgoingMailAuth),Ei.isNormal(e.OutgoingMailLogin)&&this.outgoingMailLogin(e.OutgoingMailLogin),Ei.isNormal(e.OutgoingMailPort)&&this.outgoingMailPort(e.OutgoingMailPort),Ei.isNormal(e.OutgoingMailServer)&&this.outgoingMailServer(e.OutgoingMailServer),this.setExtensions(e.Extensions))},J.prototype.changeAccount=function(){Mi.Accounts.changeCurrentAccount(this.id())},J.prototype.getDefaultIdentity=function(){return _.find(this.identities()||[],function(e){return e.isDefault()})},J.prototype.getFetchersIdentitiesEmails=function(){var e=this.fetchers()?this.fetchers().collection():[],t=this.identities()||[],i=[];return _.each(e,function(e){i.push(e.email())}),_.each(t,function(e){i.push(e.email())}),i},X.prototype.changeCurrentAccount=function(e){var t=this.getCurrent(),i=this.getAccount(e);i&&this.currentId()!==e&&(t.isCurrent(!1),this.currentId(e),i.isCurrent(!0),Fi.Routing.setHash(Fi.Links.inbox()))},X.prototype.changeEditedAccount=function(e){var t=this.getEdited(),i=this.getAccount(e);i&&this.editedId()!==e&&(t.isEdited(!1),this.editedId(e),i.isEdited(!0))},X.prototype.parse=function(e,t){var i=null,s=!1,o=null;_.isArray(t)&&this.collection(_.map(t,function(t){var i=new J;return i.parse(t,e),i.id()===e&&(s=!0),i})),!s&&this.collection.length>0&&(i=this.collection()[0],e=i.id(),s=!0),s&&(this.defaultId(e),this.currentId(e),this.editedId(e)),o=this.getDefault(),o&&_.defer(function(){o.isDefault(!0)})},X.prototype.getAccount=function(e){var t=_.find(this.collection(),function(t){return t.id()===e},this);return t},X.prototype.getCurrent=function(){return this.getAccount(this.currentId())},X.prototype.getDefault=function(){return this.getAccount(this.defaultId())},X.prototype.getEdited=function(){return this.getAccount(this.editedId())},X.prototype.getEmail=function(e){e=e||this.currentId();var t="",i=this.getAccount(e);return i&&(t=i.email()),t},X.prototype.addAccount=function(e){this.collection.push(e)},X.prototype.deleteAccount=function(e){this.currentId()===e&&this.changeCurrentAccount(this.defaultId()),this.editedId()===e&&this.changeEditedAccount(this.defaultId()),this.collection.remove(function(t){return t.id()===e})},X.prototype.hasAccountWithId=function(e){var t=_.find(this.collection(),function(t){return t.id()===e},this);return!!t},X.prototype.populateFetchersIdentities=function(){this.populateFetchers(),this.populateIdentities()},X.prototype.populateFetchers=function(){Mi.User.AllowFetcher&&Fi.Ajax.send({Action:"AccountFetcherGetList",AccountID:Mi.Accounts.defaultId()},this.onAccountFetcherGetListResponse,this)},X.prototype.onAccountFetcherGetListResponse=function(e){var t=null,i=this.getDefault();Ei.isNonEmptyArray(e.Result)&&(t=new Et,t.parse(Mi.Accounts.defaultId(),e.Result)),i.fetchers(t)},X.prototype.populateIdentities=function(){Mi.AllowIdentities&&Fi.Ajax.send({Action:"AccountIdentitiesGet"},this.onAccountIdentitiesGetResponse,this)},X.prototype.onAccountIdentitiesGetResponse=function(e){var t={};Ei.isNonEmptyArray(e.Result)&&_.each(e.Result,function(e){var i=new it,s=-1;i.parse(e),s=i.accountId(),t[s]||(t[s]=[]),t[s].push(i)}),_.each(this.collection(),function(e){var i=t[e.id()],s=new it;Ei.isNonEmptyArray(i)||(i=[]),s.parse({"@Object":"Object/CIdentity",Loyal:!0,Default:!_.find(i,function(e){return e.isDefault()}),Email:e.email(),Enabled:!0,FriendlyName:e.friendlyName(),IdAccount:e.id(),IdIdentity:1e5*e.id(),Signature:e.signature()?e.signature().signature():"",UseSignature:e.signature()?!!e.signature().options():!1}),i.unshift(s),e.identities(i)})},X.prototype.populateIdentitiesFromSourceAccount=function(e){e&&_.each(this.collection(),function(t){var i=e.getAccount(t.id());i&&(t.fetchers(i.fetchers()),t.identities(i.identities()),t.signature(i.signature()))})},X.prototype.getAllFullEmails=function(){var e=[];return _.each(this.collection(),function(t){t&&(e.push(t.fullEmail()),t.fetchers()&&Ei.isNonEmptyArray(t.fetchers().collection())&&_.each(t.fetchers().collection(),function(t){t.isOutgoingEnabled()&&""!==t.fullEmail()&&e.push(t.fullEmail())}),Ei.isNonEmptyArray(t.identities())&&_.each(t.identities(),function(t){e.push(t.fullEmail())}))}),e},X.prototype.getCurrentFetchersAndFiltersFolderNames=function(){var e=this.getCurrent(),t=[];return e&&(e.filters()&&_.each(e.filters().collection(),function(e){t.push(e.folder())},this),e.fetchers()&&_.each(e.fetchers().collection(),function(e){t.push(e.folder())},this)),t},X.prototype.getAttendee=function(e){var t=[],i="";return _.each(this.collection(),function(e){t=e.isCurrent()?_.union(e.email(),e.getFetchersIdentitiesEmails(),t):_.union(t,e.email(),e.getFetchersIdentitiesEmails())}),t=_.uniq(t),_.each(t,_.bind(function(t){if(""===i){var s=_.find(e,function(e){return e===t});s===t&&(i=t)}},this)),i},Z.prototype.parse=function(e){null!==e&&(this.sName=Ei.pString(e.DisplayName),"string"!=typeof this.sName&&(this.sName=""),this.sEmail=Ei.pString(e.Email),"string"!=typeof this.sEmail&&(this.sEmail=""),this.sDisplay=this.sName.length>0?this.sName:this.sEmail,this.setFull())},Z.prototype.getEmail=function(){return this.sEmail},Z.prototype.getName=function(){return this.sName},Z.prototype.getDisplay=function(){return this.sDisplay},Z.prototype.setFull=function(){var e="";e=this.sEmail.length>0?this.sName.length>0?-1!==this.sName.indexOf(",")?'"'+this.sName+'" <'+this.sEmail+">":this.sName+" <"+this.sEmail+">":this.sEmail:this.sName,this.sFull=e},Z.prototype.getFull=function(){return this.sFull},et.prototype.parse=function(e){this.aCollection=_.map(e,function(e){var t=new Z;return t.parse(e),t})},et.prototype.addCollection=function(e){_.each(e,function(e){var t=_.find(this.aCollection,function(t){return e.sEmail===t.sEmail});t||this.aCollection.push(e)},this)},et.prototype.excludeCollection=function(e){_.each(e,function(e){this.aCollection=_.filter(this.aCollection,function(t){return e.sEmail!==t.sEmail})},this)},et.prototype.getFirstEmail=function(){return this.aCollection.length>0?this.aCollection[0].getEmail():""},et.prototype.getFirstName=function(){return this.aCollection.length>0?this.aCollection[0].getName():""},et.prototype.getFirstDisplay=function(){return this.aCollection.length>0?this.aCollection[0].getDisplay():""},et.prototype.getDisplay=function(e,t){var i=_.map(this.aCollection,function(i){return e&&t===i.sEmail?e:i.getDisplay(e)});return i.join(", ")},et.prototype.getFull=function(){var e=_.map(this.aCollection,function(e){return e.getFull()});return e.join(", ")},et.prototype.getEmails=function(){var e=_.map(this.aCollection,function(e){return e.getEmail()});return e},tt.prototype.parse=function(e){this.iTimeStampInUTC=e,this.oMoment=moment.unix(this.iTimeStampInUTC)},tt.prototype.setDate=function(e,t,i){this.oMoment=moment([e,t,i])},tt.prototype.getTimeFormat=function(){return Mi.User.defaultTimeFormat()===Ci.TimeFormat.F24?"HH:mm":"hh:mm A"},tt.prototype.getFullDate=function(){return this.oMoment?this.oMoment.format("ddd, MMM D, YYYY, "+this.getTimeFormat()):""},tt.prototype.getMidDate=function(){return this.getShortDate(!0)},tt.prototype.getShortDate=function(e){var t="",i=null;return this.oMoment&&(i=moment(),i.format("L")===this.oMoment.format("L")?t=this.oMoment.format(this.getTimeFormat()):(t=i.clone().subtract("days",1).format("L")===this.oMoment.format("L")?Ei.i18n("DATETIME/YESTERDAY"):this.oMoment.format(i.year()===this.oMoment.year()?"MMM D":"MMM D, YYYY"),(Ei.isUnd(e)?1:!e)||(t+=", "+this.oMoment.format(this.getTimeFormat())))),t},tt.prototype.getDate=function(){return this.oMoment?this.oMoment.format("ddd, MMM D, YYYY"):""},tt.prototype.getTime=function(){return this.oMoment?this.oMoment.format(this.getTimeFormat()):""},tt.prototype.convertDate=function(e){var t=Ei.getDateFormatForMoment(Mi.User.DefaultDateFormat)+" "+this.getTimeFormat();return moment(1e3*e).format(t)},tt.prototype.getTimeStampInUTC=function(){return this.iTimeStampInUTC},it.prototype.parse=function(e){"Object/CIdentity"===e["@Object"]&&(this.loyal(!!e.Loyal),this.isDefault(!!e.Default),this.enabled(!!e.Enabled),this.email(Ei.pString(e.Email)),this.friendlyName(Ei.pString(e.FriendlyName)),this.accountId(Ei.pInt(e.IdAccount)),this.id(Ei.pInt(e.IdIdentity)),this.signature(Ei.pString(e.Signature)),this.useSignature(!!e.UseSignature))},st.prototype.dataObjectName="",st.prototype.isVisibleViewLink=function(){return this.uploaded()&&!this.uploadError()&&this.isViewMimeType()},st.prototype.parse=function(e,t){e["@Object"]===this.dataObjectName&&(this.fileName(Ei.pString(e.FileName)),this.tempName(Ei.pString(e.TempName)),""===this.tempName()&&this.tempName(this.fileName()),this.type(Ei.pString(e.MimeType)),this.size(e.EstimatedSize?parseInt(e.EstimatedSize,10):parseInt(e.SizeInBytes,10)),this.content(Ei.pString(e.Content)),this.thumb(!!e.Thumb),this.hash(Ei.pString(e.Hash)),this.accountId(t),this.allowExpandSubFiles(!!e.Expand),this.iframedView(!!e.Iframed),this.uploadUid(this.hash()),this.uploaded(!0),Ei.isFunc(this.additionalParse)&&this.additionalParse(e))},st.prototype.getInThumbQueue=function(e){this.thumbnailSessionUid(e),this.thumb()&&(!this.linked||this.linked&&!this.linked())&&Ei.thumbQueue(this.thumbnailSessionUid(),this.thumbnailLink(),this.thumbnailSrc)},st.prototype.downloadFile=function(e){this.allowDownload()&&(e&&e.Api&&e.Api.downloadByUrl||(e=Fi),e&&this.downloadLink().length>0&&"#"!==this.downloadLink()&&e.Api.downloadByUrl(this.downloadLink()))},st.prototype.onFileExpandResponse=function(e){this.subFiles([]),Ei.isNonEmptyArray(e.Result)&&(_.each(e.Result,_.bind(function(e){var t=this.getInstance();e["@Object"]=this.dataObjectName,t.parse(e,this.accountId()),this.subFiles.push(t)},this)),this.subFilesLoaded(!0),this.subFilesCollapsed(!0)),this.subFilesStartedLoading(!1)},st.prototype.expandFile=function(){this.subFilesLoaded()?this.subFilesCollapsed(!0):(this.subFilesStartedLoading(!0),Fi.Ajax.send({Action:"FileExpand",RawKey:this.hash()},this.onFileExpandResponse,this))},st.prototype.collapseFile=function(){this.subFilesCollapsed(!1)},st.prototype.getInstance=function(){return new st},st.prototype.importFile=function(){var e=this.content(),t=_.bind(function(t){t&&Fi.Screens.showPopup(q,[t,e])},this);Fi.Api.pgp(t,Mi.User.IdUser)},st.prototype.viewFile=function(){this.viewCommonFile()},st.prototype.viewCommonFile=function(){var e=null,t=Ei.getAppPath()+this.viewLink();this.visibleViewLink()&&this.viewLink().length>0&&"#"!==this.viewLink()&&(this.isLink()&&(t=this.linkUrl()),e=this.iframedView()?Ei.WindowOpener.openTab(t):Ei.WindowOpener.open(t,t,!1),e&&e.focus())},st.prototype.eventDragStart=function(e,t){var i=t.originalEvent||t;return e&&i&&i.dataTransfer&&i.dataTransfer.setData&&i.dataTransfer.setData("DownloadURL",this.generateTransferDownloadUrl()),!0},st.prototype.generateTransferDownloadUrl=function(){var e=this.downloadLink();return"http"!==e.substr(0,4)&&(e=t.location.protocol+"//"+t.location.host+t.location.pathname+e),this.type()+":"+this.fileName()+":"+e},st.prototype.onUploadSelect=function(e,t){this.fileName(Ei.pString(t.FileName)),this.type(Ei.pString(t.Type)),this.size(Ei.pInt(t.Size)),this.uploadUid(e),this.uploaded(!1),this.visibleSpinner(!1),this.statusText(""),this.progressPercent(0),this.visibleProgress(!1)},st.prototype.onUploadStart=function(){this.visibleSpinner(!0),this.visibleProgress(!0)},st.prototype.onUploadProgress=function(e,t){t>0&&(this.progressPercent(Math.ceil(e/t*100)),this.visibleProgress(!0))},st.prototype.onUploadComplete=function(e,t,i){var s=!t||!i||i.Error||!1,o=Ei.i18n(i&&"size"===i.Error?"COMPOSE/UPLOAD_ERROR_SIZE":"COMPOSE/UPLOAD_ERROR_UNKNOWN");this.visibleSpinner(!1),this.progressPercent(0),this.visibleProgress(!1),this.uploaded(!0),this.uploadError(s),this.statusText(s?o:Ei.i18n("COMPOSE/UPLOAD_COMPLETE")),s||(this.fillDataAfterUploadComplete(i,e),setTimeout(function(e){return function(){e.statusText("")}}(this),3e3))},st.prototype.fillDataAfterUploadComplete=function(){},st.prototype.onImageLoad=function(){this.thumb()&&!this.thumbnailLoaded()&&(this.thumbnailLoaded(!0),Ei.thumbQueue(this.thumbnailSessionUid()))},Ei.extend(ot,st),ot.prototype.dataObjectName="Object/CApiMailAttachment",ot.prototype.getInstance=function(){return new ot},ot.prototype.getCopy=function(){var e=new ot;return e.copyProperties(this),e},ot.prototype.copyProperties=function(e){this.fileName(e.fileName()),this.tempName(e.tempName()),this.size(e.size()),this.accountId(e.accountId()),this.hash(e.hash()),this.type(e.type()),this.cid(e.cid()),this.contentLocation(e.contentLocation()),this.inline(e.inline()),this.linked(e.linked()),this.thumb(e.thumb()),this.thumbnailSrc(e.thumbnailSrc()),this.thumbnailLoaded(e.thumbnailLoaded()),this.statusText(e.statusText()),this.uploaded(e.uploaded()),this.iframedView(e.iframedView())},ot.prototype.isVisibleViewLink=function(){return this.uploaded()&&!this.uploadError()&&(this.isViewMimeType()||this.isMessageType())},ot.prototype.additionalParse=function(e){this.mimePartIndex(Ei.pString(e.MimePartIndex)),this.cid(Ei.pString(e.CID)),this.contentLocation(Ei.pString(e.ContentLocation)),this.inline(!!e.IsInline),this.linked(!!e.IsLinked)},ot.prototype.setMessageData=function(e,t){this.folderName(e),this.messageUid(t)},ot.prototype.onMessageGetResponse=function(e){var t=e.Result,i=new at;t&&this.oNewWindow&&(i.parse(t,e.AccountID,!1,!0),this.messagePart(i),this.messagePart().viewMessage(this.oNewWindow),this.oNewWindow=void 0)},ot.prototype.viewFile=function(){this.isMessageType()?this.viewMessageFile():this.viewCommonFile()},ot.prototype.viewMessageFile=function(){var t=null,i='<div style="margin: 30px; text-align: center; font: normal 14px Tahoma;">'+Ei.i18n("MAIN/LOADING")+"</div>";t=Ei.WindowOpener.open("",this.fileName()),t&&(this.messagePart()?this.messagePart().viewMessage(t):(e(t.document.body).html(i),this.oNewWindow=t,Fi.Ajax.send({Action:"MessageGet",Folder:this.folderName(),Uid:this.messageUid(),Rfc822MimeIndex:this.mimePartIndex()},this.onMessageGetResponse,this)),t.focus())},ot.prototype.viewCommonFile=function(){var e=null,t=Ei.getAppPath()+this.viewLink();this.visibleViewLink()&&this.viewLink().length>0&&"#"!==this.viewLink()&&(t=Ei.getAppPath()+this.viewLink(),e=this.iframedView()?Ei.WindowOpener.openTab(t):Ei.WindowOpener.open(t,t,!1),e&&e.focus())},ot.prototype.fillDataAfterUploadComplete=function(e,t){this.cid(t),this.tempName(e.Result.Attachment.TempName),this.type(e.Result.Attachment.MimeType),this.size(e.Result.Attachment.Size),this.hash(e.Result.Attachment.Hash),this.iframedView(e.Result.Attachment.Iframed),this.accountId(e.AccountID)},ot.prototype.parseFromUpload=function(e,t){this.fileName(e.Name.toString()),this.tempName(e.TempName?e.TempName.toString():this.fileName()),this.type(e.MimeType.toString()),this.size(parseInt(e.Size,10)),this.hash(e.Hash),this.accountId(t),this.uploadUid(this.hash()),this.uploaded(!0),this.uploadStarted(!1)},ot.prototype.errorFromUpload=function(){this.uploaded(!0),this.uploadError(!0),this.uploadStarted(!1),this.statusText(Ei.i18n("COMPOSE/UPLOAD_ERROR_UNKNOWN"))},nt.prototype.getMessageByUid=function(e){return this.oMessages[e]},nt.prototype.getFlaggedMessageUids=function(){var e=[];return _.each(this.oMessages,function(t){t.flagged()&&e.push(t.uid())}),e},nt.prototype.setMessageUnflaggedByUid=function(e){var t=this.oMessages[e];t&&t.flagged(!1)},nt.prototype.hideThreadMessages=function(e){_.each(e.threadUids(),function(e){var t=this.oMessages[e];t&&(t.deleted()||(t.threadShowAnimation(!1),t.threadHideAnimation(!0),setTimeout(function(){t.threadHideAnimation(!1)},1e3)))},this)},nt.prototype.getThreadMessages=function(e){var t=[],i=[],s=[],o=0,n=null,r=50;return _.each(e.threadUids(),function(a){if(o<e.threadCountForLoad()){var l=this.oMessages[a];l?l.deleted()||(l.markAsThreadPart(r,e.uid()),t.push(l),s.push(l.uid()),o++,n=l):(i.push(a),s.push(a),o++)}else s.push(a)},this),e.threadLoading()||this.loadThreadMessages(i),e.changeThreadUids(s,t.length),n&&t.length<e.threadUids().length&&n.showNextLoadingLink(_.bind(e.increaseThreadCountForLoad,e)),this.addThreadUidsToUidLists(e.uid(),e.threadUids()),t},nt.prototype.computeThreadData=function(e){var t=0,i=!1,s=[],o=[],n=e.oFrom.getFirstEmail();_.each(e.threadUids(),function(e){var r=this.oMessages[e],a="";r&&!r.deleted()&&(r.seen()||t++,r.flagged()&&(i=!0),a=r.oFrom.getFirstEmail(),a!==n&&-1===Ei.inArray(a,o)&&(o.push(a),s.push(a===Mi.Accounts.getEmail()?Ei.i18n("MESSAGE/ME_SENDER"):r.oFrom.getFirstDisplay())))},this),e.threadUnreadCount(t),e.partialFlagged(i),e.threadSenders(s)},nt.prototype.addThreadUidsToUidLists=function(e,t){_.each(this.oUids,function(i){_.each(i,function(i){i.addThreadUids(e,t)})})},nt.prototype.loadThreadMessages=function(e){if(e.length>0){var t={Action:"MessagesGetListByUids",Folder:this.fullName(),Uids:e};Fi.Ajax.send(t,this.onMessagesGetListByUidsResponse,this)}},nt.prototype.getThreadCheckedUidsFromList=function(e){var t=this,i=[];return _.each(e,function(e){e.threadCount()>0&&!e.threadOpened()&&_.each(e.threadUids(),function(e){var s=t.oMessages[e];s&&!s.deleted()&&s.checked()&&i.push(e)})}),i},nt.prototype.parseAndCacheMessage=function(e,t,i){var s=e.Uid.toString(),o=Ei.isUnd(this.oMessages[s]),n=o?new at:this.oMessages[s];return n.parse(e,this.iAccountId,t,i),this.type()===Ci.FolderTypes.Inbox&&o&&n.flagged()&&Fi.MailCache.increaseStarredCount(),this.oMessages[n.uid()]=n,n},nt.prototype.onMessagesGetListByUidsResponse=function(e){var t=e.Result;t&&"Collection/MessageCollection"===t["@Object"]&&(_.each(t["@Collection"],function(e){this.parseAndCacheMessage(e,!0,!0)},this),Fi.MailCache.showOpenedThreads(this.fullName()))},nt.prototype.addRequestedUids=function(e){this.aRequestedUids=_.union(this.aRequestedUids,e)},nt.prototype.hasUidBeenRequested=function(e){return-1!==_.indexOf(this.aRequestedUids,e)},nt.prototype.addRequestedThreadUids=function(e){this.aRequestedThreadUids=_.union(this.aRequestedThreadUids,e)},nt.prototype.hasThreadUidBeenRequested=function(e){return-1!==_.indexOf(this.aRequestedThreadUids,e)},nt.prototype.hasListBeenRequested=function(e){var t=_.where(this.requestedLists,e),i=t.length>0;return i||this.requestedLists.push(e),i},nt.prototype.markMessageReplied=function(e,t){var i=this.oMessages[e];if(i)switch(t){case Ci.ReplyType.Reply:case Ci.ReplyType.ReplyAll:i.answered(!0);break;case Ci.ReplyType.Forward:i.forwarded(!0)}},nt.prototype.removeAllMessages=function(){var e=null;this.oMessages={},this.oUids={},this.messageCount(0),this.unseenMessageCount(0),this.realUnseenMessageCount(0),e=this.getUidList("",""),e.resultCount(0)},nt.prototype.removeAllMessageListsFromCacheIfHasChanges=function(){this.hasChanges()&&(this.oUids={},this.requestedLists=[],this.aRequestedThreadUids=[],this.hasChanges(!1))},nt.prototype.removeFlaggedMessageListsFromCache=function(){_.each(this.oUids,function(e,t){delete this.oUids[t][Ci.FolderFilter.Flagged]},this)},nt.prototype.removeUnseenMessageListsFromCache=function(){_.each(this.oUids,function(e,t){delete this.oUids[t][Ci.FolderFilter.Unseen]},this)},nt.prototype.setRelevantInformation=function(e,t,i,s,o){var n=this.hasExtendedInfo()&&(this.hash()!==t||this.realUnseenMessageCount()!==s);return this.uidNext(e),this.hash(t),this.hasExtendedInfo()&&o||(this.messageCount(i),this.unseenMessageCount(s),0===s&&this.unseenMessageCount.valueHasMutated()),this.realUnseenMessageCount(s),this.hasExtendedInfo(!0),n&&this.markHasChanges(),this.relevantInformationLastMoment=moment(),n},nt.prototype.increaseCountIfHasNotInfo=function(){this.hasExtendedInfo()||this.messageCount(this.messageCount()+1)},nt.prototype.markHasChanges=function(){this.hasChanges(!0)},nt.prototype.addMessagesCountsDiff=function(e,t){var i=this.messageCount()+e,s=this.unseenMessageCount()+t;0>i&&(i=0),this.messageCount(i),0>s&&(s=0),s>i&&(s=i),this.unseenMessageCount(s)},nt.prototype.markDeletedByUids=function(e){var t=0,i=0;return _.each(e,function(e){var s=this.oMessages[e];s&&(t++,s.seen()||i++,s.deleted(!0))},this),this.addMessagesCountsDiff(-t,-i),{MinusDiff:t,UnseenMinusDiff:i}},nt.prototype.revertDeleted=function(e){var t=0,i=0;return _.each(e,function(e){var s=this.oMessages[e];s&&s.deleted()&&(t++,s.seen()||i++,s.deleted(!1))},this),this.addMessagesCountsDiff(t,i),{PlusDiff:t,UnseenPlusDiff:i}},nt.prototype.commitDeleted=function(e){_.each(e,_.bind(function(e){delete this.oMessages[e]},this)),_.each(this.oUids,function(t){_.each(t,function(t){t.deleteUids(e)})})},nt.prototype.getUidList=function(e,t){var i=null;return void 0===this.oUids[e]&&(this.oUids[e]={}),void 0===this.oUids[e][t]&&(i=new lt,i.search(e),i.filters(t),this.oUids[e][t]=i),this.oUids[e][t]},nt.prototype.parse=function(e,t){var i="",s=Fi.Storage.getData("folderAccordion")||[];return"Object/Folder"===e["@Object"]?(this.parentFullName(t),i=Ei.pString(e.Name),this.name(i),this.nameForEdit(i),this.fullName(Ei.pString(e.FullNameRaw)),this.fullNameHash(Ei.pString(e.FullNameHash)),this.routingHash(Fi.Routing.buildHashFromArray([Ci.Screens.Mailbox,this.fullName()])),this.delimiter(e.Delimiter),this.type(e.Type),this.subscribed(e.IsSubscribed),this.selectable(e.IsSelectable),this.existen(e.IsExists),e.Extended&&this.setRelevantInformation(e.Extended.UidNext.toString(),e.Extended.Hash,e.Extended.MessageCount,e.Extended.MessageUnseenCount,!1),_.find(s,function(e){return e===this.name()},this)&&this.expanded(!0),e.SubFolders):null},nt.prototype.onMessageGetResponse=function(e,t){var i=e.Result,s=null,o=i?i.Uid.toString():t.Uid.toString(),n=this.oMessages[o],r=n?n.selected():!1;i?(n=this.parseAndCacheMessage(i,!1,!1),n&&n.ical()&&n.ical().isReplyType()&&Fi.CalendarCache&&Fi.CalendarCache.calendarChanged(!0)):(r&&(Fi.Api.showErrorByCode(e,Ei.i18n("WARNING/UNKNOWN_ERROR")),Fi.Routing.replaceHashWithoutMessageUid(o)),n=null),s=this.aResponseHandlers[o],s&&(s.handler.call(s.context,n,o),delete this.aResponseHandlers[o])},nt.prototype.getCompletelyFilledMessage=function(e,t,i){var s=this.oMessages[e],o={Action:"MessageGet",Folder:this.fullName(),Uid:e};e.length>0&&(s&&s.completelyFilled()&&!s.trimmed()?t&&i&&t.call(i,s,e):(t&&i&&(this.aResponseHandlers[e]={handler:t,context:i}),Fi.Ajax.send(o,this.onMessageGetResponse,this)))},nt.prototype.showExternalPictures=function(e){var t=this.oMessages[e];void 0!==t&&t.showExternalPictures()},nt.prototype.alwaysShowExternalPicturesForSender=function(e){_.each(this.oMessages,function(t){var i=t.oFrom.aCollection;i.length>0&&i[0].sEmail===e&&t.alwaysShowExternalPicturesForSender()},this)},nt.prototype.executeGroupOperation=function(e,t,i){var s=0;_.each(this.oMessages,function(o){t.length>0?_.each(t,function(t){o&&o.uid()===t&&o[e]()!==i&&(o[e](i),s++)}):o[e](i)}),0===t.length&&(s=i?this.unseenMessageCount():this.messageCount()-this.unseenMessageCount()),"seen"===e&&s>0&&(i?this.addMessagesCountsDiff(0,-s):this.addMessagesCountsDiff(0,s),this.markHasChanges())},nt.prototype.emptyFolder=function(){var e=Ei.i18n("MAILBOX/CONFIRM_EMPTY_FOLDER"),t=_.bind(this.clearFolder,this);this.enableEmptyFolder()&&Fi.Screens.showPopup(E,[e,t])},nt.prototype.clearFolder=function(e){var t={Action:"FolderClear",Folder:this.fullName()};this.enableEmptyFolder()&&e&&(Fi.Ajax.send(t),this.removeAllMessages(),Fi.MailCache.onClearFolder(this))},nt.prototype.getNameWhithLevel=function(){var e=this.level();return!this.isNamespace()&&e>0&&e--,Ei.strRepeat("",3*e)+this.name()},nt.prototype.onAccordion=function(e,t){var i=!this.expanded(),s=Fi.Storage.getData("folderAccordion")||[];i?s.push(this.name()):s=_.reject(s,function(e){return e===this.name()},this),Fi.Storage.setData("folderAccordion",s),this.expanded(i),Fi.MailCache.countMessages(this),t.stopPropagation()},nt.prototype.executeUnseenFilter=function(){var e=!1;return this.showUnseenMessages()?(Fi.MailCache.waitForUnseenMessages(!0),e=Fi.Routing.setHash(Fi.Links.mailbox(this.fullName(),1,"","",Ci.FolderFilter.Unseen)),e&&Fi.MailCache.changeCurrentMessageList(this.fullName(),1,"",Ci.FolderFilter.Unseen),!1):!0},rt.prototype.getTotalMessageCount=function(){var e=0;return _.each(this.oNamedCollection,function(t){e+=t.messageCount()},this),e},rt.prototype.getFoldersWithoutCountInfo=function(){var e=_.compact(_.map(this.oNamedCollection,function(e,t){return e.canBeSelected()&&!e.hasExtendedInfo()?t:null}));return e},rt.prototype.setCurrentFolder=function(e,t){var i=this.getFolderByFullName(e);null===i&&(i=this.inboxFolder()),null!==i&&(this.currentFolder()&&(this.currentFolder().selected(!1),this.oStarredFolder&&this.oStarredFolder.selected(!1)),this.currentFolder(i),t===Ci.FolderFilter.Flagged?this.oStarredFolder&&this.oStarredFolder.selected(!0):this.currentFolder().selected(!0))},rt.prototype.getFolderByType=function(e){switch(e){case Ci.FolderTypes.Inbox:return this.inboxFolder();case Ci.FolderTypes.Sent:return this.sentFolder();case Ci.FolderTypes.Drafts:return this.draftsFolder();case Ci.FolderTypes.Trash:return this.trashFolder();case Ci.FolderTypes.Spam:return this.spamFolder()}return null},rt.prototype.getFolderByFullName=function(e){var t=this.oNamedCollection[e];return t?t:null},rt.prototype.parse=function(e,t,i){this.iAccountId=e,this.sNamespace=Ei.pString(t.Namespace),this.bInitialized(!0),this.sNamespaceFolder=this.sNamespace.length>0?this.sNamespace.substring(0,this.sNamespace.length-1):this.sNamespace,this.expandFolders(Mi.MailExpandFolders&&!Fi.Storage.hasData("folderAccordion")),Fi.Storage.hasData("folderAccordion")||Fi.Storage.setData("folderAccordion",[]),this.collection(this.parseRecursively(t["@Collection"],i))},rt.prototype.parseRecursively=function(e,t,i,s){var o=this,n=[],r=0,a=0,l=null,h=null,c="",u=null,d=[],p=!1,m=this.expandFolders(),g=Mi.Accounts.getAccount(this.iAccountId),f=function(){var e=o.getFolderByType(Ci.FolderTypes.Spam);g&&g.extensionExists("AllowSpamFolderExtension")||(e.type(Ci.FolderTypes.User),o.spamFolder(null))},b=function(){g&&g.extensionsRequested()&&(f(),g.extensionsRequestedSubscription.dispose(),g.extensionsRequestedSubscription=void 0)};if(s=s||"",Ei.isUnd(i)&&(i=-1),i++,_.isArray(e)){for(a=e.length;a>r;r++){switch(c=Ei.pString(e[r].FullNameRaw),h=t[c],l=new nt(this),l.iAccountId=this.iAccountId,u=l.parse(e[r],s),h&&h.hasExtendedInfo()&&!l.hasExtendedInfo()&&l.setRelevantInformation(h.uidNext(),h.hash(),h.messageCount(),h.unseenMessageCount(),!1),m&&null!==u&&(l.expanded(!0),this.expandNames().push(Ei.pString(e[r].Name))),p=this.sNamespace===l.fullName()+l.delimiter(),l.isNamespace(p),l.level(i),this.oNamedCollection[l.fullName()]=l,l.type()){case Ci.FolderTypes.Inbox:this.inboxFolder(l);break;case Ci.FolderTypes.Sent:this.sentFolder(l);break;case Ci.FolderTypes.Drafts:this.draftsFolder(l);break;case Ci.FolderTypes.Trash:this.trashFolder(l);break;case Ci.FolderTypes.Spam:this.spamFolder(l),g.extensionsRequested()?f():g.extensionsRequestedSubscription=g.extensionsRequested.subscribe(b)}n.push(l),null===u&&l.type()===Ci.FolderTypes.Inbox?(this.createStarredFolder(l.fullName(),i),this.oStarredFolder&&n.push(this.oStarredFolder)):null!==u&&(d=this.parseRecursively(u["@Collection"],t,i,l.fullName()),l.type()===Ci.FolderTypes.Inbox&&(l.isNamespace()?(this.createStarredFolder(l.fullName(),i+1),this.oStarredFolder&&d.unshift(this.oStarredFolder)):(this.createStarredFolder(l.fullName(),i),this.oStarredFolder&&n.push(this.oStarredFolder))),l.subfolders(d))}m&&Fi.Storage.setData("folderAccordion",this.expandNames())}return n},rt.prototype.createStarredFolder=function(e,t){var i=new nt(this);i.iAccountId=this.iAccountId,i.virtual(!0),i.level(t),i.fullName(e),i.name(Ei.i18n("MAIN/FOLDER_STARRED")),i.type(Ci.FolderTypes.Starred),i.routingHash(Fi.Routing.buildHashFromArray(Fi.Links.mailbox(i.fullName(),1,"","",Ci.FolderFilter.Flagged))),this.oStarredFolder=i},rt.prototype.getOptions=function(e,t,i,s){var o="",n=function(e){var r=0,a=0,l=null,h=[];for(Ei.isUnd(t)&&(t=!1),Ei.isUnd(i)&&(i=!1),Ei.isUnd(s)&&(s=!1),r=0,a=e.length;a>r;r++)l=e[r],l.virtual()||(l.type()===Ci.FolderTypes.Inbox||!i)&&i||h.push({name:l.name(),fullName:l.fullName(),displayName:new Array(l.level()+1).join(o)+l.name(),translatedDisplayName:new Array(l.level()+1).join(o)+l.displayName(),disable:l.isSystem()&&!t||!s&&!l.canBeSelected()}),h=h.concat(n(l.subfolders()));return h},r=n(this.collection());return""!==e&&r.unshift({name:e,fullName:"",displayName:e,translatedDisplayName:e,disable:!1}),r},rt.prototype.deleteFolder=function(e){var t=function(i){return e&&e.fullName()===i.fullName()?!0:(i.subfolders.remove(t),!1)};this.collection.remove(t)},at.prototype.viewMessage=function(t){var i=this.getDomText(Ei.getAppPath()),s="";this.textBodyForNewWindow(i.html()),s=e(this.domMessageForPrint()).html(),t&&(e(t.document.body).html(s),t.focus(),_.each(this.attachments(),function(i){var s=e(t.document.body).find("[data-hash='download-"+i.hash()+"']");s.on("click",_.bind(i.downloadFile,i,Fi)),s=e(t.document.body).find("[data-hash='view-"+i.hash()+"']"),s.on("click",_.bind(i.viewFile,i))
},this))},at.prototype.fillFromOrToText=function(){var e=Fi.MailCache.getFolderByFullName(this.accountId(),this.folder()),t=Mi.Accounts.getAccount(this.accountId());this.fromOrToText(e.type()===Ci.FolderTypes.Drafts||e.type()===Ci.FolderTypes.Sent?this.oTo.getDisplay(Ei.i18n("MESSAGE/ME_RECIPIENT"),t.email()):this.oFrom.getDisplay(Ei.i18n("MESSAGE/ME_SENDER"),t.email()))},at.prototype.changeThreadUids=function(e,t){this.threadUids(e),this.threadLoading(t<Math.min(this.threadUids().length,this.threadCountForLoad()))},at.prototype.showNextLoadingLink=function(e){this.threadNextLoadingLinkVisible()&&(this.threadNextLoadingVisible(!0),this.threadFunctionLoadNext=e)},at.prototype.increaseThreadCountForLoad=function(){this.threadCountForLoad(this.threadCountForLoad()+5),Fi.MailCache.showOpenedThreads(this.folder())},at.prototype.loadNextMessages=function(){this.threadFunctionLoadNext&&(this.threadFunctionLoadNext(),this.threadNextLoadingLinkVisible(!1),this.threadFunctionLoadNext=null)},at.prototype.markAsThreadPart=function(e,t){var i=this;this.threadPart(!0),this.threadParentUid(t),this.threadUids([]),this.threadNextLoadingVisible(!1),this.threadNextLoadingLinkVisible(!0),this.threadFunctionLoadNext=null,this.threadHideAnimation(!1),setTimeout(function(){i.threadShowAnimation(!0)},e)},at.prototype.parse=function(e,t,i,s){var o=null,n=null,r="",a="";s&&this.threadPart(i),this.threadPart()||this.threadParentUid(""),"Object/MessageListItem"===e["@Object"]&&(this.seen(!!e.IsSeen),this.flagged(!!e.IsFlagged),this.answered(!!e.IsAnswered),this.forwarded(!!e.IsForwarded),e.Custom&&(this.Custom=e.Custom)),("Object/Message"===e["@Object"]||"Object/MessageListItem"===e["@Object"])&&(this.accountId(t),this.folder(e.Folder),this.uid(Ei.pString(e.Uid)),this.subject(Ei.pString(e.Subject)),this.messageId(Ei.pString(e.MessageId)),this.size(e.Size),this.textSize(e.TextSize),this.oDateModel.parse(e.TimeStampInUTC),this.oFrom.parse(e.From),this.oTo.parse(e.To),this.fillFromOrToText(),this.oCc.parse(e.Cc),this.oBcc.parse(e.Bcc),this.oSender.parse(e.Sender),this.oReplyTo.parse(e.ReplyTo),this.fullDate(this.oDateModel.getFullDate()),this.fullFrom(this.oFrom.getFull()),this.to(this.oTo.getFull()),this.cc(this.oCc.getFull()),this.bcc(this.oBcc.getFull()),this.hasAttachments(!!e.HasAttachments),this.hasIcalAttachment(!!e.HasIcalAttachment),this.hasVcardAttachment(!!e.HasVcardAttachment),"Object/MessageListItem"===e["@Object"]&&s&&this.threadUids(_.map(e.Threads,function(e){return e.toString()},this)),this.importance(e.Priority),_.isArray(e.DraftInfo)&&this.draftInfo(e.DraftInfo),this.sensitivity(e.Sensitivity),this.hash(Ei.pString(e.Hash)),"Object/Message"===e["@Object"]&&(this.trimmed(e.Trimmed),this.trimmedTextSize(e.TrimmedTextSize),this.inReplyTo(e.InReplyTo),this.references(e.References),this.readingConfirmation(e.ReadingConfirmation),r=Ei.pString(e.Html),a=Ei.pString(e.Plain),""!==r?(this.text(r),this.isPlain(!1)):(this.textRaw(e.PlainRaw),-1!==this.textRaw().indexOf("-----BEGIN PGP MESSAGE-----")?(this.text("<pre>"+Ei.encodeHtml(this.textRaw())+"</pre>"),this.encryptedMessage(!0)):-1!==this.textRaw().indexOf("-----BEGIN PGP SIGNED MESSAGE-----")?(this.text("<pre>"+Ei.encodeHtml(this.textRaw())+"</pre>"),this.signedMessage(!0)):this.text(""!==a?"<div>"+a+"</div>":""),this.isPlain(!0)),this.$text=null,this.isExternalsShown(!1),this.rtl(e.Rtl),this.hasExternals(!!e.HasExternals),this.foundedCids(e.FoundedCIDs),this.parseAttachments(e.Attachments,t),this.safety(e.Safety),this.sourceHeaders(e.Headers),null!==e.ICAL&&(o=new ht,o.parse(e.ICAL,Mi.Accounts.getAttendee(this.oTo.getEmails())),this.ical(o)),null!==e.VCARD&&(n=new ct,n.parse(e.VCARD),this.vcard(n)),this.completelyFilled(!0)),this.updateMomentDate())},at.prototype.updateMomentDate=function(){this.date(this.oDateModel.getShortDate(moment().clone().subtract("days",1).format("L")===moment.unix(this.oDateModel.getTimeStampInUTC()).format("L")))},at.prototype.getDomText=function(t,i){var s=this.$text;return t=t||"",(null===this.$text||""!==t)&&(this.completelyFilled()?(this.$text=e(this.text()),this.showInlinePictures(t),this.safety()===!0&&this.alwaysShowExternalPicturesForSender(),i&&this.isExternalsShown()&&this.showExternalPictures(),s=this.$text):s=e("")),s.clone()},at.prototype.getConvertedHtml=function(e,t){var i=this.getDomText(e,t);return i.length>0?i.wrap("<p>").parent().html():""},at.prototype.parseAttachments=function(e,t){if(_.isArray(e)){var i=Date.now().toString();this.attachments(_.map(e,function(e){var s=new ot;return s.parse(e,t),s.getInThumbQueue(i),s.setMessageData(this.folder(),this.uid()),s},this))}},at.prototype.parseAddressArray=function(e){var t=[];return _.isArray(e)&&(t=_.map(e,function(e){var t=new Z;return t.parse(e),t})),t},at.prototype.findAttachmentByCid=function(e){return _.find(this.attachments(),function(t){return t.cid()===e})},at.prototype.findAttachmentByContentLocation=function(e){return _.find(this.attachments(),function(t){return t.contentLocation()===e})},at.prototype.showInlinePictures=function(t){var i=this;this.foundedCids().length>0&&(e("[data-x-src-cid]",this.$text).each(function(){var s=e(this).attr("data-x-src-cid"),o=i.findAttachmentByCid(s);o&&o.viewLink().length>0&&e(this).attr("src",t+o.viewLink())}),e("[data-x-style-cid]",this.$text).each(function(){var t="",s=e(this).attr("data-x-style-cid-name"),o=e(this).attr("data-x-style-cid"),n=i.findAttachmentByCid(o);n&&n.viewLink().length>0&&""!==s&&(t=Ei.trim(e(this).attr("style")),t=""===t?"":";"===t.substr(-1)?t+" ":t+"; ",e(this).attr("style",t+s+": url('"+n.viewLink()+"')"))})),e("[data-x-src-location]",this.$text).each(function(){var s=e(this).attr("data-x-src-location"),o=i.findAttachmentByContentLocation(s);o||(o=i.findAttachmentByCid(s)),o&&o.viewLink().length>0&&e(this).attr("src",t+o.viewLink())})},at.prototype.showExternalPictures=function(){e("[data-x-src]",this.$text).each(function(){e(this).attr("src",e(this).attr("data-x-src")).removeAttr("data-x-src")}),e("[data-x-style-url]",this.$text).each(function(){var t=Ei.trim(e(this).attr("style"));t=""===t?"":";"===t.substr(-1)?t+" ":t+"; ",e(this).attr("style",t+e(this).attr("data-x-style-url")).removeAttr("data-x-style-url")}),this.isExternalsShown(!0)},at.prototype.alwaysShowExternalPicturesForSender=function(){this.completelyFilled()&&(this.isExternalsAlwaysShown(!0),this.isExternalsShown()||this.showExternalPictures())},at.prototype.openThread=function(){if(this.threadCountVisible()){var e=this.folder();this.threadOpened(!this.threadOpened()),this.threadOpened()?Fi.MailCache.showOpenedThreads(e):(Fi.MailCache.hideThreads(this),setTimeout(function(){Fi.MailCache.showOpenedThreads(e)},500))}},at.prototype.downloadAllAttachments=function(){if(""!==this.allAttachmentsHash)Fi.Api.downloadByUrl(Ei.getDownloadLinkByHash(this.accountId(),this.allAttachmentsHash));else{var e=_.filter(this.attachments(),function(e){return!e.linked()}),t=_.map(e,function(e){return e.hash()});Fi.Ajax.send({Action:"MessageAttachmentsZip",Hashes:t},this.onMessageZipAttachments,this)}},at.prototype.onMessageZipAttachments=function(e){e.Result&&(this.allAttachmentsHash=e.Result,Fi.Api.downloadByUrl(Ei.getDownloadLinkByHash(this.accountId(),this.allAttachmentsHash)))},at.prototype.saveAttachmentsToFiles=function(){var e=_.filter(this.attachments(),function(e){return!e.linked()}),t=_.map(e,function(e){return e.hash()});Fi.filesRecievedAnim(!0),Fi.Ajax.send({Action:"MessageAttachmentsSaveToFiles",Attachments:t},this.onMessageAttachmentsSaveToFilesResponse,this)},at.prototype.onMessageAttachmentsSaveToFilesResponse=function(e,t){var i=0,s=t.Attachments.length;e.Result&&_.each(t.Attachments,function(t){void 0!==e.Result[t]&&i++}),0===i?Fi.Api.showError(Ei.i18n("MESSAGE/ERROR_ATTACHMENTS_SAVED_TO_FILES")):s>i?Fi.Api.showError(Ei.i18n("MESSAGE/WARNING_ATTACHMENTS_SAVED_TO_FILES",{SAVED_COUNT:i,TOTAL_COUNT:s})):Fi.Api.showReport(Ei.i18n("MESSAGE/REPORT_ATTACHMENTS_SAVED_TO_FILES"))},at.prototype.downloadAllAttachmentsSeparately=function(){_.each(this.attachments(),function(e){e.linked()||e.downloadFile(Fi)})},at.prototype.toJSON=function(){return{uid:this.uid(),accountId:this.accountId(),to:this.to(),subject:this.subject(),threadPart:this.threadPart(),threadUids:this.threadUids(),threadOpened:this.threadOpened()}},lt.prototype.addThreadUids=function(e,t){-1!==_.indexOf(this.collection(),e)&&(this.threadUids[e]=t)},lt.prototype.setUidsAndCount=function(e){"Collection/MessageCollection"===e["@Object"]&&(_.each(e.Uids,function(t,i){this.collection()[i+e.Offset]=t.toString()},this),this.resultCount(e.MessageResultCount))},lt.prototype.getUidsForOffset=function(e,t){for(var i=0,s=this.collection().length,o="",n=0,r=[],a=null;s>i;i++)i>=e&&n<Mi.User.MailsPerPage&&(o=this.collection()[i],a=t[o],(a&&!a.deleted()||void 0===o)&&(n++,void 0!==o&&r.push(o)));return r},lt.prototype.deleteUids=function(e){for(var t=0,i=this.collection().length,s="",o=[],n=0;i>t;t++)s=this.collection()[t],-1===_.indexOf(e,s)?o.push(s):n++;this.collection(o),this.resultCount(this.resultCount()-n)},ht.prototype.fillDecisions=function(){var e=Mi.Accounts.getCurrent(),t=e?e.email():"";switch(this.cancelDecision(Ei.i18n("MESSAGE/APPOINTMENT_CANCELED",{SENDER:t})),this.icalConfig()){case Ci.IcalConfig.Accepted:this.replyDecision(Ei.i18n("MESSAGE/APPOINTMENT_ACCEPTED",{SENDER:t}));break;case Ci.IcalConfig.Declined:this.replyDecision(Ei.i18n("MESSAGE/APPOINTMENT_DECLINED",{SENDER:t}));break;case Ci.IcalConfig.Tentative:this.replyDecision(Ei.i18n("MESSAGE/APPOINTMENT_TENTATIVELY_ACCEPTED",{SENDER:t}))}},ht.prototype.parse=function(e,t){var i="";e&&"Object/CApiMailIcs"===e["@Object"]&&(i=Ei.pString(e.Description),this.uid(Ei.pString(e.Uid)),this.file(Ei.pString(e.File)),this.attendee(Ei.pString(e.Attendee)||t),this.type(e.Type),this.location(Ei.pString(e.Location)),this.description(i.replace(/\r/g,"").replace(/\n/g,"<br />")),this.when(Ei.pString(e.When)),this.calendarId(Ei.pString(e.CalendarId)),this.selectedCalendarId(Ei.pString(e.CalendarId)),Fi.CalendarCache.addIcal(this))},ht.prototype.acceptAppointment=function(){this.calendarId(this.selectedCalendarId()),this.changeAndSaveConfig(Ci.IcalConfig.Accepted)},ht.prototype.tentativeAppointment=function(){this.calendarId(this.selectedCalendarId()),this.changeAndSaveConfig(Ci.IcalConfig.Tentative)},ht.prototype.declineAppointment=function(){this.calendarId(""),this.selectedCalendarId(""),this.changeAndSaveConfig(Ci.IcalConfig.Declined)},ht.prototype.changeAndSaveConfig=function(e){this.icalConfig()!==e&&(this.icalConfig()===e||e===Ci.IcalConfig.Declined&&this.icalConfig()===Ci.IcalConfig.NeedsAction||Fi.CalendarCache.recivedAnim(!0),this.changeConfig(e),this.setAppointmentAction())},ht.prototype.changeConfig=function(e){this.type(this.icalType()+"-"+e),Mi.SingleMode&&t.opener?t.opener.App.CalendarCache.markIcalTypeByFile(this.file(),this.type(),this.cancelDecision(),this.replyDecision(),this.calendarId(),this.selectedCalendarId()):Fi.CalendarCache.markIcalTypeByFile(this.file(),this.type(),this.cancelDecision(),this.replyDecision(),this.calendarId(),this.selectedCalendarId())},ht.prototype.onCalendarAppointmentSetActionResponse=function(e){e.Result?Fi.CalendarCache&&Fi.CalendarCache.calendarChanged(!0):Fi.Api.showErrorByCode(e,Ei.i18n("WARNING/UNKNOWN_ERROR"))},ht.prototype.setAppointmentAction=function(){var e={Action:"CalendarAppointmentSetAction",AppointmentAction:this.icalConfig(),CalendarId:this.selectedCalendarId(),File:this.file(),Attendee:this.attendee()};Fi.Ajax.send(e,this.onCalendarAppointmentSetActionResponse,this)},ht.prototype.onCalendarSaveIcsResponse=function(e){e.Result?(e.Result.Uid&&this.uid(e.Result.Uid),Fi.CalendarCache&&Fi.CalendarCache.calendarChanged(!0)):Fi.Api.showErrorByCode(e)},ht.prototype.addEvent=function(){var e={Action:"CalendarSaveIcs",CalendarId:this.selectedCalendarId(),File:this.file()};Fi.Ajax.send(e,this.onCalendarSaveIcsResponse,this),this.isJustSaved(!0),this.calendarId(this.selectedCalendarId()),setTimeout(_.bind(function(){this.isJustSaved(!1)},this),2e4),Fi.CalendarCache.recivedAnim(!0)},ht.prototype.onEventDelete=function(){this.calendarId(""),this.selectedCalendarId(""),this.changeConfig(Ci.IcalConfig.NeedsAction)},ht.prototype.onEventTentative=function(){this.changeConfig(Ci.IcalConfig.Tentative)},ht.prototype.onEventAccept=function(){this.changeConfig(Ci.IcalConfig.Accepted)},ht.prototype.firstCalendarName=function(){return this.calendars()[0]?this.calendars()[0].name:""},ht.prototype.updateAttendeeStatus=function(e){if(this.icalType()===Ci.IcalType.Cancel||this.icalType()===Ci.IcalType.Reply){var t={Action:"CalendarAttendeeUpdateStatus",File:this.file(),FromEmail:e};Fi.Ajax.send(t,this.onCalendarAttendeeUpdateStatusResponse,this)}},ht.prototype.onCalendarAttendeeUpdateStatusResponse=function(e){e.Result&&Fi.CalendarCache&&(Fi.CalendarCache.recivedAnim(!0),Fi.CalendarCache.calendarChanged(!0))},ct.prototype.parse=function(e){e&&"Object/CApiMailVcard"===e["@Object"]&&(this.uid(Ei.pString(e.Uid)),this.file(Ei.pString(e.File)),this.name(Ei.pString(e.Name)),this.email(Ei.pString(e.Email)),this.isExists(!!e.Exists),Fi.ContactsCache.addVcard(this))},ct.prototype.onContactsSaveVcfResponse=function(e){e&&e.Result&&e.Result.Uid&&this.uid(e.Result.Uid)},ct.prototype.addContact=function(){var e={Action:"ContactsSaveVcf",File:this.file()};Fi.Ajax.send(e,this.onContactsSaveVcfResponse,this),this.isJustSaved(!0),this.isExists(!0),setTimeout(_.bind(function(){this.isJustSaved(!1)},this),2e4),Fi.ContactsCache.recivedAnim(!0),Mi.SingleMode&&t.opener?t.opener.App.ContactsCache.markVcardExistentByFile(this.file()):Fi.ContactsCache.markVcardExistentByFile(this.file())},ut.birthdayMonths=Ei.getMonthNamesArray(),ut.birthdayMonthSelect=[{text:Ei.i18n("DATETIME/MONTH"),value:"0"},{text:ut.birthdayMonths[0],value:"1"},{text:ut.birthdayMonths[1],value:"2"},{text:ut.birthdayMonths[2],value:"3"},{text:ut.birthdayMonths[3],value:"4"},{text:ut.birthdayMonths[4],value:"5"},{text:ut.birthdayMonths[5],value:"6"},{text:ut.birthdayMonths[6],value:"7"},{text:ut.birthdayMonths[7],value:"8"},{text:ut.birthdayMonths[8],value:"9"},{text:ut.birthdayMonths[9],value:"10"},{text:ut.birthdayMonths[10],value:"11"},{text:ut.birthdayMonths[11],value:"12"}],ut.birthdayYearSelect=[{text:Ei.i18n("DATETIME/YEAR"),value:"0"}],ut.prototype.getSendMailParts=function(e){return Fi.Links.composeWithToField(this.getFullEmail(e))},ut.prototype.getSendMailLink=function(e){return Fi.Routing.buildHashFromArray(this.getSendMailParts(e))},ut.prototype.sendMail=function(){return Fi.Api.composeMessageToAddresses(this.email()),Pi},ut.prototype.sendMailToPersonal=function(){return Fi.Api.composeMessageToAddresses(this.personalEmail()),Pi},ut.prototype.sendMailToBusiness=function(){return Fi.Api.composeMessageToAddresses(this.businessEmail()),Pi},ut.prototype.sendMailToOther=function(){return Fi.Api.composeMessageToAddresses(this.otherEmail()),Pi},ut.prototype.clear=function(){this.isNew(!1),this.readOnly(!1),this.idContact(""),this.idUser(""),this.global(!1),this.itsMe(!1),this.edited(!1),this.extented(!1),this.personalCollapsed(!1),this.businessCollapsed(!1),this.otherCollapsed(!1),this.groupsCollapsed(!1),this.displayName(""),this.firstName(""),this.lastName(""),this.nickName(""),this.skype(""),this.facebook(""),this.primaryEmail(this.sEmailDefaultType),this.primaryPhone(this.sPhoneDefaultType),this.primaryAddress(this.sAddressDefaultType),this.personalEmail(""),this.personalStreetAddress(""),this.personalCity(""),this.personalState(""),this.personalZipCode(""),this.personalCountry(""),this.personalWeb(""),this.personalFax(""),this.personalPhone(""),this.personalMobile(""),this.businessEmail(""),this.businessCompany(""),this.businessDepartment(""),this.businessJob(""),this.businessOffice(""),this.businessStreetAddress(""),this.businessCity(""),this.businessState(""),this.businessZipCode(""),this.businessCountry(""),this.businessWeb(""),this.businessFax(""),this.businessPhone(""),this.otherEmail(""),this.otherBirthdayMonth("0"),this.otherBirthdayDay("0"),this.otherBirthdayYear("0"),this.otherNotes(""),this.etag(""),this.sharedToAll(!1),this.groups([])},ut.prototype.switchToNew=function(){this.clear(),this.edited(!0),this.extented(!1),this.isNew(!0),Pi||this.displayNameFocused(!0)},ut.prototype.switchToView=function(){this.edited(!1),this.extented(!1)},ut.prototype.toObject=function(){var e={ContactId:this.idContact(),PrimaryEmail:this.primaryEmail(),PrimaryPhone:this.primaryPhone(),PrimaryAddress:this.primaryAddress(),UseFriendlyName:"1",Title:"",FullName:this.displayName(),FirstName:this.firstName(),LastName:this.lastName(),NickName:this.nickName(),Global:this.global()?"1":"0",ItsMe:this.itsMe()?"1":"0",Skype:this.skype(),Facebook:this.facebook(),HomeEmail:this.personalEmail(),HomeStreet:this.personalStreetAddress(),HomeCity:this.personalCity(),HomeState:this.personalState(),HomeZip:this.personalZipCode(),HomeCountry:this.personalCountry(),HomeFax:this.personalFax(),HomePhone:this.personalPhone(),HomeMobile:this.personalMobile(),HomeWeb:this.personalWeb(),BusinessEmail:this.businessEmail(),BusinessCompany:this.businessCompany(),BusinessJobTitle:this.businessJob(),BusinessDepartment:this.businessDepartment(),BusinessOffice:this.businessOffice(),BusinessStreet:this.businessStreetAddress(),BusinessCity:this.businessCity(),BusinessState:this.businessState(),BusinessZip:this.businessZipCode(),BusinessCountry:this.businessCountry(),BusinessFax:this.businessFax(),BusinessPhone:this.businessPhone(),BusinessWeb:this.businessWeb(),OtherEmail:this.otherEmail(),Notes:this.otherNotes(),ETag:this.etag(),BirthdayDay:this.otherBirthdayDay(),BirthdayMonth:this.otherBirthdayMonth(),BirthdayYear:this.otherBirthdayYear(),SharedToAll:this.sharedToAll()?"1":"0",GroupsIds:this.groups()};return e},ut.prototype.parse=function(e){if(e&&"Object/CContact"===e["@Object"]){var t=0,i=0,s=0,o=[];switch(this.idContact(Ei.pExport(e,"IdContact","").toString()),this.idUser(Ei.pExport(e,"IdUser","").toString()),this.global(!!Ei.pExport(e,"Global",!1)),this.itsMe(!!Ei.pExport(e,"ItsMe",!1)),this.readOnly(!!Ei.pExport(e,"ReadOnly",!1)),this.displayName(Ei.pExport(e,"FullName","")),this.firstName(Ei.pExport(e,"FirstName","")),this.lastName(Ei.pExport(e,"LastName","")),this.nickName(Ei.pExport(e,"NickName","")),this.skype(Ei.pExport(e,"Skype","")),this.facebook(Ei.pExport(e,"Facebook","")),t=Ei.pInt(Ei.pExport(e,"PrimaryEmail",0))){case 1:t=Ci.ContactEmailType.Business;break;case 2:t=Ci.ContactEmailType.Other;break;default:case 0:t=Ci.ContactEmailType.Personal}switch(this.primaryEmail(t),i=Ei.pInt(Ei.pExport(e,"PrimaryPhone",0))){case 2:i=Ci.ContactPhoneType.Business;break;case 1:i=Ci.ContactPhoneType.Personal;break;default:case 0:i=Ci.ContactPhoneType.Mobile}switch(this.primaryPhone(i),s=Ei.pInt(Ei.pExport(e,"PrimaryAddress",0))){case 1:s=Ci.ContactAddressType.Business;break;default:case 0:s=Ci.ContactAddressType.Personal}this.primaryAddress(s),this.personalEmail(Ei.pExport(e,"HomeEmail","")),this.personalStreetAddress(Ei.pExport(e,"HomeStreet","")),this.personalCity(Ei.pExport(e,"HomeCity","")),this.personalState(Ei.pExport(e,"HomeState","")),this.personalZipCode(Ei.pExport(e,"HomeZip","")),this.personalCountry(Ei.pExport(e,"HomeCountry","")),this.personalWeb(Ei.pExport(e,"HomeWeb","")),this.personalFax(Ei.pExport(e,"HomeFax","")),this.personalPhone(Ei.pExport(e,"HomePhone","")),this.personalMobile(Ei.pExport(e,"HomeMobile","")),this.businessEmail(Ei.pExport(e,"BusinessEmail","")),this.businessCompany(Ei.pExport(e,"BusinessCompany","")),this.businessDepartment(Ei.pExport(e,"BusinessDepartment","")),this.businessJob(Ei.pExport(e,"BusinessJobTitle","")),this.businessOffice(Ei.pExport(e,"BusinessOffice","")),this.businessStreetAddress(Ei.pExport(e,"BusinessStreet","")),this.businessCity(Ei.pExport(e,"BusinessCity","")),this.businessState(Ei.pExport(e,"BusinessState","")),this.businessZipCode(Ei.pExport(e,"BusinessZip","")),this.businessCountry(Ei.pExport(e,"BusinessCountry","")),this.businessWeb(Ei.pExport(e,"BusinessWeb","")),this.businessFax(Ei.pExport(e,"BusinessFax","")),this.businessPhone(Ei.pExport(e,"BusinessPhone","")),this.otherEmail(Ei.pExport(e,"OtherEmail","")),this.otherBirthdayMonth(Ei.pExport(e,"BirthdayMonth","0").toString()),this.otherBirthdayDay(Ei.pExport(e,"BirthdayDay","0").toString()),this.otherBirthdayYear(Ei.pExport(e,"BirthdayYear","0").toString()),this.otherNotes(Ei.pExport(e,"Notes","")),this.etag(Ei.pExport(e,"ETag","")),this.sharedToAll(!!Ei.pExport(e,"SharedToAll",!1)),o=Ei.pExport(e,"GroupsIds",[]),_.isArray(o)&&this.groups(_.map(o,function(e){return Ei.pInt(e)}))}},ut.prototype.getFullEmail=function(e){var t=e;return""!==this.displayName()&&(t=""!==e?'"'+this.displayName()+'" <'+e+">":this.displayName()),t},ut.prototype.getEmailsString=function(){return _.uniq(_.without([this.email(),this.personalEmail(),this.businessEmail(),this.otherEmail()],"")).join(",")},ut.prototype.viewAllMails=function(){Fi.MailCache.searchMessagesInInbox("email:"+this.getEmailsString())},ut.prototype.sendThisContact=function(){Fi.Api.composeMessageWithVcard(this)},ut.prototype.isStrLink=function(e){return/^http/.test(e)},ut.prototype.onCallClick=function(e){Fi.Phone.call(e)},ut.prototype.viewAllMailsWithContact=function(){var e=this.getEmailsString();Mi.SingleMode&&t.opener&&t.opener.App?(t.opener.App.MailCache.searchMessagesInCurrentFolder("email:"+e),t.opener.focus(),t.close()):Fi.MailCache.searchMessagesInCurrentFolder("email:"+e)},dt.prototype.clear=function(){this.isNew(!1),this.idGroup(""),this.idUser(""),this.name(""),this.nameFocused(!1),this.edited(!1),this.isOrganization(!1),this.email(""),this.country(""),this.city(""),this.company(""),this.fax(""),this.phone(""),this.state(""),this.street(""),this.web(""),this.zip(""),this.events([])},dt.prototype.populate=function(e){this.isNew(e.isNew()),this.idGroup(e.idGroup()),this.idUser(e.idUser()),this.name(e.name()),this.nameFocused(e.nameFocused()),this.edited(e.edited()),this.isOrganization(e.isOrganization()),this.email(e.email()),this.country(e.country()),this.city(e.city()),this.company(e.company()),this.fax(e.fax()),this.phone(e.phone()),this.state(e.state()),this.street(e.street()),this.web(e.web()),this.zip(e.zip())},dt.prototype.switchToNew=function(){this.clear(),this.edited(!0),this.isNew(!0),Pi||this.nameFocused(!0)},dt.prototype.switchToView=function(){this.edited(!1)},dt.prototype.toObject=function(){return{GroupId:this.idGroup(),Name:this.name(),IsOrganization:this.isOrganization()?"1":"0",Email:this.email(),Country:this.country(),City:this.city(),Company:this.company(),Fax:this.fax(),Phone:this.phone(),State:this.state(),Street:this.street(),Web:this.web(),Zip:this.zip()}},pt.prototype.parse=function(e){e&&"Object/CContactListItem"===Ei.pExport(e,"@Object","")&&(this.sId=Ei.pString(e.Id),this.sName=Ei.pString(e.Name),this.sEmail=Ei.pString(e.Email),this.bIsGroup=!!e.IsGroup,this.bIsOrganization=!!e.IsOrganization,this.bReadOnly=!!e.ReadOnly,this.bItsMe=!!e.ItsMe,this.bGlobal=!!e.Global,this.bSharedToAll=!!e.SharedToAll)},pt.prototype.IsGroup=function(){return this.bIsGroup},pt.prototype.Global=function(){return this.bGlobal},pt.prototype.ReadOnly=function(){return this.bReadOnly},pt.prototype.ItsMe=function(){return this.bItsMe},pt.prototype.Id=function(){return this.sId},pt.prototype.Name=function(){return this.sName},pt.prototype.Email=function(){return this.sEmail},pt.prototype.EmailAndName=function(){return this.sName&&this.sEmail&&0<this.sName.length&&0<this.sEmail.length?'"'+this.sName+'" <'+this.sEmail+">":this.sEmail},pt.prototype.IsSharedToAll=function(){return this.bSharedToAll},pt.prototype.IsOrganization=function(){return this.bIsOrganization},mt.prototype.parseCssColor=function(e){var t=Ei.pString(e);return t.length>7?t=t.substr(0,7):t.length>4&&t.length<7&&(t=t.substr(0,4)),4===t.length&&(t=t[0]+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]),t.match(/^#[A-Fa-f0-9]{6}$/i)||(t="#f09650"),t},mt.prototype.parse=function(e){this.id=Ei.pString(e.Id),this.cTag=e.CTag,this.name(Ei.pString(e.Name)),this.description(Ei.pString(e.Description)),this.owner(Ei.pString(e.Owner)),this.active(Fi.Storage.hasData(this.id)?Fi.Storage.getData(this.id):!0),this.isDefault=!!e.IsDefault,this.access(e.Access),this.isShared(!!e.Shared),this.isSharedToAll(!!e.SharedToAll),this.sharedToAllAccess=e.SharedToAllAccess,this.isPublic(!!e.IsPublic),this.color(this.parseCssColor(e.Color)),this.url(Ei.pString(e.Url)),this.davUrl(Ei.pString(e.ServerUrl)),this.exportUrl(Ei.getAppPath()+"?/Raw/Calendars/0/"+Ei.pString(e.ExportHash)),this.pubUrl(Ei.getAppPath()+"?calendar-pub="+Ei.pString(e.PubHash)),this.shares(e.Shares||[]),_.each(e.Events,function(e){this.addEvent(e)},this)},mt.prototype.eventExists=function(e){return _.find(this.events(),function(t){return e===t.id})},mt.prototype.updateEvent=function(e){var t=!1;return e&&(this.removeEvent(e.id),this.addEvent(e)),t},mt.prototype.addEvent=function(e){e&&!this.eventExists(e.id)&&this.events.push(this.parseEvent(e))},mt.prototype.getEvent=function(e){return _.find(this.events(),function(t){return t.id===e},this)},mt.prototype.getEvents=function(e,t){var i=_.filter(this.events(),function(i){return moment.utc(i.start).unix()>=e.unix()&&moment.utc(i.end).unix()<=t.unix()||moment.utc(i.start).unix()<=e.unix()&&moment.utc(i.end).unix()>=t.unix()},this);return Ei.isUnd(i)&&(i=[]),i},mt.prototype.removeEvent=function(e){this.events(_.filter(this.events(),function(t){return t.id!==e},this))},mt.prototype.removeEventByUid=function(e,t){Ei.isUnd(t)&&(t=!1),this.events(_.filter(this.events(),function(i){return!(i.uid===e||t&&i.excluded)},this))},mt.prototype.removeEvents=function(){this.events([])},mt.prototype.expungeEvents=function(e,t,i){var s=[];_.each(this.getEvents(moment.unix(t),moment.unix(i)),function(t){_.include(e,t.id)||s.push(t.id)},this),this.events(_.filter(this.events(),function(e){return!_.include(s,e.id)},this))},mt.prototype.isEditable=function(){return this.access()!==Ci.CalendarAccess.Read},mt.prototype.isOwner=function(){return this.account&&this.account.email()===this.owner()},mt.prototype.parseEvent=function(e){if(e.title=Ei.getTitleForEvent(e.subject),e.editable=e.appointment?!1:!0,e.backgroundColor=e.borderColor=this.color(),!_.isArray(e.className)){var t=e.className;e.className=[t]}return this.access()===Ci.CalendarAccess.Read?(e.className.push("fc-event-readonly"),e.editable=!1):e.className=_.filter(e.className,function(e){return"fc-event-readonly"!==e}),e.rrule&&!e.excluded?e.className.push("fc-event-repeat"):e.className=_.filter(e.className,function(e){return"fc-event-repeat"!==e}),Ei.isNonEmptyArray(e.attendees)?e.className.push("fc-event-appointment"):e.className=_.filter(e.className,function(e){return"fc-event-appointment"!==e}),e},mt.prototype.reloadEvents=function(){this.events(_.map(this.events(),function(e){return this.parseEvent(e)},this))},mt.prototype.canShare=function(){return!this.isShared()||this.isShared()&&this.access()===Ci.CalendarAccess.Write||this.isOwner()},gt.prototype.pickCurrentCalendar=function(e){var t=_.find(this.collection(),function(e){return e.active()&&e.access()===Ci.CalendarAccess.Write},this);this.currentCal()&&this.currentCal().active()||(e&&e.active()?this.currentCal(e):!this.defaultCal()||!this.defaultCal().active()&&t?t&&this.currentCal(t):this.currentCal(this.defaultCal()))},gt.prototype.hideOtherCalendars=function(e){_.each(this.collection(),function(t){t.active(t.id===e)},this)},gt.prototype.getCalendarById=function(e){var t=_.find(this.collection(),function(t){return t.id===e},this);return t},gt.prototype.getEvents=function(e,t){var i=[],s=[];return _.each(this.collection(),function(o){o&&o.active()&&(s=Ei.isUnd(e)||Ei.isUnd(t)?o.events():o.getEvents(e,t),i=_.union(i,s))},this),i},gt.prototype.parseCalendar=function(e){var t=new mt;return t.parse(e),t},gt.prototype.parseAndAddCalendar=function(e){var t=0,i=null,s=this.parseCalendar(e);return s.active.subscribe(function(e){this.parentOnCalendarActiveChange(s);var t=s.active()?s:this.defaultCal();this.pickCurrentCalendar(t),Fi.Storage.setData(s.id,e)},this),s.isDefault&&this.defaultCal(s),t=this.calendarExists(s.id),t||0===t?(i=this.getCalendarById(s.id),s.events(i.events()),this.collection.splice(t,1,s)):this.collection.push(s),this.sort(),s},gt.prototype.calendarExists=function(e){var t=_.indexOf(_.map(this.collection(),function(e){return e.id}),e);return 0>t?!1:t},gt.prototype.removeCalendar=function(e){this.collection(_.filter(this.collection(),function(t){return t.id!==e},this))},gt.prototype.clearCollection=function(){this.collection.removeAll()},gt.prototype.getColors=function(){return _.map(this.collection(),function(e){return e.color().toLowerCase()},this)},gt.prototype.setDefault=function(e){_.each(this.collection(),function(t){t.id!==e?(t.isDefault=!0,this.defaultCal(t)):t.isDefault=!1},this)},gt.prototype.sort=function(){var e=_.sortBy(this.collection(),function(e){return e.name()});this.collection(_.sortBy(e,function(e){return e.isShared()}))},gt.prototype.expunge=function(e){this.collection(_.filter(this.collection(),function(t){return _.include(e,t.id)},this))},Ei.extend(ft,st),ft.prototype.getInstance=function(){return new ft},ft.prototype.parse=function(e,t){var i=new tt;this.isFolder(!!e.IsFolder),this.isLink(!!e.IsLink),this.fileName(Ei.pString(e.Name)),this.id(Ei.pString(e.Id)),this.path(Ei.pString(e.Path)),this.fullPath(Ei.pString(e.FullPath)),this.storageType(Ei.pString(e.Type)),this.shared(!!e.Shared),this.isExternal(!!e.IsExternal),this.iframedView(!!e.Iframed),this.isLink()&&(this.linkUrl(Ei.pString(e.LinkUrl)),this.linkType(Ei.pInt(e.LinkType))),this.isFolder()||(this.size(Ei.pInt(e.Size)),i.parse(e.LastModified),this.lastModified(i.getShortDate()),this.owner(Ei.pString(e.Owner)),this.thumb(!!e.Thumb),this.thumbnailExternalLink(Ei.pString(e.ThumbnailLink)),this.hash(Ei.pString(e.Hash)),this.publicHash(t)),this.thumb()&&""===this.thumbnailExternalLink()&&Ei.thumbQueue(this.thumbnailSessionUid(),this.thumbnailLink(),this.thumbnailSrc),this.content(Ei.pString(e.Content))},ft.prototype.onUploadSelectOwn=function(e,t,i,s,o,n){var r=new tt,a=new Date;this.onUploadSelect(e,t),r.parse(a.getTime()/1e3),this.fileName(i),this.lastModified(r.getShortDate()),this.owner(s),this.path(o),this.storageType(n)},bt.prototype.parse=function(e){if(this.Id=e.IdHelpdeskPost,this.IdThread=e.IdHelpdeskThread,this.IdOwner=e.IdOwner,this.bThreadOwner=e.IsThreadOwner,this.sFrom=Ei.isNonEmptyArray(e.Owner)?e.Owner[1]||e.Owner[0]||"":"",this.sDate=tt.prototype.convertDate(e.Created),this.iDate=e.Created,this.iType=e.Type,this.bSysType=e.SystemType,this.sText=Ei.pString(e.Text),this.itsMe(e.ItsMe),e.Attachments){var t=0,i=0,s=null,o=[],n=Date.now().toString();for(i=e.Attachments.length;i>t;t++)e.Attachments[t]&&"Object/CHelpdeskAttachment"===Ei.pExport(e.Attachments[t],"@Object","")&&(s=new St,s.parse(e.Attachments[t]),s.getInThumbQueue(n),o.push(s));this.attachments(o)}},yt.prototype.parse=function(e){this.Id=e.IdHelpdeskThread,this.ThreadHash=Ei.pString(e.ThreadHash),this.IdOwner=e.IdOwner,this.ItsMe=!!e.ItsMe,this.sSubject=Ei.pString(e.Subject),this.time(Ei.pInt(e.Updated)),this.aOwner=Ei.isNonEmptyArray(e.Owner)?e.Owner:["",""],this.sEmail=this.aOwner[0]||"",this.sName=this.aOwner[1]||"",this.sFrom=this.sName||this.sEmail,this.sFromFull=Ei.trim(""===this.sName?this.sEmail:this.sName+(""!==this.sEmail?" ("+this.sEmail+")":"")),this.postsCount(e.PostCount),this.state(e.Type),this.unseen(!e.IsRead)},yt.prototype.Name=function(){return this.sName},yt.prototype.Email=function(){return this.sEmail},yt.prototype.updateMomentDate=function(){this.time.valueHasMutated()},Ei.extend(St,st),St.prototype.dataObjectName="Object/CHelpdeskAttachment",St.prototype.getInstance=function(){return new St},St.prototype.fillDataAfterUploadComplete=function(e){this.tempName(e.Result.HelpdeskFile.TempName),this.type(e.Result.HelpdeskFile.MimeType),this.hash(e.Result.HelpdeskFile.Hash)
},vt.prototype.parse=function(e,t){this.iAccountId=e,this.options(parseInt(t.Options,10)),this.signature(t.Signature)},At.prototype.parse=function(e,t){this.iAccountId=e,this.enable=!!t.Enable,this.subject=Ei.pString(t.Subject),this.message=Ei.pString(t.Message)},Et.prototype.parse=function(e,t){this.accountId=e;var i=[],s=0,o=0,n=null,r=null;if(_.isArray(t))for(o=t.length;o>s;s++)r=t[s],n=new Ct,n.id(r.IdFetcher),n.accountId(r.IdAccount),n.isEnabled(r.IsEnabled),n.isLocked(r.IsLocked),n.email(r.Email),n.userName(r.Name),n.folder(r.Folder),n.signatureOptions(!!r.SignatureOptions),n.signature(r.Signature),n.incomingMailServer(r.IncomingMailServer),n.incomingMailPort(r.IncomingMailPort),n.incomingMailLogin(r.IncomingMailLogin),n.leaveMessagesOnServer(r.LeaveMessagesOnServer),n.isOutgoingEnabled(r.IsOutgoingEnabled),n.outgoingMailServer(r.OutgoingMailServer),n.outgoingMailPort(r.OutgoingMailPort),n.outgoingMailAuth(r.OutgoingMailAuth),i.push(n);this.collection(i)},Et.prototype.getFetcher=function(e){var t=null,i=0,s=0,o=this.collection();for(s=o.length;s>i;i++)o[i].id()===e&&(t=o[i]);return t},Tt.prototype.parse=function(e,t){this.iAccountId=e,this.enable=!!t.Enable,this.email=Ei.pString(t.Email)},Ft.prototype.parse=function(e,t){var i=0,s=t.length,o=null;if(this.iAccountId=e,_.isArray(t))for(s=t.length;s>i;i++)o=new It(e),o.parse(t[i]),this.collection.push(o)},It.prototype.parse=function(e){this.enable(!!e.Enable),this.field(Ei.pInt(e.Field)),this.condition(Ei.pInt(e.Condition)),this.filter(Ei.pString(e.Filter)),this.action(Ei.pInt(e.Action)),this.folder(Ei.pString(e.FolderFullName)),this.commit()},It.prototype.revert=function(){this.enable.revert(),this.field.revert(),this.condition.revert(),this.filter.revert(),this.action.revert(),this.folder.revert()},It.prototype.commit=function(){this.enable.commit(),this.field.commit(),this.condition.commit(),this.filter.commit(),this.action.commit(),this.folder.commit()},It.prototype.toString=function(){var e=[this.enable(),this.field(),this.condition(),this.filter(),this.action(),this.folder()];return e.join(":")},Mt.prototype.showLoading=function(e){this.loadingMessage(e&&""!==e?e:Ei.i18n("MAIN/LOADING")),this.loadingVisible(!0),_.defer(_.bind(function(){this.loadingHidden(!1)},this))},Mt.prototype.hideLoading=function(){this.loadingHidden(!0),setTimeout(_.bind(function(){this.loadingHidden()&&this.loadingVisible(!1)},this),this.iAnimationDuration)},Mt.prototype.showReport=function(e,t){0!==t&&(t=t||this.iReportDuration),e&&""!==e?(this.reportMessage(e),this.reportVisible(!0),_.defer(_.bind(this.reportHidden,this,!1)),clearTimeout(this.iReportTimeout),0===t?this.reportVisibleClose(!0):(this.reportVisibleClose(!1),this.iReportTimeout=setTimeout(_.bind(this.selfHideReport,this),t))):(this.reportHidden(!0),this.reportVisible(!1))},Mt.prototype.selfHideReport=function(){this.reportHidden(!0),setTimeout(_.bind(function(){this.reportHidden()&&this.reportVisible(!1)},this),this.iAnimationDuration)},Mt.prototype.showError=function(e,t,i,s){e&&""!==e?(this.gray(!!s),this.errorMessage(e),this.isHtmlError(t),this.errorVisible(!0),_.defer(_.bind(function(){this.errorHidden(!1)},this)),clearTimeout(this.iErrorTimeout),i||(this.iErrorTimeout=setTimeout(_.bind(function(){this.selfHideError()},this),this.iErrorDuration))):this.selfHideError()},Mt.prototype.selfHideError=function(){this.errorHidden(!0),setTimeout(_.bind(function(){this.errorHidden()&&this.errorVisible(!1)},this),this.iAnimationDuration)},Mt.prototype.hideError=function(e){e=Ei.isUnd(e)?!1:!!e,e===this.gray()&&this.selfHideError()},wt.prototype.onRoute=function(){this.changeCurrentAccount()},wt.prototype.changeCurrentAccount=function(){this.email(Mi.Accounts.getEmail())},wt.prototype.logout=function(){Fi.logout()},wt.prototype.switchToFullVersion=function(){Fi.Ajax.send({Action:"SystemSetMobile",Mobile:0},function(){t.location.reload()},this)},_.extend(Pt.prototype,wt.prototype),Rt.prototype.hotKeysBind=function(){e(document).on("keydown",e.proxy(function(e){if(this.shown&&!Ei.isTextFieldFocused()){var t=e.keyCode;e.ctrlKey&&t===Ci.Key.Left?this.clickPreviousPage():e.ctrlKey&&t===Ci.Key.Right&&this.clickNextPage()}},this))},Rt.prototype.hide=function(){this.shown=!1},Rt.prototype.show=function(){this.shown=!0},Rt.prototype.clear=function(){this.currentPage(1),this.count(0)},Rt.prototype.setCount=function(e){this.count(e),this.currentPage()>this.pagesCount()&&this.currentPage(this.pagesCount())},Rt.prototype.setPage=function(e,t){this.perPage(t),this.currentPage(e>this.pagesCount()?this.pagesCount():e)},Rt.prototype.clickPage=function(e){var t=e.number;1>t&&(t=1),t>this.pagesCount()&&(t=this.pagesCount()),this.currentPage(t)},Rt.prototype.clickFirstPage=function(){this.currentPage(1)},Rt.prototype.clickPreviousPage=function(){var e=this.currentPage()-1;1>e&&(e=1),this.currentPage(e)},Rt.prototype.clickNextPage=function(){var e=this.currentPage()+1;e>this.pagesCount()&&(e=this.pagesCount()),this.currentPage(e)},Rt.prototype.clickLastPage=function(){this.currentPage(this.pagesCount())},Dt.prototype.hasOpenedPopup=function(){return this.visibleInsertLinkPopup()||this.visibleLinkPopup()||this.visibleImagePopup()||this.visibleInsertImagePopup()||this.visibleFontColorPopup()},Dt.prototype.init=function(){e(document.body).on("click",_.bind(function(){this.closeAllPopups(!0)},this)),this.initEditorUploader()},Dt.prototype.correctFontFromSettings=function(){var e=this.sDefaultFont,t=!1;_.each(this.aFonts,function(i){i.toLowerCase()===e.toLowerCase()&&(e=i,t=!0)}),t?this.sDefaultFont=e:this.aFonts.push(e)},Dt.prototype.showLinkPopup=function(t){var i=e(this.workareaDom()),s=i.position(),o=t.position(),n=t.height();this.linkHref(t.attr("href")||t.text()),this.linkPopupLeft(Math.round(o.left+s.left)),this.linkPopupTop(Math.round(o.top+n+s.top)),this.visibleLinkPopup(!0)},Dt.prototype.hideLinkPopup=function(){this.visibleLinkPopup(!1)},Dt.prototype.showChangeLink=function(){this.visibleLinkHref(!0),this.hideLinkPopup()},Dt.prototype.changeLink=function(){this.oCrea.changeLink(this.linkHref()),this.hideChangeLink()},Dt.prototype.hideChangeLink=function(){this.visibleLinkHref(!1)},Dt.prototype.showImagePopup=function(t,i){var s=e(this.workareaDom()),o=s.position(),n=s.offset();this.imagePopupLeft(Math.round(i.pageX+o.left-n.left)),this.imagePopupTop(Math.round(i.pageY+o.top-n.top)),this.visibleImagePopup(!0)},Dt.prototype.hideImagePopup=function(){this.visibleImagePopup(!1)},Dt.prototype.resizeImage=function(e){var t={width:"auto",height:"auto"};switch(e){case Ci.HtmlEditorImageSizes.Small:t.width="300px";break;case Ci.HtmlEditorImageSizes.Medium:t.width="600px";break;case Ci.HtmlEditorImageSizes.Large:t.width="1200px";break;case Ci.HtmlEditorImageSizes.Original:t.width="auto"}this.oCrea.changeCurrentImage(t),this.visibleImagePopup(!1)},Dt.prototype.onImageOver=function(t){if("IMG"===t.target.nodeName&&!this.visibleImagePopup()){this.imageSelected(!0),this.tooltipText(Ei.i18n("HTMLEDITOR/CLICK_TO_EDIT_IMAGE"));var i=this,s=e(this.workareaDom());s.bind("mousemove.image",function(e){var t=s.position(),o=s.offset();i.tooltipPopupTop(Math.round(e.pageY+t.top-o.top)),i.tooltipPopupLeft(Math.round(e.pageX+t.left-o.left))})}return!0},Dt.prototype.onImageOut=function(){if(this.imageSelected()){this.imageSelected(!1);var t=e(this.workareaDom());t.unbind("mousemove.image")}return!0},Dt.prototype.commit=function(){this.textChanged(!1)},Dt.prototype.initCrea=function(e,t,i){this.oCrea||(this.init(),this.oCrea=new Crea({creaId:this.creaId,fontNameArray:this.aFonts,defaultFontName:this.sDefaultFont,defaultFontSize:this.iDefaultSize,isRtl:Ei.isRTL(),enableDrop:!1,onChange:_.bind(this.textChanged,this,!0),onCursorMove:_.bind(this.setFontValuesFromText,this),onFocus:_.bind(this.onCreaFocus,this),onBlur:_.bind(this.onCreaBlur,this),onUrlIn:_.bind(this.showLinkPopup,this),onUrlOut:_.bind(this.hideLinkPopup,this),onImageSelect:_.bind(this.showImagePopup,this),onImageBlur:_.bind(this.hideImagePopup,this),onItemOver:Ni||Pi?null:_.bind(this.onImageOver,this),onItemOut:Ni||Pi?null:_.bind(this.onImageOut,this),openInsertLinkDialog:_.bind(this.insertLink,this)}),this.oCrea.start(this.isEnable())),this.oCrea.setTabIndex(i),this.oCrea.clearUndoRedo(),this.setText(e,t),this.setFontValuesFromText(),this.uploadedImagePathes([]),this.selectedFont(this.sDefaultFont),this.selectedSize(this.iDefaultSize)},Dt.prototype.setFocus=function(){this.oCrea&&this.oCrea.setFocus(!1)},Dt.prototype.changeSignatureContent=function(e,t){this.oCrea&&this.oCrea.changeSignatureContent(e,t)},Dt.prototype.setFontValuesFromText=function(){this.lockFontSubscribing(!0),this.selectedFont(this.oCrea.getFontName()),this.selectedSize(this.oCrea.getFontSizeInNumber()),this.lockFontSubscribing(!1)},Dt.prototype.isUndoAvailable=function(){return this.oCrea?this.oCrea.isUndoAvailable():!1},Dt.prototype.getPlainText=function(){return this.oCrea?this.oCrea.getPlainText():""},Dt.prototype.getText=function(e){return this.oCrea?this.oCrea.getText(e):""},Dt.prototype.setText=function(e,t){this.oCrea&&(t?this.oCrea.setPlainText(e):this.oCrea.setText(e),this.inactive.valueHasMutated())},Dt.prototype.undoAndClearRedo=function(){this.oCrea&&(this.oCrea.undo(),this.oCrea.clearRedo())},Dt.prototype.clearUndoRedo=function(){this.oCrea&&this.oCrea.clearUndoRedo()},Dt.prototype.isEditing=function(){return this.oCrea?this.oCrea.bEditing:!1},Dt.prototype.getNotDefaultText=function(){var e=this.getText();return this.removeAllTags(e)!==Ei.i18n("HTMLEDITOR/SIGNATURE_PLACEHOLDER")?e:""},Dt.prototype.removeAllTags=function(e){return e.replace(/<style>.*<\/style>/g,"").replace(/<[^>]*>/g,"")},Dt.prototype.setActivitySource=function(e){this.activitySource=e,null!==this.activitySourceSubscription&&this.activitySourceSubscription.dispose(),this.activitySourceSubscription=this.activitySource.subscribe(function(){this.inactive(0===Ei.pInt(this.activitySource()))},this),this.inactive(0===Ei.pInt(this.activitySource()))},Dt.prototype.onCreaFocus=function(){this.oCrea&&(this.closeAllPopups(),this.activitySource(1),this.textFocused(!0))},Dt.prototype.onCreaBlur=function(){this.oCrea&&this.textFocused(!1)},Dt.prototype.onEscHandler=function(){0===Fi.Screens.popups.length&&this.closeAllPopups()},Dt.prototype.closeAllPopups=function(e){e=!!e,e||this.visibleLinkPopup(!1),this.visibleInsertLinkPopup(!1),this.visibleImagePopup(!1),this.visibleInsertImagePopup(!1),this.visibleFontColorPopup(!1)},Dt.prototype.insertHtml=function(e){this.oCrea&&(this.oCrea.isFocused()||this.oCrea.setFocus(!0),this.oCrea.insertHtml(e,!1))},Dt.prototype.insertLink=function(e,t){t&&this.setActive(t),this.visibleInsertLinkPopup()||(this.linkForInsert(this.oCrea.getSelectedText()),this.closeAllPopups(),this.visibleInsertLinkPopup(!0),this.linkFocused(!0))},Dt.prototype.insertLinkFromPopup=function(e,t){this.linkForInsert().length>0&&(Ei.isCorrectEmail(this.linkForInsert())?this.oCrea.insertEmailLink(this.linkForInsert()):this.oCrea.insertLink(this.linkForInsert())),this.closeInsertLinkPopup(e,t)},Dt.prototype.closeInsertLinkPopup=function(e,t){this.visibleInsertLinkPopup(!1),t&&t.stopPropagation()},Dt.prototype.textColor=function(e,t){this.setActive(t),this.visibleFontColorPopup()?this.closeAllPopups():(this.closeAllPopups(),this.visibleFontColorPopup(!0),this.oFontColorPicker.onShow(),this.oBackColorPicker.onShow())},Dt.prototype.colorToHex=function(e){if("#"===e.substr(0,1))return e;for(var t=/(.*?)rgb\((\d+), (\d+), (\d+)\)/.exec(e),i=parseInt(t[2],10),s=parseInt(t[3],10),o=parseInt(t[4],10),n=o|s<<8|i<<16,r=n.toString(16);r.length<6;)r="0"+r;return t[1]+"#"+r},Dt.prototype.setTextColorFromPopup=function(e){this.oCrea.textColor(this.colorToHex(e)),this.closeAllPopups()},Dt.prototype.setBackColorFromPopup=function(e){this.oCrea.backgroundColor(this.colorToHex(e)),this.closeAllPopups()},Dt.prototype.insertImage=function(e,t){return this.setActive(t),this.allowInsertImage()&&!this.visibleInsertImagePopup()&&(this.imagePathFromWeb(""),this.closeAllPopups(),this.visibleInsertImagePopup(!0),this.initUploader()),!0},Dt.prototype.insertWebImageFromPopup=function(e,t){this.allowInsertImage()&&this.imagePathFromWeb().length>0&&this.oCrea.insertImage(this.imagePathFromWeb()),this.closeInsertImagePopup(e,t)},Dt.prototype.insertComputerImageFromPopup=function(t,i){var s=Ei.getViewLinkByHash(Mi.Accounts.currentId(),i.Hash),o=!1;this.allowInsertImage()&&s.length>0&&(o=this.oCrea.insertImage(s),o&&(e(this.oCrea.$editableArea).find('img[src="'+s+'"]').attr("data-x-src-cid",t),i.CID=t,this.uploadedImagePathes.push(i))),this.closeInsertImagePopup()},Dt.prototype.closeInsertImagePopup=function(e,t){this.visibleInsertImagePopup(!1),t&&t.stopPropagation()},Dt.prototype.initUploader=function(){this.imageUploaderButton()&&!this.oJua&&(this.oJua=new Jua({action:"?/Upload/Attachment/",name:"jua-uploader",queueSize:2,clickElement:this.imageUploaderButton(),hiddenElementsPosition:Ei.isRTL()?"right":"left",disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!0,hidden:{Token:function(){return Mi.Token},AccountID:function(){return Mi.Accounts.currentId()}}}),this.bInsertImageAsBase64?this.oJua.on("onSelect",_.bind(this.onEditorDrop,this)):this.oJua.on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)))},Dt.prototype.initEditorUploader=function(){if(Mi.App.AllowInsertImage&&this.uploaderAreaDom()&&!this.editorUploader){var e=null,t=null;this.oParent&&this.oParent.composeUploaderDragOver&&this.oParent.onFileUploadProgress&&this.oParent.onFileUploadStart&&this.oParent.onFileUploadComplete?(e=_.bind(function(){this.editorUploaderBodyDragOver(!0),this.oParent.composeUploaderDragOver(!0)},this),t=_.bind(function(){this.editorUploaderBodyDragOver(!1),this.oParent.composeUploaderDragOver(!1)},this),this.editorUploader=new Jua({action:"?/Upload/Attachment/",name:"jua-uploader",queueSize:1,dragAndDropElement:this.bAllowImageDragAndDrop?this.uploaderAreaDom():null,disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!this.bAllowImageDragAndDrop,hidden:{Token:function(){return Mi.Token},AccountID:function(){return Mi.Accounts.currentId()}}}),this.editorUploader.on("onDragEnter",_.bind(this.oParent.composeUploaderDragOver,this.oParent,!0)).on("onDragLeave",_.bind(this.oParent.composeUploaderDragOver,this.oParent,!1)).on("onBodyDragEnter",e).on("onBodyDragLeave",t).on("onProgress",_.bind(this.oParent.onFileUploadProgress,this.oParent)).on("onSelect",_.bind(this.onEditorDrop,this)).on("onStart",_.bind(this.oParent.onFileUploadStart,this.oParent)).on("onComplete",_.bind(this.oParent.onFileUploadComplete,this.oParent))):(e=_.bind(this.editorUploaderBodyDragOver,this,!0),t=_.bind(this.editorUploaderBodyDragOver,this,!1),this.editorUploader=new Jua({queueSize:1,dragAndDropElement:this.bAllowImageDragAndDrop?this.uploaderAreaDom():null,disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!this.bAllowImageDragAndDrop}),this.editorUploader.on("onBodyDragEnter",e).on("onBodyDragLeave",t).on("onSelect",_.bind(this.onEditorDrop,this)))}},Dt.prototype.onEditorDrop=function(e,i){var s=null,o=null,n=this,r=!1,a=Math.random().toString(),l="";if(i&&i.File&&i.File.type)if(Mi.App.AllowInsertImage&&0===i.File.type.indexOf("image/"))o=i.File,Mi.App.ImageUploadSizeLimit>0&&o.size>Mi.App.ImageUploadSizeLimit?Fi.Screens.showPopup(C,[Ei.i18n("COMPOSE/UPLOAD_ERROR_SIZE")]):(s=new t.FileReader,r=this.oCrea.isFocused(),r||this.oCrea.setFocus(!0),l=o.name+"_"+a,this.oCrea.insertHtml('<img id="'+l+'" src="skins/Default/images/wait.gif" />',!0),r||this.oCrea.fixFirefoxCursorBug(),s.onload=function(e){n.oCrea.changeImageSource(l,e.target.result)},s.readAsDataURL(o));else{if(this.oParent&&this.oParent.onFileUploadSelect)return this.oParent.onFileUploadSelect(e,i),!0;Fi.browser.ie10AndAbove||Fi.Screens.showPopup(C,[Ei.i18n("HTMLEDITOR/UPLOAD_ERROR_NOT_IMAGE")])}return!1},Dt.prototype.isFileImage=function(t){if("string"==typeof t.Type)return-1!==t.Type.indexOf("image");var i=t.FileName.lastIndexOf("."),s=t.FileName.substr(i+1),o=["jpg","jpeg","gif","tif","tiff","png"];return-1!==e.inArray(s,o)},Dt.prototype.onFileUploadSelect=function(e,t){return this.isFileImage(t)?(this.closeInsertImagePopup(),!0):(Fi.Screens.showPopup(C,[Ei.i18n("HTMLEDITOR/UPLOAD_ERROR_NOT_IMAGE")]),!1)},Dt.prototype.onFileUploadComplete=function(e,t,i){var s="";i&&i.Result?i.Result.Error?(s=Ei.i18n("size"===i.Result.Error?"COMPOSE/UPLOAD_ERROR_SIZE":"COMPOSE/UPLOAD_ERROR_UNKNOWN"),Fi.Screens.showPopup(C,[s])):(this.oCrea.setFocus(!0),this.insertComputerImageFromPopup(e,i.Result.Attachment)):Fi.Screens.showPopup(C,[Ei.i18n("COMPOSE/UPLOAD_ERROR_UNKNOWN")])},Dt.prototype.setActive=function(e){e.stopPropagation(),this.activitySource(1)},_t.prototype.onShow=function(){e(this.colorPickerDom()).find("span.color-item").on("click",_.bind(function(t){t.stopPropagation(),this.setColorFromPopup(e(t.target).data("color"))},this))},_t.prototype.setColorFromPopup=function(e){this.pickHandler.call(this.pickContext,e)},Nt.prototype.answer=function(){this.action(Ci.PhoneAction.IncomingConnect)},Nt.prototype.multiAction=function(){var e=this.action();e===Ci.PhoneAction.OfflineActive?this.action(Ci.PhoneAction.Offline):e===Ci.PhoneAction.Online?(this.action(Ci.PhoneAction.OnlineActive),this.getLogs(),_.delay(_.bind(function(){this.inputFocus(!0)},this),500)):e===Ci.PhoneAction.OnlineActive&&this.validateNumber()?(this.phone&&(this.phone.phoneToCall(this.input()),this.action(Ci.PhoneAction.Outgoing)),this.inputFocus(!1)):e!==Ci.PhoneAction.OnlineActive||this.validateNumber()?(e===Ci.PhoneAction.Outgoing||e===Ci.PhoneAction.Incoming||e===Ci.PhoneAction.OutgoingConnect||e===Ci.PhoneAction.IncomingConnect)&&(this.action(Ci.PhoneAction.Online),this.dropdownShow(!1)):(this.action(Ci.PhoneAction.Online),this.dropdownShow(!1))},Nt.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e,PhoneOnly:"1"};this.phoneAutocompleteItem(null),e=Ei.trim(e),""!==e&&Fi.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result.List&&(_.each(e.Result.List,function(e){_.each(e.Phones,function(t){i.push({label:""!==e.Name?e.Name+" <"+e.Email+"> "+t:e.Email+" "+t,value:t,frequency:e.Frequency})},this)},this),i=_.sortBy(_.compact(i),function(e){return-e.frequency})),t(i)},this)},Nt.prototype.validateNumber=function(){return/^[^a-zA-Z\u00BF-\u1FFF\u2C00-\uD7FF]+$/g.test(this.input())},Nt.prototype.onLogItem=function(e){this.input(e.phoneToCall),this.dropdownShow(!1)},Nt.prototype.getLogs=function(){this.spinner(!0),this.logs([]),this.logsToShow([]),this.phone.getLogs(this.onLogsResponse,this)},Nt.prototype.onLogsResponse=function(e){e&&e.Result&&(this.logs([]),_.each(e.Result,function(e){e.phoneToCall=this.phone.getCleanedPhone("incoming"===e.UserDirection?e.From:e.To),e.phoneToShow=e.UserDisplayName?e.UserDisplayName:e.phoneToCall,e.phoneToShow&&this.logs.push(e)},this),this.logs(_.sortBy(this.logs(),function(e){return-Date.parse(e.StartTime)}).slice(0,100)),this.seeMore()),this.spinner(!1)},Nt.prototype.seeMore=function(){this.logsToShow(this.logs().slice(0,this.logsToShow().length+10))},Nt.prototype.timer=function(){var e=0,t=0,i=0,s=function(e){var t=e.toString();return 1===t.length?t="0"+t:t};return function(o){"start"===o?(t=0,i=0,e=setInterval(_.bind(function(){60===t&&(t=0,i++),this.report(Ei.i18n("PHONE/PASSED_TIME")+" "+s(i)+":"+s(t)),t++},this),1e3)):"stop"===o&&clearInterval(e)}}(),kt.prototype.__name="CWrapLoginViewModel",kt.prototype.onShow=function(){this.oLoginViewModel.onShow&&this.oLoginViewModel.onShow()},kt.prototype.onApplyBindings=function(){this.oLoginViewModel.onApplyBindings&&this.oLoginViewModel.onApplyBindings()},kt.prototype.changeLanguage=function(e){e&&this.allowLanguages()&&(this.currentLanguage(e),this.oLoginViewModel.changingLanguage(!0),Fi.Ajax.send({Action:"SystemUpdateLanguageOnLogin",Language:e},function(){t.location.reload()},this))},Lt.prototype.__name="CLoginViewModel",Lt.prototype.onApplyBindings=function(){Ri.addClass("non-adjustable-valign")},Lt.prototype.onShow=function(){this.fillFields()},Lt.prototype.fillFields=function(){_.delay(_.bind(function(){this.focusFields()},this),1)},Lt.prototype.focusFields=function(){this.emailVisible()&&""===this.email()?this.emailFocus(!0):this.loginVisible()&&""===this.login()&&this.loginFocus(!0)},Lt.prototype.signIn=function(){e(".check_autocomplete_input").trigger("input").trigger("change").trigger("keydown");var t=this.loginFormType(),i=this.email(),s=this.login(),o=this.password();this.loading()||this.changingLanguage()||""===Ei.trim(o)||!(Ci.LoginFormType.Login===t&&""!==Ei.trim(s)||Ci.LoginFormType.Email===t&&""!==Ei.trim(i)||Ci.LoginFormType.Both===t&&""!==Ei.trim(i))?this.shake(!0):this.sendRequest()},Lt.prototype.onSystemLoginResponse=function(e){!1===e.Result?(this.loading(!1),this.shake(!0),Fi.Api.showErrorByCode(e,Ei.i18n("WARNING/LOGIN_PASS_INCORRECT"))):t.location.reload()},Lt.prototype.sendRequest=function(){var e={Action:"SystemLogin",Email:this.emailVisible()?this.email():"",IncLogin:this.loginVisible()?this.login():"",IncPassword:this.password(),SignMe:this.signMe()?"1":"0"};this.loading(!0),Fi.Ajax.send(e,this.onSystemLoginResponse,this)},Ot.prototype.__name="CForgotViewModel",Ot.prototype.executeGetQuestion=function(){var e={Action:"AccountGetForgotQuestion",Email:this.email()};this.gettingQuestion(!0),Fi.Ajax.send(e,this.onAccountGetForgotQuestionResponse,this)},Ot.prototype.onAccountGetForgotQuestionResponse=function(e){var t="";this.gettingQuestion(!1),!1===e.Result?Fi.Api.showErrorByCode(e,Ei.i18n("LOGIN/ERROR_GETTING_QUESTION")):(t=Ei.pString(e.Result.Question),""===t?Fi.Api.showError(Ei.i18n("LOGIN/ERROR_PASSWORD_RESET_NOT_AVAILABLE")):(this.question(t),this.visibleEmailForm(!1),this.visibleQuestionForm(!0),this.visiblePasswordForm(!1)))},Ot.prototype.executeValidateAnswer=function(){var e={Action:"AccountValidateForgotQuestion",Email:this.email(),Question:this.question(),Answer:this.answer()};this.validatingAnswer(!0),Fi.Ajax.send(e,this.onAccountValidateForgotQuestionResponse,this)},Ot.prototype.onAccountValidateForgotQuestionResponse=function(e){this.validatingAnswer(!1),!1===e.Result?Fi.Api.showErrorByCode(e,Ei.i18n("LOGIN/ERROR_WRONG_ANSWER")):(this.visibleEmailForm(!1),this.visibleQuestionForm(!1),this.visiblePasswordForm(!0))},Ot.prototype.executeChangePassword=function(){if(this.password()!==this.confirmPassword())Fi.Api.showError(Ei.i18n("WARNING/PASSWORDS_DO_NOT_MATCH"));else{var e={Action:"AccountChangeForgotPassword",Email:this.email(),Question:this.question(),Answer:this.answer(),Password:this.password()};this.changingPassword(!0),Fi.Ajax.send(e,this.onAccountChangeForgotPasswordResponse,this)}},Ot.prototype.onAccountChangeForgotPasswordResponse=function(e){this.changingPassword(!1),!1===e.Result?Fi.Api.showErrorByCode(e,Ei.i18n("LOGIN/ERROR_RESETTING_PASSWORD")):(this.gotoForgot(!1),Fi.Api.showReport(Ei.i18n("LOGIN/REPORT_PASSWORD_CHANGED")))},xt.prototype.__name="CRegisterViewModel",xt.prototype.registerAccount=function(){if(this.password()!==this.confirmPassword())Fi.Api.showError(Ei.i18n("WARNING/PASSWORDS_DO_NOT_MATCH"));else{var e={Action:"AccountRegister",Name:this.name(),Email:this.login()+"@"+this.selectedDomain(),Password:this.password(),Question:this.allowQuestionPart?this.visibleYourQuestion()?this.yourQuestion():this.question():"",Answer:this.allowQuestionPart?this.answer():""};this.loading(!0),Fi.Ajax.send(e,this.onAccountRegisterResponse,this)}},xt.prototype.onAccountRegisterResponse=function(e){!1===e.Result?(this.loading(!1),Fi.Api.showErrorByCode(e,Ei.i18n("WARNING/LOGIN_PASS_INCORRECT"))):t.location.reload()},Ht.prototype.createDatePickerObject=function(t){e(t).datepicker({showOtherMonths:!0,selectOtherMonths:!0,monthNames:Ei.getMonthNamesArray(),dayNamesMin:Ei.i18n("DATETIME/DAY_NAMES_MIN").split(" "),nextText:"",prevText:"",firstDay:Mi.User.CalendarWeekStartsOn,showOn:"focus",dateFormat:this.dateFormatDatePicker}),e(t).mousedown(function(){e("#ui-datepicker-div").toggle()})},Ht.prototype.changeRoutingForMessageList=function(e,t,i,s,o){var n=Fi.Routing.setHash(Fi.Links.mailbox(e,t,i,s,o));n&&s.length>0&&this.search()===s&&this.listChangedThrottle(!this.listChangedThrottle())},Ht.prototype.onEnterPress=function(e){e.openThread()},Ht.prototype.onMessageDblClick=function(e){if(!this.isSavingDraft(e)){var t=this.folderList().getFolderByFullName(e.folder());t.type()===Ci.FolderTypes.Drafts?Fi.Api.composeMessageFromDrafts(e.folder(),e.uid()):this.openMessageInNewWindowBinded(e)}},Ht.prototype.onFolderListSubscribe=function(){this.setCurrentFolder(),this.requestMessageList()},Ht.prototype.onShow=function(){this.selector.useKeyboardKeys(!0),this.oPageSwitcher.show(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},Ht.prototype.onHide=function(){this.selector.useKeyboardKeys(!1),this.oPageSwitcher.hide(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},Ht.prototype.onRoute=function(e){var t=Fi.Links.parseMailbox(e),i=this.currentPage()!==t.Page||this.folderFullName()!==t.Folder||this.filters()!==t.Filters||t.Filters===Ci.FolderFilter.Unseen&&Fi.MailCache.waitForUnseenMessages()||this.search()!==t.Search,s=Mi.User.MailsPerPage!==this.oPageSwitcher.perPage();this.pageSwitcherLocked(!0),this.folderFullName()!==t.Folder||this.search()!==t.Search||this.filters()!==t.Filters?this.oPageSwitcher.clear():this.oPageSwitcher.setPage(t.Page,Mi.User.MailsPerPage),this.pageSwitcherLocked(!1),t.Page!==this.oPageSwitcher.currentPage()&&Fi.Routing.replaceHash(Fi.Links.mailbox(t.Folder,this.oPageSwitcher.currentPage(),t.Uid,t.Search,t.Filters)),this.currentPage(this.oPageSwitcher.currentPage()),this.folderFullName(t.Folder),this.filters(t.Filters),this.search(t.Search),this.searchInput(this.search()),this.searchSpan.notifySubscribers(),this.setCurrentFolder(),(i||s||0===this.collection().length)&&(t.Filters===Ci.FolderFilter.Unseen&&Fi.MailCache.waitForUnseenMessages(!0),this.requestMessageList()),this.highlightTrigger.notifySubscribers(!0)},Ht.prototype.setCurrentFolder=function(){this.folderList().setCurrentFolder(this.folderFullName(),this.filters()),this.folderType(Fi.MailCache.folderList().currentFolderType())},Ht.prototype.requestMessageList=function(){var e=this.folderList().currentFolderFullName(),t=this.oPageSwitcher.currentPage();e.length>0?Fi.MailCache.changeCurrentMessageList(e,t,this.search(),this.filters()):Fi.MailCache.checkCurrentFolderList()},Ht.prototype.calculateSearchStringFromAdvancedForm=function(){var t=this.searchInputFrom(),i=this.searchInputTo(),s=this.searchInputSubject(),o=this.searchInputText(),n=this.searchAttachmentsCheckbox(),r=(this.searchAttachments(),this.searchDateStart()),a=this.searchDateEnd(),l=[],h=function(t){return t=e.trim(t).replace(/"/g,'\\"'),(-1<t.indexOf(" ")||-1<t.indexOf('"'))&&(t='"'+t+'"'),t};return""!==t&&l.push("from:"+h(t)),""!==i&&l.push("to:"+h(i)),""!==s&&l.push("subject:"+h(s)),""!==o&&l.push("text:"+h(o)),n&&l.push("has:attachments"),(""!==r||""!==a)&&l.push("date:"+h(r)+"/"+h(a)),l.join(" ")},Ht.prototype.onSearchClick=function(){var e=this.folderList().currentFolderFullName(),t=1,i=this.searchInput();this.bAdvancedSearch()&&(i=this.calculateSearchStringFromAdvancedForm(),this.searchInput(i),this.bAdvancedSearch(!1)),this.changeRoutingForMessageList(e,t,"",i,this.filters())},Ht.prototype.onRetryClick=function(){this.requestMessageList()},Ht.prototype.onClearSearchClick=function(){var e=this.folderList().currentFolderFullName(),t=this.currentMessage()?this.currentMessage().uid():"",i="",s=1;this.clearAdvancedSearch(),this.changeRoutingForMessageList(e,s,t,i,this.filters())},Ht.prototype.onClearFilterClick=function(){var e=this.folderList().currentFolderFullName(),t=this.currentMessage()?this.currentMessage().uid():"",i="",s=1,o="";this.clearAdvancedSearch(),this.changeRoutingForMessageList(e,s,t,i,o)},Ht.prototype.onStopSearchClick=function(){this.onClearSearchClick()},Ht.prototype.isSavingDraft=function(e){var t=this.folderList().currentFolder();return t.type()===Ci.FolderTypes.Drafts&&e.uid()===Fi.MailCache.savingDraftUid()},Ht.prototype.routeForMessage=function(e){if(null!==e&&!this.isSavingDraft(e)){var t=this.folderList().currentFolder(),i=this.folderList().currentFolderFullName(),s=this.oPageSwitcher.currentPage(),o=e.uid(),n=this.search();""!==o&&(Pi&&t.type()===Ci.FolderTypes.Drafts?Fi.Routing.setHash(Fi.Links.composeFromMessage("drafts",e.folder(),e.uid())):(this.changeRoutingForMessageList(i,s,o,n,this.filters()),Pi&&Fi.MailCache.currentMessage()&&o===Fi.MailCache.currentMessage().uid()&&Fi.MailCache.currentMessage.valueHasMutated()))}},Ht.prototype.onApplyBindings=function(t){var s=this,o=_.bind(function(e){e&&e.stopPropagation&&e.stopPropagation()},this);e(".message_list",t).on("click",function(){s.isFocused(!1)}).on("click",".message_sub_list .item .flag",function(e){s.onFlagClick(i.dataFor(this)),e&&e.stopPropagation&&e.stopPropagation()}).on("dblclick",".message_sub_list .item .flag",o).on("click",".message_sub_list .item .thread",o).on("dblclick",".message_sub_list .item .thread",o),this.selector.initOnApplyBindings(".message_sub_list .item",".message_sub_list .item.selected",".message_sub_list .item .custom_checkbox",e(".message_list",t),e(".message_list_scroll.scroll-inner",t)),this.initUploader()},Ht.prototype.onFlagClick=function(e){this.isSavingDraft(e)||Fi.MailCache.executeGroupOperation("MessageSetFlagged",[e.uid()],"flagged",!e.flagged())},Ht.prototype.executeMarkAsRead=function(){Fi.MailCache.executeGroupOperation("MessageSetSeen",this.checkedOrSelectedUids(),"seen",!0)},Ht.prototype.executeMarkAsUnread=function(){Fi.MailCache.executeGroupOperation("MessageSetSeen",this.checkedOrSelectedUids(),"seen",!1)},Ht.prototype.executeMarkAllRead=function(){Fi.MailCache.executeGroupOperation("MessagesSetAllSeen",[],"seen",!0)},Ht.prototype.executeMoveToFolder=function(e){Fi.MailCache.moveMessagesToFolder(e,this.checkedOrSelectedUids())},Ht.prototype.executeCopyToFolder=function(e){Fi.MailCache.copyMessagesToFolder(e,this.checkedOrSelectedUids())},Ht.prototype.onDeletePress=function(e){var t=_.map(e,function(e){return e.uid()});t.length>0&&Fi.Api.deleteMessages(t,Fi)},Ht.prototype.executeDelete=function(){Fi.Api.deleteMessages(this.checkedOrSelectedUids(),Fi)},Ht.prototype.executeSpam=function(){var e=this.folderList().spamFolderFullName();this.folderList().currentFolderFullName()!==e&&Fi.MailCache.moveMessagesToFolder(e,this.checkedOrSelectedUids())},Ht.prototype.executeNotSpam=function(){var e=this.folderList().inboxFolder();e&&this.folderList().currentFolderFullName()!==e.fullName()&&Fi.MailCache.moveMessagesToFolder(e.fullName(),this.checkedOrSelectedUids())},Ht.prototype.clearAdvancedSearch=function(){this.searchInputFrom(""),this.searchInputTo(""),this.searchInputSubject(""),this.searchInputText(""),this.bAdvancedSearch(!1),this.searchAttachmentsCheckbox(!1),this.searchAttachments(""),this.searchDateStart(""),this.searchDateEnd("")},Ht.prototype.onAdvancedSearchClick=function(){this.bAdvancedSearch(!this.bAdvancedSearch())},Ht.prototype.calculateSearchStringForDescription=function(){return'<span class="part">'+Ei.encodeHtml(this.search())+"</span>"},Ht.prototype.initUploader=function(){var e=this;this.uploaderArea()&&(this.oJua=new Jua({action:"?/Upload/Message/",name:"jua-uploader",queueSize:2,dragAndDropElement:this.uploaderArea(),disableAjaxUpload:this.isPublic,disableFolderDragAndDrop:this.isPublic,disableDragAndDrop:this.isPublic,hidden:{Token:function(){return Mi.Token},AccountID:function(){return Mi.Accounts.currentId()},AdditionalData:function(){return JSON.stringify({Folder:e.folderFullName()})}}}),this.oJua.on("onDrop",_.bind(this.onFileDrop,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)))},Ht.prototype.onFileDrop=function(e){e&&e.File&&e.File.type&&0===e.File.type.indexOf("message/")||Fi.Api.showError(Ei.i18n("MAILBOX/ERROR_INCORRECT_FILE_EXTENSION"))
},Ht.prototype.onFileUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1;s?Fi.Api.showError(i.ErrorCode&&i.ErrorCode===Ci.Errors.IncorrectFileExtension?Ei.i18n("CONTACTS/ERROR_INCORRECT_FILE_EXTENSION"):Ei.i18n("WARNING/ERROR_UPLOAD_FILE")):Fi.MailCache.executeCheckMail()},Gt.prototype.resizeDblClick=function(t,i){""!==i.target.className&&i.target.className.search(/add_contact|icon|link|title|subject|link|date|from/)&&(i.preventDefault(),i.stopPropagation?i.stopPropagation():i.cancelBubble=!0,Ei.removeSelection(),this.jqPanelHelper||(this.jqPanelHelper=e(".MailLayout .panel_helper")),this.jqPanelHelper.trigger("resize",[5,"min",!0]))},Gt.prototype.notifySender=function(){this.currentMessage()&&""!==this.currentMessage().readingConfirmation()&&(Fi.Ajax.send({Action:"MessageSendConfirmation",Confirmation:this.currentMessage().readingConfirmation(),Subject:Ei.i18n("MESSAGE/RETURN_RECEIPT_MAIL_SUBJECT"),Text:Ei.i18n("MESSAGE/RETURN_RECEIPT_MAIL_TEXT",{EMAIL:Mi.Accounts.getEmail(),SUBJECT:this.subject()}),ConfirmFolder:this.currentMessage().folder(),ConfirmUid:this.currentMessage().uid()}),this.currentMessage().readingConfirmation(""))},Gt.prototype.onFolderListSubscribe=function(){Mi.SingleMode&&this.onMessagesSubscribe()},Gt.prototype.onMessagesSubscribe=function(){!this.currentMessage()&&this.uid().length>0&&Fi.MailCache.setCurrentMessage(this.uid(),this.folder())},Gt.prototype.onCurrentMessageSubscribe=function(){var i=null,s=null,o=this.currentMessage(),n=o?Mi.Accounts.getAccount(o.accountId()):null;if(this.singleMode()&&t.opener&&t.opener.oReplyDataFromViewPane?(this.replyText(t.opener.oReplyDataFromViewPane.ReplyText),this.replyDraftUid(t.opener.oReplyDataFromViewPane.ReplyDraftUid),t.opener.oReplyDataFromViewPane=null):o&&o.uid()===this.displayedMessageUid()||(this.replyText(""),this.replyDraftUid("")),o&&this.uid()===o.uid()){if(this.subject(o.subject()),this.importance(o.importance()),this.from(o.oFrom.getDisplay()),this.fromEmail(o.oFrom.getFirstEmail()),this.fullFrom(o.oFrom.getFull()),this.oFromAddr(o.oFrom.aCollection.length>0?o.oFrom.aCollection[0]:null),this.to(o.oTo.getFull()),this.aToAddr(o.oTo.aCollection),this.cc(o.oCc.getFull()),this.aCcAddr(o.oCc.aCollection),this.bcc(o.oBcc.getFull()),this.aBccAddr(o.oBcc.aCollection),this.currentAccountEmail(n.email()),this.aAllRecipients(_.uniq(_.union(this.aToAddr(),this.aCcAddr(),this.aBccAddr()))),this.mobileApp||this.requestContactsByEmail(_.union(o.oFrom.aCollection,this.aAllRecipients())),this.midDate(o.oDateModel.getMidDate()),this.fullDate(o.oDateModel.getFullDate()),this.isLoading(""!==o.uid()&&!o.completelyFilled()),this.setMessageBody(),this.rtlMessage(o.rtl()),this.singleMode()){var r=[],a=Date.now().toString();_.each(o.attachments(),_.bind(function(e){var t=new ot;t.copyProperties(e),t.getInThumbQueue(a),r.push(t)},this)),this.attachments(r)}else this.attachments(o.attachments());if(null!==this.ical()&&this.ical().animation(!1),i=o.ical(),i&&this.singleMode()&&(i=this.getIcalCopy(i)),this.ical(i),null!==this.ical()&&(_.defer(_.bind(function(){null!==this.ical()&&this.ical().animation(!0)},this)),this.ical().updateAttendeeStatus(this.fromEmail())),s=o.vcard(),s&&this.singleMode()&&(s=this.getVcardCopy(s)),this.vcard(s),!o.completelyFilled()||o.trimmed()){var l=o.completelyFilled()?o.trimmed:o.completelyFilled;this.singleMode()?o.completelyFilledSingleModeSubscription=l.subscribe(this.onCurrentMessageSubscribe,this):o.completelyFilledSubscription=l.subscribe(this.onCurrentMessageSubscribe,this)}else o.completelyFilledSubscription?(o.completelyFilledSubscription.dispose(),o.completelyFilledSubscription=void 0):o.completelyFilledSingleModeSubscription&&(o.completelyFilledSingleModeSubscription.dispose(),o.completelyFilledSingleModeSubscription=void 0)}else this.isLoading(!1),e(this.domTextBody()).empty().data("displayed-message-uid",""),this.displayedMessageUid(""),this.rtlMessage(!1),this.attachments([]),this.visiblePicturesControl(!1),this.visibleShowPicturesLink(!1),this.ical(null),this.vcard(null),this.decryptPassword(""),this.visibleDecryptControl(!1),this.visibleVerifyControl(!1)},Gt.prototype.updateMomentDate=function(){var e=this.currentMessage();e&&e.oDateModel&&(this.midDate(e.oDateModel.getMidDate()),this.fullDate(e.oDateModel.getFullDate()))},Gt.prototype.requestContactsByEmail=function(e){_.each(e,_.bind(function(e){Fi.ContactsCache.getContactByEmail(e.sEmail,this.onContactResponse,this)},this))},Gt.prototype.onContactResponse=function(e,t){e&&(this.recipientsContacts.push(e),this.recipientsContacts(_.uniq(this.recipientsContacts()))),_.each(_.union([this.oFromAddr()],this.aAllRecipients()),function(i){i&&i.sEmail===t&&(i.loaded(!0),e&&i.founded(!0))})},Gt.prototype.getVcardCopy=function(e){var t=new ct;return t.uid(e.uid()),t.file(e.file()),t.name(e.name()),t.email(e.email()),t.isExists(e.isExists()),t.isJustSaved(e.isJustSaved()),t},Gt.prototype.getIcalCopy=function(e){var t=new ht;return t.uid(e.uid()),t.file(e.file()),t.attendee(e.attendee()),t.type(e.type()),t.cancelDecision(e.cancelDecision()),t.replyDecision(e.replyDecision()),t.isJustSaved(e.isJustSaved()),t.location(e.location()),t.description(e.description()),t.when(e.when()),t.calendarId(e.calendarId()),t.selectedCalendarId(e.selectedCalendarId()),t.calendars(e.calendars()),t.animation(e.animation()),t},Gt.prototype.setMessageBody=function(){if(this.currentMessage()){var t=this.currentMessage(),i=t.text();this.textBody(i),_.defer(_.bind(function(){if(this.currentMessage()){var t=this.currentMessage(),i=t.text(),s=null,o="",n=i.length,r=5e6,a=e(this.domTextBody()),l=[];a.data("displayed-message-uid")===t.uid()&&(l=this.getBlockquotesStatus()),a.empty(),t.isPlain()||n>r?(a.html(i),this.visiblePicturesControl(!1)):(s=t.getDomText(),o=s.length>0?s.html():"",a.append(o),this.visiblePicturesControl(t.hasExternals()&&!t.isExternalsAlwaysShown()),this.visibleShowPicturesLink(!t.isExternalsShown()),Ei.htmlStartsWithBlockquote(o)||this.doHidingBlockquotes(l)),this.decryptPassword(""),this.visibleDecryptControl(Mi.User.enableOpenPgp()&&t.encryptedMessage()),this.visibleVerifyControl(Mi.User.enableOpenPgp()&&t.signedMessage()),a.data("displayed-message-uid",t.uid()),this.displayedMessageUid(t.uid())}},this))}},Gt.prototype.getBlockquotesStatus=function(){var t=[];return e(e("blockquote",e(this.domTextBody())).get()).each(function(){var i=e(this);i.hasClass("blockquote_before_toggle")&&t.push(i.hasClass("collapsed"))}),t},Gt.prototype.doHidingBlockquotes=function(t){var i=120,s=80,o=0;e(e("blockquote",e(this.domTextBody())).get()).each(function(){var n=e(this),r=n.parents("blockquote"),a=e('<span class="blockquote_toggle"></span>').html(Ei.i18n("MESSAGE/SHOW_QUOTED_TEXT")),l=!0;0===r.length&&n.height()>i&&(n.addClass("blockquote_before_toggle").after(a).wrapInner('<div class="blockquote_content"></div>'),a.bind("click",function(){l?(n.height("auto"),a.html(Ei.i18n("MESSAGE/HIDE_QUOTED_TEXT")),l=!1):(n.height(s),a.html(Ei.i18n("MESSAGE/SHOW_QUOTED_TEXT")),l=!0),n.toggleClass("collapsed",l)}),o<t.length&&(l=t[o],o++),n.height(l?s:"auto").toggleClass("collapsed",l))})},Gt.prototype.onRoute=function(e){var t=Fi.Links.parseMailbox(e);""!==this.replyText()&&this.uid()!==t.Uid&&this.saveReplyMessage(!1),this.uid(t.Uid),this.folder(t.Folder),Fi.MailCache.setCurrentMessage(this.uid(),this.folder()),this.contentHasFocus(!0)},Gt.prototype.showPictures=function(){Fi.MailCache.showExternalPictures(!1),this.visibleShowPicturesLink(!1),this.setMessageBody()},Gt.prototype.alwaysShowPictures=function(){var e=this.currentMessage()?this.currentMessage().oFrom.getFirstEmail():"";e.length>0&&Fi.Ajax.send({Action:"EmailSetSafety",Email:e}),Fi.MailCache.showExternalPictures(!0),this.visiblePicturesControl(!1),this.setMessageBody()},Gt.prototype.openInNewWindow=function(){this.openMessageInNewWindowBinded(this.currentMessage())},Gt.prototype.addToContacts=function(e,t){this.processed()||(this.processed(!0),Fi.ContactsCache.addToContacts(t,e,this.onAddToContactsResponse,this))},Gt.prototype.onAddToContactsResponse=function(e,t){e.Result&&""!==t.HomeEmail&&(Fi.Api.showReport(Ei.i18n("CONTACTS/REPORT_CONTACT_SUCCESSFULLY_ADDED")),Fi.ContactsCache.clearInfoAboutEmail(t.HomeEmail),Fi.ContactsCache.getContactByEmail(t.HomeEmail,this.onContactResponse,this)),this.processed(!1)},Gt.prototype.getReplyHtmlText=function(){return'<div style="font-family: '+this.defaultFontName+'; font-size: 16px">'+Fi.MessageSender.getHtmlFromText(this.replyText())+"</div>"},Gt.prototype.executeReplyOrForward=function(e){this.currentMessage()&&(Fi.MessageSender.setReplyData(this.getReplyHtmlText(),this.replyDraftUid()),this.replyText(""),this.replyDraftUid(""),Fi.Api.composeMessageAsReplyOrForward(e,this.currentMessage().folder(),this.currentMessage().uid()))},Gt.prototype.executeDeleteMessage=function(){this.currentMessage()&&(this.singleMode()&&t.opener&&t.opener.App&&t.opener.App.MailCache?Fi.Api.deleteMessages([this.currentMessage().uid()],t.opener.App,function(){t.close()}):this.mobileApp&&Fi.Api.deleteMessages([this.currentMessage().uid()],Fi))},Gt.prototype.executePrevMessage=function(){this.isEnablePrevMessage()&&this.moveToSingleMessageView(this.prevMessageUid())},Gt.prototype.executeNextMessage=function(){this.isEnableNextMessage()&&this.moveToSingleMessageView(this.nextMessageUid())},Gt.prototype.moveToSingleMessageView=function(e){var t=Fi.MailCache.folderList().currentFolderFullName(),i=[Ci.Screens.SingleMessageView,t,"msg"+e];Fi.Routing.setHash(i)},Gt.prototype.executeReply=function(){this.executeReplyOrForward(Ci.ReplyType.Reply)},Gt.prototype.executeReplyAll=function(){this.executeReplyOrForward(Ci.ReplyType.ReplyAll)},Gt.prototype.executeResend=function(){this.executeReplyOrForward(Ci.ReplyType.Resend)},Gt.prototype.executeForward=function(){this.executeReplyOrForward(Ci.ReplyType.Forward)},Gt.prototype.executePrint=function(){var t=this.currentMessage(),i=t?Ei.WindowOpener.open("",this.subject()+"-print"):null,s="";t&&i&&(this.textBodyForNewWindow(t.getConvertedHtml(Ei.getAppPath(),!0)),s=e(this.domMessageForPrint()).html(),e(i.document.body).html(s),i.print())},Gt.prototype.executeSave=function(){this.currentMessage()&&Fi.Api.downloadByUrl(this.currentMessage().downloadLink())},Gt.prototype.executeSaveAsPdf=function(){if(this.currentMessage()){var t=this.currentMessage().getDomText(),i=this.currentMessage().accountId(),s=function(e){try{var t=document.createElement("canvas"),i=null;t.width=e.width,t.height=e.height,i=t.getContext("2d"),i.drawImage(e,0,0),e.src=t.toDataURL("image/png")}catch(s){}};e("img[data-x-src-cid]",t).each(function(){s(this)}),Fi.Ajax.send({Action:"MessageGetPdfFromHtml",Subject:this.subject(),Html:t.html()},function(e){e&&e.Result&&e.Result.Hash?Fi.Api.downloadByUrl(Ei.getDownloadLinkByHash(i,e.Result.Hash)):Fi.Api.showError(Ei.i18n("WARNING/CREATING_PDF_ERROR"))},this)}},Gt.prototype.changeAddMenuVisibility=function(){var e=!this.visibleAddMenu();this.visibleAddMenu(e)},Gt.prototype.onMessageSendOrSaveResponse=function(e,t){var i=Fi.MessageSender.onMessageSendOrSaveResponse(e,t,this.requiresPostponedSending());switch(i.Action){case"MessageSend":this.replySendingStarted(!1),i.Result&&this.replyText("");break;case"MessageSave":i.Result&&this.replyDraftUid(i.NewUid),this.replySavingStarted(!1),this.replyAutoSavingStarted(!1)}},Gt.prototype.executeSendQuickReplyCommand=function(){this.isEnableSendQuickReply()&&(this.replySendingStarted(!0),this.requiresPostponedSending(this.replyAutoSavingStarted()),Fi.MessageSender.sendReplyMessage("MessageSend",this.getReplyHtmlText(),this.replyDraftUid(),this.onMessageSendOrSaveResponse,this,this.requiresPostponedSending()),this.replyTextFocus(!1))},Gt.prototype.executeSaveQuickReply=function(){this.saveReplyMessage(!1)},Gt.prototype.saveReplyMessage=function(e){this.isEnableSaveQuickReply()&&(e?this.replyAutoSavingStarted(!0):this.replySavingStarted(!0),Fi.MessageSender.sendReplyMessage("MessageSave",this.getReplyHtmlText(),this.replyDraftUid(),this.onMessageSendOrSaveResponse,this))},Gt.prototype.stopAutosaveTimer=function(){t.clearTimeout(this.autoSaveTimer)},Gt.prototype.startAutosaveTimer=function(){if(this.isEnableSaveQuickReply()){var e=_.bind(this.saveReplyMessage,this,!0);this.stopAutosaveTimer(),Mi.User.AllowAutosaveInDrafts&&(this.autoSaveTimer=t.setTimeout(e,1e3*Mi.App.AutoSaveIntervalSeconds))}},Gt.prototype.downloadAllAttachments=function(){this.currentMessage()&&this.currentMessage().downloadAllAttachments()},Gt.prototype.saveAttachmentsToFiles=function(){this.currentMessage()&&this.currentMessage().saveAttachmentsToFiles()},Gt.prototype.downloadAllAttachmentsSeparately=function(){this.currentMessage()&&this.currentMessage().downloadAllAttachmentsSeparately()},Gt.prototype.onApplyBindings=function(t){Fi.registerSessionTimeoutFunction(_.bind(function(){""!==this.replyText()&&this.saveReplyMessage(!1)},this)),e(t).on("mousedown","a",function(t){if(t&&3!==t.which){var i=e(this).attr("href");if(i&&"mailto:"===i.toString().toLowerCase().substr(0,7))return Fi.Api.composeMessageToAddresses(i.toString().substr(7)),!1}return!0}),this.hotKeysBind()},Gt.prototype.hotKeysBind=function(){e(document).on("keydown",e.proxy(function(e){var t=Fi.Screens.currentScreen()===Ci.Screens.Mailbox&&e&&!e.ctrlKey&&!e.shiftKey&&!Ei.isTextFieldFocused()&&this.isEnableReply();t&&e.keyCode===Ci.Key.q?(e.preventDefault(),this.replyTextFocus(!0)):t&&e.keyCode===Ci.Key.r&&this.executeReply()},this))},Gt.prototype.showSourceHeaders=function(){var t=this.currentMessage(),i=t&&t.completelyFilled()?Ei.WindowOpener.open("",this.subject()+"-headers"):null;i&&e(i.document.body).html("<pre>"+Ei.encodeHtml(t.sourceHeaders())+"</pre>")},Gt.prototype.onDecryptMessageClick=function(){this.currentMessage()&&this.currentMessage().encryptedMessage()&&this.decryptVerifyMessage(!1)},Gt.prototype.onVerifyMessageClick=function(){this.currentMessage()&&this.currentMessage().signedMessage()&&this.decryptVerifyMessage(!0)},Gt.prototype.decryptVerifyMessage=function(e){var t=_.bind(function(t){var i=this.currentMessage();t&&i&&(e&&i.signedMessage()?this.verifyMessage(t):i.encryptedMessage()&&this.decryptMessage(t))},this);Fi.Api.pgp(t,Mi.User.IdUser)},Gt.prototype.decryptMessage=function(e){var t=this.currentMessage(),i=t.textRaw(),s=Mi.Accounts.getEmail(),o=t.oFrom.getFirstEmail(),n=this.decryptPassword(),r=e.decryptAndVerify(i,s,o,n),a=!1;r&&r.result&&!r.errors&&(t.text("<pre>"+Ei.encodeHtml(r.result)+"</pre>"),t.$text=null,t.encryptedMessage(!1),this.decryptPassword(""),this.visibleDecryptControl(!1),this.setMessageBody(),Fi.Api.showReport(r.notices?Ei.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_DECRYPTED"):Ei.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_DECRYPTED_AND_VERIFIED"))),r&&(r.errors||r.notices)&&(a=Fi.Api.showPgpErrorByCode(r,Ci.PgpAction.DecryptVerify),a&&Fi.Api.showReport(Ei.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_DECRYPTED_AND_NOT_SIGNED")))},Gt.prototype.verifyMessage=function(e){var t=this.currentMessage(),i=t.textRaw(),s=t.oFrom.getFirstEmail(),o=e.verify(i,s);o&&o.result&&!o.errors&&!o.notices&&(t.text("<pre>"+Ei.encodeHtml(o.result)+"</pre>"),t.$text=null,t.signedMessage(!1),this.visibleVerifyControl(!1),this.setMessageBody(),Fi.Api.showReport(Ei.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_VERIFIED"))),o&&(o.errors||o.notices)&&Fi.Api.showPgpErrorByCode(o,Ci.PgpAction.Verify)},Gt.prototype.testFunction=function(){Fi.Api.pgp(function(){})},Bt.prototype.executeCompose=function(){Fi.Api.composeMessage()},Bt.prototype.executeCheckMail=function(){Fi.MailCache.checkMessageFlags(),Fi.MailCache.executeCheckMail()},Bt.prototype.openMessageInNewWindow=function(e){var i=this.folderList().getFolderByFullName(e.folder()),s=i.type()===Ci.FolderTypes.Drafts;!this.oMessagePane.currentMessage()||this.oMessagePane.currentMessage().uid()!==e.uid()||""===this.oMessagePane.replyText()&&""===this.oMessagePane.replyDraftUid()||(t.oReplyDataFromViewPane={ReplyText:this.oMessagePane.replyText(),ReplyDraftUid:this.oMessagePane.replyDraftUid()},this.oMessagePane.replyText(""),this.oMessagePane.replyDraftUid("")),Ei.WindowOpener.openMessage(e,s)},Bt.prototype.gotoFolderList=function(){this.changeSelectedPanel(Ci.MobilePanel.Groups)},Bt.prototype.gotoMessageList=function(){return this.changeSelectedPanel(Ci.MobilePanel.Items),!0},Bt.prototype.gotoMessagePane=function(){Fi.MailCache.currentMessage()?this.changeSelectedPanel(Ci.MobilePanel.View):this.gotoMessageList()},Bt.prototype.changeSelectedPanel=function(e){this.mobileApp&&this.selectedPanel()!==e&&this.selectedPanel(e)},Bt.prototype.resizeDblClick=function(t,i){i.preventDefault(),i.stopPropagation?i.stopPropagation():i.cancelBubble=!0,Ei.removeSelection(),this.jqPanelHelper||(this.jqPanelHelper=e(".MailLayout .panel_helper")),this.jqPanelHelper.trigger("resize",[600,"max"])},Bt.prototype.onRoute=function(e){this.oMessageList.onRoute(e),this.oMessagePane.onRoute(e)},Bt.prototype.onShow=function(){this.oMessageList.onShow()},Bt.prototype.onHide=function(){this.oMessageList.onHide()},Bt.prototype.onApplyBindings=function(){var t=this;this.oMessageList.onApplyBindings(this.$viewModel),this.oMessagePane.onApplyBindings(this.$viewModel),e(this.domFolderList()).on("click","span.folder",function(i){t.folderList().currentFolderFullName()!==e(this).data("folder")&&(i.ctrlKey?t.oMessageList.executeCopyToFolder(e(this).data("folder")):t.oMessageList.executeMoveToFolder(e(this).data("folder")))}),this.hotKeysBind()},Bt.prototype.hotKeysBind=function(){e(document).on("keydown",e.proxy(function(e){var i=e.keyCode,s=e&&!e.ctrlKey&&!e.altKey&&!e.shiftKey&&!Ei.isTextFieldFocused()&&Fi.Screens.currentScreen()===Ci.Screens.Mailbox,o=this.oMessageList,n=o.collection()[0],r=n&&Fi.MailCache.currentMessage()&&n.uid()===Fi.MailCache.currentMessage().uid();s&&i===Ci.Key.s||s&&r&&i===Ci.Key.Up?(e.preventDefault(),this.searchFocus()):o.isFocused()&&e&&i===Ci.Key.Down&&n?(e.preventDefault(),o.isFocused(!1),o.routeForMessage(n)):s&&i===Ci.Key.n&&(t.location.href="#compose")},this))},Bt.prototype.dragAndDropHelper=function(t,i){t&&t.checked(!0);var s=Ei.draggableMessages(),o=this.oMessageList.checkedOrSelectedUids(),n=o.length;return s.data("p7-message-list-folder",this.folderList().currentFolderFullName()),s.data("p7-message-list-uids",o),e(".count-text",s).text(Ei.i18n("MAILBOX/DRAG_TEXT_PLURAL",{COUNT:i?"+ "+n:n},null,n)),s},Bt.prototype.messagesDrop=function(e,t,i){if(e){var s=i&&i.helper?i.helper:null,o=s?s.data("p7-message-list-folder"):"",n=s?s.data("p7-message-list-uids"):null;""!==o&&null!==n&&(Ei.uiDropHelperAnim(t,i),t.ctrlKey?this.oMessageList.executeCopyToFolder(e.fullName()):this.oMessageList.executeMoveToFolder(e.fullName()),this.uncheckMessages())}},Bt.prototype.searchFocus=function(){this.oMessageList.selector.useKeyboardKeys()&&!Ei.isTextFieldFocused()&&this.oMessageList.isFocused(!0)},Bt.prototype.backToList=function(){Fi.Routing.setPreviousHash()},Bt.prototype.onVolumerClick=function(e,t){t.stopPropagation()},Bt.prototype.uncheckMessages=function(){_.each(Fi.MailCache.messages(),function(e){e.checked(!1)})},jt.prototype.__name="CComposeViewModel",jt.prototype.isEnableSending=function(){var e=0===this.toAddr().length&&0===this.ccAddr().length&&0===this.bccAddr().length,t=this.folderList()&&0!==this.folderList().iAccountId;return t&&!this.sending()&&!e&&this.allAttachmentsUploaded()},jt.prototype.isEnableSaving=function(){var e=this.folderList()&&0!==this.folderList().iAccountId;return this.shown()&&e&&!this.sending()&&!this.saving()},jt.prototype.initInputosaurus=function(t,i,s,o){t()&&e(t()).length>0&&e(t()).inputosaurus({width:"auto",parseOnBlur:!0,autoCompleteSource:_.bind(function(e,t){this.autocompleteCallback(e.term,t)},this),autoCompleteAppendTo:e(t()).closest("td"),change:_.bind(function(e){s(!0),this.setRecipient(i,e.target.value),this.minHeightAdjustTrigger(!0),s(!1)},this),copy:_.bind(function(e){this.inputosaurusBuffer=e},this),paste:_.bind(function(){var e=this.inputosaurusBuffer||"";return this.inputosaurusBuffer="",e},this),focus:_.bind(this.focusedField,this,o),mobileDevice:Ni})},jt.prototype.onApplyBindings=function(){Fi.registerSessionTimeoutFunction(_.bind(this.executeSave,this,!1)),this.allowDropbox&&Ei.loadScript("https://www.dropbox.com/static/api/2/dropins.js",null,{id:"dropboxjs","data-app-key":this.dropboxKey}),this.hotKeysBind()},jt.prototype.hotKeysBind=function(){e(document).on("keydown",e.proxy(function(e){if(e&&e.ctrlKey&&!e.altKey&&!e.shiftKey){var t=e.keyCode,i=this.shown()&&(!this.minimized||!this.minimized()),s=i&&e&&e.ctrlKey,o=Ci.Key;s&&t===o.s?(e.preventDefault(),e.returnValue=!1,this.isEnableSaving()&&this.saveCommand()):s&&t===o.Enter&&""!==this.toAddr()&&this.sendCommand()}},this))},jt.prototype.getMessageOnRoute=function(){var e=this.routeParams(),t="",i="";""!==this.routeType()&&3===e.length&&(t=e[1],i=e[2],Fi.MailCache.getMessage(t,i,this.onMessageResponse,this))},jt.prototype.onShow=function(){var t=this.focusedField();this.shown(!0),e(this.splitterDom()).trigger("resize"),this.useSaveMailInSentItems(Mi.User.getUseSaveMailInSentItems()),this.saveMailInSentItems(Mi.User.getSaveMailInSentItems()),this.oHtmlEditor.initCrea(this.textBody(),this.plainText(),"7"),this.oHtmlEditor.commit(),this.initUploader(),this.backToListOnSendOrSave(!1),this.startAutosaveTimer(),this.focusedField(t),Ri.addClass("screen-compose"),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0),this.getSocialAccounts()},jt.prototype.onRoute=function(e){var i="",s={};switch(this.plainText(!1),this.pgpSecured(!1),this.pgpEncrypted(!1),this.fromDrafts(!1),this.bUploadStatus=!1,t.clearTimeout(this.iUploadAttachmentsTimer),this.messageUploadAttachmentsStarted(!1),this.draftUid(""),this.draftInfo.removeAll(),this.setDataFromMessage(new at),this.isDraftsCleared(!1),this.routeType(e.length>0?e[0]:""),this.routeType()){case Ci.ReplyType.Reply:case Ci.ReplyType.ReplyAll:case Ci.ReplyType.Resend:case Ci.ReplyType.Forward:case"drafts":this.routeParams(e),0!==this.folderList().iAccountId&&this.getMessageOnRoute();break;default:i=Fi.MessageSender.getSignatureText(this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),Mi.SingleMode&&t.opener&&t.opener.aMessagesParametersFromCompose&&t.opener.aMessagesParametersFromCompose[t.name]?this.setMessageDataInSingleMode(t.opener.aMessagesParametersFromCompose[t.name]):""!==i&&this.textBody("<br /><br />"+i+"<br />"),"to"===this.routeType()&&2===e.length&&(s=Fi.Links.parseToAddr(e[1]),this.setRecipient(this.toAddr,s.to),s.hasMailto&&(this.subject(s.subject),this.setRecipient(this.ccAddr,s.cc),this.setRecipient(this.bccAddr,s.bcc),this.textBody(s.body))),"vcard"===this.routeType()&&2===e.length&&this.addContactAsAttachment(e[1]),"file"===this.routeType()&&2===e.length&&this.addFilesAsAttachment(e[1]),"data-as-file"===this.routeType()&&3===e.length&&this.addDataAsAttachment(e[1],e[2]),_.defer(_.bind(function(){this.focusAfterFilling()},this))}this.visibleCc(""!==this.ccAddr()),this.visibleBcc(""!==this.bccAddr()),this.commit(!0),this.allowFiles(Mi.User.IsFilesSupported&&Mi.User.filesEnable()),Mi.SingleMode&&this.changedInPreviousWindow()&&_.defer(_.bind(this.executeSave,this,!0))},jt.prototype.focusToAddr=function(){e(this.toAddrDom()).inputosaurus("focus")},jt.prototype.focusCcAddr=function(){e(this.ccAddrDom()).inputosaurus("focus")},jt.prototype.focusBccAddr=function(){e(this.bccAddrDom()).inputosaurus("focus")},jt.prototype.focusAfterFilling=function(){switch(this.focusedField()){case"to":this.focusToAddr();break;case"cc":this.visibleCc(!0),this.focusCcAddr();break;case"bcc":this.visibleBcc(!0),this.focusBccAddr();break;case"subject":this.subjectFocused(!0);break;case"text":this.oHtmlEditor.setFocus();break;default:0===this.toAddr().length?this.focusToAddr():0===this.subject().length?this.subjectFocused(!0):this.oHtmlEditor.setFocus()}},jt.prototype.beforeHide=function(e){var t=Ei.i18n("COMPOSE/CONFIRM_DISCARD_CHANGES"),i=_.bind(function(t){t&&Ei.isFunc(e)?(this.commit(),e()):Fi.Routing.historyBackWithoutParsing(Ci.Screens.Compose)},this);!this.closeBecauseSingleCompose()&&this.hasSomethingToSave()?Fi.Screens.showPopup(E,[t,i]):Ei.isFunc(e)&&e()},jt.prototype.onHide=function(){this.stopAutosaveTimer(),!Ei.isFunc(this.closeCommand)&&this.hasSomethingToSave()&&this.executeSave(!0),this.shown(!1),this.routeParams([]),this.subjectFocused(!1),this.focusedField(""),this.oHtmlEditor.closeAllPopups(),this.oHtmlEditor.visibleLinkPopup(!1),this.messageUploadAttachmentsStarted(!1),Ri.removeClass("screen-compose").removeClass("screen-compose-cc").removeClass("screen-compose-bcc").removeClass("screen-compose-attachments"),this.minHeightRemoveTrigger(!0),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},jt.prototype.sendingAndSavingSubscription=function(){(this.sending()||this.saving())&&this.stopAutosaveTimer(),this.sending()||this.saving()||this.startAutosaveTimer()},jt.prototype.stopAutosaveTimer=function(){t.clearTimeout(this.autoSaveTimer)},jt.prototype.startAutosaveTimer=function(){if(this.shown()&&!this.pgpSecured()){var e=_.bind(this.executeSave,this,!0);this.stopAutosaveTimer(),Mi.User.AllowAutosaveInDrafts&&(this.autoSaveTimer=t.setTimeout(e,1e3*Mi.App.AutoSaveIntervalSeconds))}},jt.prototype.setRecipient=function(e,t){e()===t?e.valueHasMutated():e(t)},jt.prototype.onMessageResponse=function(e){var t=null;if(null===e)this.setDataFromMessage(new at);else{switch(this.routeType()){case Ci.ReplyType.Reply:case Ci.ReplyType.ReplyAll:this.oSenderSelector.setFetcherOrIdentityByReplyMessage(e),t=Fi.MessageSender.getReplyDataFromMessage(e,this.routeType(),this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),this.draftInfo(t.DraftInfo),this.draftUid(t.DraftUid),this.setRecipient(this.toAddr,t.To),this.setRecipient(this.ccAddr,t.Cc),this.setRecipient(this.bccAddr,t.Bcc),this.subject(t.Subject),this.textBody(t.Text),this.attachments(t.Attachments),this.inReplyTo(t.InReplyTo),this.references(t.References);break;case Ci.ReplyType.Forward:this.oSenderSelector.setFetcherOrIdentityByReplyMessage(e),t=Fi.MessageSender.getReplyDataFromMessage(e,this.routeType(),this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),this.draftInfo(t.DraftInfo),this.draftUid(t.DraftUid),this.setRecipient(this.toAddr,t.To),this.setRecipient(this.ccAddr,t.Cc),this.subject(t.Subject),this.textBody(t.Text),this.attachments(t.Attachments),this.inReplyTo(t.InReplyTo),this.references(t.References);break;case Ci.ReplyType.Resend:this.setDataFromMessage(e);break;case"drafts":this.draftUid(e.uid()),this.setDataFromMessage(e),this.fromDrafts(!0)}this.routeType("")}this.attachments().length>0&&this.requestAttachmentsTempName(),this.visibleCc(""!==this.ccAddr()),this.visibleBcc(""!==this.bccAddr()),this.commit(!0),_.defer(_.bind(function(){this.focusAfterFilling()},this)),this.minHeightAdjustTrigger(!0)},jt.prototype.setDataFromMessage=function(e){var t="",i=!1,s=!1,o=Fi.MessageSender.getFirstFetcherOrIdentityByRecipientsOrDefault(e.oFrom.aCollection,e.accountId());this.oSenderSelector.changeSenderAccountId(e.accountId(),o),e.isPlain()?(i=-1!==e.textRaw().indexOf("-----BEGIN PGP MESSAGE-----"),s=-1!==e.textRaw().indexOf("-----BEGIN PGP SIGNED MESSAGE-----"),s||i?(t=e.textRaw(),this.pgpSecured(!0),this.pgpEncrypted(i)):t=e.textRaw()):t=e.getConvertedHtml(),this.draftInfo(e.draftInfo()),this.inReplyTo(e.inReplyTo()),this.references(e.references()),this.setRecipient(this.toAddr,e.oTo.getFull()),this.setRecipient(this.ccAddr,e.oCc.getFull()),this.setRecipient(this.bccAddr,e.oBcc.getFull()),this.subject(e.subject()),this.attachments(e.attachments()),this.plainText(e.isPlain()),this.textBody(t),this.selectedImportance(e.importance()),this.selectedSensitivity(e.sensitivity()),this.readingConfirmation(e.readingConfirmation())},jt.prototype.addDataAsAttachment=function(e,t){var i="data-as-attachment-"+Math.random(),s={Action:"DataAsAttachmentUpload",Data:e,FileName:t,Hash:i},o=new ot;this.subject(t.substr(0,t.length-4)),o.fileName(t),o.hash(i),o.uploadStarted(!0),this.attachments.push(o),this.messageUploadAttachmentsStarted(!0),Fi.Ajax.send(s,this.onDataAsAttachmentUpload,this)},jt.prototype.onDataAsAttachmentUpload=function(e,t){var i=e.Result,s=t.Hash,o=_.find(this.attachments(),function(e){return e.hash()===s});this.messageUploadAttachmentsStarted(!1),o&&(i&&i.Attachment?o.parseFromUpload(i.Attachment,e.AccountID):o.errorFromUpload())},jt.prototype.addFilesAsAttachment=function(e){var t=null,i=[],s=null;_.each(e,function(e){t=new ot,t.fileName(e.fileName()),t.hash(e.hash()),t.thumb(e.thumb()),t.uploadStarted(!0),this.attachments.push(t),i.push(e.hash())},this),i.length>0&&(s={Action:"FilesUpload",Hashes:i},this.messageUploadAttachmentsStarted(!0),Fi.Ajax.send(s,this.onFilesUpload,this))},jt.prototype.onFilesUpload=function(t,i){var s=t.Result,o=i.Hashes,n=Date.now().toString();this.messageUploadAttachmentsStarted(!1),e.isArray(s)?_.each(s,function(e){var i=_.find(this.attachments(),function(t){return t.hash()===e.Hash});i&&(i.parseFromUpload(e,t.AccountID),i.hash(e.NewHash),i.getInThumbQueue(n))},this):_.each(o,function(e){var t=_.find(this.attachments(),function(t){return t.hash()===e});t&&t.errorFromUpload()},this)},jt.prototype.addContactAsAttachment=function(e){var t=new ot,i=null;e&&(t.fileName("contact-"+e.idContact()+".vcf"),t.uploadStarted(!0),this.attachments.push(t),i={Action:"ContactVCardUpload",ContactId:e.idContact(),Global:e.global()?"1":"0",Name:t.fileName()},this.messageUploadAttachmentsStarted(!0),Fi.Ajax.send(i,this.onContactVCardUpload,this))},jt.prototype.onContactVCardUpload=function(e,t){var i=e.Result,s=null;this.messageUploadAttachmentsStarted(!1),i?(s=_.find(this.attachments(),function(e){return e.fileName()===i.Name&&e.uploadStarted()}),s&&s.parseFromUpload(i,e.AccountID)):(s=_.find(this.attachments(),function(e){return e.fileName()===t.Name&&e.uploadStarted()}),s&&s.errorFromUpload())},jt.prototype.requestAttachmentsTempName=function(){var e=_.map(this.attachments(),function(e){return e.uploadUid(e.hash()),e.uploadStarted(!0),e.hash()}),t={Action:"MessageAttachmentsUpload",Attachments:e};e.length>0&&(this.messageUploadAttachmentsStarted(!0),Fi.Ajax.send(t,this.onMessageUploadAttachmentsResponse,this))},jt.prototype.onMessageUploadAttachmentsResponse=function(e,t){var i=t.Attachments;this.messageUploadAttachmentsStarted(!1),e.Result?_.each(e.Result,_.bind(this.setAttachTepmNameByHash,this)):(_.each(i,function(e){var t=_.find(this.attachments(),function(t){return t.hash()===e});t&&t.errorFromUpload()},this),Fi.Api.showError(Ei.i18n("COMPOSE/UPLOAD_ERROR_REPLY_ATTACHMENTS")))},jt.prototype.setAttachTepmNameByHash=function(e,t){_.each(this.attachments(),function(i){i.hash()===e&&(i.tempName(t),i.uploadStarted(!1))})},jt.prototype.setMessageDataInSingleMode=function(e){this.draftInfo(e.draftInfo),this.draftUid(e.draftUid),this.inReplyTo(e.inReplyTo),this.references(e.references),this.setRecipient(this.toAddr,e.toAddr),this.setRecipient(this.ccAddr,e.ccAddr),this.setRecipient(this.bccAddr,e.bccAddr),this.subject(e.subject),this.attachments(_.map(e.attachments,function(e){var t=new ot;return t.parse(e,this.senderAccountId()),t},this)),this.textBody(e.textBody),this.selectedImportance(e.selectedImportance),this.selectedSensitivity(e.selectedSensitivity),this.readingConfirmation(e.readingConfirmation),this.changedInPreviousWindow(e.changedInPreviousWindow),this.oSenderSelector.changeSenderAccountId(e.senderAccountId,e.selectedFetcherOrIdentity),this.focusedField(e.focusedField)},jt.prototype.commit=function(e){this.toAddr.commit(),this.toAddr.valueHasMutated(),this.ccAddr.commit(),this.toAddr.valueHasMutated(),this.bccAddr.commit(),this.toAddr.valueHasMutated(),this.subject.commit(),this.toAddr.valueHasMutated(),this.oHtmlEditor.commit(),this.attachmentsChanged(!1),e||this.changedInPreviousWindow(!1)},jt.prototype.isChanged=function(){return this.toAddr.changed()||this.ccAddr.changed()||this.bccAddr.changed()||this.subject.changed()||this.oHtmlEditor.textChanged()||this.attachmentsChanged()||this.changedInPreviousWindow()
},jt.prototype.executeBackToList=function(){Mi.SingleMode?t.close():this.shown()&&Fi.Routing.setPreviousHash(),this.backToListOnSendOrSave(!1)},jt.prototype.onFileUploadSelect=function(e,t){var i;return Fi.Api.showErrorIfAttachmentSizeLimit(t.FileName,Ei.pInt(t.Size))?!1:(i=new ot,i.onUploadSelect(e,t),this.attachments.push(i),!0)},jt.prototype.getAttachmentByUid=function(e){return _.find(this.attachments(),function(t){return t.uploadUid()===e})},jt.prototype.onFileUploadStart=function(e){var t=this.getAttachmentByUid(e);t&&t.onUploadStart()},jt.prototype.onFileUploadProgress=function(e,t,i){var s=this.getAttachmentByUid(e);s&&s.onUploadProgress(t,i)},jt.prototype.onFileUploadComplete=function(e,t,i){var s=this.getAttachmentByUid(e),o=Date.now().toString();s&&(s.onUploadComplete(e,t,i),"image"===s.type().substr(0,5)&&(s.thumb(!0),s.getInThumbQueue(o)))},jt.prototype.onFileRemove=function(e){var t=this.getAttachmentByUid(e);this.oJua&&this.oJua.cancel(e),this.attachments.remove(t)},jt.prototype.initUploader=function(){this.shown()&&this.composeUploaderButton()&&null===this.oJua&&(this.oJua=new Jua({action:"?/Upload/Attachment/",name:"jua-uploader",queueSize:2,clickElement:this.composeUploaderButton(),hiddenElementsPosition:Ei.isRTL()?"right":"left",dragAndDropElement:this.composeUploaderDropPlace(),disableAjaxUpload:!1,disableFolderDragAndDrop:!1,disableDragAndDrop:!1,hidden:{Token:function(){return Mi.Token},AccountID:function(){return Mi.Accounts.currentId()}}}),this.oJua.on("onDragEnter",_.bind(this.composeUploaderDragOver,this,!0)).on("onDragLeave",_.bind(this.composeUploaderDragOver,this,!1)).on("onBodyDragEnter",_.bind(this.composeUploaderBodyDragOver,this,!0)).on("onBodyDragLeave",_.bind(this.composeUploaderBodyDragOver,this,!1)).on("onProgress",_.bind(this.onFileUploadProgress,this)).on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)),this.allowDragNDrop(this.oJua.isDragAndDropSupported()))},jt.prototype.getSendSaveParameters=function(e){var t=Fi.MessageSender.convertAttachmentsForSending(this.attachments());return _.each(this.oHtmlEditor.uploadedImagePathes(),function(e){t[e.TempName]=[e.Name,e.CID,"1","1"]}),{AccountID:this.senderAccountId(),FetcherID:this.selectedFetcherOrIdentity()&&this.selectedFetcherOrIdentity().FETCHER?this.selectedFetcherOrIdentity().id():"",IdentityID:this.selectedFetcherOrIdentity()&&!this.selectedFetcherOrIdentity().FETCHER?this.selectedFetcherOrIdentity().id():"",DraftInfo:this.draftInfo(),DraftUid:this.draftUid(),To:this.toAddr(),Cc:this.ccAddr(),Bcc:this.bccAddr(),Subject:this.subject(),Text:this.plainText()?this.oHtmlEditor.getPlainText():this.oHtmlEditor.getText(e),IsHtml:this.plainText()?"0":"1",Importance:this.selectedImportance(),Sensivity:this.selectedSensitivity(),ReadingConfirmation:this.readingConfirmation()?"1":"0",Attachments:t,InReplyTo:this.inReplyTo(),References:this.references()}},jt.prototype.onMessageSendOrSaveResponse=function(e,t){var i=Fi.MessageSender.onMessageSendOrSaveResponse(e,t,this.requiresPostponedSending());switch(this.commit(),i.Action){case"MessageSave":i.Result&&t.DraftUid===this.draftUid()&&(this.draftUid(Ei.pString(i.NewUid)),Mi.SingleMode&&Fi.Routing.replaceHashDirectly(Fi.Links.composeFromMessage("drafts",t.DraftFolder,this.draftUid()))),this.saving(!1);break;case"MessageSend":i.Result&&this.backToListOnSendOrSave()&&(Ei.isFunc(this.closeCommand)?this.closeCommand():this.executeBackToList()),this.sending(!1)}},jt.prototype.verifyDataForSending=function(){var e=Ei.getIncorrectEmailsFromAddressString(this.toAddr()),t=Ei.getIncorrectEmailsFromAddressString(this.ccAddr()),i=Ei.getIncorrectEmailsFromAddressString(this.bccAddr()),s=_.union(e,t,i),o=Ei.i18n("COMPOSE/WARNING_INPUT_CORRECT_EMAILS")+s.join(", ");return s.length>0?(Fi.Screens.showPopup(C,[o]),!1):!0},jt.prototype.executeSend=function(e){var t=e===!0;this.isEnableSending()&&this.verifyDataForSending()&&(!t&&this.enableOpenPgp()&&Mi.User.AutosignOutgoingEmails&&!this.pgpSecured()?this.openPgpPopup(!0):(this.sending(!0),this.requiresPostponedSending(!this.allowStartSending()),Fi.MessageSender.send("MessageSend",this.getSendSaveParameters(!0),this.saveMailInSentItems(),!0,this.onMessageSendOrSaveResponse,this,this.requiresPostponedSending())),this.backToListOnSendOrSave(!0))},jt.prototype.executeSaveCommand=function(){this.executeSave(!1)},jt.prototype.executeSave=function(e,t){if(e=Ei.isUnd(e)?!1:e,t=Ei.isUnd(t)?!0:t,!e||!Fi.MailCache.disableComposeAutosave()){var i=Ei.i18n("OPENPGP/CONFIRM_SAVE_ENCRYPTED_DRAFT"),s=Ei.i18n("COMPOSE/TOOL_SAVE"),o=_.bind(function(i){i&&(t?(this.saving(!0),Fi.MessageSender.send("MessageSave",this.getSendSaveParameters(!1),this.saveMailInSentItems(),!e,this.onMessageSendOrSaveResponse,this)):Fi.MessageSender.send("MessageSave",this.getSendSaveParameters(!1),this.saveMailInSentItems(),!e,Fi.MessageSender.onMessageSendOrSaveResponse,Fi.MessageSender))},this);this.isEnableSaving()&&(!e||this.isChanged()?!e&&this.pgpSecured()?Fi.Screens.showPopup(E,[i,o,"",s]):o(!0):e&&this.startAutosaveTimer(),this.backToListOnSendOrSave(!0))}},jt.prototype.changeBccVisibility=function(){this.visibleBcc(!this.visibleBcc()),this.visibleBcc()?this.focusBccAddr():this.focusToAddr(),this.minHeightAdjustTrigger(!0)},jt.prototype.changeCcVisibility=function(){this.visibleCc(!this.visibleCc()),this.visibleCc()?this.focusCcAddr():this.focusToAddr(),this.minHeightAdjustTrigger(!0)},jt.prototype.getMessageDataForSingleMode=function(){var e=_.map(this.attachments(),function(e){return{"@Object":"Object/CApiMailAttachment",FileName:e.fileName(),TempName:e.tempName(),MimeType:e.type(),MimePartIndex:e.mimePartIndex(),EstimatedSize:e.size(),CID:e.cid(),ContentLocation:e.contentLocation(),IsInline:e.inline(),IsLinked:e.linked(),Hash:e.hash()}});return{accountId:this.senderAccountId(),draftInfo:this.draftInfo(),draftUid:this.draftUid(),inReplyTo:this.inReplyTo(),references:this.references(),senderAccountId:this.senderAccountId(),selectedFetcherOrIdentity:this.selectedFetcherOrIdentity(),toAddr:this.toAddr(),ccAddr:this.ccAddr(),bccAddr:this.bccAddr(),subject:this.subject(),attachments:e,textBody:this.oHtmlEditor.getText(),selectedImportance:this.selectedImportance(),selectedSensitivity:this.selectedSensitivity(),readingConfirmation:this.readingConfirmation(),changedInPreviousWindow:this.isChanged(),focusedField:this.focusedField()}},jt.prototype.openInNewWindow=function(){var e="id"+Math.random().toString(),i={},s=null,o="#"+Ci.Screens.SingleCompose;this.closeBecauseSingleCompose(!0),i=this.getMessageDataForSingleMode(),this.draftUid().length>0&&!this.isChanged()?(o=Fi.Routing.buildHashFromArray(Fi.Links.composeFromMessage("drafts",Fi.MailCache.folderList().draftsFolderFullName(),this.draftUid(),!0)),s=Ei.WindowOpener.openTab(o)):this.isChanged()?(t.aMessagesParametersFromCompose||(t.aMessagesParametersFromCompose=[]),t.aMessagesParametersFromCompose[e]=i,s=Ei.WindowOpener.openTab(o,e)):(o=Fi.Routing.buildHashFromArray(_.union([Ci.Screens.SingleCompose],this.routeParams())),s=Ei.WindowOpener.openTab(o)),this.commit(),Ei.isFunc(this.closeCommand)?this.closeCommand():this.executeBackToList()},jt.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e};e=Ei.trim(e),""!==e?Fi.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result&&e.Result.List&&(i=_.map(e.Result.List,function(e){var t="",i=e.Email;return e.IsGroup?t=e.Name&&0<Ei.trim(e.Name).length?'"'+e.Name+'" ('+e.Email+")":"("+e.Email+")":e.Name&&0<Ei.trim(e.Name).length?(t='"'+e.Name+'" <'+e.Email+">",i=t):t=e.Email,{label:t,value:i,frequency:e.Frequency}}),i=_.compact(i)),t(i)},this):t([])},jt.prototype.onShowFilesPopupClick=function(){var e=_.bind(this.addFilesAsAttachment,this);Fi.Screens.showPopup(L,[e])},jt.prototype.onShowGoogleDriveClick=function(){Fi.Screens.showPopup(z,[_.bind(this.googlePickerCallback,this)])},jt.prototype.googlePickerCallback=function(e,t){var i=null,s=[],o={},n=this;_.each(e,function(e){i=(new ot).fileName(e.name).hash(e.id).size(e.sizeBytes).uploadStarted(!0).type(e.mimeType),"image"===i.type().substr(0,5)&&i.thumb(!0),n.attachments.push(i),s.push(e.id)},this),o={Action:"FilesUploadByLink",Links:s,LinksAsIds:!0,AccessToken:t},this.messageUploadAttachmentsStarted(!0),Fi.Ajax.send(o,this.onFilesUpload,this)},jt.prototype.onShowDropBoxClick=function(){var e=null,i=[],s={},o=this,n={success:function(t){_.each(t,function(t){e=(new ot).fileName(t.name).hash(t.link).size(t.bytes).uploadStarted(!0).thumb(!!t.thumbnailLink),o.attachments.push(e),i.push(t.link)},o),s={Action:"FilesUploadByLink",Links:i},o.messageUploadAttachmentsStarted(!0),Fi.Ajax.send(s,o.onFilesUpload,o)},cancel:function(){},linkType:"direct",multiselect:!0};this.allowDropbox&&t.Dropbox&&t.Dropbox.choose(n)},jt.prototype.confirmOpenPgp=function(){var e=Ei.i18n("OPENPGP/CONFIRM_HTML_TO_PLAIN_FORMATTING"),t=_.bind(function(e){e&&this.openPgpPopup(!1)},this);this.notInlineAttachments().length>0&&(e+="\r\n\r\n"+Ei.i18n("OPENPGP/CONFIRM_HTML_TO_PLAIN_ATTACHMENTS")),Fi.Screens.showPopup(E,[e,t])},jt.prototype.openPgpPopup=function(e){var t=this.oHtmlEditor.getPlainText(),i=_.bind(function(t,i){e||(this.stopAutosaveTimer(),this.executeSave(!0)),this.plainText(!0),this.textBody(t),this.pgpSecured(!0),this.pgpEncrypted(i),e&&this.executeSend(!0)},this),s=_.bind(function(){e&&this.executeSend(!0)},this);Fi.Screens.showPopup(Y,[t,Mi.Accounts.getEmail(this.senderAccountId()),this.recipientEmails(),e,i,s])},jt.prototype.undoPgp=function(){var e=this.textBody(),t=[];this.pgpSecured()&&(this.plainText(!1),this.fromDrafts()&&!this.pgpEncrypted()?(t=e.split("-----BEGIN PGP SIGNED MESSAGE-----"),2===t.length&&(e=t[1]),t=e.split("-----BEGIN PGP SIGNATURE-----"),2===t.length&&(e=t[0]),t=e.split("\r\n\r\n"),t.length>0&&(t.shift(),e=t.join("\r\n\r\n")),e="<div>"+e.replace(/\r\n/gi,"<br />")+"</div>",this.textBody(e)):this.oHtmlEditor.undoAndClearRedo(),this.pgpSecured(!1),this.pgpEncrypted(!1))},jt.prototype.getSocialAccounts=function(){var e=Ei.emptyFunction();this.googleConnected(!1),this.dropboxConnected(!1),_.each(Mi.User.SocialAccounts(),function(t){"Object/CSocial"===t["@Object"]&&_.indexOf(t.Scopes,"filestorage")>=0&&Ei.isFunc(this[t.Type+"Connected"])&&(e=this[t.Type+"Connected"])(!0)},this)},Vt.prototype.changeSelectedSender=function(e){if(e){var t=Ei.pString(e.id());e.FETCHER&&(t="fetcher"+t),_.find(this.senderList(),function(e){return e.id===t})&&(this.lockSelectedSender(!0),this.selectedSender(t),this.selectedFetcherOrIdentity(e),this.lockSelectedSender(!1))}},Vt.prototype.changeSenderAccountId=function(e,t){var i=!1;this.senderAccountId()!==e&&(Mi.Accounts.hasAccountWithId(e)?(this.senderAccountId(e),i=!0):Mi.Accounts.hasAccountWithId(this.senderAccountId())||(this.senderAccountId(Mi.Accounts.currentId()),i=!0)),(i||0===this.senderList().length)&&(this.fillSenderList(t),i=!0),!i&&t&&this.changeSelectedSender(t)},Vt.prototype.fillSenderList=function(e){var t=[],i=Mi.Accounts.getAccount(this.senderAccountId());i&&(_.isArray(i.identities())&&_.each(i.identities(),function(e){e.enabled()&&t.push({fullEmail:e.fullEmail(),id:Ei.pString(e.id())})},this),i.identitiesSubscribtion||(i.identitiesSubscribtion=i.identities.subscribe(function(){this.fillSenderList(e),this.changeSelectedSender(i.getDefaultIdentity())},this)),i.fetchers()?_.each(i.fetchers().collection(),function(e){var i=e.fullEmail();e.isOutgoingEnabled()&&i.length>0&&t.push({fullEmail:i,id:"fetcher"+e.id()})},this):i.fetchersSubscribtion||(i.fetchersSubscribtion=i.fetchers.subscribe(function(){this.fillSenderList(e)},this))),this.senderList(t),this.changeSelectedSender(e)},Vt.prototype.setFetcherOrIdentityByReplyMessage=function(e){var t=e.oTo.aCollection.concat(e.oCc.aCollection),i=Fi.MessageSender.getFirstFetcherOrIdentityByRecipientsOrDefault(t,e.accountId());i&&this.changeSelectedSender(i)},Ei.extend(Kt,jt),Kt.prototype.popupTemplate=function(){return"Popups_ComposePopupViewModel"},Kt.prototype.onShow=function(e){if(e=e||[],1===e.length&&"close"===e[0])this.closeCommand();else{var t=3===e.length&&"drafts"===e[0]&&e[2]===this.draftUid();this.maximize(),this.shown()?(e.length>0&&!t&&(this.hasSomethingToSave()?(this.stopAutosaveTimer(),Fi.Screens.showPopup(A,[_.bind(function(t){switch(t){case Ci.AnotherMessageComposedAnswer.Discard:this.onRoute(e);break;case Ci.AnotherMessageComposedAnswer.SaveAsDraft:this.hasSomethingToSave()&&this.executeSave(!0,!1),this.onRoute(e);break;case Ci.AnotherMessageComposedAnswer.Cancel:}this.startAutosaveTimer()},this)])):this.onRoute(e)),this.oHtmlEditor.oCrea.clearUndoRedo()):(jt.prototype.onShow.call(this),this.onRoute(e))}},Kt.prototype.minimize=function(){this.minimized(!0),Kt.__dom.addClass("minimized"),this.minHeightRemoveTrigger(!0)},Kt.prototype.maximize=function(){this.minimized(!1),Kt.__dom.removeClass("minimized"),this.minHeightAdjustTrigger(!0)},Kt.prototype.saveAndClose=function(){this.hasSomethingToSave()&&this.saveCommand(),this.closeCommand()},Kt.prototype.onCancelClick=function(){this.hasSomethingToSave()?this.minimize():this.closeCommand()},Kt.prototype.onEscHandler=function(e){var t=this.oHtmlEditor.hasOpenedPopup(),i=!Fi.browser.ie&&e.target&&"input"===e.target.tagName.toLowerCase()&&"file"===e.target.type.toLowerCase();i&&e.target.blur(),1!==Fi.Screens.popups.length||t||i||this.minimize(),t&&this.oHtmlEditor.closeAllPopups()},Wt.prototype.onApplyBindings=function(t){this.oJua=new Jua({action:"?/Upload/Contacts/",name:"jua-uploader",queueSize:1,clickElement:e("#jue_import_button",t),hiddenElementsPosition:Ei.isRTL()?"right":"left",disableAjaxUpload:!1,disableDragAndDrop:!0,disableMultiple:!0,hidden:{Token:function(){return Mi.Token},AccountID:function(){return Mi.Accounts.currentId()}}}),this.oJua.on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this))},Wt.prototype.onFileUploadStart=function(){this.importing(!0)},Wt.prototype.onFileUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1,o=0;this.importing(!1),this.oParent.requestContactList(),s?Fi.Api.showError(i.ErrorCode&&i.ErrorCode===Ci.Errors.IncorrectFileExtension?Ei.i18n("CONTACTS/ERROR_INCORRECT_FILE_EXTENSION"):Ei.i18n("WARNING/ERROR_UPLOAD_FILE")):(o=Ei.pInt(i.Result.ImportedCount),o>0?Fi.Api.showReport(Ei.i18n("CONTACTS/CONTACT_IMPORT_HINT_PLURAL",{NUM:o},null,o)):Fi.Api.showError(Ei.i18n("WARNING/CONTACTS_IMPORT_NO_CONTACTS")))},qt.prototype.groupDropdownToggle=function(e){this.currentGroupDropdown(e)},qt.prototype.gotoGroupList=function(){this.changeSelectedPanel(Ci.MobilePanel.Groups)},qt.prototype.gotoContactList=function(){return this.changeSelectedPanel(Ci.MobilePanel.Items),!0},qt.prototype.gotoViewPane=function(){this.changeSelectedPanel(Ci.MobilePanel.View)},qt.prototype.backToContactList=function(){var e=this.selectedGroupType(),t=e===Ci.ContactsGroupListType.SubGroup?this.currentGroupId():"";Fi.Routing.setHash(Fi.Links.contacts(e,t,this.search(),this.oPageSwitcher.currentPage()))},qt.prototype.changeSelectedPanel=function(e){this.mobileApp&&this.selectedPanel(e)},qt.prototype.executeSave=function(e){var t={},i=[];e===this.selectedItem()&&this.selectedItem().canBeSave()?e instanceof ut&&!e.readOnly()?(_.each(this.groupFullCollection(),function(e){e&&e.checked()&&i.push(e.Id())}),e.groups(i),t=e.toObject(),t.Action=e.isNew()?"ContactCreate":"ContactUpdate",t.SharedToAll=e.isNew()?Ci.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0":e.sharedToAll()?"1":"0",e.edited()&&e.edited(!1),e.isNew()&&this.selectedItem(null),(this.selectedGroupType()===Ci.ContactsGroupListType.Global||this.selectedGroupType()===Ci.ContactsGroupListType.All)&&this.recivedAnimUnshare(!0),Fi.Ajax.send(t,this.onContactCreateResponse,this)):e instanceof dt&&!e.readOnly()&&(t=e.toObject(),t.Action=e.isNew()?"ContactsGroupCreate":"ContactsGroupUpdate",this.gotoGroupList(),e.edited()&&e.edited(!1),e.isNew()&&!this.mobileApp&&this.selectedItem(null),Fi.Ajax.send(t,this.onGroupCreateResponse,this)):Fi.Api.showError(Ei.i18n("CONTACTS/ERROR_EMPTY_CONTACT"))},qt.prototype.executeNewContact=function(){if(this.showPersonalContacts()){var e=this.selectedGroupInList();this.oContactModel.switchToNew(),this.oContactModel.groups(e?[e.Id()]:[]),this.selectedItem(this.oContactModel),this.selector.itemSelected(null),this.gotoViewPane()}},qt.prototype.executeNewGroup=function(){this.oGroupModel.switchToNew(),this.selectedItem(this.oGroupModel),this.selector.itemSelected(null),this.gotoViewPane()},qt.prototype.executeDelete=function(){var e=this.selectedGroupType();if(e===Ci.ContactsGroupListType.Personal||e===Ci.ContactsGroupListType.SharedToAll){var t=_.filter(this.selector.listCheckedOrSelected(),function(e){return!e.ReadOnly()}),i=t.length,s=Ei.i18n("CONTACTS/CONFIRM_DELETE_CONTACT_PLURAL",{},null,i),o=_.bind(function(e){e&&this.deleteContacts(t)},this);Fi.Screens.showPopup(E,[s,o])}else e===Ci.ContactsGroupListType.SubGroup&&this.removeFromGroupCommand()},qt.prototype.deleteContacts=function(e){var t=this,i=this.selectedContact(),s=_.map(e,function(e){return e.Id()});0<s.length&&(this.preLoadingList(!0),_.each(e,function(e){e&&(Fi.ContactsCache.clearInfoAboutEmail(e.Email()),!i||e.IsGroup()||e.ReadOnly()||i.readOnly()||i.idContact()!==e.Id()||(i=null,this.selectedContact(null)))},this),_.each(this.collection(),function(t){-1<Ei.inArray(t,e)&&t.deleted(!0)}),_.delay(function(){t.collection.remove(function(e){return e.deleted()})},500),Fi.Ajax.send({Action:"ContactDelete",ContactsId:s.join(","),SharedToAll:Ci.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0"},this.requestContactList,this),Fi.ContactsCache.markVcardsNonexistentByUid(s))},qt.prototype.executeRemoveFromGroup=function(){var e=this,t=this.selectedGroupInList(),i=this.selector.listCheckedOrSelected(),s=_.map(i,function(e){return e.ReadOnly()?"":e.Id()});s=_.compact(s),t&&0<s.length&&(this.preLoadingList(!0),_.each(this.collection(),function(e){-1<Ei.inArray(e,i)&&e.deleted(!0)}),_.delay(function(){e.collection.remove(function(e){return e.deleted()})},500),Fi.Ajax.send({Action:"ContactsRemoveFromGroup",GroupId:t.Id(),ContactsId:s.join(",")},this.requestContactList,this))},qt.prototype.executeImport=function(){this.selectedItem(null),this.oContactImportViewModel.visibility(!0),this.selector.itemSelected(null),this.selectedGroupType(Ci.ContactsGroupListType.Personal),this.gotoViewPane()},qt.prototype.executeCSVExport=function(){Fi.Api.downloadByUrl(Ei.getExportContactsLink("csv"))},qt.prototype.executeVCFExport=function(){Fi.Api.downloadByUrl(Ei.getExportContactsLink("vcf"))},qt.prototype.executeCancel=function(){var e=this.selectedItem();e&&(e instanceof ut&&!e.readOnly()?e.isNew()?this.selectedItem(null):e.edited()&&e.edited(!1):e instanceof dt&&!e.readOnly()&&(e.isNew()?this.selectedItem(null):e.edited()&&(this.selectedItem(this.selectedOldItem()),e.edited(!1)),this.gotoGroupList())),this.oContactImportViewModel.visibility(!1)},qt.prototype.executeAddContactsToGroup=function(e,t){e&&_.isArray(t)&&0<t.length&&(e.recivedAnim(!0),this.executeAddContactsToGroupId(e.Id(),t))},qt.prototype.executeAddContactsToGroupId=function(e,t){e&&_.isArray(t)&&0<t.length&&Fi.Ajax.send({Action:"ContactsAddToGroup",GroupId:e,ContactsId:t},this.onContactsAddToGroupResponse,this)},qt.prototype.onContactsAddToGroupResponse=function(){this.requestContactList(),this.selector.itemSelected()&&this.requestContact(this.selector.itemSelected().sId)},qt.prototype.executeAddSelectedContactsToGroup=function(e){var t=this.selector.listCheckedOrSelected(),i=[];e&&_.isArray(t)&&0<t.length&&_.each(t,function(e){e&&!e.IsGroup()&&i.push([e.Id(),e.Global()?"1":"0"])},this),this.executeAddContactsToGroup(e,i)},qt.prototype.groupsInContactView=function(e){var t=[],i=[];return e&&!e.groupsIsEmpty()&&(i=e.groups(),t=_.filter(this.groupFullCollection(),function(e){return 0<=Ei.inArray(e.Id(),i)})),t},qt.prototype.onShow=function(){this.selector.useKeyboardKeys(!0),this.oPageSwitcher.show(),this.oPageSwitcher.perPage(Mi.User.ContactsPerPage),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},qt.prototype.onHide=function(){this.selector.listCheckedOrSelected(!1),this.selector.useKeyboardKeys(!1),this.selectedItem(null),this.oPageSwitcher.hide(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},qt.prototype.onApplyBindings=function(){this.selector.initOnApplyBindings(".contact_sub_list .item",".contact_sub_list .selected.item",".contact_sub_list .item .custom_checkbox",e(".contact_list",this.$viewModel),e(".contact_list_scroll.scroll-inner",this.$viewModel));var t=this;this.$viewModel.on("click",".content .item.add_to .dropdown_helper .item",function(){e(this).hasClass("new-group")?t.executeNewGroup():t.executeAddSelectedContactsToGroup(i.dataFor(this))}),this.showPersonalContacts(!!Mi.User.ShowPersonalContacts),this.showGlobalContacts(!!Mi.User.ShowGlobalContacts),this.showSharedToAllContacts(!!Mi.App.AllowContactsSharing),this.selectedGroupType.valueHasMutated(),this.oContactImportViewModel.onApplyBindings(this.$viewModel),this.requestGroupFullList(),this.hotKeysBind(),this.initUploader()},qt.prototype.hotKeysBind=function(){var t=!1;e(document).on("keydown",_.bind(function(e){var i=e.keyCode,s=this.collection()[0],o=this.isSearchFocused(),n=!1,r=Fi.Screens.currentScreen()===Ci.Screens.Contacts;r&&!Ei.isTextFieldFocused()&&!o&&e&&i===Ci.Key.s?(e.preventDefault(),this.searchFocus()):s&&(n=s.selected(),s&&o&&e&&i===Ci.Key.Down?(this.isSearchFocused(!1),this.selector.itemSelected(s),t=!0):!o&&t&&n&&e&&i===Ci.Key.Up?(this.isSearchFocused(!0),this.selector.itemSelected(!1),t=!1):n?t=!0:n||(t=!1))},this))},qt.prototype.requestContactList=function(){this.loadingList(!0),Fi.Ajax.send({Action:Ci.ContactsGroupListType.Global===this.selectedGroupType()?"ContactGlobalList":"ContactList",Offset:(this.oPageSwitcher.currentPage()-1)*Mi.User.ContactsPerPage,Limit:Mi.User.ContactsPerPage,SortField:this.sortType(),SortOrder:this.sortOrder()?"1":"0",Search:this.search(),GroupId:this.selectedGroupInList()?this.selectedGroupInList().Id():"",SharedToAll:Ci.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0",All:Ci.ContactsGroupListType.All===this.selectedGroupType()?"1":"0"},this.onContactListResponse,this)},qt.prototype.requestGroupFullList=function(){Fi.Ajax.send({Action:"ContactsGroupFullList"},this.onGroupListResponse,this)},qt.prototype.requestContact=function(e){this.loadingViewPane(!0);var t=_.find(this.collection(),function(t){return t.sId===e});t&&(this.selector.itemSelected(t),Fi.Ajax.send({Action:t.Global()?"ContactGlobal":"ContactGet",ContactId:t.Id(),SharedToAll:t.IsSharedToAll()?"1":"0"},this.onContactGetResponse,this))},qt.prototype.requestContactById=function(e,t){this.loadingViewPane(!0),e&&Fi.Ajax.send({Action:t?"ContactGlobal":"ContactGet",ContactId:e},this.onContactGetResponse,this)},qt.prototype.editGroup=function(e){var t=new dt;t.populate(e),this.selectedOldItem(t),e.edited(!0)},qt.prototype.changeGroupType=function(e){Fi.Routing.setHash(Fi.Links.contacts(e))},qt.prototype.onViewGroupClick=function(e){Fi.Routing.setHash(Fi.Links.contacts(Ci.ContactsGroupListType.SubGroup,e.Id()))},qt.prototype.onRoute=function(e){var t=Fi.Links.parseContacts(e),i=[Ci.ContactsGroupListType.Personal,Ci.ContactsGroupListType.SharedToAll,Ci.ContactsGroupListType.Global,Ci.ContactsGroupListType.All],s=this.selectedGroupType()===Ci.ContactsGroupListType.SubGroup?this.currentGroupId():"",o=this.selectedGroupType()!==t.Type||s!==t.GroupId||this.search()!==t.Search,n=!0,r=!1;this.pageSwitcherLocked(!0),o?this.oPageSwitcher.clear():this.oPageSwitcher.setPage(t.Page,Mi.User.ContactsPerPage),this.pageSwitcherLocked(!1),t.Page!==this.oPageSwitcher.currentPage()&&Fi.Routing.replaceHash(Fi.Links.contacts(t.Type,t.GroupId,t.Search,this.oPageSwitcher.currentPage())),this.currentPage()!==t.Page&&(this.currentPage(t.Page),r=!0),-1!==Ei.inArray(t.Type,i)?this.selectedGroupType(t.Type):s!==t.GroupId&&(n=this.viewGroup(t.GroupId),n?r=!1:Fi.Routing.replaceHash(Fi.Links.contacts())),this.search()!==t.Search&&(this.search(t.Search),r=!0),this.contactUidForRequest(""),t.Uid?0===this.collection().length?this.contactUidForRequest(t.Uid):this.requestContact(t.Uid):(this.selector.itemSelected(null),this.gotoContactList()),r&&this.requestContactList()},qt.prototype.viewGroup=function(e){var t=_.find(this.groupFullCollection(),function(t){return t&&t.Id()===e});return t&&(this.oGroupModel.clear(),this.oGroupModel.idGroup(t.Id()).name(t.Name()),t.IsOrganization()&&this.requestGroup(t),this.selectedGroupInList(t),this.selectedItem(this.oGroupModel),this.selector.itemSelected(null),this.selector.listCheckedOrSelected(!1),Fi.Ajax.send({Action:"ContactsGroupEvents",GroupId:e},this.onGroupEventsResponse,this)),!!t},qt.prototype.deleteGroup=function(e){e&&(Fi.Ajax.send({Action:"ContactsGroupDelete",GroupId:e},this.requestGroupFullList,this),this.selectedGroupType(Ci.ContactsGroupListType.Personal),this.groupFullCollection.remove(function(t){return t&&t.Id()===e}))},qt.prototype.mailGroup=function(e){e&&Fi.Ajax.send({Action:"ContactList",Offset:0,Limit:99,SortField:Ci.ContactSortType.Email,SortOrder:"1",GroupId:e.idGroup()},function(e){if(e&&e.Result&&e.Result.List){var t=0,i=0,s=[],o=null,n=[],r=e.Result.List;for(i=r.length;i>t;t++)r[t]&&"Object/CContactListItem"===Ei.pExport(r[t],"@Object","")&&(o=new pt,o.parse(r[t]),n.push(o));s=_.map(n,function(e){return e.EmailAndName()}),s=_.compact(s),Fi.Api.composeMessageToAddresses(s.join(", "))}},this)},qt.prototype.dragAndDropHelper=function(t){t&&t.checked(!0);var i=this.selector.itemSelected(),s=Ei.draggableMessages(),o=this.selector.listCheckedOrSelected().length,n=o>0?_.map(this.selector.listCheckedOrSelected(),function(e){return[e.Id(),e.Global()?"1":"0"]}):[];return i&&!i.checked()&&i.checked(!0),s.data("p7-contatcs-type",this.selectedGroupType()),s.data("p7-contatcs-uids",n),e(".count-text",s).text(Ei.i18n("CONTACTS/DRAG_TEXT_PLURAL",{COUNT:o},null,o)),s},qt.prototype.contactsDrop=function(e,t,i){if(e){var s=i&&i.helper?i.helper:null,o=s?s.data("p7-contatcs-uids"):null;null!==o&&(Ei.uiDropHelperAnim(t,i),this.executeAddContactsToGroup(e,o))}},qt.prototype.contactsDropToGroupType=function(e,t,i){var s=i&&i.helper?i.helper:null,o=s?s.data("p7-contatcs-type"):null,n=s?s.data("p7-contatcs-uids"):null;e!==o&&null!==o&&null!==n&&(Ei.uiDropHelperAnim(t,i),this.executeShare())},qt.prototype.searchFocus=function(){this.selector.useKeyboardKeys()&&!Ei.isTextFieldFocused()&&this.isSearchFocused(!0)},qt.prototype.onContactDblClick=function(){var e=this.selectedContact();e&&Fi.Api.composeMessageToAddresses(e.email())},qt.prototype.onClearSearchClick=function(){this.searchInput(""),this.searchSubmitCommand()},qt.prototype.onContactGetResponse=function(e){if(e&&e.Action&&e.Result){var t=new ut,i=this.selector.itemSelected();t.parse(e.Result),i&&i.Id()===t.idContact()&&this.selectedItem(t)}},qt.prototype.onContactCreateResponse=function(e){e&&e.Action&&e.Result&&(Fi.Api.showReport(Ei.i18n("ContactCreate"===e.Action?"CONTACTS/REPORT_CONTACT_SUCCESSFULLY_ADDED":"CONTACTS/REPORT_CONTACT_SUCCESSFULLY_UPDATED")),this.requestContactList())},qt.prototype.onContactListResponse=function(e){if(e&&e.Action&&e.Result){var t=0,i=0,s=[],o="ContactGlobalList"===e.Action,n=this.selector.itemSelected(),r=null,a=this.selector.listChecked(),l=a&&0<a.length?_.map(a,function(e){return e.Id()}):[],h=null;for(i=e.Result.List.length;i>t;t++)e.Result.List[t]&&"Object/CContactListItem"===Ei.pExport(e.Result.List[t],"@Object","")&&(h=new pt,h.parse(e.Result.List[t],o),s.push(h));n&&(r=_.find(s,function(e){return n.Id()===e.Id()})),l&&0<l.length&&_.each(s,function(e){e.checked(-1<Ei.inArray(e.Id(),l))}),this.collection(s),this.loadingList(!1),this.oPageSwitcher.setCount(Ei.pInt(e.Result.ContactCount)),r&&(this.selector.itemSelected(r),this.requestContact(n.Id())),this.selectedGroupContactsList(e.Result.List),n&&this.requestContact(n.Id())}},qt.prototype.viewAllMails=function(){var e=this.selectedGroupContactsList(),t="email:";e&&(_.each(e,function(e){_.each(e.Emails,function(e){t=t+e+","})}),Fi.MailCache.searchMessagesInInbox(t))},qt.prototype.onGroupListResponse=function(e){if(e&&e.Action&&e.Result){var t=0,i=0,s=[],o=_.find(this.groupFullCollection(),function(e){return e.selected()}),n=null;for(this.groupFullCollection(s),i=e.Result.length;i>t;t++)e.Result[t]&&"Object/CContactListItem"===Ei.pExport(e.Result[t],"@Object","")&&(n=new pt,n.parse(e.Result[t]),n.IsGroup()&&(o&&o.Id()===n.Id()&&this.selectedGroupInList(n),s.push(n)));this.groupFullCollection(s)}},qt.prototype.onGroupCreateResponse=function(e){if(e&&e.Action&&e.Result){var t=_.map(this.selector.listChecked(),function(e){return[e.Id(),e.Global()?"1":"0"]});this.executeAddContactsToGroupId(e.Result.IdGroup,t),this.mobileApp||(this.selectedItem(null),this.selector.itemSelected(null)),Fi.Api.showReport(Ei.i18n("CONTACTS/REPORT_GROUP_SUCCESSFULLY_ADDED")),this.requestContactList(),this.requestGroupFullList()}},qt.prototype.executeShare=function(){var e=this,t=this.selector.listCheckedOrSelected(),i=this.selectedContact(),s=_.map(t,function(e){return e.ReadOnly()?"":e.Id()});s=_.compact(s),0<s.length&&(_.each(t,function(e){e&&(Fi.ContactsCache.clearInfoAboutEmail(e.Email()),!i||e.IsGroup()||e.ReadOnly()||i.readOnly()||i.idContact()!==e.Id()||(i=null,this.selectedContact(null)))},this),_.each(this.collection(),function(e){-1<Ei.inArray(e,t)&&e.deleted(!0)}),_.delay(function(){e.collection.remove(function(e){return e.deleted()})},500),Ci.ContactsGroupListType.SharedToAll===this.selectedGroupType()?this.recivedAnimUnshare(!0):this.recivedAnimShare(!0),Fi.Ajax.send({Action:"ContactUpdateSharedToAll",ContactsId:s.join(","),SharedToAll:Ci.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0"},this.onContactUpdateSharedToAllResponse,this))},qt.prototype.onContactUpdateSharedToAllResponse=function(){},qt.prototype.requestGroup=function(e){this.loadingViewPane(!0),e&&Fi.Ajax.send({Action:"ContactsGroup",GroupId:e.Id()},this.onGroupResponse,this)},qt.prototype.onGroupResponse=function(e){if(e&&e.Action&&e.Result){var t=e.Result;this.oGroupModel.idGroup(t.IdGroup).name(t.Name).isOrganization(t.IsOrganization).company(t.Company).country(t.Country).state(t.State).city(t.City).street(t.Street).zip(t.Zip).phone(t.Phone).fax(t.Fax).email(t.Email).web(t.Web)}},qt.prototype.onGroupEventsResponse=function(e){if(e&&e.Action&&e.Result){var t=e.Result;this.oGroupModel.events(t)}},qt.prototype.reload=function(){this.requestContactList()},qt.prototype.initUploader=function(){var e=this;this.uploaderArea()&&(this.oJua=new Jua({action:"?/Upload/Contacts/",name:"jua-uploader",queueSize:2,dragAndDropElement:this.uploaderArea(),disableAjaxUpload:this.isPublic,disableFolderDragAndDrop:this.isPublic,disableDragAndDrop:this.isPublic,hidden:{Token:function(){return Mi.Token},AccountID:function(){return Mi.Accounts.currentId()},AdditionalData:function(){return JSON.stringify({GroupId:e.selectedGroupType()===Ci.ContactsGroupListType.SubGroup?e.currentGroupId():0,IsShared:e.selectedGroupType()===Ci.ContactsGroupListType.SharedToAll})}}}),this.oJua.on("onComplete",_.bind(this.onContactUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)))},qt.prototype.onContactUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1;s?i.ErrorCode?Fi.Api.showErrorByCode(i,Ei.i18n("The file must have .CSV or .VCF extension.")):Fi.Api.showError(Ei.i18n("WARNING/UNKNOWN_ERROR")):this.reload()},Yt.prototype.onHide=function(e){var t=null,i=this.tab();this.confirmSaving(i),t=this.getCurrentViewModel(),t&&Ei.isFunc(t.onHide)&&t.onHide(e),Ri.removeClass("non-adjustable")},Yt.prototype.onApplyBindings=function(){_.each(this.aTabs,function(e){e&&Ei.isFunc(e.onApplyBindings)&&e.onApplyBindings()
})},Yt.prototype.onShow=function(e){var t=this.getCurrentViewModel();t&&Ei.isFunc(t.onShow)&&t.onShow(e),Ri.addClass("non-adjustable")},Yt.prototype.viewTab=function(e){var t=this.getViewModel(Ci.SettingsTab.Common),i=t?Ci.SettingsTab.Common:Ci.SettingsTab.EmailAccounts,s=this.getViewModel(e),o=-1===Ei.inArray(e,Ci.SettingsTab);e=s&&o?e:i,this.tab(e)},Yt.prototype.onRoute=function(e){var t=null,i=this.tab();i=_.isArray(e)&&e.length>0?e[0]:Ci.SettingsTab.Common,this.tab()!==i&&(t=this.getCurrentViewModel(),t&&Ei.isFunc(t.onHide)&&t.onHide(e),this.confirmSaving(this.tab())),this.viewTab(i),t=this.getCurrentViewModel(),t&&Ei.isFunc(t.onRoute)&&t.onRoute(e)},Yt.prototype.confirmSaving=function(e){var t=this.getViewModel(e),i=_.bind(function(e){t&&(e?t.onSaveClick&&t.onSaveClick():t.init&&t.init())},this);t&&Ei.isFunc(t.isChanged)&&t.isChanged()&&Fi.Screens.showPopup(E,[Ei.i18n("SETTINGS/CONFIRM_SETTINGS_SAVE"),i,"",Ei.i18n("SETTINGS/BUTTON_SAVE"),Ei.i18n("SETTINGS/BUTTON_DISCARD")])},Yt.prototype.getViewModel=function(e){return _.find(this.aTabs,function(t){return t.TabName===e})},Yt.prototype.getCurrentViewModel=function(){return this.getViewModel(this.tab())},Yt.prototype.showTab=function(e){Fi.Routing.setHash([Ci.Screens.Settings,e])},Yt.prototype.onResponseFolderChanges=function(e){e.Result||(Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")),Fi.MailCache.getFolderList(Mi.Accounts.editedId()))},Yt.prototype.onResponseFolderRename=function(e,t){t&&t.Result?t&&e&&t.Result&&!Ei.isUnd(t.Result.FullName)&&(e.fullName(t.Result.FullName),e.fullNameHash(t.Result.FullNameHash)):(Fi.Api.showErrorByCode(t,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")),Fi.MailCache.getFolderList(Mi.Accounts.editedId()))},Yt.prototype.deleteFolder=function(e,t,i){var s={Action:"FolderDelete",AccountID:Mi.Accounts.editedId(),Folder:e.fullName()};i&&t&&e&&(t.remove(function(t){return e.fullName()===t.fullName()?!0:!1}),Fi.Ajax.send(s,this.onResponseFolderChanges,this))},Yt.prototype.onSubscribeFolderClick=function(e){var t={Action:"FolderSubscribe",AccountID:Mi.Accounts.editedId(),Folder:e.fullName(),SetAction:e.subscribed()?0:1};e&&e.canSubscribe()&&(e.subscribed(!e.subscribed()),Fi.Ajax.send(t,this.onResponseFolderChanges,this))},Yt.prototype.onDeleteFolderClick=function(e,t){var i=Ei.i18n("SETTINGS/ACCOUNT_FOLDERS_CONFIRMATION_DELETE"),s=this.getCollectionFromParent(t),o=_.bind(this.deleteFolder,this,e,s),n=this.getViewModel(Ci.SettingsTab.EmailAccounts);e&&e.canDelete()?Fi.Screens.showPopup(E,[i,o]):n&&n.oAccountFolders.highlighted(!0)},Yt.prototype.folderEditOnEnter=function(e){if(e.name()!==e.nameForEdit()){var t={Action:"FolderRename",AccountID:Mi.Accounts.editedId(),PrevFolderFullNameRaw:e.fullName(),NewFolderNameInUtf8:e.nameForEdit()};Fi.Ajax.send(t,_.bind(this.onResponseFolderRename,this,e),this),e.name(e.nameForEdit())}e.edited(!1)},Yt.prototype.folderEditOnEsc=function(e){e.edited(!1)},Yt.prototype.getCollectionFromParent=function(e){return e.subfolders?e.subfolders:e.collection},Yt.prototype.canMoveFolderUp=function(e,t,i){var s=this.getCollectionFromParent(i),o=s()[t-1],n="";return t>0&&o&&(n=s()[t-1].fullName()),0!==t&&e&&e.fullName()!==Fi.MailCache.editedFolderList().inboxFolderFullName()&&Fi.MailCache.editedFolderList().inboxFolderFullName()!==n},Yt.prototype.canMoveFolderDown=function(e,t,i){var s=this.getCollectionFromParent(i);return t!==s().length-1&&e.fullName()!==Fi.MailCache.editedFolderList().inboxFolderFullName()},Yt.prototype.moveFolderUp=function(e,t,i){var s=this.getCollectionFromParent(i);this.canMoveFolderUp(e,t,i)&&s&&(s.splice(t,1),s.splice(t-1,0,e),this.folderListOrderUpdateDebounce())},Yt.prototype.moveFolderDown=function(e,t,i){var s=this.getCollectionFromParent(i);this.canMoveFolderDown(e,t,i)&&s&&(s.splice(t,1),s.splice(t+1,0,e),this.folderListOrderUpdateDebounce())},Yt.prototype.afterSortableFolderMove=function(){this.folderListOrderUpdateDebounce()},Yt.prototype.folderListOrderUpdate=function(){var e=Fi.MailCache.editedFolderList().getOptions("",!1,!1,!1),t={Action:"FoldersUpdateOrder",AccountID:Mi.Accounts.editedId(),FolderList:_.compact(_.map(e,function(e){return e&&e.fullName?e.fullName:null}))};Fi.Ajax.send(t,this.onResponseFolderChanges,this)},zt.prototype.TemplateName="Settings_CommonSettingsViewModel",zt.prototype.TabName=Ci.SettingsTab.Common,zt.prototype.TabTitle=Ei.i18n("SETTINGS/TAB_COMMON"),zt.prototype.onApplyBindings=function(){this.init(),this.updateFirstState()},zt.prototype.setMessagesPerPage=function(e){var t=this.rangeOfNumbers;-1===_.indexOf(t,e)&&(t=_.sortBy(_.union(t,[e]),function(e){return e},this)),this.messagesPerPageValues(t),this.messagesPerPage(e)},zt.prototype.setContactsPerPage=function(e){var t=this.rangeOfNumbers;-1===_.indexOf(t,e)&&(t=_.sortBy(_.union(t,[e]),function(e){return e},this)),this.contactsPerPageValues(t),this.contactsPerPage(e)},zt.prototype.init=function(){this.selectedSkin(Mi.User.DefaultTheme),this.selectedLanguage(Mi.User.DefaultLanguage),this.setMessagesPerPage(Mi.User.MailsPerPage),this.setContactsPerPage(Mi.User.ContactsPerPage),this.autocheckmailInterval(Mi.User.AutoCheckMailInterval),this.timeFormat(Mi.User.defaultTimeFormat()),this.dateFormat(Mi.User.DefaultDateFormat),this.useThreads(Mi.User.useThreads()),this.saveRepliedToCurrFolder(Mi.User.SaveRepliedToCurrFolder),this.allowChangeInputDirection(Mi.User.AllowChangeInputDirection),this.desktopNotifications(Mi.User.DesktopNotifications)},zt.prototype.getState=function(){var e=[this.selectedSkin(),this.selectedLanguage(),this.messagesPerPage(),this.contactsPerPage(),this.autocheckmailInterval(),this.timeFormat(),this.dateFormat(),this.useThreads(),this.saveRepliedToCurrFolder(),this.allowChangeInputDirection(),this.desktopNotifications()];return e.join(":")},zt.prototype.updateFirstState=function(){this.firstState=this.getState()},zt.prototype.isChanged=function(){return this.firstState&&this.getState()!==this.firstState?!0:!1},zt.prototype.onResponse=function(e,i){var s=!1;this.loading(!1),e.Result===!1?Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):(Fi.CalendarCache.calendarSettingsChanged(!0),s=i.DefaultTheme!==Mi.User.DefaultTheme||i.DefaultLanguage!==Mi.User.DefaultLanguage,s?t.location.reload():(this.setMessagesPerPage(i.MailsPerPage),this.setContactsPerPage(i.ContactsPerPage),Mi.User.updateCommonSettings(i.MailsPerPage,i.ContactsPerPage,i.AutoCheckMailInterval,i.DefaultTheme,i.DefaultLanguage,i.DefaultDateFormat,i.DefaultTimeFormat,i.UseThreads,i.SaveRepliedMessagesToCurrentFolder,i.DesktopNotifications,i.AllowChangeInputDirection),Fi.Api.showReport(Ei.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY"))))},zt.prototype.onSaveClick=function(){var e={Action:"UserSettingsUpdate",MailsPerPage:Ei.pInt(this.messagesPerPage()),ContactsPerPage:Ei.pInt(this.contactsPerPage()),AutoCheckMailInterval:Ei.pInt(this.autocheckmailInterval()),DefaultTheme:this.selectedSkin(),DefaultLanguage:this.selectedLanguage(),DefaultDateFormat:this.dateFormat(),DefaultTimeFormat:this.timeFormat(),UseThreads:this.useThreads()?"1":"0",SaveRepliedMessagesToCurrentFolder:this.saveRepliedToCurrFolder()?"1":"0",AllowChangeInputDirection:this.allowChangeInputDirection()?"1":"0",DesktopNotifications:this.desktopNotifications()?"1":"0"};this.loading(!0),this.updateFirstState(),Fi.Ajax.send(e,this.onResponse,this)},zt.prototype.registerMailto=function(){Ei.registerMailto()},Qt.prototype.TemplateName="Settings_EmailAccountsSettingsViewModel",Qt.prototype.TabName=Ci.SettingsTab.EmailAccounts,Qt.prototype.TabTitle=Ei.i18n("SETTINGS/TAB_EMAIL_ACCOUNTS"),Qt.prototype.isChanged=function(){return!1},Qt.prototype.onRoute=function(e){var t=Mi.Accounts.getEdited();t&&(_.isArray(e)&&e.length>1?this.changeCurrentTab(e[1]):this.onChangeAccount(this.editedAccountId()))},Qt.prototype.onHide=function(){var e=this.getCurrentViewModel();this.confirmSaving(this.tab()),e&&Ei.isFunc(e.onHide)&&e.onHide()},Qt.prototype.changeCurrentTab=function(e){var t=Mi.Accounts.getEdited(),i=null,s=this.isTabAllowed(e,t),o=_.bind(function(){this.tab()!==e&&(i=this.getCurrentViewModel(),i&&Ei.isFunc(i.onHide)&&i.onHide()),this.tab(e),i=this.getCurrentViewModel(),i&&Ei.isFunc(i.onShow)&&i.onShow(t)},this);t&&(s?o():this.tab()===e?(this.tab(Ci.AccountSettingsTab.Properties),Fi.Routing.replaceHash([Ci.Screens.Settings,Ci.SettingsTab.EmailAccounts,Ci.AccountSettingsTab.Properties]),this.editedFetcherId(null),this.editedIdentityId(null)):Fi.Routing.replaceHash([Ci.Screens.Settings,Ci.SettingsTab.EmailAccounts,this.tab()]))},Qt.prototype.allowedChangeTabAfterConfirm=function(){},Qt.prototype.getViewModel=function(e){switch(e){case Ci.AccountSettingsTab.Folders:return this.oAccountFolders;case Ci.AccountSettingsTab.Filters:return this.oAccountFilters;case Ci.AccountSettingsTab.Forward:return this.oAccountForward;case Ci.AccountSettingsTab.Signature:return this.oAccountSignature;case Ci.AccountSettingsTab.Autoresponder:return this.oAccountAutoresponder;case Ci.AccountSettingsTab.FetcherInc:return this.oFetcherIncoming;case Ci.AccountSettingsTab.FetcherOut:return this.oFetcherOutgoing;case Ci.AccountSettingsTab.FetcherSig:return this.oFetcherSignature;case Ci.AccountSettingsTab.IdentityProperties:return this.oIdentityProperties;case Ci.AccountSettingsTab.IdentitySignature:return this.oIdentityProperties;default:case Ci.AccountSettingsTab.Properties:return this.oAccountProperties}},Qt.prototype.getCurrentViewModel=function(){return this.getViewModel(this.tab())},Qt.prototype.isTabAllowed=function(e,t){var i=[Ci.AccountSettingsTab.Properties,Ci.AccountSettingsTab.Signature,Ci.AccountSettingsTab.Folders,Ci.AccountSettingsTab.FetcherInc,Ci.AccountSettingsTab.FetcherOut,Ci.AccountSettingsTab.FetcherSig];return t.extensionExists("AllowSieveFiltersExtension")&&i.push(Ci.AccountSettingsTab.Filters),t.extensionExists("AllowForwardExtension")&&i.push(Ci.AccountSettingsTab.Forward),t.extensionExists("AllowAutoresponderExtension")&&i.push(Ci.AccountSettingsTab.Autoresponder),Mi.AllowIdentities&&this.editedIdentityId()&&(i.push(Ci.AccountSettingsTab.IdentityProperties),i.push(Ci.AccountSettingsTab.IdentitySignature)),-1!==Ei.inArray(e,i)},Qt.prototype.onTabClick=function(e){this.confirmSaving(this.tab(),_.bind(function(){Fi.Routing.setHash([Ci.Screens.Settings,Ci.SettingsTab.EmailAccounts,e])},this))},Qt.prototype.onAccountDeleteResponse=function(e,i){e.Result?(Mi.Accounts.deleteAccount(i.AccountIDToDelete),this.onChangeAccount(this.editedAccountId()),this.defaultAccountId()===i.AccountIDToDelete&&(Fi.Routing.setHash([]),t.location.reload())):Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED"))},Qt.prototype.deleteAccount=function(e,t){var i={Action:"AccountDelete",AccountIDToDelete:e};t&&Fi.Ajax.send(i,this.onAccountDeleteResponse,this)},Qt.prototype.onAccountDelete=function(e){var t=_.bind(this.deleteAccount,this,e),i=Mi.Accounts.getAccount(e);!i.isInternal()&&Mi.App.AllowUsersChangeEmailSettings&&Fi.Screens.showPopup(E,[i.removeConfirmation(),t,i.email()])},Qt.prototype.onEditedAccountDelete=function(){this.onAccountDelete(this.editedAccountId())},Qt.prototype.onAccountAdd=function(){Fi.Screens.showPopup(T,[])},Qt.prototype.onChangeAccount=function(e){this.confirmSaving(this.tab(),_.bind(function(){var t=null,i={Action:"AccountSettingsGet",AccountID:e};(this.isFetcherTab(this.tab())||this.isIdentityTab(this.tab()))&&this.onTabClick(Ci.AccountSettingsTab.Properties),this.confirmSaving(this.tab()),t=Mi.Accounts.getAccount(e),!Ei.isUnd(t)&&t.isExtended()?this.populate(t):Fi.Ajax.send(i,this.onAccountSettingsGetResponse,this),this.editedFetcherId(null),this.editedIdentityId(null)},this),e)},Qt.prototype.onAccountSettingsGetResponse=function(e,t){if(e.Result){var i=Mi.Accounts.getAccount(t.AccountID);Ei.isUnd(i)||(i.updateExtended(e.Result),this.populate(i))}else Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED"))},Qt.prototype.populate=function(e){this.allowAutoresponderExtension(e.extensionExists("AllowAutoresponderExtension")),this.allowForwardExtension(e.extensionExists("AllowForwardExtension")),this.allowSieveFiltersExtension(e.extensionExists("AllowSieveFiltersExtension")),Mi.Accounts.changeEditedAccount(e.id()),this.changeCurrentTab(this.tab())},Qt.prototype.onIdentityAdd=function(e,t){t.stopPropagation(),Fi.Screens.showPopup(F,[e])},Qt.prototype.onFetcherAdd=function(){Fi.Screens.showPopup(I,[])},Qt.prototype.fetcherDelete=function(e,t){var i={Action:"AccountFetcherDelete",FetcherID:e};t&&Fi.Ajax.send(i,this.onAccountFetcherDeleteResponse,this)},Qt.prototype.onFetcherDeleteClick=function(e){var t=Ei.i18n("WARNING/FETCHER_DELETE_WARNING"),i=_.bind(this.fetcherDelete,this,e.idFetcher()),s=e.incomingMailServer();Fi.Screens.showPopup(E,[t,i,s])},Qt.prototype.onAccountFetcherDeleteResponse=function(e){e.Result?(Mi.Accounts.populateFetchers(),this.editedFetcherId(null)):Fi.Api.showErrorByCode(e.ErrorCode,Ei.i18n("WARNING/FETCHER_DELETING_ERROR"))},Qt.prototype.onChangeFetcher=function(e){this.confirmSaving(this.tab(),_.bind(function(){var t=this.defaultAccount.fetchers().getFetcher(e);this.fetcher(t),this.isFetcherTab(this.tab())||this.onTabClick(Ci.AccountSettingsTab.FetcherInc),this.confirmSaving(this.tab()),this.oFetcherIncoming.populate(t),this.oFetcherOutgoing.populate(t),this.oFetcherSignature.populate(t),this.editedFetcherId(t.id()),this.editedIdentityId(null)},this),e)},Qt.prototype.isFetcherTab=function(e){return-1!==Ei.inArray(e,[Ci.AccountSettingsTab.FetcherInc,Ci.AccountSettingsTab.FetcherOut,Ci.AccountSettingsTab.FetcherSig])},Qt.prototype.onChangeIdentity=function(e){this.confirmSaving(this.tab(),_.bind(function(){this.onTabClick(Ci.AccountSettingsTab.IdentityProperties),this.oIdentityProperties.populate(e),this.editedIdentityId(e.id()),this.editedFetcherId(null)},this),e)},Qt.prototype.isIdentityTab=function(e){return-1!==Ei.inArray(e,[Ci.AccountSettingsTab.IdentityProperties,Ci.AccountSettingsTab.IdentitySignature])},Qt.prototype.onRemoveIdentity=function(){this.editedIdentityId(null),this.changeCurrentTab(this.tab())},Qt.prototype.confirmSaving=function(e,t,i){var s=this.getViewModel(e),o=_.bind(function(e){s&&setTimeout(function(){e?Ei.isFunc(s.onSaveClick)&&s.onSaveClick():(Ei.isFunc(s.revert)&&s.revert(),s.updateFirstState()),Ei.isFunc(t)&&(i?t(i):t())}.bind(this),1)},this);s&&Ei.isFunc(s.isChanged)&&s.isChanged()?Fi.Screens.showPopup(E,[Ei.i18n("SETTINGS/CONFIRM_SETTINGS_SAVE"),o,"",Ei.i18n("SETTINGS/BUTTON_SAVE"),Ei.i18n("SETTINGS/BUTTON_DISCARD")]):Ei.isFunc(t)&&(i?t(i):t())},$t.prototype.TemplateName="Settings_CalendarSettingsViewModel",$t.prototype.TabName=Ci.SettingsTab.Calendar,$t.prototype.TabTitle=Ei.i18n("SETTINGS/TAB_CALENDAR"),$t.prototype.init=function(){this.showWeekends(Mi.User.CalendarShowWeekEnds),this.selectedWorkdayStarts(Mi.User.CalendarWorkDayStarts),this.selectedWorkdayEnds(Mi.User.CalendarWorkDayEnds),this.showWorkday(Mi.User.CalendarShowWorkDay),this.weekStartsOn(Mi.User.CalendarWeekStartsOn),this.defaultTab(Mi.User.CalendarDefaultTab)},$t.prototype.getState=function(){var e=[this.showWeekends(),this.selectedWorkdayStarts(),this.selectedWorkdayEnds(),this.showWorkday(),this.weekStartsOn(),this.defaultTab()];return e.join(":")},$t.prototype.updateFirstState=function(){this.firstState=this.getState()},$t.prototype.isChanged=function(){return this.firstState&&this.getState()!==this.firstState?!0:!1},$t.prototype.onResponse=function(e,t){this.loading(!1),e.Result===!1?Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_CALENDAR_SETTINGS_SAVING_FAILED")):(Fi.CalendarCache.calendarSettingsChanged(!0),Mi.User.updateCalendarSettings(t.ShowWeekEnds,t.ShowWorkDay,t.WorkDayStarts,t.WorkDayEnds,t.WeekStartsOn,t.DefaultTab),Fi.Api.showReport(Ei.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))},$t.prototype.onSaveClick=function(){var e={Action:"UserSettingsUpdate",ShowWeekEnds:this.showWeekends()?1:0,ShowWorkDay:this.showWorkday()?1:0,WorkDayStarts:parseInt(this.selectedWorkdayStarts(),10),WorkDayEnds:parseInt(this.selectedWorkdayEnds(),10),WeekStartsOn:parseInt(this.weekStartsOn(),10),DefaultTab:parseInt(this.defaultTab(),10)};this.loading(!0),this.updateFirstState(),Fi.Ajax.send(e,this.onResponse,this)},$t.prototype.getDisplayedTimes=function(e){var t=[];switch(e){case"HH:mm":t=[{text:"01:00",value:"1"},{text:"02:00",value:"2"},{text:"03:00",value:"3"},{text:"04:00",value:"4"},{text:"05:00",value:"5"},{text:"06:00",value:"6"},{text:"07:00",value:"7"},{text:"08:00",value:"8"},{text:"09:00",value:"9"},{text:"10:00",value:"10"},{text:"11:00",value:"11"},{text:"12:00",value:"12"},{text:"13:00",value:"13"},{text:"14:00",value:"14"},{text:"15:00",value:"15"},{text:"16:00",value:"16"},{text:"17:00",value:"17"},{text:"18:00",value:"18"},{text:"19:00",value:"19"},{text:"20:00",value:"20"},{text:"21:00",value:"21"},{text:"22:00",value:"22"},{text:"23:00",value:"23"},{text:"00:00",value:"24"}];break;case"hh:mm A":t=[{text:"01:00 AM",value:"1"},{text:"02:00 AM",value:"2"},{text:"03:00 AM",value:"3"},{text:"04:00 AM",value:"4"},{text:"05:00 AM",value:"5"},{text:"06:00 AM",value:"6"},{text:"07:00 AM",value:"7"},{text:"08:00 AM",value:"8"},{text:"09:00 AM",value:"9"},{text:"10:00 AM",value:"10"},{text:"11:00 AM",value:"11"},{text:"12:00 PM",value:"12"},{text:"01:00 PM",value:"13"},{text:"02:00 PM",value:"14"},{text:"03:00 PM",value:"15"},{text:"04:00 PM",value:"16"},{text:"05:00 PM",value:"17"},{text:"06:00 PM",value:"18"},{text:"07:00 PM",value:"19"},{text:"08:00 PM",value:"20"},{text:"09:00 PM",value:"21"},{text:"10:00 PM",value:"22"},{text:"11:00 PM",value:"23"},{text:"12:00 AM",value:"24"}]}return t},Jt.prototype.TemplateName="Settings_MobileSyncSettingsViewModel",Jt.prototype.TabName=Ci.SettingsTab.MobileSync,Jt.prototype.TabTitle=Ei.i18n("SETTINGS/TAB_MOBILE_SYNC"),Jt.prototype.onRoute=function(){Mi.User.requestSyncSettings()},Jt.prototype.onMobileSyncSubscribe=function(){this.enableDav(Mi.User.MobileSyncEnable&&this.mobileSync()&&this.mobileSync().EnableDav),this.enableDav()&&(this.davLogin(this.mobileSync().Dav.Login),this.davServer(this.mobileSync().Dav.Server),this.davCalendars(this.mobileSync().Dav.Calendars),this.davPersonalContactsUrl(this.mobileSync().Dav.PersonalContactsUrl),this.davCollectedAddressesUrl(this.mobileSync().Dav.CollectedAddressesUrl),this.davGlobalAddressBookUrl(this.mobileSync().Dav.GlobalAddressBookUrl),this.davSharedWithAllUrl(this.mobileSync().Dav.SharedWithAllUrl))},Xt.prototype.TemplateName="Settings_OutLookSyncSettingsViewModel",Xt.prototype.TabName=Ci.SettingsTab.OutLookSync,Xt.prototype.TabTitle=Ei.i18n("SETTINGS/TAB_OUTLOOK_SYNC"),Xt.prototype.onRoute=function(){Mi.User.requestSyncSettings()},Xt.prototype.onOutlookSyncSubscribe=function(){Mi.User.OutlookSyncEnable&&(this.visibleOutlookSync(!0),this.outlookSync()&&this.server(this.outlookSync().Server))},Zt.prototype.TemplateName="Settings_PgpSettingsViewModel",Zt.prototype.TabName=Ci.SettingsTab.Pgp,Zt.prototype.TabTitle=Ei.i18n("SETTINGS/TAB_OPENPGP"),Zt.prototype.init=function(){this.enableOpenPgp(Mi.User.enableOpenPgp()),this.allowAutosaveInDrafts(Mi.User.AllowAutosaveInDrafts),this.autosignOutgoingEmails(Mi.User.AutosignOutgoingEmails)},Zt.prototype.getState=function(){var e=[this.enableOpenPgp(),this.allowAutosaveInDrafts(),this.autosignOutgoingEmails()];return e.join(":")},Zt.prototype.updateFirstState=function(){this.firstState=this.getState()},Zt.prototype.isChanged=function(){return this.firstState&&this.getState()!==this.firstState?!0:!1},Zt.prototype.onRoute=function(){var e=_.bind(function(e){e&&(this.pgp=e,this.keys(this.pgp.getKeys()),this.pgp.getKeysObservable().subscribe(function(){this.keys(this.pgp.getKeys())},this)),this.pgpLoaded(!0)},this);Fi.Api.pgp(e,Mi.User.IdUser)},Zt.prototype.importKey=function(){this.pgp&&Fi.Screens.showPopup(q,[this.pgp])},Zt.prototype.generateNewKey=function(){this.pgp&&Fi.Screens.showPopup(K,[this.pgp])},Zt.prototype.removeOpenPgpKey=function(e){var t="",i=_.bind(function(t){if(t){var i=this.pgp.deleteKey(e);i.result||Fi.Api.showError(Ei.i18n("OPENPGP/ERROR_DELETE_KEY"))}},this);this.pgp&&e&&(t=Ei.i18n("OPENPGP/CONFIRM_DELETE_KEY",{KEYEMAIL:e.getEmail()}),Fi.Screens.showPopup(E,[t,i]))},Zt.prototype.showArmor=function(e){this.pgp&&Fi.Screens.showPopup(W,[e])},Zt.prototype.onResponse=function(e,t){this.loading(!1),e.Result===!1?Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):(Mi.User.updateOpenPgpSettings(t.EnableOpenPgp,t.AllowAutosaveInDrafts,t.AutosignOutgoingEmails),Fi.Api.showReport(Ei.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))},Zt.prototype.onSaveClick=function(){var e={Action:"UserSettingsUpdate",EnableOpenPgp:this.enableOpenPgp()?"1":"0",AllowAutosaveInDrafts:this.allowAutosaveInDrafts()?"1":"0",AutosignOutgoingEmails:this.autosignOutgoingEmails()?"1":"0"};this.loading(!0),this.updateFirstState(),Fi.Ajax.send(e,this.onResponse,this)},ei.prototype.onShow=function(e){this.account(e),this.populate()},ei.prototype.getState=function(){var e=[this.friendlyName(),this.email(),this.incomingMailLogin(),this.incomingMailPort(),this.incomingMailServer(),this.outgoingMailLogin(),this.outgoingMailPort(),this.outgoingMailServer(),this.useSmtpAuthentication()];return e.join(":")},ei.prototype.updateFirstState=function(){this.firstState=this.getState()},ei.prototype.isChanged=function(){return!!this.firstState&&this.getState()!==this.firstState},ei.prototype.populate=function(){var e=this.account();e?(this.allowChangePassword(e.extensionExists("AllowChangePasswordExtension")),this.isInternal(e.isInternal()),this.isLinked(e.isLinked()),this.isDefault(e.isDefault()),this.removeHint(e.removeHint()),this.useSmtpAuthentication(2===Ei.pInt(e.outgoingMailAuth())?!0:!1),this.friendlyName(e.friendlyName()),this.email(e.email()),this.incomingMailLogin(e.incomingMailLogin()),this.incomingMailServer(e.incomingMailServer()),this.incomingMailPort(e.incomingMailPort()),this.outgoingMailServer(e.outgoingMailServer()),this.outgoingMailLogin(e.outgoingMailLogin()),this.outgoingMailPort(e.outgoingMailPort()),this.updateFirstState()):(this.allowChangePassword(!1),this.isLinked(!0),this.useSmtpAuthentication(!0),this.friendlyName(""),this.email(""),this.incomingMailLogin(""),this.incomingMailServer(""),this.incomingMailPort(143),this.outgoingMailServer(""),this.outgoingMailLogin(""),this.outgoingMailPort(25))},ei.prototype.onAccountSettingsUpdateResponse=function(e,t){if(this.loading(!1),e.Result){var i=Ei.pInt(e.AccountID),s=i>0?Mi.Accounts.getAccount(i):null;s&&(s.updateExtended(t),Fi.Api.showReport(Ei.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))}else Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED"))},ei.prototype.prepareParameters=function(){var e={Action:"AccountSettingsUpdate",AccountID:this.account().id(),FriendlyName:this.friendlyName(),Email:this.email(),IncomingMailLogin:this.incomingMailLogin(),IncomingMailServer:this.incomingMailServer(),IncomingMailPort:Ei.pInt(this.incomingMailPort()),OutgoingMailServer:this.outgoingMailServer(),OutgoingMailLogin:this.outgoingMailLogin(),OutgoingMailPort:Ei.pInt(this.outgoingMailPort()),OutgoingMailAuth:this.useSmtpAuthentication()?2:0,IncomingMailPassword:this.incomingMailPassword()};return e},ei.prototype.saveData=function(e){this.updateFirstState(),Fi.Ajax.send(e,this.onAccountSettingsUpdateResponse,this)},ei.prototype.onSaveClick=function(){this.account()&&(this.loading(!0),this.saveData(this.prepareParameters()))},ei.prototype.onChangePasswordClick=function(){Fi.Screens.showPopup(P,[!1])},ti.prototype.__name="CAccountFoldersViewModel",ti.prototype.onHide=function(){var e=Mi.Accounts.editedId();_.delay(function(){Fi.MailCache.getFolderList(e)},3e3)},ti.prototype.onShow=function(){this.setTotalMessageCount()},ti.prototype.setTotalMessageCount=function(){var e=Fi.MailCache.editedFolderList();0===e.iAccountId?this.totalMessageCount(0):(this.totalMessageCount(e.getTotalMessageCount()),e.countsCompletelyFilled()||(e.countsCompletelyFilledSubscribtion&&(e.countsCompletelyFilledSubscribtion.dispose(),e.countsCompletelyFilledSubscribtion=null),e.countsCompletelyFilledSubscribtion=e.countsCompletelyFilled.subscribe(function(){e.countsCompletelyFilled()&&(this.totalMessageCount(e.getTotalMessageCount()),e.countsCompletelyFilledSubscribtion.dispose(),e.countsCompletelyFilledSubscribtion=null)},this)))},ti.prototype.isChanged=function(){return!1},ti.prototype.onAddNewFolderClick=function(){Fi.Screens.showPopup(w)},ti.prototype.onSystemFoldersClick=function(){Fi.Screens.showPopup(M)},ii.prototype.__name="CAccountSignatureViewModel",ii.prototype.onShow=function(e){this.account(e),this.oHtmlEditor.initCrea(this.signature(),!1,""),this.oHtmlEditor.setActivitySource(this.useSignature),this.enableImageDragNDrop(this.oHtmlEditor.editorUploader.isDragAndDropSupported()&&!Fi.browser.ie10AndAbove),this.updateFirstState()},ii.prototype.getState=function(){var e=[this.type(),this.useSignature(),this.oHtmlEditor.getText()];return e.join(":")},ii.prototype.updateFirstState=function(){this.firstState=this.getState()},ii.prototype.isChanged=function(){return this.firstState&&this.getState()!==this.firstState?!0:!1},ii.prototype.getSignature=function(){if(this.account())if(null!==this.account().signature())this.type(this.account().signature().type()),this.useSignature(this.account().signature().options()),this.signature(this.account().signature().signature()),this.updateFirstState();else{var e={Action:"AccountSignatureGet",AccountID:this.account().id()};Fi.Ajax.send(e,this.onAccountSignatureGetResponse,this)}},ii.prototype.onAccountSignatureGetResponse=function(e){var t=null,i=parseInt(e.AccountID,10);e.Result?this.account()&&i===this.account().id()&&(t=new vt,t.parse(i,e.Result),this.account().signature(t),this.type(this.account().signature().type()),this.useSignature(this.account().signature().options()),this.signature(this.account().signature().signature()),this.updateFirstState()):Fi.Api.showErrorByCode(e)},ii.prototype.prepareParameters=function(){var e={Action:"AccountSignatureUpdate",AccountID:this.account().id(),Type:this.type()?1:0,Options:this.useSignature(),Signature:this.signature()};return e},ii.prototype.saveData=function(e){this.updateFirstState(),Fi.Ajax.send(e,this.onAccountSignatureUpdateResponse,this)},ii.prototype.onSaveClick=function(){this.account()&&(this.loading(!0),this.signature(this.oHtmlEditor.getNotDefaultText()),this.account().signature().type(this.type()),this.account().signature().options(this.useSignature()),this.account().signature().signature(this.signature()),this.saveData(this.prepareParameters()))},ii.prototype.onAccountSignatureUpdateResponse=function(e){this.loading(!1),e.Result?Fi.Api.showReport(Ei.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")):Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED"))},si.prototype.onShow=function(e){this.account(e)},si.prototype.getState=function(){return[this.enable(),this.email()].join(":")},si.prototype.updateFirstState=function(){this.firstState=this.getState()},si.prototype.isChanged=function(){return this.firstState&&this.getState()!==this.firstState},si.prototype.prepareParameters=function(){return{Action:"AccountForwardUpdate",AccountID:this.account().id(),Enable:this.enable()?"1":"0",Email:this.email()}},si.prototype.saveData=function(e){this.updateFirstState(),Fi.Ajax.send(e,this.onAccountForwardUpdateResponse,this)},si.prototype.onSaveClick=function(){if(this.account()){var e=this,t=this.account().forward(),i=function(){t&&(t.enable=e.enable(),t.email=e.email()),e.loading(!0),e.saveData(e.prepareParameters())};this.enable()&&""===this.email()?this.emailFocus(!0):this.enable()&&""!==this.email()&&Ei.getIncorrectEmailsFromAddressString(this.email()).length?Fi.Screens.showPopup(C,[Ei.i18n("COMPOSE/WARNING_INPUT_CORRECT_EMAILS")+" "+this.email()]):i()}},si.prototype.getForward=function(){if(this.account())if(null!==this.account().forward())this.enable(this.account().forward().enable),this.email(this.account().forward().email),this.firstState=this.getState();else{var e={Action:"AccountForwardGet",AccountID:this.account().id()};this.loading(!0),this.updateFirstState(),Fi.Ajax.send(e,this.onAccountForwardGetResponse,this)}},si.prototype.onAccountForwardGetResponse=function(e,t){if(this.loading(!1),t&&t.Action){if(e&&e.Result&&e.AccountID&&this.account()){var i=null,s=new Tt,o=Ei.pInt(e.AccountID);o&&(i=Mi.Accounts.getAccount(o),i&&(s.parse(o,e.Result),i.forward(s),this.enable(i.forward().enable),this.email(i.forward().email),this.updateFirstState(),o===this.account().id()&&this.getForward()))}}else Fi.Api.showError(Ei.i18n("WARNING/UNKNOWN_ERROR"))},si.prototype.onAccountForwardUpdateResponse=function(e,t){this.loading(!1),t&&t.Action?e&&e.Result?Fi.Api.showReport(Ei.i18n("SETTINGS/ACCOUNT_FORWARD_SUCCESS_REPORT")):Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):Fi.Api.showError(Ei.i18n("WARNING/UNKNOWN_ERROR"))},oi.prototype.onShow=function(e){this.account(e)},oi.prototype.getState=function(){var e=[this.enable(),this.subject(),this.message()];return e.join(":")},oi.prototype.updateFirstState=function(){this.firstState=this.getState()},oi.prototype.isChanged=function(){return this.firstState&&this.getState()!==this.firstState?!0:!1},oi.prototype.prepareParameters=function(){var e={Action:"AccountAutoresponderUpdate",AccountID:this.account().id(),Enable:this.enable()?"1":"0",Subject:this.subject(),Message:this.message()};return e},oi.prototype.saveData=function(e){this.updateFirstState(),Fi.Ajax.send(e,this.onAccountAutoresponderUpdateResponse,this)},oi.prototype.onSaveClick=function(){if(this.account()){var e=this.account().autoresponder();e&&(e.enable=this.enable(),e.subject=this.subject(),e.message=this.message()),this.loading(!0),this.saveData(this.prepareParameters())}},oi.prototype.getAutoresponder=function(){if(this.account())if(null!==this.account().autoresponder())this.enable(this.account().autoresponder().enable),this.subject(this.account().autoresponder().subject),this.message(this.account().autoresponder().message),this.updateFirstState();else{var e={Action:"AccountAutoresponderGet",AccountID:this.account().id()};this.loading(!0),Fi.Ajax.send(e,this.onAccountAutoresponderGetResponse,this)}},oi.prototype.onAccountAutoresponderGetResponse=function(e,t){if(this.loading(!1),t&&t.Action){if(e&&e.Result&&e.AccountID&&this.account()){var i=null,s=new At,o=Ei.pInt(e.AccountID);o&&(i=Mi.Accounts.getAccount(o),i&&(s.parse(o,e.Result),i.autoresponder(s),o===this.account().id()&&this.getAutoresponder()))}}else Fi.Api.showError(Ei.i18n("WARNING/UNKNOWN_ERROR"))},oi.prototype.onAccountAutoresponderUpdateResponse=function(e,t){this.loading(!1),t&&t.Action?e&&e.Result?Fi.Api.showReport(Ei.i18n("SETTINGS/ACCOUNT_AUTORESPONDER_SUCCESS_REPORT")):Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):Fi.Api.showError(Ei.i18n("WARNING/UNKNOWN_ERROR"))},ni.prototype.onShow=function(e){this.account(e),this.getFilters()},ni.prototype.onHide=function(){this.collection([]),this.updateFirstState()},ni.prototype.revert=function(){_.each(this.collection(),function(e){e.revert()})},ni.prototype.commit=function(){_.each(this.collection(),function(e){e.commit()})},ni.prototype.getState=function(){var e=":",t=_.map(this.collection(),function(e){return e.toString()},this);return t.length>0&&(e=t.join(":")),e},ni.prototype.updateFirstState=function(){this.firstState=this.getState()},ni.prototype.isChanged=function(){return this.firstState&&this.getState()!==this.firstState},ni.prototype.prepareParameters=function(){var e=_.map(this.collection(),function(e){return{Enable:e.enable()?"1":"0",Field:e.field(),Filter:e.filter(),Condition:e.condition(),Action:e.action(),FolderFullName:e.folder()}}),t={Action:"AccountSieveFiltersUpdate",AccountID:this.account().id(),Filters:e};return t},ni.prototype.saveData=function(e){var t=_.some(this.collection(),function(e){return""===e.filter()||"3"===Ei.pString(e.action())&&""===e.folder()
});t?Fi.Api.showError(Ei.i18n("SETTINGS/ERROR_FILTERS_FIELDS_FILL")):(this.saving(!0),this.commit(),this.updateFirstState(),Fi.Ajax.send(e,this.onAccountSieveFiltersUpdateResponse,this))},ni.prototype.onSaveClick=function(){this.account()&&this.saveData(this.prepareParameters())},ni.prototype.getFilters=function(){if(this.account())if(null!==this.account().filters())this.account().id()===this.folderList().iAccountId?(this.collection(this.account().filters().collection()),this.updateFirstState(),this.loading(!1)):this.loading(!0);else{var e={Action:"AccountSieveFiltersGet",AccountID:this.account().id()};this.loading(!0),Fi.Ajax.send(e,this.onAccountSieveFiltersGetResponse,this)}},ni.prototype.deleteFilter=function(e){this.collection.remove(e)},ni.prototype.addFilter=function(){if(this.account()){var e=new It(this.account().id());this.collection.push(e)}},ni.prototype.displayFilterPart=function(e,t){var i="";return i="%FIELD%"===e?"Field":"%CONDITION%"===e?"Condition":"%STRING%"===e?"String":"%ACTION%"===e?"Action":"%FOLDER%"===e?"Folder":"%DEPENDED"===e.substr(0,9)?"DependedText":"Text",t+i},ni.prototype.getDependedText=function(e){return e=Ei.pString(e),e&&(e=e.replace(/%/g,"").split("=")[1]||""),e},ni.prototype.getDependedField=function(e,t){return e=Ei.pString(e),e&&(e=e.replace(/[=](.*)/g,"").split("-")[1]||"",e=e.toLowerCase()),Ei.isUnd(t[e])?!1:t[e]()},ni.prototype.onAccountSieveFiltersGetResponse=function(e,t){if(this.loading(!1),t&&t.Action){if(e&&e.Result&&e.AccountID&&this.account()){var i=null,s=new Ft,o=Ei.pInt(e.AccountID);o&&(i=Mi.Accounts.getAccount(o),i&&(s.parse(o,e.Result),i.filters(s),o===this.account().id()&&this.getFilters()))}}else Fi.Api.showError(Ei.i18n("WARNING/UNKNOWN_ERROR"))},ni.prototype.onAccountSieveFiltersUpdateResponse=function(e,t){this.saving(!1),t&&t.Action?e&&e.Result?Fi.Api.showReport(Ei.i18n("SETTINGS/ACCOUNT_FILTERS_SUCCESS_REPORT")):Fi.Api.showError(Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):Fi.Api.showError(Ei.i18n("WARNING/UNKNOWN_ERROR"))},ri.prototype.onSaveClick=function(){if(this.isEmptyRequiredFields())Fi.Api.showError(Ei.i18n("WARNING/FETCHER_CREATE_ERROR"));else{var e={Action:"AccountFetcherUpdate",AccountID:this.defaultAccountId(),FetcherID:this.idFetcher(),IsEnabled:this.isEnabled()?1:0,Folder:this.folder(),IncomingMailServer:this.incomingMailServer(),IncomingMailPort:parseInt(this.incomingMailPort(),10),IncomingMailPassword:""===this.incomingMailPassword()?"******":this.incomingMailPassword(),LeaveMessagesOnServer:this.leaveMessagesOnServer()?1:0};this.loading(!0),Fi.Ajax.send(e,this.onAccountFetcherUpdateResponse,this)}},ri.prototype.onAccountFetcherUpdateResponse=function(e){this.loading(!1),e.Result?(Fi.Api.showReport(Ei.i18n("SETTINGS/ACCOUNT_FETCHER_SUCCESSFULLY_SAVED")),this.updateFirstState()):Fi.Api.showErrorByCode(e,Ei.i18n("WARNING/UNKNOWN_ERROR")),Mi.Accounts.populateFetchers()},ri.prototype.populate=function(e){e&&(this.fetcher(e),this.idFetcher(e.id()),this.isEnabled(e.isEnabled()),this.folder(e.folder()),this.incomingMailServer(e.incomingMailServer()),this.incomingMailPort(e.incomingMailPort()),this.incomingMailLogin(e.incomingMailLogin()),this.incomingMailPassword("******"),this.leaveMessagesOnServer(e.leaveMessagesOnServer()),this.updateFirstState())},ri.prototype.isEmptyRequiredFields=function(){switch(""){case this.incomingMailServer():return this.serverIsSelected(!0),!0;case this.incomingMailLogin():return this.loginIsSelected(!0),!0;case this.incomingMailPassword():return this.passwordIsSelected(!0),!0;default:return!1}},ri.prototype.getState=function(){return[this.isEnabled(),this.incomingMailServer(),this.incomingMailPort(),this.incomingMailPassword(),this.folder(),this.leaveMessagesOnServer()].join(":")},ri.prototype.updateFirstState=function(){this.firstState=this.getState()},ri.prototype.isChanged=function(){return!!this.firstState&&this.getState()!==this.firstState},ai.prototype.onSaveClick=function(){if(this.outgoingMailAuth()&&this.isEmptyRequiredFields())Fi.Api.showError(Ei.i18n("WARNING/FETCHER_CREATE_ERROR"));else{var e={Action:"AccountFetcherUpdate",AccountID:this.defaultAccountId(),FetcherID:this.idFetcher(),Email:this.email(),Name:this.userName(),IsOutgoingEnabled:this.isOutgoingEnabled()?1:0,OutgoingMailServer:this.outgoingMailServer(),OutgoingMailPort:parseInt(this.outgoingMailPort(),10),OutgoingMailAuth:this.outgoingMailAuth()?1:0};this.loading(!0),Fi.Ajax.send(e,this.onAccountFetcherUpdateResponse,this)}},ai.prototype.onAccountFetcherUpdateResponse=function(e){this.loading(!1),e.Result?(Fi.Api.showReport(Ei.i18n("SETTINGS/ACCOUNT_FETCHER_SUCCESSFULLY_SAVED")),this.updateFirstState()):Fi.Api.showErrorByCode(e,Ei.i18n("WARNING/UNKNOWN_ERROR")),Mi.Accounts.populateFetchers()},ai.prototype.populate=function(e){e&&(this.fetcher(e),this.idFetcher(e.id()),this.isEnabled(e.isEnabled()),this.email(e.email()),this.userName(e.userName()),this.isOutgoingEnabled(e.isOutgoingEnabled()),this.outgoingMailServer(e.outgoingMailServer()),this.outgoingMailPort(e.outgoingMailPort()),this.outgoingMailAuth(e.outgoingMailAuth()),this.updateFirstState())},ai.prototype.isEmptyRequiredFields=function(){return this.isOutgoingEnabled()&&""===this.outgoingMailServer()?(this.serverIsSelected(!0),!0):!1},ai.prototype.getState=function(){return[this.isOutgoingEnabled(),this.outgoingMailServer(),this.outgoingMailPort(),this.outgoingMailAuth(),this.userName(),this.email()].join(":")},ai.prototype.updateFirstState=function(){this.firstState=this.getState()},ai.prototype.isChanged=function(){return!!this.firstState&&this.getState()!==this.firstState},li.prototype.__name="CFetcherSignatureViewModel",li.prototype.onSaveClick=function(){var e={Action:"AccountFetcherUpdate",AccountID:this.defaultAccountId(),FetcherID:this.idFetcher(),SignatureOptions:this.useSignature(),Signature:this.oHtmlEditor.getNotDefaultText()};this.loading(!0),Fi.Ajax.send(e,this.onAccountFetcherUpdateResponse,this)},li.prototype.onAccountFetcherUpdateResponse=function(e){this.loading(!1),e.Result?(Fi.Api.showReport(Ei.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")),this.updateFirstState()):Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")),Mi.Accounts.populateFetchers()},li.prototype.populate=function(e){e&&(this.fetcher(e),this.idFetcher(e.id()),this.signature(e.signature()),this.useSignature(e.signatureOptions()),setTimeout(function(){this.updateFirstState()}.bind(this),1))},li.prototype.onShow=function(){this.oHtmlEditor.initCrea(this.signature(),!1,""),this.oHtmlEditor.setActivitySource(this.useSignature),this.enableImageDragNDrop(this.oHtmlEditor.editorUploader.isDragAndDropSupported()&&!Fi.browser.ie10AndAbove),this.updateFirstState()},li.prototype.getState=function(){return[this.type(),this.useSignature(),this.oHtmlEditor.getNotDefaultText()].join(":")},li.prototype.updateFirstState=function(){this.firstState=this.getState()},li.prototype.isChanged=function(){return!!this.firstState&&this.getState()!==this.firstState},hi.prototype.TemplateName="Settings_HelpdeskSettingsViewModel",hi.prototype.TabName=Ci.SettingsTab.Helpdesk,hi.prototype.TabTitle=Ei.i18n("SETTINGS/TAB_HELPDESK"),hi.prototype.onShow=function(){this.allowNotifications(Mi.User.AllowHelpdeskNotifications)},hi.prototype.onResponse=function(e){this.loading(!1),e.Result===!1?Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):(Mi.User.updateHelpdeskSettings(this.allowNotifications()),Fi.Api.showReport(Ei.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))},hi.prototype.onSaveClick=function(){var e={Action:"HelpdeskUserSettingsUpdate",AllowHelpdeskNotifications:this.allowNotifications()?"1":"0"};this.loading(!0),Fi.Ajax.send(e,this.onResponse,this)},ci.prototype.__name="CServicesSettingsViewModel",ci.prototype.TemplateName="Settings_ServicesSettingsViewModel",ci.prototype.TabName=Ci.SettingsTab.Services,ci.prototype.TabTitle=Ei.i18n("SETTINGS/TAB_SERVICES"),ci.prototype.getState=function(){var e=[this.enableFiles()];return e.join(":")},ci.prototype.updateFirstState=function(){this.firstState=this.getState()},ci.prototype.isChanged=function(){return this.firstState&&this.getState()!==this.firstState?!0:!1},ci.prototype.init=function(){this.enableFiles(Mi.User.filesEnable())},ci.prototype.onApplyBindings=function(){var e=Ei.emptyFunction();t.servicesSettingsViewModelCallback=_.bind(function(t,i){i&&(this.getSocialAccount(t),Ei.isFunc(this[t+"Connected"])&&(e=this[t+"Connected"])(!e()))},this)},ci.prototype.onShow=function(){},ci.prototype.onRoute=function(){this.getSocialAccounts()},ci.prototype.onSocialSignInClick=function(t){var i=null;e.cookie("SocialRedirect","storage"),i=Ei.WindowOpener.open(Ei.getAppPath()+"?social-auth="+t+"&scope=storage",t)},ci.prototype.addSocialAccount=function(e){Mi.User.SocialAccounts.push(e)},ci.prototype.deleteSocialAccount=function(e){Mi.User.SocialAccounts(_.filter(Mi.User.SocialAccounts(),function(t){return"Object/CSocial"===t["@Object"]&&t.Type!==e},this))},ci.prototype.onSocialSignOutClick=function(e){var t=Ei.emptyFunction();this.deleteSocialAccount(e),Ei.isFunc(this[e+"Connected"])&&(t=this[e+"Connected"])(!1),Fi.Ajax.send({Action:"SocialAccountDelete",Type:e},this.onSocialAccountDeleteResponse,this)},ci.prototype.onSocialAccountDeleteResponse=function(e,t){var i=e.Result,s=t.Type,o=Ei.emptyFunction();Ei.isFunc(this[s+"Connected"])&&(o=this[s+"Connected"])(i!==!1?!1:!o())},ci.prototype.onSaveClick=function(){var e={Action:"UserSettingsUpdate",FilesEnable:this.enableFiles()?"1":"0"};this.loading(!0),this.updateFirstState(),Fi.Ajax.send(e,this.onResponse,this)},ci.prototype.onResponse=function(e){this.loading(!1),e.Result===!1?Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ERROR_SETTINGS_SAVING_FAILED")):(Mi.User.filesEnable(this.enableFiles()),Fi.Api.showReport(Ei.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))},ci.prototype.getSocialAccounts=function(){var e=Ei.emptyFunction();_.each(Mi.User.SocialAccounts(),function(t){"Object/CSocial"===t["@Object"]&&_.indexOf(t.Scopes,"filestorage")>=0&&Ei.isFunc(this[t.Type+"Connected"])&&(e=this[t.Type+"Connected"])(!0)},this)},ci.prototype.getSocialAccount=function(e){Fi.Ajax.send({Action:"SocialAccountGet",Type:e},this.onSocialAccountGetResponse,this)},ci.prototype.onSocialAccountGetResponse=function(e){var t=e.Result;t&&"Object/CSocial"===t["@Object"]&&_.indexOf(t.Scopes,"filestorage")>=0&&(this.deleteSocialAccount(t.Type),this.addSocialAccount(t))},ui.prototype.__name="CIdentityPropertiesViewModel",ui.prototype.onShow=function(){this.oHtmlEditor.initCrea(this.signature(),!1,""),this.oHtmlEditor.setActivitySource(this.useSignature),this.enableImageDragNDrop(this.oHtmlEditor.editorUploader.isDragAndDropSupported()&&!Fi.browser.ie10AndAbove)},ui.prototype.onSaveClick=function(){var e={};if(this.updateFirstState(),""===this.email())Fi.Api.showError(Ei.i18n("WARNING/IDENTITY_CREATE_ERROR"));else if(this.identity().loyal()){var t=Mi.Accounts.getAccount(this.identity().accountId());this.signature(this.oHtmlEditor.getNotDefaultText()),t.signature().options(this.useSignature()),t.signature().signature(this.signature()),e={Action:"AccountIdentityLoyalUpdate",AccountID:t.id(),FriendlyName:this.friendlyName(),Type:t.signature().type()?1:0,Signature:this.signature(),Options:this.useSignature(),Loyal:1,Default:this.isDefault()?1:0},Fi.Ajax.send(e,this.onAccountIdentityUpdateResponse,this)}else this.signature(this.oHtmlEditor.getNotDefaultText()),e={Action:this.bCreate?"AccountIdentityCreate":"AccountIdentityUpdate",AccountID:this.identity().accountId(),Enabled:this.enabled()?1:0,Email:this.email(),Signature:this.signature(),UseSignature:this.useSignature(),FriendlyName:this.friendlyName(),Loyal:0,Default:this.isDefault()?1:0},this.bCreate||(e.IdIdentity=this.identity().id()),this.loading(!0),Fi.Ajax.send(e,this.onAccountIdentityUpdateResponse,this)},ui.prototype.onAccountIdentityUpdateResponse=function(e,t){if(this.loading(!1),e.Result){if(Mi.Accounts.populateIdentities(),this.bCreate&&this.oEmailAccountsSettings.closeCommand(),t.Loyal){var i=Ei.pInt(e.AccountID),s=i>0?Mi.Accounts.getAccount(i):null;s&&(s.updateExtended(t),Fi.Api.showReport(Ei.i18n("SETTINGS/COMMON_REPORT_UPDATED_SUCCESSFULLY")))}this.disableCheckbox(this.isDefault())}else Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ACCOUNTS_IDENTITY_ADDING_ERROR"))},ui.prototype.populate=function(e){e&&(this.identity(e),this.enabled(e.enabled()),this.isDefault(e.isDefault()),this.email(e.email()),this.loyal(e.loyal()),this.friendlyName(e.friendlyName()),this.signature(e.signature()),this.useSignature(e.useSignature()?1:0),this.disableCheckbox(e.isDefault()),setTimeout(function(){this.updateFirstState()}.bind(this),1))},ui.prototype.remove=function(){if(!this.identity().loyal()){var e={Action:"AccountIdentityDelete",AccountID:this.identity().accountId(),IdIdentity:this.identity().id()};Fi.Ajax.send(e,this.onAccountIdentityDeleteResponse,this),this.bCreate||this.oEmailAccountsSettings.onRemoveIdentity()}},ui.prototype.onAccountIdentityDeleteResponse=function(e){e.Result||Fi.Api.showErrorByCode(e,Ei.i18n("SETTINGS/ACCOUNTS_IDENTITY_DELETING_ERROR")),Mi.Accounts.populateIdentities()},ui.prototype.cancel=function(){this.bCreate&&this.oEmailAccountsSettings.cancel()},ui.prototype.getState=function(){return[this.friendlyName(),this.email(),this.useSignature(),this.oHtmlEditor.getNotDefaultText()].join(":")},ui.prototype.updateFirstState=function(){this.firstState=this.getState()},ui.prototype.isChanged=function(){return!!this.firstState&&this.getState()!==this.firstState},di.prototype.getFCObject=function(){return this.$calendarGrid.fullCalendar("getCalendar")},di.prototype.getDateFromCurrentView=function(e){var t=this.$calendarGrid.fullCalendar("getView"),i=t&&t[e]?t[e]:null;return i&&"end"===e&&"agendaDay"===t.name&&i.add(1,"d"),i&&i.unix?t[e].unix():0},di.prototype.eventsSource=function(e,t,i,s){s(this.calendars.getEvents(e,t))},di.prototype.initFullCalendar=function(){this.$calendarGrid.fullCalendar(this.fullcalendarOptions)},di.prototype.applyCalendarSettings=function(){this.timeFormat=Mi.User.defaultTimeFormat()===Ci.TimeFormat.F24?"HH:mm":"hh:mm A",this.dateFormat=Mi.User.DefaultDateFormat,this.calendarGridDom().removeClass("fc-show-weekends"),Mi.User.CalendarShowWeekEnds&&this.calendarGridDom().addClass("fc-show-weekends"),this.fullcalendarOptions.timeFormat=this.timeFormat,this.fullcalendarOptions.axisFormat=this.timeFormat,this.fullcalendarOptions.defaultView=this.defaultViewName(),this.fullcalendarOptions.lang=moment.lang(),this.applyFirstDay(),this.$calendarGrid.fullCalendar("destroy"),this.$calendarGrid.fullCalendar(this.fullcalendarOptions),this.changeView(this.defaultViewName())},di.prototype.applyFirstDay=function(){var e=[],t="",i="";switch(Mi.Auth&&(this.fullcalendarOptions.firstDay=Mi.User.CalendarWeekStartsOn),_.each(this.aDayNames,function(t){e.push(t)}),this.fullcalendarOptions.firstDay){case 1:i=e.shift(),e.push(i);break;case 6:t=e.pop(),e.unshift(t)}this.$datePicker.datepicker("option","firstDay",this.fullcalendarOptions.firstDay)},di.prototype.initDatePicker=function(){this.$datePicker.datepicker({showOtherMonths:!0,selectOtherMonths:!0,monthNames:Ei.getMonthNamesArray(),dayNamesMin:Ei.i18n("DATETIME/DAY_NAMES_MIN").split(" "),nextText:"",prevText:"",onChangeMonthYear:_.bind(this.changeMonthYearFromDatePicker,this),onSelect:_.bind(this.selectDateFromDatePicker,this),beforeShowDay:_.bind(this.getDayDescription,this)})},di.prototype.onApplyBindings=function(){this.$calendarGrid=e(this.calendarGridDom()),this.$datePicker=e(this.datePickerDom()),this.isPublic||this.initUploader()},di.prototype.onShow=function(){this.initialized()||(this.initDatePicker(),this.applyCalendarSettings(),this.highlightWeekInDayPicker(),this.initialized(!0)),Fi.CalendarCache?(Fi.CalendarCache.calendarSettingsChanged()||Fi.CalendarCache.calendarChanged())&&(Fi.CalendarCache.calendarSettingsChanged()&&this.applyCalendarSettings(),Fi.CalendarCache.calendarSettingsChanged(!1),Fi.CalendarCache.calendarChanged(!1),this.getCalendars()):this.isPublic&&this.$calendarGrid.fullCalendar("render"),this.refetchEvents()},di.prototype.setTimeline=function(){var t=(this.$calendarGrid.fullCalendar("getView"),new Date),i=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=new Date(this.todayDate.getFullYear(),this.todayDate.getMonth(),this.todayDate.getDate()),o=null,n=null,r=0,a=0,l=0;i>s&&(this.execCommand("today"),this.todayDate=this.$calendarGrid.fullCalendar("getDate").toDate(),this.$calendarGrid.fullCalendar("render")),o=e(".fc-slats:visible").parent(),n=o.children(".timeline"),0===n.length&&(n=e("<hr>").addClass("timeline"),o.prepend(n)),n.css("left",e("td .fc-axis").width()+10),n.show(),r=60*t.getHours()*60+60*t.getMinutes()+t.getSeconds(),a=r/86400,l=Math.floor(o.height()*a),n.css("top",l+"px")},di.prototype.viewRenderCallback=function(i){var s,o=null,n="01/01/1971 ";this.changeDate(),this.loaded||this.initResizing(),"undefined"!=typeof s&&t.clearInterval(s),s=t.setInterval(_.bind(function(){this.setTimeline()},this),6e4);try{this.setTimeline()}catch(r){}"month"!==i.name&&Mi.User.CalendarShowWorkDay&&e(".fc-slats tr").each(function(){e("tr .fc-time span").each(function(){var t=e(this).eq(0).text(),i=""!==t?Date.parse(n+t):o,s=Date.parse(n+Mi.User.CalendarWorkDayStarts+":00"),r=Date.parse(n+Mi.User.CalendarWorkDayEnds+":00");o=i,(s>i||i>=r)&&(e(this).parent().parent().addClass("fc-non-working-time"),e(this).parent().parent().next().addClass("fc-non-working-time"))})}),this.activateCustomScrollInDayAndWeekView()},di.prototype.collectBusyDays=function(){var e=[],t=null,i=null,s=0,o=0;_.each(this.calendars.getEvents(),function(n){for(t=moment(n.start),i=n.end?moment(n.end):null,n.allDay&&i&&i.subtract(1,"days"),s=i?i.diff(t,"days"):0,o=0;s>=o;o++)e.push(t.clone().add("days",o).toDate())},this),this.busyDays(e)},di.prototype.refreshDatePicker=function(){var e=this;_.defer(function(){e.collectBusyDays(),e.$datePicker.datepicker("refresh"),e.highlightWeekInDayPicker()})},di.prototype.getDayDescription=function(e){var t=!0,i=_.find(this.busyDays(),function(t){return t.getDate()===e.getDate()&&t.getMonth()===e.getMonth()&&t.getYear()===e.getYear()},this),s=i?"day_with_events":"",o="";return[t,s,o]},di.prototype.initResizing=function(){var i=_.throttle(_.bind(this.resize,this),50);e(t).bind("resize",function(e){(e.target===this||Fi.browser.ie8AndBelow)&&i()}),i()},di.prototype.resize=function(){var e=this.$calendarGrid.parent();e&&this.$calendarGrid.fullCalendar("option","height",e.height()),this.dayNamesResize()},di.prototype.dayNamesResize=function(){if("month"===this.selectedView()){var t=e("div.weekday-header-item"),i=e("tr.fc-first td.fc-day"),s=e(i[0]).width(),o=0;if(7===t.length&&7===i.length&&0!==s)for(;7>o;o++)e(t[o]).width(s)}},di.prototype.changeMonthYearFromDatePicker=function(e,t){if(this.changeFullCalendarDate){var i=this.$calendarGrid.fullCalendar("getDate");i.month(t-1).year(e),this.$calendarGrid.fullCalendar("gotoDate",i)}},di.prototype.selectDateFromDatePicker=function(e){var t=this.getFCObject().moment(e);this.$calendarGrid.fullCalendar("gotoDate",t),_.defer(_.bind(this.highlightWeekInDayPicker,this))},di.prototype.highlightWeekInDayPicker=function(){var e=this.$datePicker.find("td.ui-datepicker-current-day"),t=e.parent(),i=this.$datePicker.find("table.ui-datepicker-calendar"),s=this.$calendarGrid.fullCalendar("getView");switch(s.name){case"agendaDay":i.addClass("highlight_day").removeClass("highlight_week");break;case"agendaWeek":i.removeClass("highlight_day").addClass("highlight_week");break;default:i.removeClass("highlight_day").removeClass("highlight_week")}t.addClass("current_week")},di.prototype.changeDateTitle=function(){var e=this.$calendarGrid.fullCalendar("getDate"),t=this.$calendarGrid.fullCalendar("getView"),i=e.format("MMMM YYYY"),s=t.intervalStart,o=t.intervalEnd?t.intervalEnd.add("days",-1):null;switch(t.name){case"agendaDay":i=e.format("MMMM D, YYYY");break;case"agendaWeek":s&&o&&(i=s.format("MMMM D, YYYY")+" - "+o.format("MMMM D, YYYY"))}this.dateTitle(i)},di.prototype.changeDate=function(){this.changeDateInDatePicker(),this.changeDateTitle(),this.getTimeLimits(),this.getCalendars()},di.prototype.changeDateInDatePicker=function(){var e=this.$calendarGrid.fullCalendar("getDate");this.changeFullCalendarDate=!1,this.$datePicker.datepicker("setDate",e.local().toDate()),this.changeFullCalendarDate=!0,this.highlightWeekInDayPicker()},di.prototype.activateCustomScrollInDayAndWeekView=function(){if(!Ni){var t=this.$calendarGrid.fullCalendar("getView"),s="month"===t.name?"day":"time",o=e(".fc-"+s+"-grid-container"),n=e("<div></div>");o.parent().append(n),o.appendTo(n),n.hasClass("scroll-wrap")||(n.attr("data-bind","customScrollbar: {x: false, y: true, top: 0}"),o.css({overflow:"hidden"}).addClass("scroll-inner"),i.applyBindings({},n[0])),this.domScrollWrapper=n}},di.prototype.execCommand=function(e,t){t?this.$calendarGrid.fullCalendar(e,t):this.$calendarGrid.fullCalendar(e)},di.prototype.displayToday=function(){this.execCommand("today")},di.prototype.displayPrev=function(){this.execCommand("prev")},di.prototype.displayNext=function(){this.execCommand("next")},di.prototype.changeView=function(e){this.selectedView(e),this.$calendarGrid.fullCalendar("changeView",e)},di.prototype.setAutoReloadTimer=function(){var e=this;clearTimeout(this.iAutoReloadTimer),Mi.User.AutoCheckMailInterval>0&&(this.iAutoReloadTimer=setTimeout(function(){e.getCalendars()},60*Mi.User.AutoCheckMailInterval*1e3))},di.prototype.reloadAll=function(){this.needsToReload=!0,this.getCalendars()},di.prototype.getTimeLimits=function(){var e=this.getDateFromCurrentView("start"),t=this.getDateFromCurrentView("end");this.startDateTime=e,this.endDateTime=t,this.needsToReload=!0},di.prototype.getCalendars=function(){this.checkStarted(!0),this.setCalendarGridVisibility(),Fi.Ajax.sendExt({Action:"CalendarList",IsPublic:this.isPublic?1:0,PublicCalendarId:this.publicCalendarId},this.onCalendarsResponse,this)},di.prototype.onCalendarsResponse=function(e){var t=[],i=[],s=null,o=null;e.Result?(this.loaded=!0,e.Result=_.sortBy(e.Result,function(e){return!e.isDefault}),_.each(e.Result,function(e){s=this.calendars.parseCalendar(e),t.push(s.id),o=this.calendars.getCalendarById(s.id),(!o||s&&o&&o.cTag!==s.cTag)&&(s=this.calendars.parseAndAddCalendar(e),s&&(this.isPublic&&(Fi.setTitle(s.name()),this.publicCalendarName(s.name())),i.push(s.id)))},this),0===this.calendars.count()&&this.isPublic&&this.needsToReload&&(Fi.setTitle(Ei.i18n("CALENDAR/NO_CALENDAR_FOUND")),Fi.Api.showErrorByCode(0,Ei.i18n("CALENDAR/NO_CALENDAR_FOUND"))),this.needsToReload=!1,this.calendars.expunge(t),_.each(t,function(e){s=this.calendars.getCalendarById(e),s&&s.eventsCount()>0&&s.reloadEvents()},this),this.getEvents(t)):(this.setCalendarGridVisibility(),this.checkStarted(!1))},di.prototype.getEvents=function(e){e.length>0?Fi.Ajax.sendExt({Action:"CalendarEventList",CalendarIds:JSON.stringify(e),Start:this.startDateTime,End:this.endDateTime,IsPublic:this.isPublic?1:0,TimezoneOffset:moment().zone(),Timezone:t.jstz?t.jstz.determine().name():""},this.onEventsResponse,this):(this.setAutoReloadTimer(),this.checkStarted(!1))},di.prototype.onEventsResponse=function(e,t){var i=null,s=t.CalendarIds?JSON.parse(t.CalendarIds):[],o=[];e.Result&&(_.each(e.Result,function(e){if(i=this.calendars.getCalendarById(e.calendarId)){o.push(e.id);var t=i.eventExists(e.id);Ei.isUnd(t)?i.addEvent(e):t.lastModified!==e.lastModified&&i.updateEvent(e)}},this),_.each(s,function(e){i=this.calendars.getCalendarById(e),i&&i.eventsCount()>0&&i.active()&&i.expungeEvents(o,this.startDateTime,this.endDateTime)},this),this.refreshView()),this.setAutoReloadTimer(),this.checkStarted(!1)},di.prototype.setCalendarGridVisibility=function(){this.$calendarGrid.css("visibility","").find(".fc-view div").first().css("visibility","")},di.prototype.getUnusedColor=function(){var e=_.difference(this.colors,this.calendars.getColors());return e.length>0?e[0]:this.colors[0]},di.prototype.openCreateCalendarForm=function(){if(!this.isPublic){var e=new mt;e.color(this.getUnusedColor()),Fi.Screens.showPopup(O,[_.bind(this.createCalendar,this),this.colors,e])}},di.prototype.createCalendar=function(e,t,i){this.isPublic||Fi.Ajax.send({Name:e,Description:t,Color:i,Action:"CalendarCreate"},this.onCalendarCreateResponse,this)},di.prototype.onCalendarCreateResponse=function(e){e.Result&&(this.calendars.parseAndAddCalendar(e.Result),this.calendars.sort())},di.prototype.openImportCalendarForm=function(e){this.isPublic||Fi.Screens.showPopup(x,[_.bind(this.reloadAll,this),e])},di.prototype.openUpdateCalendarForm=function(e){this.isPublic||Fi.Screens.showPopup(O,[_.bind(this.updateCalendar,this),this.colors,e])},di.prototype.updateCalendar=function(e,t,i,s){this.isPublic||Fi.Ajax.send({Name:e,Description:t,Color:i,Id:s,Action:"CalendarUpdate"},this.onCalendarUpdateResponse,this)},di.prototype.onCalendarUpdateResponse=function(e,t){var i=null;e.Result&&(i=this.calendars.getCalendarById(t.Id),i&&(i.name(t.Name),i.description(t.Description),i.color(t.Color),this.refetchEvents()))},di.prototype.updateCalendarColor=function(e,t){this.isPublic||Fi.Ajax.send({Color:e,Id:t,Action:"CalendarUpdateColor"},this.onCalendarUpdateColorResponse,this)},di.prototype.onCalendarUpdateColorResponse=function(e,t){if(e.Result){var i=this.calendars.getCalendarById(t.Id);i&&(i.color(t.Color),this.refetchEvents())}},di.prototype.openGetLinkCalendarForm=function(e){this.isPublic||Fi.Screens.showPopup(H,[_.bind(this.publicCalendar,this),e])},di.prototype.openShareCalendarForm=function(e){this.isPublic||Fi.Screens.showPopup(U,[_.bind(this.shareCalendar,this),e])},di.prototype.shareCalendar=function(e,t,i,s,o){this.isPublic||Fi.Ajax.send({Action:"CalendarShareUpdate",Id:e,IsPublic:t?1:0,Shares:JSON.stringify(i),ShareToAll:s?1:0,ShareToAllAccess:o},this.onCalendarShareUpdateResponse,this)},di.prototype.onCalendarShareUpdateResponse=function(e,t){if(e.Result){var i=this.calendars.getCalendarById(t.Id);i&&(i.shares(JSON.parse(t.Shares)),1===t.ShareToAll?(i.isShared(!0),i.isSharedToAll(!0),i.sharedToAllAccess=t.ShareToAllAccess):i.isSharedToAll(!1))}},di.prototype.publicCalendar=function(e,t){this.isPublic||Fi.Ajax.send({Action:"CalendarPublicUpdate",Id:e,IsPublic:t?1:0},this.onCalendarPublicUpdateResponse,this)},di.prototype.onCalendarPublicUpdateResponse=function(e,t){if(e.Result){var i=this.calendars.getCalendarById(t.Id);i&&i.isPublic(t.IsPublic)}},di.prototype.deleteCalendar=function(e,t){var i=this.calendars.getCalendarById(e),s=i?t?Ei.i18n("CALENDAR/CONFIRM_UNSUBSCRIBE_CALENDAR",{CALENDARNAME:i.name()}):Ei.i18n("CALENDAR/CONFIRM_REMOVE_CALENDAR",{CALENDARNAME:i.name()}):"",o=_.bind(function(t){t&&Fi.Ajax.send({Id:e,Action:"CalendarDelete"},this.onCalendarDeleteResponse,this)},this);!this.isPublic&&i&&Fi.Screens.showPopup(E,[s,o])},di.prototype.onCalendarDeleteResponse=function(e,t){if(e.Result){var i=this.calendars.getCalendarById(t.Id);i&&!i.isDefault&&(this.calendars.currentCal().id===i.id&&this.calendars.currentCal(null),this.calendars.removeCalendar(i.id),this.refetchEvents())}},di.prototype.onEventDragStart=function(){this.dragEventTrigger=!0,this.refreshDatePicker()},di.prototype.onEventDragStop=function(){var e=this;this.dragEventTrigger=!1,this.delayOnEventResult&&this.delayOnEventResultData&&0<this.delayOnEventResultData.length?(this.delayOnEventResult=!1,_.each(this.delayOnEventResultData,function(t){e.onEventActionResponse(t[0],t[1],!1)}),this.delayOnEventResultData=[],this.refreshView()):this.refreshDatePicker()},di.prototype.onEventResizeStart=function(){this.dragEventTrigger=!0},di.prototype.onEventResizeStop=function(){var e=this;this.dragEventTrigger=!1,this.delayOnEventResult&&this.delayOnEventResultData&&0<this.delayOnEventResultData.length?(this.delayOnEventResult=!1,_.each(this.delayOnEventResultData,function(t){e.onEventActionResponse(t[0],t[1],!1)}),this.delayOnEventResultData=[],this.refreshView()):this.refreshDatePicker()},di.prototype.createEventInCurrentCalendar=function(){this.createEventToday(this.calendars.currentCal())},di.prototype.createEventInCalendar=function(e){this.createEventToday(this.calendars.getCalendarById(e))},di.prototype.createEventToday=function(e){var t=this.getFCObject().moment();t.minutes()>30?t.add("minutes",60-t.minutes()):t.minutes(30),t.seconds(0).milliseconds(0),this.openEventPopup(e,t,t.clone().add("minutes",30),!1)},di.prototype.getParamsFromEventData=function(e){return{id:e.id,uid:e.uid,calendarId:e.calendarId,newCalendarId:Ei.isUnd(e.newCalendarId)?e.calendarId:e.newCalendarId,subject:e.subject,allDay:e.allDay?1:0,location:e.location,description:e.description,alarms:e.alarms?JSON.stringify(e.alarms):"[]",attendees:e.attendees?JSON.stringify(e.attendees):"[]",owner:e.owner,recurrenceId:e.recurrenceId,excluded:e.excluded,allEvents:e.allEvents,modified:e.modified?1:0,start:e.start.local().toDate(),end:e.end.local().toDate(),startTS:e.start.unix(),endTS:(e.end,e.end.unix()),rrule:e.rrule?JSON.stringify(e.rrule):null}},di.prototype.getEventDataFromParams=function(e){var t=e;return t.alarms=e.alarms?JSON.parse(e.alarms):[],t.attendees=e.attendees?JSON.parse(e.attendees):[],e.rrule&&(t.rrule=JSON.parse(e.rrule)),t},di.prototype.createEventFromGrid=function(e,t){var i=!e.hasTime();this.openEventPopup(this.calendars.currentCal(),e.local(),t.local(),i)},di.prototype.openEventPopup=function(e,t,i,s){this.isPublic||Fi.Screens.showPopup(G,[{CallbackSave:_.bind(this.createEvent,this),CallbackDelete:_.bind(this.deleteEvent,this),FCMoment:this.getFCObject().moment,Calendars:this.calendars,SelectedCalendar:e.id,Start:t,End:i,AllDay:s,TimeFormat:this.timeFormat,DateFormat:this.dateFormat,CallbackAttendeeActionDecline:_.bind(this.attendeeActionDecline,this)}])},di.prototype.createEvent=function(e){var t=this.getParamsFromEventData(e);this.isPublic||(t.calendarId=e.newCalendarId,t.selectStart=this.getDateFromCurrentView("start"),t.selectEnd=this.getDateFromCurrentView("end"),t.Action="CalendarEventCreate",Fi.Ajax.send(t,this.onEventActionResponseWithSubThrottle,this))},di.prototype.eventClickCallback=function(e){var t=_.bind(function(t){var i={ID:e.id,Uid:e.uid,RecurrenceId:e.recurrenceId,Calendars:this.calendars,SelectedCalendar:e.calendarId,AllDay:e.allDay,Location:e.location,Description:e.description,Subject:e.subject,Alarms:e.alarms,Attendees:e.attendees,RRule:e.rrule?e.rrule:null,Excluded:e.excluded?e.excluded:!1,Owner:e.owner,Appointment:e.appointment,OwnerName:e.ownerName,TimeFormat:this.timeFormat,DateFormat:this.dateFormat,AllEvents:t,CallbackSave:_.bind(this.updateEvent,this),CallbackDelete:_.bind(this.deleteEvent,this),CallbackAttendeeActionDecline:_.bind(this.attendeeActionDecline,this)};t!==Ci.CalendarEditRecurrenceEvent.None&&(t===Ci.CalendarEditRecurrenceEvent.AllEvents&&e.rrule?(i.Start=moment.unix(e.rrule.startBase),i.End=moment.unix(e.rrule.endBase)):(i.Start=e.start.clone(),i.Start=i.Start.local(),i.End=e.end.clone(),i.End=i.End.local()),Fi.Screens.showPopup(G,[i]))},this);e.rrule?e.excluded?t(Ci.CalendarEditRecurrenceEvent.OnlyThisInstance):Fi.Screens.showPopup(B,[t]):t(Ci.CalendarEditRecurrenceEvent.AllEvents)},di.prototype.eventAction=function(e,t,i){var s=this.calendars.getCalendarById(t.calendarId);s.access()===Ci.CalendarAccess.Read?i&&i():this.isPublic||(i&&(this.revertFunction=i),t.Action=e,Fi.Ajax.send(t,this.onEventActionResponseWithSubThrottle,this))},di.prototype.updateEvent=function(e){var t=this.getParamsFromEventData(e);t.selectStart=this.getDateFromCurrentView("start"),t.selectEnd=this.getDateFromCurrentView("end"),e.modified&&(this.calendars.setDefault(e.newCalendarId),this.eventAction("CalendarEventUpdate",t))},di.prototype.moveEvent=function(e,t,i){var s=this.getParamsFromEventData(e);s.selectStart=this.getDateFromCurrentView("start"),s.selectEnd=this.getDateFromCurrentView("end"),this.isPublic||(s.rrule?i(!1):(s.allEvents=Ci.CalendarEditRecurrenceEvent.AllEvents,this.eventAction("CalendarEventUpdate",s,i)))
},di.prototype.resizeEvent=function(e,t,i){var s=this.getParamsFromEventData(e),o=_.bind(function(e){e!==Ci.CalendarEditRecurrenceEvent.None?(s.allEvents=e,this.eventAction("CalendarEventUpdate",s,i)):i()},this);s.selectStart=this.getDateFromCurrentView("start"),s.selectEnd=this.getDateFromCurrentView("end"),e.rrule?s.excluded?o(Ci.CalendarEditRecurrenceEvent.OnlyThisInstance):Fi.Screens.showPopup(B,[o]):o(Ci.CalendarEditRecurrenceEvent.AllEvents)},di.prototype.deleteEvent=function(e){this.eventAction("CalendarEventDelete",this.getParamsFromEventData(e))},di.prototype.onEventActionResponseWithSubThrottle=function(e,t){this.dragEventTrigger?(this.delayOnEventResult=!0,this.delayOnEventResultData.push([e,t])):this.onEventActionResponse(e,t)},di.prototype.onEventActionResponse=function(t,i,s){var o=this.calendars.getCalendarById(i.calendarId),n=null,r=null,a=0;s=Ei.isUnd(s)?!0:!!s,t&&t.Result&&!Ei.isUnd(o)?(a=e(".calendar .fc-widget-content .scroll-inner").scrollTop(),"CalendarEventCreate"===i.Action||"CalendarEventUpdate"===i.Action?(r=o.getEvent(i.id),(Ei.isUnd(r)||Ei.isUnd(r.rrule))&&!i.rrule||i.allEvents!==Ci.CalendarEditRecurrenceEvent.AllEvents?o.removeEvent(i.id):o.removeEventByUid(i.uid,!0),i.newCalendarId&&i.newCalendarId!==i.calendarId&&(o=this.calendars.getCalendarById(i.newCalendarId)),_.each(t.Result.Events,function(e){o.addEvent(e)},this),o.cTag=t.Result.CTag,o.active()||o.active(!0),s&&this.refreshView(),this.restoreScroll(a),this.calendars.currentCal(o)):"CalendarEventDelete"===i.Action?(o.cTag=t.Result,i.allEvents===Ci.CalendarEditRecurrenceEvent.OnlyThisInstance?o.removeEvent(i.id):o.removeEventByUid(i.uid),s&&this.refreshView(),this.restoreScroll(a)):"CalendarEventBase"===i.Action&&(n=t.Result,Fi.Screens.showPopup(G,[{CallbackSave:_.bind(this.updateEvent,this),CallbackDelete:_.bind(this.deleteEvent,this),ID:n.id,Uid:n.uid,RecurrenceId:n.recurrenceId,Calendars:this.calendars,SelectedCalendar:n.calendarId,Start:moment(1e3*n.start),End:moment(1e3*n.end),AllDay:n.allDay,Location:n.location,Description:n.description,Subject:n.subject,Alarms:n.alarms,Attendees:n.attendees,RRule:n.rrule?n.rrule:null,Excluded:n.excluded?n.excluded:!1,Owner:n.owner,Appointment:n.appointment,TimeFormat:this.timeFormat,DateFormat:this.dateFormat,AllEvents:Ci.CalendarEditRecurrenceEvent.AllEvents}]))):"CalendarEventUpdate"!==i.Action||t.Result||1155!==Ei.pInt(t.ErrorCode)?this.revertFunction&&this.revertFunction():this.revertFunction=null,this.revertFunction=null},di.prototype.attendeeActionDecline=function(e,t){e.removeEvent(t),this.refreshView()},di.prototype.refetchEvents=function(){this.$calendarGrid.fullCalendar("refetchEvents")},di.prototype.refreshViewSingle=function(){this.refetchEvents(),this.refreshDatePicker()},di.prototype.refreshView=function(){},di.prototype.initUploader=function(){var e=this;this.uploaderArea()&&(this.oJua=new Jua({action:"?/Upload/Calendars/",name:"jua-uploader",queueSize:2,dragAndDropElement:this.uploaderArea(),disableAjaxUpload:!1,disableFolderDragAndDrop:!1,disableDragAndDrop:!1,disableAutoUploadOnDrop:!0,hidden:{Token:function(){return Mi.Token},AccountID:function(){return Mi.Accounts.currentId()},AdditionalData:function(){return JSON.stringify({CalendarID:e.uploadCalendarId()})}}}),this.oJua.on("onDrop",_.bind(this.onFileDrop,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)))},di.prototype.onFileDrop=function(e,t,i){var s=_.filter(this.calendars.collection(),function(e){return e.isEditable()});s.length>1?Fi.Screens.showPopup(j,[{CallbackSave:_.bind(this.uploadToSelectedCalendar,this),ProceedUploading:i,Calendars:this.calendars,EditableCalendars:s,DefaultCalendarId:this.defaultCalendarId()}]):this.uploadToSelectedCalendar(this.defaultCalendarId(),i)},di.prototype.onFileUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1;s?Fi.Api.showError(i.ErrorCode&&i.ErrorCode===Ci.Errors.IncorrectFileExtension?Ei.i18n("CONTACTS/ERROR_INCORRECT_FILE_EXTENSION"):Ei.i18n("WARNING/ERROR_UPLOAD_FILE")):this.reloadAll()},di.prototype.uploadToSelectedCalendar=function(e,t){this.uploadCalendarId(e),this.checkStarted(!0),t()},di.prototype.restoreScroll=function(e){this.domScrollWrapper&&this.domScrollWrapper.data("customscroll").vertical.set(e)},pi.prototype.__name="CFileStorageViewModel",pi.prototype.onApplyBindings=function(t){this.selector.initOnApplyBindings(".items_sub_list .item",".items_sub_list .selected.item",".items_sub_list .item .custom_checkbox",e(".panel.files .items_list",t),e(".panel.files .items_list .files_scroll.scroll-inner",t)),this.initUploader(),this.hotKeysBind()},pi.prototype.hotKeysBind=function(){var t=Fi.Screens.currentScreen()===Ci.Screens.FileStorage;e(document).on("keydown",_.bind(function(e){t&&e&&e.keyCode===Ci.Key.s&&this.selector.useKeyboardKeys()&&!Ei.isTextFieldFocused()&&(e.preventDefault(),this.isSearchFocused(!0))},this))},pi.prototype.initUploader=function(){var e=this;this.uploaderButton()&&this.uploaderArea()&&(this.oJua=new Jua({action:"?/Upload/File/",name:"jua-uploader",queueSize:2,clickElement:this.uploaderButton(),hiddenElementsPosition:Ei.isRTL()?"right":"left",dragAndDropElement:this.uploaderArea(),disableAjaxUpload:this.isPublic?!0:!1,disableFolderDragAndDrop:this.isPublic?!0:!1,disableDragAndDrop:this.isPublic?!0:!1,hidden:{Token:function(){return Mi.Token},AccountID:function(){return Mi.Accounts.currentId()},AdditionalData:function(t){return JSON.stringify({Type:e.storageType(),SubPath:t&&!Ei.isUnd(t.Folder)?t.Folder:"",Path:e.dropPath()})}}}),this.oJua.on("onProgress",_.bind(this.onFileUploadProgress,this)).on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onStart",_.bind(this.onFileUploadStart,this)).on("onDrop",_.bind(this.onDrop,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)))},pi.prototype.onFileUploadSelect=function(e,t){if(Mi.App.FileSizeLimit>0&&t.Size/1048576>Mi.App.FileSizeLimit)return Fi.Screens.showPopup(C,[Ei.i18n("FILESTORAGE/ERROR_SIZE_LIMIT",{SIZE:Mi.App.FileSizeLimit})]),!1;if(""===this.searchPattern()){var i=new ft,s=t.FileName,o=Ei.getFileExtension(s),n=Ei.getFileNameWithoutExtension(s),r=0,a=Mi.Accounts.getDefault();for(""!==o&&(o="."+o);!Ei.isUnd(this.getFileByName(s));)s=n+"_"+r+o,r++;i.onUploadSelectOwn(e,t,s,a.email(),this.path(),this.storageType()),this.uploadingFiles.push(i)}},pi.prototype.onFileUploadStart=function(e){var t=this.getUploadFileByUid(e);t&&t.onUploadStart()},pi.prototype.onFileUploadProgress=function(e,t,i){if(""===this.searchPattern()){var s=this.getUploadFileByUid(e);s&&s.onUploadProgress(t,i)}},pi.prototype.onFileUploadComplete=function(e,t,i){if(""===this.searchPattern()){var s=this.getUploadFileByUid(e);s&&(s.onUploadComplete(e,t,i),this.deleteUploadFileByUid(e),s.uploadError()?(this.uploadError(!0),Fi.Api.showError(s.statusText())):(this.files.push(s),0===this.uploadingFiles().length&&Fi.Api.showReport(Ei.i18n("COMPOSE/UPLOAD_COMPLETE")))),this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()),this.searchPattern(),!1)}},pi.prototype.onDrop=function(e,t){if(!this.isPublic)if(t&&t.target&&""===this.searchPattern()){var s=i.dataFor(t.target);s&&s instanceof ft&&s.isFolder()&&this.dropPath(s.fullPath())}else Fi.Api.showReport(Ei.i18n("FILESTORAGE/INFO_CANNOT_UPLOAD_SEARCH_RESULT"))},pi.prototype.filesDrop=function(e,t,i){if(!this.isPublic&&e&&t){var s=this,o="",n=e.fullPath(),r=t.ctrlKey?"FilesCopy":"FilesMove",a=[],l=[];(this.path()!==n&&this.storageType()===e.storageType()||this.storageType()!==e.storageType())&&(e.recivedAnim(!0),Ei.uiDropHelperAnim(t,i),a=this.selector.listCheckedAndSelected(),l=_.map(a,function(e){return t.ctrlKey||(e.isFolder()?s.deleteFolderByName(e.fileName()):s.deleteFileByName(e.id())),o=e.path(),{Name:e.id(),IsFolder:e.isFolder()}}),Fi.Ajax.send({Action:r,FromType:this.storageType(),ToType:e.storageType(),FromPath:o,ToPath:n,Files:JSON.stringify(l)},this.onFilesMoveResponse,this))}},pi.prototype.onFilesMoveResponse=function(){this.getQuota(this.storageType())},pi.prototype.dragAndDropHelper=function(t){t&&t.checked(!0);var i=Ei.draggableMessages(),s=this.selector.listCheckedAndSelected(),o=s.length,n=0,r=0,a="";return _.each(s,function(e){e.isFolder()?r++:n++},this),0!==n&&0!==r?a=Ei.i18n("FILESTORAGE/DRAG_ITEMS_TEXT_PLURAL",{COUNT:o},null,o):0===n?a=Ei.i18n("FILESTORAGE/DRAG_FOLDERS_TEXT_PLURAL",{COUNT:r},null,r):0===r&&(a=Ei.i18n("FILESTORAGE/DRAG_TEXT_PLURAL",{COUNT:n},null,n)),e(".count-text",i).text(a),i},pi.prototype.onItemDelete=function(){this.executeDelete()},pi.prototype.onEnter=function(e){this.onItemDblClick(e)},pi.prototype.onItemDblClick=function(e){e&&(e.isFolder()?this.getFiles(this.storageType(),e):e.isViewable()?e.viewFile():e.downloadFile())},pi.prototype.onFilesResponse=function(e,t){if(e.Result){var i=[],s=[],o=Date.now().toString();e.Result.Quota&&(this.quota(e.Result.Quota[0]+e.Result.Quota[1]),this.used(e.Result.Quota[0])),_.each(e.Result.Items,function(e){var t=(new ft).allowDrag(!0).allowSelect(!0).allowCheck(!0).allowDelete(!0).allowUpload(!0).allowSharing(!0).allowHeader(!0).allowDownload(!0).isPopupItem(this.isPopup);t.parse(e,this.publicHash),t.getInThumbQueue(o),t.isFolder()?i.push(t):s.push(t)},this),(this.isPublic||t.Type===this.storageType())&&(this.folders(i),this.files(s)),this.loading(!1),this.loadedFiles(!0),clearTimeout(this.timerId)}else this.error(!0),this.loading(!1)},pi.prototype.onQuotaResponse=function(e){e.Result&&e.Result.Quota&&(this.quota(e.Result.Quota[0]+e.Result.Quota[1]),this.used(e.Result.Quota[0]))},pi.prototype.onFilesDeleteResponse=function(e){e.Result?this.expungeFileItems():this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()),this.searchPattern())},pi.prototype.executeRename=function(){var e=this.selector.listCheckedAndSelected();!this.isPublic&&e[0]&&Fi.Screens.showPopup(N,[e[0],_.bind(this.renameItem,this)])},pi.prototype.executeDownload=function(){var e=this.selector.listCheckedAndSelected();e[0]&&!e[0].isFolder()&&e[0].downloadFile()},pi.prototype.executeShare=function(){var e=this.selector.listCheckedAndSelected();!this.isPublic&&e[0]&&Fi.Screens.showPopup(k,[e[0]])},pi.prototype.executeSend=function(){var e=this.selector.listCheckedAndSelected(),t=_.filter(e,function(e){return!e.isFolder()},this);t.length>0&&Fi.Api.composeMessageWithFiles(t)},pi.prototype.onShareIconClick=function(e){e&&Fi.Screens.showPopup(k,[e])},pi.prototype.renameItem=function(e){var t=Ei.trim(e.nameForEdit());return Ei.validateFileOrFolderName(t)?(Fi.Ajax.send({Action:"FilesRename",Type:this.storageType(),Path:e.path(),Name:e.id(),NewName:t,IsLink:e.isLink()?1:0},this.onFilesRenameResponse,this),""):Ei.i18n(e.isFolder()?"FILESTORAGE/INVALID_FOLDER_NAME":"FILESTORAGE/INVALID_FILE_NAME")},pi.prototype.onFilesRenameResponse=function(){this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()),this.searchPattern())},pi.prototype.executeDelete=function(){var e=this.selector.listCheckedAndSelected();!this.isPublic&&e&&e.length>0&&Fi.Screens.showPopup(E,[Ei.i18n("FILESTORAGE/CONFIRMATION_DELETE"),_.bind(this.deleteItems,this,e)])},pi.prototype.onShow=function(){this.loaded(!0),this.getStorages(),this.selector.useKeyboardKeys(!0),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},pi.prototype.onHide=function(){this.selector.useKeyboardKeys(!1),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},pi.prototype.getQuota=function(e){Fi.Ajax.send({Action:"FilesQuota",Type:e},this.onQuotaResponse,this)},pi.prototype.getStorageByType=function(e){return _.find(this.storages(),function(t){return t.storageType()===e})},pi.prototype.getStorages=function(){this.isPublic?this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex())):(this.getStorageByType("personal")||this.storages.push((new ft).isFolder(!0).storageType("personal").displayName(Ei.i18n("FILESTORAGE/TAB_PERSONAL_FILES"))),this.IsCollaborationSupported&&(this.getStorageByType("corporate")||this.storages.push((new ft).isFolder(!0).storageType("corporate").displayName(Ei.i18n("FILESTORAGE/TAB_CORPORATE_FILES"))),this.AllowFilesSharing&&(this.getStorageByType("shared")||this.storages.push((new ft).isFolder(!0).storageType("shared").displayName(Ei.i18n("FILESTORAGE/TAB_SHARED_FILES"))))),this.isPopup?this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex())):this.getExternalFileStorages())},pi.prototype.getExternalFileStorages=function(){Fi.Ajax.send({Action:"FileStoragesExternal"},this.onExternalStoragesResponse,this)},pi.prototype.onExternalStoragesResponse=function(e){e.Result&&(_.each(e.Result,function(e){this.getStorageByType(e.Type)||this.storages.push((new ft).isExternal(!0).isFolder(!0).storageType(e.Type).displayName(e.DisplayName))},this),this.expungeExternalStorages(_.map(e.Result,function(e){return e.Type},this))),this.getStorageByType(this.storageType())||this.storageType("personal"),this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()))},pi.prototype.getFiles=function(e,t,i,s){var o=this,n=this.storageType(),r=this.iPathIndex(),a=(new ft).isFolder(!0).storageType(e);return this.isPublic?this.getFilesPub(t):(this.error(!1),this.storageType(e),o.loadedFiles(!1),(Ei.isUnd(s)||!Ei.isUnd(s)&&s)&&(this.timerId=setTimeout(function(){o.loadedFiles()||(o.folders([]),o.files([]),o.loading(!0))},1500)),this.searchPattern(Ei.isUnd(i)?"":Ei.pString(i)),Ei.isUnd(t)||""===t.id()?(this.pathItems.removeAll(),a.displayName(this.rootPath())):a=t,this.pathItems.push(a),this.iPathIndex(this.pathItems().length-1),(r!==this.iPathIndex()||n!==this.storageType())&&(this.folders([]),this.files([])),void Fi.Ajax.sendExt({Action:"Files",Type:e,Path:this.path(),Pattern:this.searchPattern()},this.onFilesResponse,this))},pi.prototype.getFilesPub=function(e){var t=this.iPathIndex(),i=(new ft).isFolder(!0);Ei.isUnd(e)||""===e.id()?(this.pathItems.removeAll(),i.displayName(this.rootPath())):i=e,this.pathItems.push(i),this.iPathIndex(this.pathItems().length-1),t!==this.iPathIndex()&&(this.folders([]),this.files([])),Fi.Ajax.sendExt({Action:"FilesPub",Hash:Mi.FileStoragePubHash,Path:this.path()},this.onFilesResponse,this)},pi.prototype.deleteItems=function(e,t){if(t&&0<e.length){var i=_.map(e,function(e){return e.deleted(!0),{Path:e.path(),Name:e.id()}});Fi.Ajax.send({Action:"FilesDelete",Type:this.storageType(),Path:this.path(),Items:JSON.stringify(i)},this.onFilesDeleteResponse,this)}},pi.prototype.getPathItemByIndex=function(e){var t=this.pathItems()[e],i=(new ft).fileName(this.rootPath()).id("");return this.pathItems(this.pathItems().slice(0,e)),t&&!this.isPublic&&(i=t),i},pi.prototype.getFullPathByIndex=function(e){var t=_.map(this.pathItems().slice(0,e),function(e){return e.fileName()});return t.join("/")},pi.prototype.getFileByName=function(e){return _.find(this.files(),function(t){return t.id()===e})},pi.prototype.deleteFileByName=function(e){this.files(_.filter(this.files(),function(t){return t.id()!==e}))},pi.prototype.deleteFolderByName=function(e){this.folders(_.filter(this.folders(),function(t){return t.fileName()!==e}))},pi.prototype.expungeFileItems=function(){this.folders(_.filter(this.folders(),function(e){return!e.deleted()},this)),this.files(_.filter(this.files(),function(e){return!e.deleted()},this))},pi.prototype.expungeExternalStorages=function(e){this.storages(_.filter(this.storages(),function(t){return!t.isExternal()||_.include(e,t.storageType())},this))},pi.prototype.deleteStorageByType=function(e){this.storages(_.filter(this.storages(),function(t){return t.storageType()!==e}))},pi.prototype.getUploadFileByUid=function(e){return _.find(this.uploadingFiles(),function(t){return t.uploadUid()===e})},pi.prototype.deleteUploadFileByUid=function(e){this.uploadingFiles(_.filter(this.uploadingFiles(),function(t){return t.uploadUid()!==e}))},pi.prototype.getUploadingFiles=function(){var e=[],t=this.uploadingFiles(),i=this;return Ei.isUnd(t)||(e=_.filter(t,function(e){return e.path()===i.path()&&e.storageType()===i.storageType()})),e},pi.prototype.onCancelUpload=function(e){this.oJua&&this.oJua.cancel(e),this.deleteUploadFileByUid(e)},pi.prototype.onCreateFolderResponse=function(){this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()))},pi.prototype.createFolder=function(e){return e=Ei.trim(e),Ei.validateFileOrFolderName(e)?(Fi.Ajax.send({Action:"FilesFolderCreate",Type:this.storageType(),Path:this.path(),FolderName:e},this.onCreateFolderResponse,this),""):Ei.i18n("FILESTORAGE/INVALID_FOLDER_NAME")},pi.prototype.onCreateFolderClick=function(){Fi.Screens.showPopup(R,[_.bind(this.createFolder,this)])},pi.prototype.onCreateLinkResponse=function(){this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()))},pi.prototype.createLink=function(e){Fi.Ajax.send({Action:"FilesLinkCreate",Type:this.storageType(),Path:this.path(),Link:e.linkUrl(),Name:e.fileName()},this.onCreateLinkResponse,this)},pi.prototype.onCreateLinkClick=function(){var e=_.bind(this.createLink,this);Fi.Screens.showPopup(D,[e])},pi.prototype.onSearch=function(){this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()),this.searchPattern())},pi.prototype.clearSearch=function(){this.getFiles(this.storageType(),this.getPathItemByIndex(this.iPathIndex()))},mi.prototype.requestFromLogin=function(){Fi.Storage.getData("helpdeskQuestion")&&(this.newThreadText(Fi.Storage.getData("helpdeskQuestion")),Fi.Storage.setData("helpdeskQuestion"),this.executeThreadCreate())},mi.prototype.cleanAll=function(){this.replyText(""),this.replyTextFocus(!1),this.newThreadText(""),this.uploadedFiles([]),this.posts([]),this.internalNote(!1),this.isQuickReplyActive(!1)},mi.prototype.onOwnerContactResponse=function(e){e?(this.ownerContact(e),this.ownerExistsInContacts(!0)):(this.ownerContact(new ut),this.ownerExistsInContacts(!1)),this.ownerContactInfoReceived(!0)},mi.prototype.updateOpenerWindow=function(){this.singleMode&&t.opener&&t.opener.App&&t.opener.App.updateHelpdesk()},mi.prototype.deletePost=function(e){if(e&&e.itsMe()){var t=this,i=function(i){i&&Fi.Ajax[t.ajaxSendFunc]({Action:"HelpdeskPostDelete",PostId:e.Id,ThreadId:e.IdThread,IsExt:t.bExtApp?1:0},t.onHelpdeskPostDeleteResponse,t)};Fi.Screens.showPopup(E,[Ei.i18n("HELPDESK/CONFIRM_DELETE_THIS_POST"),i])}},mi.prototype.onHelpdeskPostDeleteResponse=function(e){e.Result===!1?Fi.Api.showErrorByCode(e,Ei.i18n("HELPDESK/ERROR_COULDNT_DELETE_POST")):Fi.Api.showReport(Ei.i18n("HELPDESK/REPORT_POST_HAS_BEEN_DELETED")),this.requestPosts(),this.updateOpenerWindow()},mi.prototype.addToContacts=function(){this.selectedItem()&&Fi.ContactsCache.addToContacts("",this.selectedItem().sEmail,this.onAddToContactsResponse,this)},mi.prototype.iHaveMoreToSay=function(){var e=this;this.isQuickReplyHidden(!1),_.delay(function(){e.replyTextFocus(!0)},300)},mi.prototype.onAddToContactsResponse=function(e,t){e.Result&&this.selectedItem()&&""!==t.HomeEmail&&t.HomeEmail===this.selectedItem().sEmail&&(Fi.Api.showReport(Ei.i18n("CONTACTS/REPORT_CONTACT_SUCCESSFULLY_ADDED")),Fi.ContactsCache.clearInfoAboutEmail(this.selectedItem().sEmail),Fi.ContactsCache.getContactByEmail(this.selectedItem().sEmail,this.onOwnerContactResponse,this))},mi.prototype.scrollPostsToBottom=function(){this.scrollToBottomTrigger(!this.scrollToBottomTrigger())},mi.prototype.scrollPostsToTop=function(){this.scrollToTopTrigger(!this.scrollToTopTrigger())},mi.prototype.showClientDetails=function(){this.clientDetailsVisible(!0)},mi.prototype.hideClientDetails=function(){this.clientDetailsVisible(!1)},mi.prototype.startAutocheckmail=function(){var e=this,t=Mi&&Mi.User?Mi.User.AutoCheckMailInterval:1;t>0&&(clearTimeout(this.iAutoCheckTimer),this.iAutoCheckTimer=setTimeout(function(){e.checkCommand()},60*t*1e3))},mi.prototype.onApplyBindings=function(t){this.selector.initOnApplyBindings(".items_sub_list .item",".items_sub_list .selected.item",".items_sub_list .item .custom_checkbox",e(".items_list",t),e(".threads_scroll.scroll-inner",t)),this.initUploader(),e(this.domQuickReply()).on("click",_.bind(function(e){this.isQuickReplyActive(!0),e.stopPropagation()},this)),e(document.body).on("click",_.bind(function(){var e=Fi.Screens.currentScreen()===Ci.Screens.Helpdesk;e&&this.isEmptyQuickReplyPane()&&this.isQuickReplyActive(!1)},this)),Fi.registerHelpdeskUpdateFunction&&Fi.registerHelpdeskUpdateFunction(_.bind(this.checkCommand,this)),this.startAutocheckmail(),this.hotKeysBind()},mi.prototype.onShow=function(){this.newThreadButtonWidth.notifySubscribers(),this.selector.useKeyboardKeys(!0),this.oPageSwitcher.show(),this.oPageSwitcher.perPage(this.ThreadsPerPage),this.oPageSwitcher.currentPage(1),this.requestThreadsList()},mi.prototype.onHide=function(){this.selector.useKeyboardKeys(!1),this.selectedItem(null),this.oPageSwitcher.hide()},mi.prototype.requestThreadsList=function(){this.loadingList(!0),this.checkStarted(!0),Fi.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadsList",IsExt:this.bExtApp?1:0,Offset:(this.oPageSwitcher.currentPage()-1)*this.ThreadsPerPage,Limit:this.ThreadsPerPage,Filter:this.listFilter(),Search:this.search()},this.onHelpdeskThreadsListResponse,this),this.requestThreadsPendingCount()},mi.prototype.requestThreadByIdOrHash=function(e,t){Fi.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadByIdOrHash",IsExt:this.bExtApp?1:0,ThreadId:e?e:0,ThreadHash:t?t:""},this.onThreadByIdOrHashResponse,this)},mi.prototype.requestThreadsPendingCount=function(){Fi.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadsPendingCount",IsExt:this.bExtApp?1:0},this.onHelpdeskThreadsPendingCountResponse,this)},mi.prototype.onHelpdeskThreadsListResponse=function(e){var t=0,i=0,s=this.selectedItem(),o=s?Ei.pString(s.Id):"",n=[],r=null,a=null,l=e.Result&&_.isArray(e.Result.List)?e.Result.List:[];if(this.checkStarted(!1),e.Result===!1)Fi.Api.showErrorByCode(e);else{for(i=l.length;i>t;t++)l[t]&&"Object/CHelpdeskThread"===Ei.pExport(l[t],"@Object","")&&(r=new yt,r.parse(l[t]),r.OwnerIsMe=Ei.pString(r.IdOwner),o===Ei.pString(r.Id)&&(s.postsCount(r.postsCount()),r.selected(!0),this.selector.itemSelected(r)),n.push(r));this.loadingList(!1);var h=_.max(this.threads().concat(n),function(e){return e.time()});h&&moment().unix()-h.time()<3&&h.ItsMe&&this.onItemSelect(h),this.threads(n),Fi.helpdeskUnseenCount(_.filter(n,function(e){return e.unseen()},this).length),this.oPageSwitcher.setCount(Ei.pInt(e.Result.ItemsCount)),Mi.HelpdeskThreadId&&(a=_.find(n,function(e){return e.Id===Mi.HelpdeskThreadId},this),a?(a=a,this.onItemSelect(a)):n.length&&this.requestThreadByIdOrHash(Mi.HelpdeskThreadId)),Mi.HelpdeskThreadAction&&("add"===Mi.HelpdeskThreadAction?this.iHaveMoreToSay():"close"===Mi.HelpdeskThreadAction&&this.closeCommand())}},mi.prototype.onHelpdeskThreadsPendingCountResponse=function(e){e.Result===!1?Fi.Api.showErrorByCode(e):Fi.helpdeskPendingCount(e.Result)},mi.prototype.requestPosts=function(e,t){var i=this.selectedItem(),s=e?e.Id:i?i.Id:0,o=t?t:0,n={};s&&(n={Action:"HelpdeskThreadPosts",IsExt:this.bExtApp?1:0,ThreadId:s,StartFromId:o,Limit:5},o&&this.loadingMoreMessages(!0),Fi.Ajax[this.ajaxSendFunc](n,this.onHelpdeskThreadPostsResponse,this))},mi.prototype.onHelpdeskThreadPostsResponse=function(e){var t=this,i=0,s=0,o=[],n=[],r=null,a="",l=e.Result&&_.isArray(e.Result.List)?e.Result.List:[];if(e.Result===!1)Fi.Api.showErrorByCode(e);else if(this.selectedItem()&&e.Result.ThreadId===this.selectedItem().Id){for(this.selectedItem().postsCount(Ei.pInt(e.Result.ItemsCount)),s=l.length;s>i;i++)l[i]&&"Object/CHelpdeskPost"===Ei.pExport(l[i],"@Object","")&&(r=new bt,r.parse(l[i]),o.push(r));if(n=this.posts(),e.Result.StartFromId){for(a=e.Result.StartFromId,s=n.length,i=0;s>i&&n.Id!==a;i++);_.each(o,function(e){this.posts.unshift(e)},this),this.loadingMoreMessages(!1)}else(0===n.length||n[n.length-1].Id!==o[0].Id)&&(0!==n.length?_.each(o.reverse(),function(e){_.find(n,function(t){return t.Id===e.Id})||this.posts.push(e)},this):this.posts(o.reverse()),_.delay(function(){t.scrollPostsToBottom()},100));this.selectedItem().unseen()&&this.executeThreadSeen(this.selectedItem().Id)}},mi.prototype.onRoute=function(e){var t=e[0],i=_.find(this.threads(),function(e){return e.ThreadHash===t});i?(i=i,this.onItemSelect(i)):0===this.threads().length&&this.loadingList()&&void 0===this.threadSubscription&&!Mi.SingleMode?this.threadSubscription=this.threads.subscribe(function(){this.onRoute(e),this.threadSubscription.dispose(),this.threadSubscription=void 0},this):t?this.requestThreadByIdOrHash(null,t):(this.selectedItem(null),this.selector.itemSelected(null))},mi.prototype.onThreadByIdOrHashResponse=function(e){var t=new yt;e.Result&&(t.parse(e.Result),t.OwnerIsMe=Ei.pString(t.IdOwner),this.onItemSelect(t))},mi.prototype.onItemSelect=function(e){(!this.selectedItem()||e&&(this.selectedItem().ThreadHash!==e.ThreadHash||this.selectedItem().Id!==e.Id))&&(this.uploadedFiles().length>0||this.replyText().length>0||this.newThreadText().length>0?Fi.Screens.showPopup(E,[Ei.i18n("HELPDESK/CONFIRM_CANCEL_REPLY"),_.bind(function(t){t?this.selectItem(e):(this.replyTextFocus(!0),this.isQuickReplyHidden(!1),this.selector.itemSelected(null))},this)]):this.selectItem(e))},mi.prototype.onItemDelete=function(){this.executeDelete()},mi.prototype.selectItem=function(e){this.visibleNewThread(!1),this.selector.listCheckedAndSelected(!1),this.cleanAll(),e&&(this.selector.itemSelected(e),this.selectedItem(e),this.isQuickReplyHidden(e.ItsMe||!this.bAgent),this.requestPosts(e),this.singleMode||Fi.Routing.setHash([Ci.Screens.Helpdesk,e.ThreadHash]),e.postsCount(0),this.posts([]))},mi.prototype.openNewThread=function(){this.uploadedFiles().length>0||this.replyText().length>0||this.newThreadText().length>0?Fi.Screens.showPopup(E,[Ei.i18n("HELPDESK/CONFIRM_CANCEL_REPLY"),_.bind(function(e){e&&(this.cleanAll(),this.visibleNewThread(!0))},this)]):(this.selector.itemSelected(null),this.selectedItem(null),this.visibleNewThread(!0),Fi.Routing.setHash([Ci.Screens.Helpdesk,""]))},mi.prototype.cancelNewThread=function(){this.onItemSelect(this.previousSelectedItem())},mi.prototype.isEnableListActions=function(){return!!this.selectedItem()},mi.prototype.executeDelete=function(){var e=this,t=this.selectedItem();t&&(_.each(this.threads(),function(e){e===t&&e.deleted(!0)}),_.delay(function(){e.threads.remove(function(e){return e.deleted()})},500),this.selectedItem(null),Fi.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadDelete",IsExt:this.bExtApp?1:0,ThreadId:t.Id},this.onHelpdeskThreadDeleteResponse,this),Fi.Routing.setHash([Ci.Screens.Helpdesk,""]))},mi.prototype.executeOpenNewWindow=function(){var e=Fi.Routing.buildHashFromArray([Ci.Screens.SingleHelpdesk,this.selectedItem().ThreadHash]);Ei.WindowOpener.openTab(e)},mi.prototype.onHelpdeskThreadDeleteResponse=function(){this.requestThreadsList(),this.updateOpenerWindow()},mi.prototype.executeChangeState=function(e){var t=this.selectedItem();void 0!==e&&t&&(t.state(e),Fi.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadChangeState",IsExt:this.bExtApp?1:0,ThreadId:t.Id,Type:t.state()},this.onHelpdeskThreadChangeStateResponse,this))},mi.prototype.onHelpdeskThreadChangeStateResponse=function(){this.requestThreadsList(),this.updateOpenerWindow()},mi.prototype.executeThreadPing=function(e){void 0!==e&&Fi.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadPing",IsExt:this.bExtApp?1:0,ThreadId:e},this.onThreadPingResponse,this)},mi.prototype.onThreadPingResponse=function(e){this.watchers(_.map(e.Result,function(e){var t=e.length>0?e[0].replace(/"/g,""):"",i=e.length>0?e[1]:"",s={name:t,email:i,text:i,initial:i.substr(0,2),icon:""};return i.length>0&&t.length>0?(s.text='"'+t+'" <'+i+">",s.initial=/\s/g.test(t)?_.reduce(t.split(" ",2),function(e,t){return e+t.substr(0,1)},""):t.substr(0,2)):i.length>0?(s.text=i,s.initial=i.substr(0,2)):t.length>0&&(s.text=t,s.initial=_.reduce(t.split(" ",2),function(e,t){return e+t.substr(0,1)},"")),s},this))},mi.prototype.executeThreadSeen=function(e){void 0!==e&&Fi.Ajax[this.ajaxSendFunc]({Action:"HelpdeskThreadSeen",IsExt:this.bExtApp?1:0,ThreadId:e},this.onHelpdeskThreadSeenResponse,this)},mi.prototype.onHelpdeskThreadSeenResponse=function(e,t){var i=0,s=0,o=[],n=0;if(t.ThreadId&&(o=this.threads(),n=this.selectedItem()?this.selectedItem().Id:0,n>0))for(s=o.length;s>i;i++)if(n===t.ThreadId){Fi.helpdeskUnseenCount(Fi.helpdeskUnseenCount()-1),this.selectedItem().unseen(!1);break}this.updateOpenerWindow()},mi.prototype.executeThreadCreate=function(){var e=Ei.trim(this.newThreadText().replace(/[\n\r]/," ")),t=e.indexOf(" ",40);t>=0&&(e=e.substring(0,t)),this.newThreadCreating(!0),this.sendHelpdeskPostCreate(0,e,this.newThreadText(),this.onThreadCreateResponse)},mi.prototype.onThreadCreateResponse=function(e,t){this.newThreadCreating(!1),e.Result&&t&&(Fi.Api.showReport(Ei.i18n("HELPDESK/REPORT_THREAD_SUCCESSFULLY_CREATED")),this.cleanAll(),this.visibleNewThread(!1)),this.requestThreadsList(),this.updateOpenerWindow()},mi.prototype.executePostCreate=function(){this.selectedItem()&&(this.replySendingStarted(!0),this.sendHelpdeskPostCreate(this.selectedItem().Id,"",this.replyText(),this.onPostCreateResponse))},mi.prototype.onPostCreateResponse=function(e,t){this.replySendingStarted(!1),e.Result&&t&&(Fi.Api.showReport(Ei.i18n("HELPDESK/REPORT_POST_SUCCESSFULLY_ADDED")),this.cleanAll(),this.requestPosts()),this.requestThreadsList(),this.updateOpenerWindow()},mi.prototype.sendHelpdeskPostCreate=function(e,t,i,s){var o={},n={};_.each(this.uploadedFiles(),function(e){o[e.tempName()]=e.hash()}),n={Action:"HelpdeskPostCreate",IsExt:this.bExtApp?1:0,ThreadId:e,IsInternal:this.internalNote()?1:0,Subject:t,Text:i,Attachments:o},Fi.Ajax[this.ajaxSendFunc](n,s,this)},mi.prototype.onShowThreadsByOwner=function(){this.search("owner:"+this.selectedItem().aOwner[0]),this.requestThreadsList()},mi.prototype.onSearch=function(){this.requestThreadsList()},mi.prototype.onClearSearch=function(){this.search(""),this.requestThreadsList()},mi.prototype.initUploader=function(){this.oJua=this.createJuaObject(this.uploaderButton()),this.oJuaCompose=this.createJuaObject(this.uploaderButtonCompose())},mi.prototype.createJuaObject=function(e){if(e){var t=new Jua({action:"?/Upload/HelpdeskFile/",name:"jua-uploader",queueSize:2,clickElement:e,hiddenElementsPosition:Ei.isRTL()?"right":"left",dragAndDropElement:e,disableAjaxUpload:!1,disableFolderDragAndDrop:!1,disableDragAndDrop:!1,hidden:{IsExt:this.bExtApp?"1":"0",Token:Mi.Token,TenantHash:this.bExtApp&&Mi?Mi.TenantHash:"",AccountID:this.bExtApp?0:Mi.Accounts.currentId()}});return t.on("onProgress",_.bind(this.onFileUploadProgress,this)).on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)),t}return null},mi.prototype.onFileRemove=function(e){var t=this.getUploadedFileByUID(e);this.oJua&&this.oJua.cancel(e),this.uploadedFiles.remove(t)},mi.prototype.getUploadedFileByUID=function(e){return _.find(this.uploadedFiles(),function(t){return t.uploadUid()===e})},mi.prototype.onFileUploadSelect=function(e,t){var i,s=Ei.i18n("HELPDESK/ERROR_UPLOAD_FILES_COUNT"),o=Ei.i18n("MAIN/BUTTON_CLOSE"),n=this.uploadedFiles().length;return n>=5?(Fi.Screens.showPopup(C,[s,null,"",o]),!1):Fi.Api.showErrorIfAttachmentSizeLimit(t.FileName,t.Size)?!1:(i=new St,i.onUploadSelect(e,t),this.uploadedFiles.push(i),!0)},mi.prototype.onFileUploadProgress=function(e,t,i){var s=this.getUploadedFileByUID(e);s&&s.onUploadProgress(t,i)},mi.prototype.onFileUploadStart=function(e){var t=this.getUploadedFileByUID(e);t&&t.onUploadStart()},mi.prototype.onFileUploadComplete=function(e,t,i){var s=this.getUploadedFileByUID(e),o=Date.now().toString();s&&(s.onUploadComplete(e,t,i),"image"===s.type().substr(0,5)&&(s.thumb(!0),s.getInThumbQueue(o)))
},mi.prototype.hotKeysBind=function(){},mi.prototype.quoteText=function(e){var t=this.replyText(),i=_.bind(function(){this.replyText(""===t?">"+e:t+"\n>"+e),this.replyTextFocus(!0)},this);this.isQuickReplyHidden()?_.delay(function(){i()},300):i(),this.isQuickReplyHidden(!1)},gi.prototype.initScreens=function(){},gi.prototype.initLayout=function(){},gi.prototype.init=function(){this.initScreens(),this.initLayout(),e("#pSevenContent").addClass("single_mode"),_.defer(function(){Mi.SingleMode||e("#pSevenContent").removeClass("single_mode")}),this.informationScreen(this.showNormalScreen(Ci.Screens.Information))},gi.prototype.hasOpenedMinimizedPopups=function(){var e=!1;return _.each(this.popups,function(t){var i=t.__vm;i.minimized&&i.minimized()&&(e=!0)}),e},gi.prototype.hasOpenedMaximizedPopups=function(){var e=!1;return _.each(this.popups,function(t){var i=t.__vm;i.minimized&&i.minimized()||(e=!0)}),e},gi.prototype.getCurrentScreenModel=function(){var e=this.oScreens[this.currentScreen()],t="undefined"!=typeof e?e.Model:null;return t},gi.prototype.showCurrentScreen=function(e,t){var i=this.oScreens[this.currentScreen()],s="undefined"!=typeof i?i.Model:null;this.currentScreen()!==e&&(s&&i.bInitialized&&s.hideViewModel(),this.currentScreen(e)),this.showNormalScreen(e,t),this.resizeAll()},gi.prototype.showNormalScreen=function(e,t){var i=e,s=this.oScreens[i];return s&&(s.bInitialized="boolean"!=typeof s.bInitialized?!1:s.bInitialized,s.bInitialized||(s.Model=this.initViewModel(s.Model,s.TemplateName),s.bInitialized=!0),s.Model.showViewModel(t)),s?s.Model:null},gi.prototype.initViewModel=function(t,s){var o=null,n=null;return o=new t,n=e('div[data-view-model="'+s+'"]').attr("data-bind","template: {name: '"+s+"'}").hide(),o.$viewModel=n,o.bShown=!1,o.showViewModel=function(e){this.$viewModel.show(),"function"==typeof this.onRoute&&this.onRoute(e),this.bShown||("function"==typeof this.onShow&&this.onShow(e),Ii.runPluginHook&&this.__name&&Ii.runPluginHook("view-model-on-show",[this.__name,this]),this.bShown=!0)},o.hideViewModel=function(){this.$viewModel.hide(),"function"==typeof this.onHide&&this.onHide(),this.bShown=!1},i.applyBindings(o,n[0]),"function"==typeof o.onApplyBindings&&o.onApplyBindings(n),o},gi.prototype.showPopup=function(t,s){if(t){if(!t.__builded){var o=null,n=new t,r=n.popupTemplate?n.popupTemplate():"";""!==r&&(o=e('div[data-view-model="'+r+'"]').attr("data-bind","template: {name: '"+r+"'}").removeClass("visible").hide(),o&&1===o.length&&(n.visibility=i.observable(!1),t.__builded=!0,t.__vm=n,n.$viewModel=o,t.__dom=o,n.showViewModel=Ei.createCommand(n,function(){Fi&&Fi.Screens&&Fi.Screens.showPopup(t)}),n.closeCommand=Ei.createCommand(n,function(){Fi&&Fi.Screens&&Fi.Screens.hidePopup(t)}),i.applyBindings(n,o[0]),Ei.delegateRun(n,"onApplyBindings",[o])))}t.__vm&&t.__dom&&(t.__vm.visibility()||(t.__dom.show(),_.delay(function(){t.__dom.addClass("visible")},50),t.__vm.visibility(!0),this.popups.push(t),this.keyupPopupBinded=_.bind(this.keyupPopup,this,t.__vm),e(document).on("keyup",this.keyupPopupBinded)),Ei.delegateRun(t.__vm,"onShow",s))}},gi.prototype.keyupPopup=function(e,i){if(i){var s=t.parseInt(i.keyCode,10);Ci.Key.Esc===s&&(e.onEscHandler?e.onEscHandler(i):e.closeCommand()),Ci.Key.Enter!==s&&Ci.Key.Space!==s||!e.onEnterHandler||e.onEnterHandler()}},gi.prototype.hidePopup=function(t){t&&t.__vm&&t.__dom&&(this.keyupPopupBinded&&(e(document).off("keyup",this.keyupPopupBinded),this.keyupPopupBinded=void 0),t.__dom.removeClass("visible").hide(),t.__vm.visibility(!1),Ei.delegateRun(t.__vm,"onHide"),this.popups=_.without(this.popups,t))},gi.prototype.hideAllPopup=function(){_.each(this.popups,function(e){this.hidePopup(e)},this)},gi.prototype.showLoading=function(e){this.informationScreen()&&this.informationScreen().showLoading(e)},gi.prototype.hideLoading=function(){this.informationScreen()&&this.informationScreen().hideLoading()},gi.prototype.showReport=function(e,t){this.informationScreen()&&this.informationScreen().showReport(e,t)},gi.prototype.showError=function(e,t,i,s){this.informationScreen()&&this.informationScreen().showError(e,t,i,s)},gi.prototype.hideError=function(e){this.informationScreen()&&this.informationScreen().hideError(e)},gi.prototype.initHelpdesk=function(){var e=this.oScreens[Ci.Screens.Helpdesk];Mi.User.IsHelpdeskSupported&&e&&!e.bInitialized&&(e.Model=this.initViewModel(e.Model,e.TemplateName),e.bInitialized=!0)},gi.prototype.initScreens=function(){this.oScreens[Ci.Screens.Information]={Model:Mt,TemplateName:"Common_InformationViewModel"},this.oScreens[Ci.Screens.Login]={Model:kt,TemplateName:"Login_WrapLoginViewModel"},this.oScreens[Ci.Screens.Header]={Model:Pt,TemplateName:"Common_HeaderViewModel"},this.oScreens[Ci.Screens.Mailbox]={Model:Bt,TemplateName:"Mail_LayoutSidePane_MailViewModel"},this.oScreens[Ci.Screens.SingleMessageView]={Model:Gt,TemplateName:"Mail_LayoutSidePane_MessagePaneViewModel"},this.oScreens[Ci.Screens.Compose]={Model:jt,TemplateName:"Mail_ComposeViewModel"},this.oScreens[Ci.Screens.SingleCompose]={Model:jt,TemplateName:"Mail_ComposeViewModel"},this.oScreens[Ci.Screens.Settings]={Model:Yt,TemplateName:"Settings_SettingsViewModel"},this.oScreens[Ci.Screens.SingleHelpdesk]={Model:mi,TemplateName:"Helpdesk_ViewThreadInNewWindow"}},gi.prototype.initLayout=function(){e("#pSevenContent").append(e("#Layout").html())},fi.prototype.init=function(){var e=null;if(Fi.Ajax.openedRequestsCount.subscribe(function(){0===Fi.Ajax.openedRequestsCount()&&_.delay(_.bind(function(){0===Fi.Ajax.requests().length&&(this.checkMailStarted(!1),this.folderListLoading(!1))},this),10)},this),Mi.SingleMode&&t.opener&&(e=t.opener.App.MailCache,this.oFolderListItems=e.oFolderListItems,this.uidList(e.uidList()),e.uidList.subscribe(_.bind(function(){this.uidList(e.uidList())},this)),t.name)){var i,s=Ei.pInt(t.name);0===s&&t.opener&&t.opener.aMessagesParametersFromCompose&&(i=t.opener.aMessagesParametersFromCompose[t.name],s=i?i.accountId:0),0!==s&&this.currentAccountId(s)}this.currentAccountId.valueHasMutated()},fi.prototype.getCurrentFolder=function(){return this.folderList().currentFolder()},fi.prototype.getFolderByFullName=function(e,t){var i=this.oFolderListItems[e];return i?i.getFolderByFullName(t):null},fi.prototype.checkCurrentFolderList=function(){var e=Mi.Accounts.currentId(),t=this.oFolderListItems[e];t||this.messagesLoading()||(this.messagesLoading(!0),this.messagesLoadingError(!1),this.getFolderList(e))},fi.prototype.getFolderList=function(e){var t={Action:"FoldersGetList"};Ei.isUnd(e)||(t.AccountID=e),this.folderListLoading(!0),Fi.Ajax.send(t,this.onFoldersGetListResponse,this)},fi.prototype.markMessageReplied=function(e,t,i,s){var o=this.oFolderListItems[e],n=null;o&&(n=o.getFolderByFullName(t),n&&n.markMessageReplied(i,s))},fi.prototype.hideThreads=function(e){Mi.User.useThreads()&&e.folder()===this.folderList().currentFolderFullName()&&!e.threadOpened()&&this.folderList().currentFolder().hideThreadMessages(e)},fi.prototype.showOpenedThreads=function(e){this.messages(this.getMessagesWithThreads(e,this.uidList(),this.messages()))},fi.prototype.useThreadsInCurrentList=function(e){e=e||this.uidList();var t=this.folderList().currentFolder(),i=t&&t.withoutThreads(),s=""===e.search()&&""===e.filters();return Mi.User.useThreads()&&!i&&s},fi.prototype.getMessagesWithThreads=function(e,t,i){var s=[],o=[],n=this.folderList().currentFolder();return n&&e===n.fullName()&&this.useThreadsInCurrentList(t)?(o=_.filter(i,function(e){return!e.threadPart()}),_.each(o,function(e){var t=[];s.push(e),e.threadCount()>0&&(e.threadOpened()&&(t=this.folderList().currentFolder().getThreadMessages(e),s=_.union(s,t)),n.computeThreadData(e))},this),s):i},fi.prototype.setMessagesFromUidList=function(e,t,i,s){var o=e.getUidsForOffset(t,i),n=_.map(o,function(e){return i[e]},this),r=n.length;return s&&(this.messages(this.getMessagesWithThreads(this.folderList().currentFolderFullName(),e,n)),t+r<e.resultCount()&&r<Mi.User.MailsPerPage&&(e.filters()!==Ci.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.messagesLoading(!0),this.currentMessage()&&(this.currentMessage().deleted()||this.currentMessage().folder()!==this.folderList().currentFolderFullName())&&this.currentMessage(null)),o},fi.prototype.executeCheckMail=function(){var e=this.oFolderListItems[this.currentAccountId()],t=e?e.inboxFolder():null,i=t?t.uidNext():"",s=Mi.Accounts.getCurrentFetchersAndFiltersFolderNames(),o=e?[e.inboxFolderFullName(),e.spamFolderFullName(),e.currentFolderFullName()]:[],n=e?e.iAccountId:0,r=this.checkMailStarted()&&this.checkMailStartedAccountId()===n,a=null;Fi.Ajax.hasOpenedRequests("FoldersGetRelevantInformation")&&r||!(o.length>0)||(o=_.uniq(_.compact(_.union(o,s))),a={Action:"FoldersGetRelevantInformation",Folders:o,AccountID:n,InboxUidnext:i},this.checkMailStarted(!0),this.checkMailStartedAccountId(n),Fi.Ajax.send(a,this.onFoldersGetRelevantInformationResponse,this))},fi.prototype.setAutocheckmailTimer=function(){clearTimeout(this.iAutoCheckMailTimer),!Mi.SingleMode&&Mi.User.AutoCheckMailInterval>0&&(this.iAutoCheckMailTimer=setTimeout(function(){Fi.Ajax.isSearchMessages()||Fi.MailCache.executeCheckMail()},60*Mi.User.AutoCheckMailInterval*1e3))},fi.prototype.checkMessageFlags=function(){var e=this.folderList().inboxFolder(),t=e?e.getFlaggedMessageUids():[],i={Action:"MessagesGetFlags",Folder:this.folderList().inboxFolderFullName(),Uids:t};t>0&&Fi.Ajax.send(i,this.onMessagesGetFlagsResponse,this)},fi.prototype.onMessagesGetFlagsResponse=function(e){var t=this.folderList().inboxFolder();e.Result&&_.each(e.Result,function(e,i){-1===_.indexOf(e,"\\flagged")&&t.setMessageUnflaggedByUid(i)}),t.removeFlaggedMessageListsFromCache(),Fi.Prefetcher.prefetchStarredMessageList()},fi.prototype.changeCurrentMessageList=function(e,t,i,s){this.requestCurrentMessageList(e,t,i,s,!0)},fi.prototype.requestCurrentMessageList=function(e,t,i,s,o){var n=this.requestMessageList(e,t,i,s||"",!0,o||!1),r=60*Mi.User.AutoCheckMailInterval*1e3,a=n.Folder.relevantInformationLastMoment?moment().diff(n.Folder.relevantInformationLastMoment):r+1;this.uidList(n.UidList),this.page(t),this.messagesLoading(n.RequestStarted),this.messagesLoadingError(!1),!n.RequestStarted&&r>0&&a>r&&this.executeCheckMail()},fi.prototype.requestMessageList=function(e,t,i,s,o,n){var r=this.oFolderListItems[this.currentAccountId()],a=r?r.getFolderByFullName(e):null,l=a&&a.withoutThreads(),h=Mi.User.useThreads()&&!l&&""===i&&""===s,c=a?a.getUidList(i,s):null,u=c&&-1===c.resultCount(),d=(t-1)*Mi.User.MailsPerPage,p={Action:"MessagesGetList",Folder:e,Offset:d,Limit:Mi.User.MailsPerPage,Search:i,Filters:s,UseThreads:h?"1":"0"},m=!1,g=!1,f=o?this.onCurrentMessagesGetListResponse:this.onMessagesGetListResponse,b=[];return a.type()===Ci.FolderTypes.Inbox&&(p.InboxUidnext=a.uidNext()),u&&c.search()===this.uidList().search()&&c.filters()===this.uidList().filters()&&(c=this.uidList()),c&&(b=this.setMessagesFromUidList(c,d,a.oMessages,n)),c&&(g=u||d+b.length<c.resultCount()&&b.length<Mi.User.MailsPerPage,m=a.hasChanges()||g),m?Fi.Ajax.send(p,f,this):this.waitForUnseenMessages(!1),{UidList:c,RequestStarted:m,DataExpected:g,Folder:a}},fi.prototype.executeEmptyTrash=function(){var e=this.folderList().trashFolder();e&&e.emptyFolder()},fi.prototype.executeEmptySpam=function(){var e=this.folderList().spamFolder();e&&e.emptyFolder()},fi.prototype.onClearFolder=function(e){if(e&&e.selected()){this.messages.removeAll(),this.currentMessage(null);var t=e?e.getUidList(this.uidList().search(),this.uidList().filters()):null;this.uidList(t?t:new lt),this.checkMailStarted(!1),this.setAutocheckmailTimer()}},fi.prototype.moveMessagesToFolder=function(e,t,i){if(t.length>0){var s=this.folderList().currentFolder(),o=s&&s.type()===Ci.FolderTypes.Drafts,n=Ei.WindowOpener.getOpenedDraftUids(),r=o&&_.find(t,_.bind(function(e){return-1!==Ei.inArray(e,n)},this)),a=this.folderList().getFolderByFullName(e),l={Action:"MessageMove",Folder:s?s.fullName():"",ToFolder:e,Uids:t.join(",")},h=null,c=_.bind(function(){this.uidList().filters()===Ci.FolderFilter.Unseen&&this.uidList().resultCount()>Mi.User.MailsPerPage&&this.waitForUnseenMessages(!0),h=s.markDeletedByUids(t),a.addMessagesCountsDiff(h.MinusDiff,h.UnseenMinusDiff),(Ei.isUnd(i)?0:!i)||a.recivedAnim(!0),this.excludeDeletedMessages(),a.markHasChanges(),Fi.Ajax.send(l,this.onMoveMessagesResponse,this),a&&a.type()===Ci.FolderTypes.Trash&&Ii.runPluginHook("move-messages-to-trash",[Mi.Accounts.currentId(),l.Folder,t]),a&&a.type()===Ci.FolderTypes.Spam&&Ii.runPluginHook("move-messages-to-spam",[Mi.Accounts.currentId(),l.Folder,t])},this);s&&a&&(r?(this.disableComposeAutosave(!0),Fi.Screens.showPopup(E,[Ei.i18n("MAILBOX/CONFIRM_MESSAGE_FOR_DELETE_IS_EDITED"),_.bind(function(e){e&&(Ei.WindowOpener.closeComposesWithDraftUids(t),c()),this.disableComposeAutosave(!1)},this),"",Ei.i18n("MAILBOX/BUTTON_CLOSE_DELETE_DRAFT")])):c())}},fi.prototype.copyMessagesToFolder=function(e,t,i){if(t.length>0){var s=this.folderList().currentFolder(),o=this.folderList().getFolderByFullName(e),n={Action:"MessageCopy",Folder:s?s.fullName():"",ToFolder:e,Uids:t.join(",")};s&&o&&((Ei.isUnd(i)?0:!i)||o.recivedAnim(!0),o.markHasChanges(),Fi.Ajax.send(n,this.onCopyMessagesResponse,this),o&&o.type()===Ci.FolderTypes.Trash&&Ii.runPluginHook("copy-messages-to-trash",[Mi.Accounts.currentId(),n.Folder,t]),o&&o.type()===Ci.FolderTypes.Spam&&Ii.runPluginHook("copy-messages-to-spam",[Mi.Accounts.currentId(),n.Folder,t]))}},fi.prototype.excludeDeletedMessages=function(){_.delay(_.bind(function(){var e=this.folderList().currentFolder(),t=(this.page()-1)*Mi.User.MailsPerPage;this.setMessagesFromUidList(this.uidList(),t,e.oMessages,!0)},this),500)},fi.prototype.removeOneMessageFromCacheForFolder=function(e,t,i){var s=this.oFolderListItems[e],o=s?s.getFolderByFullName(t):null;o&&o.type()===Ci.FolderTypes.Drafts&&(o.markDeletedByUids([i]),o.commitDeleted([i]))},fi.prototype.startMessagesLoadingWhenDraftSaving=function(e,t){var i=this.oFolderListItems[e],s=i?i.getFolderByFullName(t):null;s&&s.type()===Ci.FolderTypes.Drafts&&s.selected()&&this.messagesLoading(!0)},fi.prototype.removeMessagesFromCacheForFolder=function(e,t){var i=this.oFolderListItems[e],s=i?i.getFolderByFullName(t):null,o=i?i.currentFolderFullName():null;s&&(s.markHasChanges(),this.currentAccountId()===e&&t===o&&this.requestCurrentMessageList(o,this.page(),this.uidList().search(),"",!0))},fi.prototype.deleteMessages=function(e){var t=this.folderList().currentFolder();t&&this.deleteMessagesFromFolder(t,e)},fi.prototype.deleteMessagesFromFolder=function(e,t){var i={Action:"MessageDelete",Folder:e.fullName(),Uids:t.join(",")};e.markDeletedByUids(t),this.excludeDeletedMessages(),Fi.Ajax.send(i,this.onMoveMessagesResponse,this),Ii.runPluginHook("delete-messages",[Mi.Accounts.currentId(),i.Folder,t])},fi.prototype.showExternalPictures=function(e){var t=[],i=null;this.currentMessage()&&(t=this.currentMessage().oFrom.aCollection,i=this.folderList().getFolderByFullName(this.currentMessage().folder()),e&&t.length>0?i.alwaysShowExternalPicturesForSender(t[0].sEmail):i.showExternalPictures(this.currentMessage().uid()))},fi.prototype.setCurrentMessage=function(e,t){var i=this.folderList().currentFolder(),s=i&&e?i.oMessages[e]:null;!Mi.SingleMode||i&&i.fullName()===t||(this.folderList().setCurrentFolder(t,""),i=this.folderList().currentFolder()),s&&!s.deleted()?(this.currentMessage(s),this.currentMessage().seen()||this.executeGroupOperation("MessageSetSeen",[this.currentMessage().uid()],"seen",!0),i.getCompletelyFilledMessage(e,this.onCurrentMessageResponse,this)):(this.currentMessage(null),Mi.SingleMode&&i&&i.getCompletelyFilledMessage(e,this.onCurrentMessageResponse,this))},fi.prototype.onCurrentMessageResponse=function(e,t){var i=this.currentMessage()?this.currentMessage().uid():"";null===e&&i===t?this.currentMessage(null):e&&i===t?this.currentMessage.valueHasMutated():Mi.SingleMode&&e&&null===this.currentMessage()&&this.currentMessage(e)},fi.prototype.getMessage=function(e,t,i,s){var o=this.folderList().getFolderByFullName(e);o&&o.getCompletelyFilledMessage(t,i,s)},fi.prototype.executeGroupOperation=function(e,t,i,s){var o=this.folderList().currentFolder(),n={Action:e,Folder:o?o.fullName():"",Uids:t.join(","),SetAction:s?1:0},r=(this.page()-1)*Mi.User.MailsPerPage,a=t.length,l=this.folderList().oStarredFolder?this.folderList().oStarredFolder.messageCount():0,h=o?o.getUidList("",Ci.FolderFilter.Flagged):null;o&&("MessageSetSeen"===n.Action&&this.iMessageSetSeenCount++,Fi.Ajax.send(n,this.onExecuteGroupOperationResponse,this),o.executeGroupOperation(i,t,s),o.type()===Ci.FolderTypes.Inbox&&"flagged"===i&&(this.uidList().filters()===Ci.FolderFilter.Flagged?s||(this.uidList().deleteUids(t),this.folderList().oStarredFolder&&this.folderList().oStarredFolder.messageCount(h.resultCount())):(o.removeFlaggedMessageListsFromCache(),""===this.uidList().search()&&this.folderList().oStarredFolder&&this.folderList().oStarredFolder.messageCount(s?l+a:l-a>0?l-a:0))),"seen"===i&&o.removeUnseenMessageListsFromCache(),(this.uidList().filters()!==Ci.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.setMessagesFromUidList(this.uidList(),r,o.oMessages,!0))},fi.prototype.onExecuteGroupOperationResponse=function(e,t){"MessageSetSeen"===t.Action&&(this.iMessageSetSeenCount--,this.iMessageSetSeenCount<0&&(this.iMessageSetSeenCount=0),this.folderList().currentFolder()&&0===this.iMessageSetSeenCount&&(this.uidList().filters()!==Ci.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.requestCurrentMessageList(this.folderList().currentFolder().fullName(),this.page(),this.uidList().search(),this.uidList().filters(),!1))},fi.prototype.onFoldersGetListResponse=function(e,t){var i=new rt,s=parseInt(e.AccountID,10),o=this.oFolderListItems[s],n=o?o.oNamedCollection:{};e.Result===!1?(Fi.Api.showErrorByCode(e),t.AccountID===this.currentAccountId()&&0===this.messages().length&&(this.messagesLoading(!1),this.messagesLoadingError(!0))):(i.parse(s,e.Result,n),o&&i.oStarredFolder.messageCount(o.oStarredFolder.messageCount()),this.oFolderListItems[s]=i,setTimeout(_.bind(this.getAllFoldersRelevantInformation,this,s),2e3),this.currentAccountId()===s&&this.folderList(i),this.editedAccountId()===s&&this.editedFolderList(i),Mi.Accounts.defaultId()===s&&this.defaultFolderList(i)),this.folderListLoading(!1)},fi.prototype.setCurrentFolderList=function(e){var t=e.iAccountId;t===this.currentAccountId()&&t!==this.folderList().iAccountId&&this.folderList(e)},fi.prototype.getAllFoldersRelevantInformation=function(e){var t=this.oFolderListItems[e],i=t.inboxFolder(),s=i?i.uidNext():"",o=t?t.getFoldersWithoutCountInfo():[],n={Action:"FoldersGetRelevantInformation",Folders:o,AccountID:e,InboxUidnext:s};o.length>0&&Fi.Ajax.send(n,this.onFoldersGetRelevantInformationResponse,this)},fi.prototype.onFoldersGetRelevantInformationResponse=function(e){var t=!1,i=e.AccountID,s=this.oFolderListItems[i],o=this.folderList().currentFolderFullName(),n=this.currentAccountId()===i;e.Result===!1?Fi.Api.showErrorByCode(e):(s&&(_.each(e.Result&&e.Result.Counts,function(e,i){if(_.isArray(e)&&e.length>3){var r=e[0],a=e[1],l=e[2],h=e[3],c=!1,u=!1,d=null;d=s.getFolderByFullName(i),d&&(u=n&&d.fullName()===o,c=d.setRelevantInformation(l,h,r,a,u),u&&c&&this.uidList().filters()!==Ci.FolderFilter.Unseen&&(this.requestCurrentMessageList(d.fullName(),this.page(),this.uidList().search(),this.uidList().filters(),!1),t=!0))}},this),s.countsCompletelyFilled(!0)),this.showNotificationsForNewMessages(e)),this.checkMailStarted(t),this.checkMailStarted()||this.setAutocheckmailTimer()},fi.prototype.showNotificationsForNewMessages=function(e){var t=0,i={};e.Result.New&&e.Result.New.length&&(t=e.Result.New.length,i={action:"show",icon:"skins/wm_logo_140x140.png",title:Ei.i18n("NOTIFICATION/NEW_MESSAGE_PLURAL",{COUNT:t},null,t),timeout:5e3},1===t&&(i.body=Ei.i18n("MESSAGE/HEADER_SUBJECT")+": "+e.Result.New[0].Subject+"\r\n"+Ei.i18n("MESSAGE/HEADER_FROM")+": "+_.map(e.Result.New[0].From,function(e){return""!==e.DisplayName?e.DisplayName:e.Email}).join(", ")),Fi.desktopNotify(i))},fi.prototype.onCurrentMessagesGetListResponse=function(e,t){this.checkMailStarted(!1),e.Result?(this.messagesLoadingError(!1),this.parseMessageList(e,t)):(Fi.Api.showErrorByCode(e),this.messagesLoading()!==!0||0!==this.messages().length&&e.ErrorCode===Ci.Errors.NotDisplayedError||this.messagesLoadingError(!0),this.messagesLoading(!1),this.setAutocheckmailTimer())},fi.prototype.onMessagesGetListResponse=function(e,t){e&&e.Result&&this.parseMessageList(e,t)},fi.prototype.parseMessageList=function(e,t){var i=e.Result,s=this.oFolderListItems[e.AccountID],o=null,n=null,r="1"===t.UseThreads,a=!1,l=this.currentAccountId()===e.AccountID&&this.folderList().currentFolderFullName()===i.FolderName,h=l&&this.uidList().search()===i.Search&&this.uidList().filters()===i.Filters,c=this.page()===i.Offset/Mi.User.MailsPerPage+1,u=[];this.showNotificationsForNewMessages(e),i!==!1&&"Collection/MessageCollection"===i["@Object"]&&(o=s.getFolderByFullName(i.FolderName),o.setRelevantInformation(i.UidNext.toString(),i.FolderHash,i.MessageCount,i.MessageUnseenCount,l&&!h),a=o.hasChanges(),o.removeAllMessageListsFromCacheIfHasChanges(),n=o.getUidList(i.Search,i.Filters),n.setUidsAndCount(i),_.each(i["@Collection"],function(e){var t=o.parseAndCacheMessage(e,!1,r);u.push(t)},this),Ii.runPluginHook("response-custom-messages",[e.AccountID,o.fullName(),u]),h&&(this.uidList(n),c&&(n.filters()!==Ci.FolderFilter.Unseen||this.waitForUnseenMessages())&&(this.setMessagesFromUidList(n,i.Offset,o.oMessages,!0),this.messagesLoading(!1),this.waitForUnseenMessages(!1),this.setAutocheckmailTimer())),!a||!l||h&&c||this.uidList().filters()===Ci.FolderFilter.Unseen||this.requestCurrentMessageList(this.folderList().currentFolderFullName(),this.page(),this.uidList().search(),this.uidList().filters(),!1),o.type()===Ci.FolderTypes.Inbox&&n.filters()===Ci.FolderFilter.Flagged&&""===n.search()&&this.folderList().oStarredFolder&&(this.folderList().oStarredFolder.messageCount(n.resultCount()),this.folderList().oStarredFolder.hasExtendedInfo(!0)))},fi.prototype.increaseStarredCount=function(){this.folderList().oStarredFolder&&this.folderList().oStarredFolder.increaseCountIfHasNotInfo()},fi.prototype.onMoveMessagesResponse=function(e,t){var i=e.Result,s=this.folderList().getFolderByFullName(t.Folder),o=this.folderList().getFolderByFullName(t.ToFolder),n=o&&o.type()===Ci.FolderTypes.Trash,r=o&&o.type()===Ci.FolderTypes.Spam,a=null,l=Ei.i18n(n?"MAILBOX/CONFIRM_MESSAGES_DELETE_WITHOUT_TRASH":"MAILBOX/CONFIRM_MESSAGES_MARK_SPAM_WITHOUT_SPAM"),h=_.bind(function(e){e&&s&&this.deleteMessagesFromFolder(s,t.Uids.split(","))},this),c=this.folderList().currentFolder(),u=c.fullName(),d=!1;if(i===!1?(a=s.revertDeleted(t.Uids.split(",")),o?(o.addMessagesCountsDiff(-a.PlusDiff,-a.UnseenPlusDiff),e.ErrorCode===Ci.Errors.ImapQuota&&(n||r)?Fi.Screens.showPopup(E,[l,h]):Fi.Api.showErrorByCode(e,Ei.i18n("MAILBOX/ERROR_MOVING_MESSAGES"))):Fi.Api.showErrorByCode(e,Ei.i18n("MAILBOX/ERROR_DELETING_MESSAGES")),d=!0):s.commitDeleted(t.Uids.split(",")),u===s.fullName()||o&&u===o.fullName())switch(c.markHasChanges(),this.uidList().filters()){case Ci.FolderFilter.Flagged:break;case Ci.FolderFilter.Unseen:this.waitForUnseenMessages()&&this.requestCurrentMessageList(u,this.page(),this.uidList().search(),this.uidList().filters(),d);break;default:this.requestCurrentMessageList(u,this.page(),this.uidList().search(),this.uidList().filters(),d)}else u!==s.fullName()?Fi.Prefetcher.startFolderPrefetch(s):o&&u!==o.fullName()&&Fi.Prefetcher.startFolderPrefetch(o)},fi.prototype.onCopyMessagesResponse=function(e,t){var i=e.Result,s=this.folderList().getFolderByFullName(t.Folder),o=this.folderList().getFolderByFullName(t.ToFolder),n=this.folderList().currentFolder(),r=n.fullName();i===!1&&Fi.Api.showErrorByCode(e,Ei.i18n("MAILBOX/ERROR_COPYING_MESSAGES")),r===s.fullName()||o&&r===o.fullName()?(n.markHasChanges(),this.requestCurrentMessageList(r,this.page(),this.uidList().search(),"",!1)):r!==s.fullName()?Fi.Prefetcher.startFolderPrefetch(s):o&&r!==o.fullName()&&Fi.Prefetcher.startFolderPrefetch(o)},fi.prototype.searchMessagesInCurrentFolder=function(e){var t=this.folderList().currentFolderFullName()||"INBOX",i=this.currentMessage()?this.currentMessage().uid():"",s=this.uidList().filters();Fi.Routing.setHash(Fi.Links.mailbox(t,1,i,e,s))},fi.prototype.searchMessagesInInbox=function(e){Fi.Routing.setHash(Fi.Links.mailbox(this.folderList().inboxFolderFullName()||"INBOX",1,"",e,""))},fi.prototype.countMessages=function(e){var t=[],i=function(e){_.each(e.subfolders(),function(e){e.subscribed()&&(t.push(e.unseenMessageCount()),e.subfolders().length&&e.subscribed()&&i(e))},this)};e.expanded()||e.isNamespace()?e.subfoldersMessagesCount(0):(i(e),e.subfoldersMessagesCount(_.reduce(t,function(e,t){return e+t},0)))},bi.prototype.clearInfoAboutEmail=function(e){this.contacts[e]=void 0},bi.prototype.getContactByEmail=function(e,t,i){if(Mi.User.ShowContacts){var s=this.contacts[e],o={Action:"ContactGetByEmail",Email:e};void 0!==s?t.apply(i,[s,e]):(this.responseHandlers[e]={Handler:t,Context:i},Fi.Ajax.send(o,this.onContactGetByEmailResponse,this))}},bi.prototype.onContactGetByEmailResponse=function(e,t){var i=null,s=this.responseHandlers[t.Email];e.Result&&(i=new ut,i.parse(e.Result)),this.contacts[t.Email]=i,s&&(s.Handler.apply(s.Context,[i,t.Email]),this.responseHandlers[t.Email]=void 0)},bi.prototype.addVcard=function(e){this.vcardAttachments.push(e)},bi.prototype.markVcardsNonexistentByUid=function(e){_.each(this.vcardAttachments,function(t){-1!==_.indexOf(e,t.uid())&&t.isExists(!1)})},bi.prototype.markVcardExistentByFile=function(e){_.each(this.vcardAttachments,function(t){t.file()===e&&t.isExists(!0)})},bi.prototype.addToContacts=function(e,t,i,s){var o={Action:"ContactCreate",PrimaryEmail:"Home",UseFriendlyName:"1",FullName:e,HomeEmail:t};Fi.Ajax.send(o,i,s),Fi.ContactsCache.recivedAnim(!0)},yi.prototype.addIcal=function(e){this.icalAttachments.push(e),0===this.calendars().length&&this.canRequestCalendarList()&&this.requestCalendarList()},yi.prototype.firstRequestCalendarList=function(){return this.canRequestCalendarList(!0),this.icalAttachments.length>0&&0===this.calendars().length&&this.requestCalendarList(),this.calendarsLoadingStarted()},yi.prototype.onCalendarListResponse=function(e){if(e&&e.Result){var t=Mi.Accounts,i=t.currentId(),s=t.getAccount(i).email(),o=_.filter(e.Result,function(e){return e.Owner===s||e.Access===Ci.CalendarAccess.Full||e.Access===Ci.CalendarAccess.Write});this.calendars(_.map(o,function(e){return{name:e.Name+" <"+e.Owner+">",id:e.Id}}))}this.calendarsLoadingStarted(!1)},yi.prototype.requestCalendarList=function(){this.calendarsLoadingStarted()||(Fi.Ajax.send({Action:"CalendarList"},this.onCalendarListResponse,this),this.calendarsLoadingStarted(!0))},yi.prototype.markIcalNonexistent=function(e){_.each(this.icalAttachments,function(t){e===t.uid()&&t.onEventDelete()})},yi.prototype.markIcalTypeByFile=function(e,t,i,s,o,n){_.each(this.icalAttachments,function(r){e===r.file()&&(r.type(t),r.cancelDecision(i),r.replyDecision(s),r.calendarId(o),r.selectedCalendarId(n))})},yi.prototype.markIcalTentative=function(e){_.each(this.icalAttachments,function(t){e===t.uid()&&t.onEventTentative()})},yi.prototype.markIcalAccepted=function(e){_.each(this.icalAttachments,function(t){e===t.uid()&&t.onEventAccept()})},Si.prototype.init=function(){},Si.prototype.collectScreensData=function(){},Si.prototype.run=function(){},Si.prototype.momentDateTriggerCallback=function(){var e=i.dataFor(this);e&&e.updateMomentDate&&e.updateMomentDate()},Si.prototype.fastMomentDateTrigger=function(){e(".moment-date-trigger-fast").each(this.momentDateTriggerCallback)},Si.prototype.setTitle=function(e){document.title=".",document.title=e||""},_.extend(vi.prototype,Si.prototype),vi.prototype.initPhone=function(){return null},vi.prototype.init=function(){var s=this,o=Mi.User,n=new $,r=Mi.Accounts,a=new X,l=Mi.App,h=new Q(!!l.AllowOpenPGP&&this.Api.isPgpSupported());h.parse(l),Mi.App=h,n.parse(o),Mi.User=n,a.parse(Ei.pInt(Mi.Default),r),Mi.Accounts=a,this.MailCache=new fi,this.Phone=this.initPhone(n.AllowVoice&&!this.browser.ie&&!Pi),this.useGoogleAnalytics(),this.collectScreensData(),e(t).unload(function(){Ni||Ei.WindowOpener.closeAll()}),this.nowMoment=i.observable(moment()),t.setInterval(function(){s.fastMomentDateTrigger(),moment().diff(s.nowMoment(),"days")>0&&s.nowMoment(moment())},6e4),this.browser.ie8AndBelow&&e("body").css("overflow","hidden")},vi.prototype.collectScreensData=function(){},vi.prototype.registerHelpdeskUpdateFunction=function(e){this.fHelpdeskUpdate=e},vi.prototype.updateHelpdesk=function(){this.fHelpdeskUpdate&&this.fHelpdeskUpdate()},vi.prototype.useGoogleAnalytics=function(){var e=null,i=null;Mi.App.GoogleAnalyticsAccount&&0<Mi.App.GoogleAnalyticsAccount.length&&(t._gaq=t._gaq||[],t._gaq.push(["_setAccount",Mi.App.GoogleAnalyticsAccount]),t._gaq.push(["_trackPageview"]),e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src=("https:"===document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",i=document.getElementsByTagName("script")[0],i.parentNode.insertBefore(e,i))},vi.prototype.tokenProblem=function(){var e="window.location.reload(); return false;",t=Ei.i18n("WARNING/TOKEN_PROBLEM_HTML",{RELOAD_FUNC:e});Mi.Auth=!1,Fi.Api.showError(t,!0,!0)},vi.prototype.logout=function(e){var t={Action:"SystemLogout"};e&&(t.LastErrorCode=e),Fi.Ajax.send(t,this.onLogout,this),Mi.Auth=!1},vi.prototype.authProblem=function(){this.logout(Ci.Errors.AuthError)},vi.prototype.onLogout=function(){Ei.WindowOpener.closeAll(),Fi.Routing.finalize(),""!==Mi.App.CustomLogoutUrl?t.location.href=Mi.App.CustomLogoutUrl:t.location.reload()},vi.prototype.getAccounts=function(){return Mi.Accounts},vi.prototype.run=function(){this.Screens.init(),Di&&Mi&&Mi.Auth&&Mi.App.IosDetectOnLogin&&Mi.App.AllowIosProfile?t.location.href="?ios":Mi&&Mi.Auth?(Mi.SingleMode=this.Routing.isSingleMode(),Mi.SingleMode&&t.opener&&Mi.Accounts.populateIdentitiesFromSourceAccount(t.opener.App.getAccounts()),Mi.App.AllowWebMail&&this.MailCache.init(),Mi.HelpdeskRedirect&&this.Routing.currentScreen!==Ci.Screens.Helpdesk&&this.Routing.setHash([Ci.Screens.Helpdesk]),this.initRouting()):Mi&&""!==Mi.App.CustomLoginUrl?t.location.href=Mi.App.CustomLoginUrl:(this.Screens.showCurrentScreen(Ci.Screens.Login),this.checkLoginScreenStartError()),this.phoneInOneTab(),Ei.registerMailto(this.browser.firefox)},vi.prototype.checkLoginScreenStartError=function(){var e=Ei.pInt(Ei.getRequestParam("error"));0!==e&&Fi.Api.showErrorByCode({ErrorCode:e,ErrorMessage:""},"",!0),Mi&&Mi.LastErrorCode===Ci.Errors.AuthError&&this.Api.showError(Ei.i18n("WARNING/AUTH_PROBLEM"),!1,!0)},vi.prototype.initRouting=function(){var e=!!_.find(Ci.Screens,function(e){return e===Mi.App.DefaultTab});e&&(Mi.App.AllowWebMail||Mi.App.DefaultTab!==Ci.Screens.Mailbox)?this.Routing.init(Mi.App.DefaultTab):Mi.App.AllowWebMail?this.Routing.init(Ci.Screens.Mailbox):this.headerTabs().length>0&&this.Routing.init(this.headerTabs()[0].name)},vi.prototype.getHelpLink=function(e){return Mi&&Mi.Links&&Mi.Links[e]?Mi.Links[e]:""},vi.prototype.addScreenToHeader=function(e,t,s,o,n,r,a){var l=this.Routing.buildHashFromArray([e]),h=this;e===Ci.Screens.Helpdesk&&(l=i.computed(function(){return"#"+h.Routing.lastHelpdeskHash()})),Ci.Screens[e]=e,this.Screens.oScreens[e]={Model:n,TemplateName:o},this.headerTabs.push({name:e,title:t,hash:l,koVisibleTab:r,koRecivedAnim:a}),this.screensTitle[e]=s},vi.prototype.registerSessionTimeoutFunction=function(e){this.sessionTimeoutFunctions.push(e)},vi.prototype.initSessionTimeout=function(){this.setSessionTimeout(),e("body").on("click",_.bind(this.setSessionTimeout,this)).on("keydown",_.bind(this.setSessionTimeout,this))},vi.prototype.setSessionTimeout=function(){clearTimeout(this.iSessionTimeout),Mi&&Mi.Auth&&Mi.App.IdleSessionTimeout&&(this.iSessionTimeout=setTimeout(_.bind(this.logoutBySessionTimeout,this),Mi.App.IdleSessionTimeout))
},vi.prototype.logoutBySessionTimeout=function(){Mi.Auth&&(_.each(this.sessionTimeoutFunctions,function(e){e()}),_.delay(_.bind(this.logout,this),500))},vi.prototype.initHeaderInfo=function(){this.browser.ie?e(document).bind("focusin",_.bind(this.onFocus,this)).bind("focusout",_.bind(this.onBlur,this)):e(t).bind("focus",_.bind(this.onFocus,this)).bind("blur",_.bind(this.onBlur,this))},vi.prototype.onFocus=function(){this.focused(!0)},vi.prototype.onBlur=function(){this.focused(!1)},vi.prototype.setTitle=function(e){var t=this.newMessagesCount(),i="";e=e||"",e=this.focused()||0===t||!Mi.App.AllowWebMail?this.getTitleByScreen():Ei.i18n("TITLE/HAS_UNSEEN_MESSAGES_PLURAL",{COUNT:t},null,t)+" - "+Mi.Accounts.getEmail(),this.favico&&(i=t>99?"99+":t,this.favico._cachevalue!==i&&(this.favico._cachevalue=i,this.favico.badge(i))),document.title=".",document.title=e},vi.prototype.getTitleByScreen=function(){var e="",t="";try{this.MailCache.currentMessage()&&(t=this.MailCache.currentMessage().subject())}catch(i){}switch(this.currentScreen()){case Ci.Screens.Login:e=Ei.i18n("TITLE/LOGIN",null,"");break;case Ci.Screens.Mailbox:e=Mi.Accounts.getEmail()+" - "+Ei.i18n("TITLE/MAILBOX");break;case Ci.Screens.Compose:case Ci.Screens.SingleCompose:e=Mi.Accounts.getEmail()+" - "+Ei.i18n("TITLE/COMPOSE");break;case Ci.Screens.SingleMessageView:e=Mi.Accounts.getEmail()+" - "+Ei.i18n("TITLE/VIEW_MESSAGE"),t&&(e=t+" - "+e);break;default:this.screensTitle[this.currentScreen()]&&(e=this.screensTitle[this.currentScreen()])}return""===e?e=Mi.App.SiteName:e+=Mi.App.SiteName&&""!==Mi.App.SiteName?" - "+Mi.App.SiteName:"",e},vi.prototype.desktopNotify=function(e,t,i,s,o,n){Ei.desktopNotify(e,t,i,s,o,n)},vi.prototype.phoneInOneTab=function(){if(this.Phone&&t.localStorage){var i=this;e(t).on("storage",function(){"false"!==t.localStorage.getItem("p7phoneLoad")&&t.localStorage.setItem("p7phoneLoad","false")}),t.localStorage.setItem("p7phoneLoad",Math.floor(900*Math.random()+100).toString()),t.setTimeout(function(){Mi.SingleMode||!i.Phone||"false"===t.localStorage.getItem("p7phoneLoad")&&!t.sessionStorage.getItem("p7phoneTab")||(i.Phone.init(),t.sessionStorage.setItem("p7phoneTab","true"))},1e3)}},_.extend(Ai.prototype,vi.prototype),Ai.prototype.initPhone=function(e){return e?new m:null},Ai.prototype.collectScreensData=function(){Mi.User.ShowContacts&&this.addScreenToHeader("contacts",Ei.i18n("HEADER/CONTACTS"),Ei.i18n("TITLE/CONTACTS"),"Contacts_ContactsViewModel",qt,!0,this.ContactsCache.recivedAnim),Mi.User.AllowCalendar&&this.addScreenToHeader("calendar",Ei.i18n("HEADER/CALENDAR"),Ei.i18n("TITLE/CALENDAR"),"Calendar_CalendarViewModel",di,!0,this.CalendarCache.recivedAnim,!0),Mi.User.IsFilesSupported&&this.addScreenToHeader("files",Ei.i18n("HEADER/FILESTORAGE"),Ei.i18n("TITLE/FILESTORAGE"),"FileStorage_FileStorageViewModel",pi,Mi.User.filesEnable,this.filesRecievedAnim),Mi.User.IsHelpdeskSupported&&this.addScreenToHeader("helpdesk",Ei.i18n("HEADER/HELPDESK"),Ei.i18n("TITLE/HELPDESK"),"Helpdesk_HelpdeskViewModel",mi,!0)},Fi=new Ai,t.App=Fi,-1===Mi.IsMobile){var Li=t.matchMedia("all and (min-width: 768px)").matches?0:1;t.App.Ajax.send({Action:"SystemSetMobile",Mobile:Li},function(){Li?t.location.reload():e(function(){_.defer(function(){Fi.run()})})},this)}else e(function(){_.defer(function(){Fi.run()})});t.Modernizr&&navigator&&t.Modernizr.addTest("mobile",function(){return Pi}),t.AfterLogicApi=Ii,t.Enums=Ci,Ri.removeClass("no-js").addClass("js"),Ri.hasClass("pdf")&&(ki.push("application/pdf"),ki.push("application/x-pdf"))}(jQuery,window,ko,crossroads,hasher);
